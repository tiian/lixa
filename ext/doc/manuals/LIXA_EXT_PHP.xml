<chapter>
  <title>PHP</title>
  <note>
    <para>
      There is not a porting of LIXA to Microsoft Windows operating system;
      LIXA PHP extension is not suitable to operate in a Microsoft Windows
      environment as well as LIXA base technology.
    </para>
    <para>
      Most of the PHP technology is platform independent, but this does not
      apply to LIXA PHP extension: it has been developed and tested using
      GNU/Linux operating system.
    </para>
  </note>
  <section>
    <title>Extension type</title>
    <para>
      LIXA PHP extension is a <emphasis>patch</emphasis> for 
      <link xlink:href="http://www.php.net/">Zend</link>      
      engine. The patch contains:
      <itemizedlist mark='bullet'>
	<listitem><para>
	    a PHP LIXA wrapper dynamically generated using
	    <link xlink:href="http://www.swig.org/">SWIG</link>      
	</para></listitem>
	<listitem><para>
	    a set of changes to PHP database drivers
	</para></listitem>
	<listitem><para>
	    all the build &amp; deploy stuff needed to produce a Zend 
	    (LIXA patched) PHP engine
	</para></listitem>
      </itemizedlist>
    </para>
  </section>
  <section>
    <title>Prerequisites</title>
    <para>
      LIXA wrapper is dynamically generated using
      <link xlink:href="http://www.swig.org/">SWIG</link>,
      so you must install SWIG on your system before you can going on.
    </para>
    <para>
      PHP needs some specific versions of <command>autoconf</command>
      as explained in 
      <link xlink:href="http://www.php.net/manual/en/internals2.buildsys.configunix.php">
	Talking to the UNIX build system: config.m4</link>;
      you must install the right version of <command>autoconf</command>
      before going on. Without a valid version of <command>autoconf</command>
      you will not be able to build a Zend PHP engine.
    </para>
    <para>
      For the sake of easiness, this manual shows how to build a fresh
      PHP Zend environment patched with LIXA extension.
      You could patched your previously downloaded PHP environment, but this
      manual tries to keep it easy and uses a freshly downloaded tarball.
    </para>
  </section>
  <section>
    <title>Installation</title>
    <para>
      Locate the <filename>ext/php</filename> directory inside the LIXA source
      tree and enter it; you should find an executable shell script named
      <command>download_and_patch.sh</command> inside it:
      <screen>
tiian@mojan:~/lixa/ext/php$ ls -la download_and_patch.sh
-rwxr-xr-x 1 tiian tiian 4855 2012-03-31 23:37 download_and_patch.sh
      </screen>
      <note>
	<para>
	  You need a running Internet connection before command execution
	  because it will try to download the PHP tarball for you from
	  <link xlink:href="http://docs.php.net/">http://docs.php.net/</link>
	</para>
      </note>
      Command <command>download_and_patch.sh</command> can do most operation
      for you, but you can perform the same manually.
      Try to execute the script from a terminal session:
      <table frame="box">
	<thead><tr><td>[Shell terminal session]</td></tr></thead>
	<tbody><tr><td><screen>
tiian@ubuntu:~/lixa/ext/php$ ./download_and_patch.sh
PHP 5.4.0 will be downloaded...
Checking if wget command is available... wget is /usr/bin/wget
Checking if bunzip2 is available... bunzip2 is /bin/bunzip2
--22:19:05--  http://docs.php.net/get/php-5.4.0.tar.bz2/from/docs.php.net/mirror
           => `php-5.4.0.tar.bz2'
Resolving docs.php.net... 213.175.195.123
Connecting to docs.php.net|213.175.195.123|:80... connected.
HTTP request sent, awaiting response... 302 Found
Location: http://docs.php.net/distributions/php-5.4.0.tar.bz2 [following]
--22:19:05--  http://docs.php.net/distributions/php-5.4.0.tar.bz2
           => `php-5.4.0.tar.bz2'
Connecting to docs.php.net|213.175.195.123|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 11,439,508 (11M) [application/octet-stream]

100%[====================================>] 11,439,508   837.51K/s    ETA 00:00

22:19:19 (819.29 KB/s) - `php-5.4.0.tar.bz2' saved [11439508/11439508]

Deflating PHP source code...
Checking if the downloaded PHP source code can be patched...
File lixa-php-5.4.0-patch.diff exists, trying patch command...
patching file php-5.4.0/ext/mysqli/mysqli_api.c
patching file php-5.4.0/ext/mysqli/mysqli_nonapi.c
patching file php-5.4.0/ext/mysqli/php_mysqli_structs.h
patching file php-5.4.0/ext/lixa/config.m4
Patching PHP source code...
patching file php-5.4.0/ext/mysqli/mysqli_api.c
patching file php-5.4.0/ext/mysqli/mysqli_nonapi.c
patching file php-5.4.0/ext/mysqli/php_mysqli_structs.h
patching file php-5.4.0/ext/lixa/config.m4
PHP source code successfully patched!
Removing php-5.4.0/configure and some stuff...
Creating new configure script...
Forcing buildconf
buildconf: checking installation...
buildconf: autoconf version 2.61 (ok)
rebuilding configure
rebuilding main/php_config.h.in
Checking configure recognize LIXA extension...
  --with-lixa=FILE        Include LIXA support. File is the path to lixa-config program

************************************************************************
  PHP source code in directory php-5.4.0 is ready for build and deploy;
  use --with-lixa=/opt/lixa/bin/lixa-config (or different path if you
  not using LIXA default path) to enable LIXA extension for PHP
************************************************************************
	</screen></td></tr></tbody>
      </table>
      These are the steps performed by the script:
      <orderedlist numeration='arabic'>
	<listitem>
	  <para>
	    PHP tarball download using <command>wget</command> from
	    http://docs.php.net/
	  </para>
	  <para>
	    if <command>bunzip2</command> is installed, 
	    <filename>.tar.bz2</filename> will be downloaded;
	    if <command>gunzip</command> is installed, 
	    <filename>.tar.gz</filename> will be downloaded;
	  </para>
	</listitem>
	<listitem><para>
	    tarball extraction
	</para></listitem>
	<listitem><para>
	    PHP source code patching
	</para></listitem>
	<listitem><para>
	    PHP build environment clean up 
	    (<command>rm -vf configure autom4te.cache/*</command>)
	</para></listitem>
	<listitem><para>
	    PHP build environment reset
	    (<command>./buildconf --force</command>)
	</para></listitem>
	<listitem><para>
	    check PHP build is LIXA enabled
	    (<command>./configure --help | grep lixa</command>)
	</para></listitem>
      </orderedlist>
    </para>
    <screen>
tiian@mojan:/tmp$ nice ./configure --enable-debug --enable-maintainer-zts --enable-cgi --enable-cli --enable-shared --with-mysqli=/usr/bin/mysql_config --with-pgsql --with-oci8=/usr/lib/oracle/xe/app/oracle/product/10.2.0/server --prefix=/opt/php-5.4-lixa --with-lixa=/opt/lixa/bin/lixa-config
    </screen>
  </section>
</chapter>
