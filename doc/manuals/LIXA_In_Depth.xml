<chapter>
  <title>In Depth</title>
  <para>
    This chapter explains some internal details you can be interested in
    when you are dealing with complex environments.
  </para>
  <section>
    <title>Logging</title>
    <para>
      [...]
    </para>
  </section>
  <section xml:id="Tracing">
    <title>Tracing</title>
    <para>
      The LIXA project can produce a lot of traces when the software is 
      running; the tracing functions are included in the code by default but
      you can disable them when you configure the software before the build 
      phase:
      <screen>
	./configure --disable-trace
	make
	...
      </screen>
      <warning><para>
	  Excluding tracing functions can reduce CPU and memory usage when
	  the software is running, but you should disable tracing 
	  <emphasis>only if you are really sure about it:
	  </emphasis>without tracing you have no instruments
	  to understand what's happening inside LIXA code when it's running.
      </para></warning>
      In the case you didn't disable the tracing feature at build time (see
      above), you could activate the message production when you need it.
    </para>
    <section xml:id="Tracing_modules">
      <title>Tracing modules</title>
      <para>
	The trace messages produced by LIXA code are divided by 
	<emphasis>modules</emphasis>: you can activate the trace messages for
	one or more modules. There is not a concept of <quote>severity</quote>
	for the trace messages: if you activate the trace for a module, it
	will print all the trace messages of that module.
      </para>
      <para>
	The table below shows how the LIXA software is partitioned in modules:
	<table xml:id="ex.calstable" frame="all">
	  <title>Tracing module flags</title>
	  <tgroup cols='4' align='left' colsep='1' rowsep='1'>
	    <thead>
	      <row>
		<entry align="center">Module Trace Label</entry>
		<entry align="center">Hex Flag</entry>
		<entry align="center">Component</entry>
		<entry align="center">Function</entry>
	      </row>
	    </thead>
	    <tbody>
	      <row>
		<entry>LIXA_TRACE_MOD_SERVER</entry>
		<entry>0x00000001</entry>
		<entry><command>lixad</command> (state server)</entry>
		<entry>main program</entry>
	      </row>
	      <row>
		<entry>LIXA_TRACE_MOD_SERVER_CONFIG</entry>
		<entry>0x00000002</entry>
		<entry><command>lixad</command> (state server)</entry>
		<entry>configuration: config file parsing and environment 
		  variable detection</entry>
	      </row>
	      <row>
		<entry>LIXA_TRACE_MOD_SERVER_LISTENER</entry>
		<entry>0x00000004</entry>
		<entry><command>lixad</command> (state server)</entry>
		<entry>network listener and signal handler</entry>
	      </row>
	      <row>
		<entry>LIXA_TRACE_MOD_SERVER_MANAGER</entry>
		<entry>0x00000008</entry>
		<entry><command>lixad</command> (state server)</entry>
		<entry>session client manager, thread manager, 
		  network I/O manager</entry>
	      </row>
	      <row>
		<entry>LIXA_TRACE_MOD_SERVER_STATUS</entry>
		<entry>0x00000010</entry>
		<entry><command>lixad</command> (state server)</entry>
		<entry>persistent state</entry>
	      </row>
	      <row>
		<entry>LIXA_TRACE_MOD_SERVER_XA</entry>
		<entry>0x00000040</entry>
		<entry><command>lixad</command> (state server)</entry>
		<entry>XA logic called by client</entry>
	      </row>
	      <row>
		<entry>LIXA_TRACE_MOD_SERVER_REPLY</entry>
		<entry>0x00000080</entry>
		<entry><command>lixad</command> (state server)</entry>
		<entry>replies to client messages</entry>
	      </row>
	      <row>
		<entry>LIXA_TRACE_MOD_SERVER_RECOVERY</entry>
		<entry>0x00000100</entry>
		<entry><command>lixad</command> (state server)</entry>
		<entry>logic necessary to answer the client recovery 
		  calls</entry>
	      </row>
	      <row>
		<entry>LIXA_TRACE_MOD_CLIENT_TX</entry>
		<entry>0x00001000</entry>
		<entry><systemitem class="library">lixac</systemitem>
		  (client library)</entry>
		<entry>transaction demarcation (TX) functions:
		  <function>tx_open()</function>,
		  <function>tx_begin()</function>, ...</entry>
	      </row>
	      <row>
		<entry>LIXA_TRACE_MOD_CLIENT_XA</entry>
		<entry>0x00002000</entry>
		<entry><systemitem class="library">lixac</systemitem>
		  (client library)</entry>
		<entry>XA function wrapper:
		  <function>xa_open()</function>,
		  <function>xa_start()</function>, 
		  <function>ax_reg()</function>, ...</entry>
	      </row>
	      <row>
		<entry>LIXA_TRACE_MOD_CLIENT_CONN</entry>
		<entry>0x00004000</entry>
		<entry><systemitem class="library">lixac</systemitem>
		  (client library)</entry>
		<entry>function necessary to connect to the state server 
		  (<command>lixad</command>)</entry>
	      </row>
	      <row>
		<entry>LIXA_TRACE_MOD_CLIENT_CONFIG</entry>
		<entry>0x00008000</entry>
		<entry><systemitem class="library">lixac</systemitem>
		  (client library)</entry>
		<entry>configuration: config file parsing and environment 
		  variable detection</entry>
	      </row>
	      <row>
		<entry>LIXA_TRACE_MOD_CLIENT_XA_SWITCH</entry>
		<entry>0x00010000</entry>
		<entry><systemitem class="library">lixac</systemitem>
		  (client library)</entry>
		<entry>XA switch file implementation of the dummy resource
		managers provided by LIXA and of the XA wrappers for the
		resource managers without a standard switch file</entry>
	      </row>
	      <row>
		<entry>LIXA_TRACE_MOD_CLIENT_STATUS</entry>
		<entry>0x00020000</entry>
		<entry><systemitem class="library">lixac</systemitem>
		  (client library)</entry>
		<entry>client status management</entry>
	      </row>
	      <row>
		<entry>LIXA_TRACE_MOD_CLIENT_RECOVERY</entry>
		<entry>0x00040000</entry>
		<entry><systemitem class="library">lixac</systemitem>
		  (client library)</entry>
		<entry>warm and cold recovery of the transaction(s)</entry>
	      </row>
	      <row>
		<entry>LIXA_TRACE_MOD_COMMON_CONFIG</entry>
		<entry>0x01000000</entry>
		<entry><systemitem class="library">lixab</systemitem>
		  (common base library)</entry>
		<entry>configuration stuff common to all components</entry>
	      </row>
	      <row>
		<entry>LIXA_TRACE_MOD_COMMON_XML_MSG</entry>
		<entry>0x02000000</entry>
		<entry><systemitem class="library">lixab</systemitem>
		  (common base library)</entry>
		<entry>functions related to XML messages serialization and
		deserialization</entry>
	      </row>
	      <row>
		<entry>LIXA_TRACE_MOD_COMMON_STATUS</entry>
		<entry>0x04000000</entry>
		<entry><systemitem class="library">lixab</systemitem>
		  (common base library)</entry>
		<entry>convenience functions used to manage the status on
		client and server side</entry>
	      </row>
	      <row>
		<entry>LIXA_TRACE_MOD_COMMON_UTILS</entry>
		<entry>0x08000000</entry>
		<entry><systemitem class="library">lixab</systemitem>
		  (common base library)</entry>
		<entry>utility functions used by all the components</entry>
	      </row>
	      <row>
		<entry>LIXA_TRACE_MOD_COMMON_XID</entry>
		<entry>0x10000000</entry>
		<entry><systemitem class="library">lixab</systemitem>
		  (common base library)</entry>
		<entry>functions specialized for XID (transaction ID)
		management</entry>
	      </row>
	    </tbody>
	  </tgroup>
	</table>
	You can trace any module combination creating any
	<emphasis>trace mask</emphasis> ORing the bits; for example:
	<itemizedlist mark="bullet">
	  <listitem>
	    <para>0x00000003 will produce all the messages of
	    <constant>LIXA_TRACE_MOD_SERVER</constant> and
	    <constant>LIXA_TRACE_MOD_SERVER_CONFIG</constant></para>
	  </listitem>
	  <listitem>
	    <para>0xffffffff will produce all the messages</para>
	  </listitem>
	  <listitem>
	    <para>0x00000000 will disable all the messages</para>
	  </listitem>
	</itemizedlist>
      </para>
    </section>
    <section>
      <title>Activating trace</title>
      <para>
	The trace can be activated setting the environment variable
	<varname>LIXA_TRACE_MASK</varname> before starting the execution of
	the traced program. Try the following example...
      </para>
      <para>
	Check the state server is not active:
	<screen>
tiian@ubuntu:~$ ps -ef|grep lixad|grep -v grep
	</screen>
	try to execute <command>lixat</command>, the LIXA test program:
	<screen>
tiian@ubuntu:~$ /opt/lixa/bin/lixat
tx_open(): -7
	</screen>
	it gives us few information (<constant>TX_FAIL = -7</constant>): from
	<filename>/opt/lixa/include/tx.h</filename> we can retrieve the
	meaning: <quote>fatal error</quote>... Not so much...
	We could try to trace the <quote>CLIENT TX</quote> module:
	<screen>
tiian@ubuntu:~$ /opt/lixa/bin/lixat
2011-12-04 12:19:49.235007 [8899/3073612464] lixa_tx_open
2011-12-04 12:19:49.241544 [8899/3073612464] lixa_tx_open/TX_*=-7/excp=5/ret_cod=-138/errno=111
tx_open(): -7
	</screen>
	<quote>ret_cod=-138</quote> can be inspected inside
	<filename>src/common/lixa_errors.h</filename>:
	<screen>
[...]
/**
 * "connect" function error
 */
#define LIXA_RC_CONNECT_ERROR                  -138
[...]
	</screen>
	now we know the errors happens using <function>connect()</function>
	function; <quote>errno=111</quote> can be inspected inside
	<filename>/usr/include/asm-generic/errno.h</filename>:
	<screen>
[...]
#define ECONNREFUSED    111     /* Connection refused */
[...]
	</screen>
      </para>
    </section>
  </section>
  <section>
    <title>Automatic and manual recovery</title>
    <para>
      [...]
    </para>
  </section>
  <section xml:id="Non_root_installation">
    <title>Non root installation</title>
    <para>
      [...]
    </para>
  </section>
  <section xml:id="Workload_balanced_environments">
    <title>Workload balanced environments</title>
    <para>
      [...]
    </para>
  </section>
</chapter>
