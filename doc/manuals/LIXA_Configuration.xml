<chapter>
  <title>Configuration</title>
  <para>
    A LIXA system is the assembling of two components: the client and 
    the server. The figure
    below shows a typical configuration with one Application
    Programs and two Resource Managers.
  </para>
  <figure xml:id="config1">
    <title>Typical LIXA topology</title>
    <mediaobject>
      <imageobject>
	<imagedata fileref="LIXA_Configuration_1.png"/>
      </imageobject>
    </mediaobject>
  </figure>
  <para>
    The model shows logical and phisycal blocks:
    <itemizedlist mark='bullet'>
      <listitem><para>
	  "Application Program code" is the code of your own application
      </para></listitem>
      <listitem><para>
	  "librm1" is the code of the library your application must use to
	  communicate with "RM1" (the first resource manager)
      </para></listitem>
      <listitem><para>
	  "librm2" is the code of the library your application must use to
	  communicate with "RM2" (the second resource manager)
      </para></listitem>
      <listitem><para>
	  "liblixac" is the code of the library your application must use to
	  invoke the TX verbs and send instruction to the Transaction Manager
      </para></listitem>
      <listitem><para>
	  "Application Program code" + "librm1" + "librm2" + "liblixac" must
	  be linked togheter to produce the Application Program; the
	  Application Program is an executable object
      </para></listitem>
      <listitem><para>
	  "RM1" is the first resource manager; it may be a relational database
	  (RDBMS)
      </para></listitem>
      <listitem><para>
	  "RM2" is the second resource manager; it may be an object oriented
	  database (OODBMS)
      </para></listitem>
      <listitem><para>
	  "lixad" is the <emphasis>daemon</emphasis> used by "liblixac" to
	  store the states of the transactions
      </para></listitem>
    </itemizedlist>
  </para>
  <para>
    The model shows how the blocks communicate:
    <itemizedlist mark='bullet'>
      <listitem><para>
	  (A1): is the protocol supplied by the first resource manager; 
	  SQL/CLI is an example and is supplied by IBM DB2, 
	  SQL/OCI is another example and is supplied by Oracle Database Server
      </para></listitem>
      <listitem><para>
	  (B1): is the protocol supplied by the second resource manager; every
	  resource manager has its own protocol and its own API
      </para></listitem>
      <listitem><para>
	  (A2): is the internal protocol used by the client of RM1 to 
	  communicate with RM1 server process(es); it can be a cross memory
	  or a network protocol and it depends on RM1 configuration
      </para></listitem>
      <listitem><para>
	  (B2): is the internal protocol used by the client of RM2 to 
	  communicate with RM2 server process(es); it can be a cross memory
	  or a network protocol and it depends on RM2 configuration
      </para></listitem>
      <listitem><para>
	  (TX): is the protocol supplied by the LIXA project and is described
	  in <citation>TXspec</citation>; it's a standard protocol and API
      </para></listitem>
      <listitem><para>
	  (XA): is the standard protocol used by the LIXA project to 
	  communicateand with the resource managers and is described
	  in <citation>XAspec</citation>; it's a standard protocol and API
      </para></listitem>
      <listitem><para>
	  (LX): is the internal protocol used by the client of LIXA to 
	  communicate with the LIXA server process (lixad); it is a network 
	  protocol
      </para></listitem>
    </itemizedlist>
  </para>
  <section>
    <title>Architectural elements</title>
    <para>
      The <command>lixad</command> daemon process can be executed on any
      system: there is no need it is executed on the same system that's hosting
      the Application Programs. The communications between 
      the client and the server (<command>lixad</command>) uses TCP/IP sockets.
    </para>
    <para>
      The <command>lixac</command> library is embedded in the Application
      Programs; the communication between the Application Program and
      the <command>lixac</command> library uses TX (Transaction Demarcation)
      API, see <citation>TXspec</citation>. The <command>lixac</command> 
      library contains all the logic of the LIXA Transaction Manager.
    </para>
    <para>
      The communication between the Application Program and the Resource
      Managers depends on Resource Managers type and configuration: 
      it may be cross memory, TCP/IP, System V IPC, etc...
      The communication between the <command>lixac</command> library and the
      Resource Manager depends on Resource Manager configuration and must be
      of the same used by the Application Program.
    </para>
    <para>
      The communication between <command>lixac</command> library and 
      <command>lixad</command> is ever istantiated by the client: the
      server never calls the clients.
    </para>
    <section>
      <title>Deployment models</title>
      <para>
	This section explains some different deployment models you can
	set up leveraging the LIXA project technology.
      </para>
      <section>
	<title>The easiest non trivial model</title>
	<para>
	  The easiest non trivial deployment of a distributed transaction
	  processing system based on the LIXA project is showed below: a single
	  node hosts the Application Program, the Resource Managers and the
	  LIXA server.
	</para>
	<figure xml:id="config2">
	  <mediaobject>
	    <imageobject>
	      <imagedata fileref="LIXA_Configuration_2.png"/>
	    </imageobject>
	  </mediaobject>
	  <title>Easiest non trivial deployment model</title>
	</figure>
      </section>
      <section>
	<title>The easiest trivial model</title>
	<para>
	  The easiest trivial deployment of a distributed transaction
	  processing system based on the LIXA project is showed below: a single
	  node hosts the Application Program, the Resource Manager and the
	  LIXA server. This configuration is obtained from the previous one
	  after a Resource Manager was removed.
	</para>
	<para>
	  Using only one Resource Manager is supported by the LIXA project
	  technology, but it's quite useless because you don't need a
	  transaction manager to perform 
	  <emphasis>single phase commit</emphasis> against one
	  Resource Manager. This type of configuration will not be described
	  more deeply.
	</para>
	<figure xml:id="config3">
	  <mediaobject>
	    <imageobject>
	      <imagedata fileref="LIXA_Configuration_3.png"/>
	    </imageobject>
	  </mediaobject>
	  <title>Easiest trivial deployment model</title>
	</figure>
      </section>
      <section>
	<title>A fully distributed model</title>
	<para>
	  A fully distributed transaction processing system can be achieved
	  splitting every component in to a different node.
	  The picture below shows 4 different nodes:
	  <itemizedlist mark='bullet'>
	    <listitem><para>
		an application server node hosting the Application Program
	    </para></listitem>
	    <listitem><para>
		a transaction manager dedicated node hosting the 
		LIXA server
	    </para></listitem>
	    <listitem><para>
		two resource manager dedicated nodes hosting the
		Reosurce Manager
	    </para></listitem>
	  </itemizedlist>
	</para>
	<figure xml:id="config4">
	  <mediaobject>
	    <imageobject>
	      <imagedata fileref="LIXA_Configuration_4.png"/>
	    </imageobject>
	  </mediaobject>
	  <title>Fully distributed deployment model</title>
	</figure>
      </section>
      <section>
	<title>A more complex distributed model</title>
	<para>
	  A more complex distributed transaction processing system 
	  can be achieved introducing a second application server and a third
	  Resource Manager; in the picture below the third Resource Manager 
	  is hosted in the same node of the second Resource Manager.
	</para>
	<para>
	  The two different Application Programs do not need to be hosted in
	  different application server. They are different 
	  Application Programs because they use a different mix of the
	  available Resource Managers.
	</para>
	<figure xml:id="config5">
	  <mediaobject>
	    <imageobject>
	      <imagedata fileref="LIXA_Configuration_5.png"/>
	    </imageobject>
	  </mediaobject>
	  <title>Complex distributed deployment model</title>
	</figure>
	<para>
	  Further complexity can be reached introducing an Application
	  Program that uses three (or more) different Resource Managers,
	  but this document will not go on this path to preserve
	  understandability
	  <footnote><para>
	      The dashed box named "Transaction Manager" was removed to
	      simplify the picture.
	  </para></footnote>
	  .
	</para>
      </section>
    </section>
  </section>
  <section>
    <title>Configuring the server</title>
    <para>
      The default configuration file is <filename>etc/lixad_conf.xml</filename>
      and is located at the root installation path (i.e.
      <filename>/opt/lixa/etc/lixad_conf.xml</filename>). 
      Below there is a sample configuration file:
      <screen>
&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
  &lt;server pid_file="/tmp/lixa/var/run.pid"&gt;
  &lt;listeners&gt;
    &lt;listener domain="AF_INET" address="127.0.0.1" port="3456"/&gt;
    &lt;listener domain="AF_INET" address="0.0.0.0" port="2345"/&gt;
  &lt;/listeners&gt;
  &lt;managers&gt;
    &lt;manager status_file="/tmp/lixa/var/lixad_status1"/&gt;
    &lt;manager status_file="/tmp/lixa/var/lixad_status2"/&gt;
    &lt;manager status_file="/tmp/lixa/var/lixad_status3"/&gt;
  &lt;/managers&gt;
&lt;/server&gt;
      </screen>
      
      The tags and the
      properties of the XML file are described below:
      <itemizedlist mark='bullet'>
	<listitem><para>
	    <varname>pid_file</varname>: it is the file used by the server 
	    to store the daemon <acronym>PID</acronym>; the server creates
	    the file at start-up and destroys it at shutdown
	</para></listitem>
	<listitem><para>
	    <varname>listener</varname>: the server can activate one or more
	    listeners; most of the times one listener is sufficient, but if
	    you want to use only a subset of the IP addresses defined at
	    the operating system level, you have do configure a dedicated
	    listener for every desired address
	</para></listitem>
	<listitem><para>
	    <varname>domain</varname>: the type of socket must be used to
	    listen for clients. The only allowed type is 
	    <constant>AF_INET</constant>; this may change in the future
	</para></listitem>
	<listitem><para>
	    <varname>address</varname>: the address must be used to listen for
	    clients; the special value <constant>0.0.0.0</constant> means
	    any address
	</para></listitem>
	<listitem><para>
	    <varname>port</varname>: the port must be used to listen for
	    clients; it must be a free port (use command 
	    <command>netstat</command> to find out one)
	</para></listitem>
	<listitem><para>
	    <varname>manager</varname>: any configured 
	    <emphasis>manager</emphasis> is a server worker and has its own
	    associated thread. The number of managers should be activated 
	    depends on the workload; if D is the number of indipendent 
	    hard disk devices and P is the number of processors/cores, the
	    suggested values are in the range:
	    <equation><title>Suggested range for the number of managers</title>
	      <mathphrase>
		[min(D,P) ; D*P]
	      </mathphrase>
	    </equation>
	</para></listitem>
	<listitem><para>
	    <varname>status_file</varname>: the physical path must be used to
	    create the status files (a couple) for a manager; this generally is
	    a persistent and reliable storage device like a RAID partition.
	    The string specified by the tag <varname>status_file</varname>
	    is used as a prefix: every manager (thread) creates two files
	    with the same prefix and different suffix.
	</para></listitem>
      </itemizedlist>
    </para>
  </section>
  <section>
    <title>Configuring the client</title>
    <para>
      The default configuration file is <filename>etc/lixac_conf.xml</filename>
      and is located at the root installation path (i.e.
      <filename>/opt/lixa/etc/lixac_conf.xml</filename>). 
      Below there is a sample configuration file:
      <screen>
&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;client&gt;
  &lt;trnmgrs&gt;
    &lt;trnmgr name="server1" domain="AF_INET" address="10.23.45.67" port="2345" /&gt;
    &lt;trnmgr name="server2" domain="AF_INET" address="10.23.46.91" port="3456" /&gt;
  &lt;/trnmgrs&gt;
  &lt;rsrmgrs&gt;
    &lt;rsrmgr name="OracleXE_dynreg" switch_file="/tmp/lixa/lib/switch_oracle_dynreg.so" xa_open_info="Oracle_XA+Acc=P/hr/hr+SesTm=30+LogDir=/tmp+threads=true+DbgFl=7+Loose_Coupling=true" xa_close_info="" /&gt;
    &lt;rsrmgr name="OracleXE_stareg" switch_file="/tmp/lixa/lib/switch_oracle_stareg.so" xa_open_info="Oracle_XA+Acc=P/hr/hr+SesTm=30+LogDir=/tmp+threads=true+DbgFl=7+Loose_Coupling=true" xa_close_info="" /&gt;
    &lt;rsrmgr name="IBMDB2_dynreg" switch_file="/tmp/lixa/lib/switch_ibmdb2_dynreg.so" xa_open_info="axlib=/tmp/lixa/lib/liblixacmt.so,db=sample,tpm=lixa" xa_close_info="" /&gt;
    &lt;rsrmgr name="IBMDB2_stareg" switch_file="/tmp/lixa/lib/switch_ibmdb2_stareg.so" xa_open_info="axlib=/tmp/lixa/lib/liblixacmt.so,db=sample,tpm=lixa" xa_close_info="" /&gt;
  &lt;/rsrmgrs&gt;
  &lt;profiles&gt;
    &lt;profile name="GT71"&gt;
      &lt;trnmgrs&gt;
        &lt;trnmgr&gt;local_1&lt;/trnmgr&gt;
      &lt;/trnmgrs&gt;
      &lt;rsrmgrs&gt;
        &lt;rsrmgr&gt;OracleXE_stareg&lt;/rsrmgr&gt;
        &lt;rsrmgr&gt;IBMDB2_stareg&lt;/rsrmgr&gt;
      &lt;/rsrmgrs&gt;
    &lt;/profile&gt;
    &lt;profile name="VZ67"&gt;
      &lt;trnmgrs&gt;
        &lt;trnmgr&gt;local_1&lt;/trnmgr&gt;
      &lt;/trnmgrs&gt;
      &lt;rsrmgrs&gt;
        &lt;rsrmgr&gt;OracleXE_dynreg&lt;/rsrmgr&gt;
        &lt;rsrmgr&gt;IBMDB2_dynreg&lt;/rsrmgr&gt;
      &lt;/rsrmgrs&gt;
    &lt;/profile&gt;
    &lt;profile name="AG71"&gt;
      &lt;trnmgrs&gt;
        &lt;trnmgr&gt;local_2&lt;/trnmgr&gt;
      &lt;/trnmgrs&gt;
      &lt;rsrmgrs&gt;
        &lt;rsrmgr&gt;IBMDB2_dynreg&lt;/rsrmgr&gt;
      &lt;/rsrmgrs&gt;
    &lt;/profile&gt;
  &lt;/profiles&gt;
&lt;/client&gt;
      </screen>
      The tags and the
      properties of the XML file are described below:
      <itemizedlist mark='bullet'>
	<listitem><para>
	    <varname>trnmgr</varname>: this section is used to describe a
	    manager (a LIXA server instance) that must be reached by any
	    client described below
	</para></listitem>
	<listitem><para>
	    <varname>trnmgr/name</varname>: a name associated to the 
	    manager; it is a logical name that is referenced by the profiles
	    defined below
	</para></listitem>
	<listitem><para>
	    <varname>domain</varname>: it must be the same domain specified 
	    by the listener that must be reached; the listener is configured
	    in <filename>lixad_conf.xml</filename> (see above) and may be
	    local or remote
	</para></listitem>
	<listitem><para>
	    <varname>address</varname>: it must be the same same address 
	    specified by the listener that must be reached; the listener is
	    configured in <filename>lixad_conf.xml</filename> (see above)
	    and may be local or remote
	</para></listitem>
	<listitem><para>
	    <varname>port</varname>: it must be the same port specified
	    by the listener that must be reached; the listener is
	    configured in
	    <filename>lixad_conf.xml</filename> (see above)
	    and may be local or remote
	</para></listitem>
	<listitem><para>
	    <varname>rsrmgr</varname>: this section is used to describe 
	    any resource manager that will be used by the
	    Application Programs configured below (see profiles)
	</para></listitem>
	<listitem><para>
	    <varname>rsrmgr/name</varname>: a name associated to the 
	    Resource Manager; it is a logical name that is referenced by
	    the profile defined below
	</para></listitem>
	<listitem><para>
	    <varname>switch_file</varname>: name of the file that contains 
	    the XA switch structure; the file is produced by the installation
	    procedure
	</para></listitem>
	<listitem><para>
	    <varname>xa_open_info</varname>: it is the string of parameters
	    that must be passed to the Resource Manager by the xa_open() 
	    function call; the content
	    of the string depends on the Resource Manager, see its
	    documentation. The string can not exceed 255 characters
	</para></listitem>
	<listitem><para>
	    <varname>xa_close_info</varname>: it is the string of parameters
	    that must be passed to the Resource Manager by the xa_open() 
	    function call; the content
	    of the string depends on the Resource Manager, see its
	    documentation. The string can not exceed 255 characters
	</para></listitem>
	<listitem><para>
	    <varname>profile</varname>: it contains the description of the
	    LIXA 


every transactional profile must be
	    used by the Application Programs needs to be listed here
	</para></listitem>
	<listitem><para>
	    <varname>profile/name</varname>: the name associated to the
	    transaction profile; this name is used in different places and
	    it is suggested to avoid special characters, blanks and possibly
	    mixed case (these hints may help you in troubleshooting)
	</para></listitem>
	<listitem><para>
	    <varname>profile/trnmgr</varname>: manager will be used to store
	    the transactional information associated to this profile; more
	    than one manager can be specified but <emphasis>only</emphasis> 
	    the first one is used with current release software
	</para></listitem>
	<listitem><para>
	    <varname>profile/rsrmgr</varname>: every Resource Manager must be
	    used by the Application Programs associated to this transactional
	    profile needs to be listed here. There is no a limit: you can
	    specify 1, 2, 3, ... resource managers. Avoid useless resource
	    manager because xa_open() and xa_close() will be performed 
	    against all the listed resource managers. If you can choose 
	    between a "dynamic" and a "static" version of the same resource
	    manager, the "dynamic" one is more efficient	    
	</para></listitem>
      </itemizedlist>
    </para>
    <section>
      <title>Client configuration explanation</title>
      <para>
	The client configuration file contains three sections:
	<itemizedlist mark='bullet'>
	  <listitem><para>
	      <varname>trnmgrs</varname>: the list of the LIXA daemons you are
	      running inside your network and you will use to manage the
	      persistent state of the clients will use the configuration
	      file; many times a single LIXA server is sufficient, but
	      sometimes you need more (development, test and production
	      environment might use different LIXA servers)
	  </para></listitem>
	  <listitem><para>
	      <varname>rsrmgrs</varname>: the list of the resource managers
	      necessary to Application Programs execution; there is no limit
	      to the number of resource managers from a LIXA point of view
	  </para></listitem>
	  <listitem><para>
	      <varname>profiles</varname>: the list of the available
	      transactional profiles for your Application Programs. This
	      concept allows you a great configuration flexibility: the same
	      configuration file can be used for completely different
	      Application Programs and completely different environment.
	      As an example, imagine you have 3 distinct applications and
	      every application uses a different mix of resource managers; then
	      you manage 3 different environments (development, test and
	      production): with 9 profiles you can completely model your
	      transactional needs (APP1DEV, APP2DEV, APP3DEV, APP1TEST,
	      APP2TEST, APP3TEST, APP1PROD, APP2PROD, APP3PROD).
	  </para></listitem>
	</itemizedlist>
	The <varname>LIXA_PROFILE</varname> environment variable must be used 
	to specify the transactional profile associated to the Application 
	Program.
	If you do not specify a valid transactional profile, the first profile
	of the list will be applied.
	<note><para>
	    There is not an alternate way to specify the transactional profile:
	    <function>tx_open</function> does not allow parameters.
	</para></note>
      </para>
    </section>
  </section>
  <section>
    <title>Environment variables</title>
    <para>
      Some environment variables are available to tailor the LIXA configuration
      to your needs.

      LIXA_PROFILE LIXA_CONFIG_FILE LIXA_JOB
      LIXA_CRASH_POINT LIXA_CRASH_COUNT
      LIXA_TRACE_MASK

    </para>
  </section>
</chapter>
