<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>LIXA</title><meta name="generator" content="DocBook XSL Stylesheets V1.73.2" /></head><body><div class="book" lang="en" xml:lang="en"><div class="titlepage"><div><div><h1 class="title"><a id="id3401788"></a>LIXA</h1></div><div><h2 class="subtitle">
    A libre, free, open source implementation of the XA and the TX 
    specifications
  </h2></div><div><div class="author"><h3 class="author"><span class="firstname">Christian</span> <span class="surname">Ferrari</span></h3></div></div><div><p class="copyright">Copyright Â© 2011 Christian Ferrari</p></div></div><hr /></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="preface"><a href="#id3402118">Preface</a></span></dt><dt><span class="chapter"><a href="#id3402119">1. Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="#id3402364">Why should I use LIXA project?</a></span></dt><dt><span class="section"><a href="#Transaction_Manager_and_Transaction_Monitor">Transaction Manager and Transaction Monitor</a></span></dt><dt><span class="section"><a href="#id3402617">LIXA Architecture</a></span></dt><dt><span class="section"><a href="#id3402640">Project, Projuct, Product</a></span></dt><dt><span class="section"><a href="#id3402789">LIXA and X/OPEN CAE specifications</a></span></dt></dl></dd><dt><span class="chapter"><a href="#Installation">2. Installation</a></span></dt><dd><dl><dt><span class="section"><a href="#id3403062">System requirements</a></span></dt><dd><dl><dt><span class="section"><a href="#id3403117">Pre-requisites</a></span></dt><dt><span class="section"><a href="#id3403303">Co-requisites</a></span></dt><dt><span class="section"><a href="#id3403390">Authorization</a></span></dt></dl></dd><dt><span class="section"><a href="#id3403463">Tested configurations</a></span></dt><dt><span class="section"><a href="#id3403646">Software download</a></span></dt><dt><span class="section"><a href="#id3403692">Configure, build and install</a></span></dt><dd><dl><dt><span class="section"><a href="#id3403702">Advanced configuration</a></span></dt><dt><span class="section"><a href="#Linking_third_party_resource_managers">Linking third party resource managers</a></span></dt><dt><span class="section"><a href="#id3404349">Summary</a></span></dt></dl></dd><dt><span class="section"><a href="#id3404371">Checking</a></span></dt></dl></dd><dt><span class="chapter"><a href="#Configuration">3. Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#id3404585">Architectural elements</a></span></dt><dd><dl><dt><span class="section"><a href="#id3404669">Deployment models</a></span></dt></dl></dd><dt><span class="section"><a href="#id3404894">Configuring LIXA components</a></span></dt><dd><dl><dt><span class="section"><a href="#id3404961">Configuring the server</a></span></dt><dt><span class="section"><a href="#id3405213">Configuring the client</a></span></dt></dl></dd><dt><span class="section"><a href="#id3405712">Environment variables</a></span></dt><dd><dl><dt><span class="section"><a href="#id3405727">LIXA_CONFIG_FILE</a></span></dt><dt><span class="section"><a href="#id3405764">LIXA_CRASH_COUNT</a></span></dt><dt><span class="section"><a href="#id3405786">LIXA_CRASH_POINT</a></span></dt><dt><span class="section"><a href="#id3405811">LIXA_JOB</a></span></dt><dt><span class="section"><a href="#id3405845">LIXA_PROFILE</a></span></dt><dt><span class="section"><a href="#id3405878">LIXA_TRACE_MASK</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#id3405944">4. Execution</a></span></dt><dd><dl><dt><span class="section"><a href="#id3405980">Starting the state server</a></span></dt><dd><dl><dt><span class="section"><a href="#Background_execution">Background (<span class="emphasis"><em>daemon</em></span>) execution</a></span></dt><dt><span class="section"><a href="#Maintenance_mode_execution">Maintenance mode execution</a></span></dt><dt><span class="section"><a href="#id3406228">Dump execution</a></span></dt><dt><span class="section"><a href="#id3406325">Additional options</a></span></dt></dl></dd><dt><span class="section"><a href="#id3405982">Starting the test utility</a></span></dt><dt><span class="section"><a href="#id3406502">Starting the recovery utility</a></span></dt></dl></dd><dt><span class="chapter"><a href="#Development">5. Development</a></span></dt><dd><dl><dt><span class="section"><a href="#id3406820">The TX (Transaction Demarcation) Specification</a></span></dt><dt><span class="section"><a href="#id3406969">The first example</a></span></dt><dd><dl><dt><span class="section"><a href="#id3407077">Some details about the example</a></span></dt></dl></dd><dt><span class="section"><a href="#Development_example2_ora">An example with Oracle Database Server</a></span></dt><dd><dl><dt><span class="section"><a href="#Development_setup_Oracle_environment">Set-up Oracle environment</a></span></dt><dt><span class="section"><a href="#Development_start_LIXA_server">Start the LIXA state server</a></span></dt><dt><span class="section"><a href="#id3407817">Build the client program</a></span></dt><dt><span class="section"><a href="#id3407872">Set-up LIXA environment</a></span></dt><dt><span class="section"><a href="#id3407970">Check the data table before execution</a></span></dt><dt><span class="section"><a href="#id3407994">Some checks before program execution</a></span></dt><dt><span class="section"><a href="#id3408073">Program execution (dynamic registration)</a></span></dt><dt><span class="section"><a href="#id3408179">Program execution (static registration)</a></span></dt></dl></dd><dt><span class="section"><a href="#Development_example3_db2">An example with IBM DB2 DBMS</a></span></dt><dd><dl><dt><span class="section"><a href="#Development_setup_DB2_environment">Set-up DB2 environment</a></span></dt><dt><span class="section"><a href="#id3408630">Start the LIXA state server</a></span></dt><dt><span class="section"><a href="#id3408648">Build the client program</a></span></dt><dt><span class="section"><a href="#id3408710">Set-up LIXA environment</a></span></dt><dt><span class="section"><a href="#id3408793">Some checks before program execution</a></span></dt><dt><span class="section"><a href="#id3408858">Program execution (dynamic registration)</a></span></dt><dt><span class="section"><a href="#id3409083">Program execution (static registration)</a></span></dt></dl></dd><dt><span class="section"><a href="#id3408271">An example with Oracle and IBM DB2</a></span></dt><dd><dl><dt><span class="section"><a href="#id3409272">Build the client program</a></span></dt><dt><span class="section"><a href="#id3409358">Set-up LIXA environment</a></span></dt><dt><span class="section"><a href="#id3409476">Some checks before program execution</a></span></dt><dt><span class="section"><a href="#id3409577">Program execution (dynamic registration)</a></span></dt><dt><span class="section"><a href="#id3409582">Program execution (mixed registration)</a></span></dt></dl></dd><dt><span class="section"><a href="#Development_example5_pql">An example with PostgreSQL</a></span></dt><dd><dl><dt><span class="section"><a href="#Development_setup_PostgreSQL_environment">Set-up PostgreSQL environment</a></span></dt><dt><span class="section"><a href="#id3410704">Start the LIXA state server</a></span></dt><dt><span class="section"><a href="#id3410742">Build the client program</a></span></dt><dt><span class="section"><a href="#id3410838">Set-up LIXA environment</a></span></dt><dt><span class="section"><a href="#id3410957">Some checks before program execution</a></span></dt><dt><span class="section"><a href="#id3411021">Program execution</a></span></dt></dl></dd><dt><span class="section"><a href="#Development_example6_pql_ora">An example with PostgreSQL &amp; Oracle</a></span></dt><dd><dl><dt><span class="section"><a href="#id3411359">Build the client program</a></span></dt><dt><span class="section"><a href="#id3411502">Set-up LIXA environment</a></span></dt><dt><span class="section"><a href="#id3411742">Some checks before program execution</a></span></dt><dt><span class="section"><a href="#id3411842">Program execution (dynamic registration for Oracle)</a></span></dt></dl></dd><dt><span class="section"><a href="#Development_example7_pql_ora">An example with PostgreSQL &amp; IBM DB2</a></span></dt><dd><dl><dt><span class="section"><a href="#id3412385">Build the client program</a></span></dt><dt><span class="section"><a href="#id3412498">Set-up LIXA environment</a></span></dt><dt><span class="section"><a href="#id3412640">Some checks before program execution</a></span></dt><dt><span class="section"><a href="#id3412747">Program execution (dynamic registration)</a></span></dt></dl></dd><dt><span class="section"><a href="#Development_example8_mys">An example with MySQL</a></span></dt><dd><dl><dt><span class="section"><a href="#Development_setup_MySQL_environment">Set-up MySQL environment</a></span></dt><dt><span class="section"><a href="#id3413406">Start the LIXA state server</a></span></dt><dt><span class="section"><a href="#id3413441">Build the client program</a></span></dt><dt><span class="section"><a href="#id3413520">Set-up LIXA environment</a></span></dt><dt><span class="section"><a href="#Development_setup_MySQL_xa_open_info">Some checks before program execution</a></span></dt><dt><span class="section"><a href="#id3413999">Program execution</a></span></dt></dl></dd><dt><span class="section"><a href="#Development_example9_mys_pql">An example with MySQL &amp; PostgreSQL</a></span></dt><dd><dl><dt><span class="section"><a href="#id3414383">Build the client program</a></span></dt><dt><span class="section"><a href="#id3414448">Set-up LIXA environment</a></span></dt><dt><span class="section"><a href="#id3414615">Some checks before program execution</a></span></dt><dt><span class="section"><a href="#id3414708">Program execution</a></span></dt></dl></dd><dt><span class="section"><a href="#Development_example10_mys_pql_ora">An example with MySQL, PostgreSQL &amp; Oracle</a></span></dt><dd><dl><dt><span class="section"><a href="#id3415144">Build the client program</a></span></dt><dt><span class="section"><a href="#id3415251">Set-up LIXA environment</a></span></dt><dt><span class="section"><a href="#id3415397">Some checks before program execution</a></span></dt><dt><span class="section"><a href="#id3415523">Program execution (dynamic registration for Oracle)</a></span></dt></dl></dd><dt><span class="section"><a href="#Development_example11_mys_mys">An example with two MySQL servers</a></span></dt><dd><dl><dt><span class="section"><a href="#id3416358">Build the client program</a></span></dt><dt><span class="section"><a href="#id3416452">Set-up LIXA environment</a></span></dt><dt><span class="section"><a href="#id3416560">Some checks before program execution</a></span></dt><dt><span class="section"><a href="#id3416634">Program execution</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#Recovery">6. Recovery</a></span></dt><dd><dl><dt><span class="section"><a href="#id3417136">Automatic (warm) recovery</a></span></dt><dd><dl><dt><span class="section"><a href="#id3417141">Scenario 1: autonoumos rollback</a></span></dt><dt><span class="section"><a href="#id3417226">Scenario 2: a second Application Program triggers the recovery action</a></span></dt></dl></dd><dt><span class="section"><a href="#Automatic_recovery_concepts">Automatic recovery concepts</a></span></dt><dd><dl><dt><span class="section"><a href="#Application_Program_equivalence">Application Program equivalence</a></span></dt><dt><span class="section"><a href="#id3417660">Automatic Recovery in a distributed environment</a></span></dt><dt><span class="section"><a href="#Forcing_automatic_recovery">Forcing automatic recovery</a></span></dt></dl></dd><dt><span class="section"><a href="#id3418112">Manual (cold) recovery</a></span></dt><dd><dl><dt><span class="section"><a href="#Recoverying_forgotten_transactions">Recoverying forgotten transactions</a></span></dt><dt><span class="section"><a href="#id3418188">Recoverying a â<span class="quote">recovery failed</span>â transaction</a></span></dt><dt><span class="section"><a href="#Recoverying_transaction_associated_different_job">Recoverying a transaction associated to a different job</a></span></dt><dt><span class="section"><a href="#id3419956">Recoverying a transaction managed by a different Transaction Manager</a></span></dt><dt><span class="section"><a href="#id3420069">Picking up the LIXA format id and branch qualifier</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#id3420212">7. In Depth</a></span></dt><dd><dl><dt><span class="section"><a href="#id3420226">Logging</a></span></dt><dt><span class="section"><a href="#Tracing">Tracing</a></span></dt><dd><dl><dt><span class="section"><a href="#Tracing_modules">Tracing modules</a></span></dt><dt><span class="section"><a href="#id3421118">Improve troubleshooting with trace</a></span></dt><dt><span class="section"><a href="#id3421138">Activating trace for <span class="command"><strong>lixad</strong></span> in 
	<span class="emphasis"><em>daemon</em></span> mode</a></span></dt><dt><span class="section"><a href="#id3421410">Redirecting the trace messages</a></span></dt></dl></dd><dt><span class="section"><a href="#Non_root_installation">Non root installation</a></span></dt><dt><span class="section"><a href="#Workload_balanced_environments">Workload balanced environments</a></span></dt><dt><span class="section"><a href="#id3421671">High Availability configuration</a></span></dt></dl></dd><dt><span class="bibliography"><a href="#id3421948">Bibliography</a></span></dt></dl></div><div class="list-of-figures"><p><b>List of Figures</b></p><dl><dt>3.1. <a href="#config1">Typical LIXA topology</a></dt><dt>3.2. <a href="#config2">Easiest non trivial deployment model</a></dt><dt>3.3. <a href="#config3">Trivial deployment model</a></dt><dt>3.4. <a href="#config4">Fully distributed deployment model</a></dt><dt>3.5. <a href="#config5">Complex distributed deployment model</a></dt><dt>3.6. <a href="#config6">The LIXA components and the necessary configuration files</a></dt><dt>3.7. <a href="#config7">The structure of lixad_conf.xml</a></dt><dt>3.8. <a href="#config8">The structure of lixac_conf.xml</a></dt><dt>3.9. <a href="#config9">A "real" environment</a></dt><dt>5.1. <a href="#develop1">Deploy model of an example with two dummy resource managers</a></dt><dt>5.2. <a href="#develop2">Deploy model of an example with Oracle Database Server</a></dt><dt>5.3. <a href="#develop3">Deploy model of an example with IBM DB2 DBMS</a></dt><dt>5.4. <a href="#develop4">Deploy model of an example showing a distributed transaction with Oracle and IBM DB2</a></dt><dt>5.5. <a href="#develop5">Deploy model of an example with PostgreSQL DBMS</a></dt><dt>5.6. <a href="#develop6">Deploy model of an example showing a distributed transaction with PostgreSQL and Oracle</a></dt><dt>5.7. <a href="#develop7">Deploy model of an example showing a distributed transaction with PostgreSQL and IBM DB2</a></dt><dt>5.8. <a href="#develop8">Deploy model of an example with MySQL DBMS</a></dt><dt>5.9. <a href="#develop9">Deploy model of an example showing a distributed transaction with
	MySQL and PostgreSQL</a></dt><dt>5.10. <a href="#develop10">Deploy model of an example showing a distributed transaction with
	MySQL, PostgreSQL and Oracle</a></dt><dt>5.11. <a href="#develop11">Deploy model of an example showing a distributed transaction with
	two MySQL servers</a></dt><dt>6.1. <a href="#recover1">The Application Program crashes before <code class="function">xa_prepare()</code></a></dt><dt>6.2. <a href="#recover2">The Application Program crashes after <code class="function">xa_prepare()</code></a></dt><dt>6.3. <a href="#recover3">Workload balanced Application Server</a></dt><dt>7.1. <a href="#high_availability_1">HA, step 1: the active node is on the left, 
	  the passive one is on the right</a></dt><dt>7.2. <a href="#high_availability_2">HA, step 2: the active node fails</a></dt><dt>7.3. <a href="#high_availability_3">HA, step 3: the passive node takes over the service</a></dt></dl></div><div class="list-of-equations"><p><b>List of Equations</b></p><dl><dt>3.1. <a href="#id3405180">Suggested range for the number of managers</a></dt></dl></div><div class="preface" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="id3402118"></a>Preface</h2></div></div></div><p>
    LIXA is acronym of LIbre XA: it's a free, libre, open source
    implementation of two X/Open specifications: "Distributed Transaction
    Processing: The TX (Transaction Demarcation) Specification" 
    [<a class="citation" href="#id3421960"><span class="citation">TXspec</span></a>]
    and "Distributed Transaction Processing: The XA Specification"
    [<a class="citation" href="#id3422020"><span class="citation">XAspec</span></a>].
  </p><p>
    The main goals of the LIXA project are:
    </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>implementing an XA compliant Transaction Manager</p></li><li style="list-style-type: disc"><p>supplying a TX compliant Application Programming Interface
	  (<acronym class="acronym">API</acronym>)
	</p></li><li style="list-style-type: disc"><p><span class="emphasis"><em>to be free</em></span></p></li><li style="list-style-type: disc"><p>to be compliant as much as possible with X/Open CAE 
	  specifications</p></li></ul></div><p>
  </p><p>
    From the following links you can buy and/or download for free the official
    X/Open documentation:
    </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	  [<a class="citation" href="#id3421958"><span class="citation">RefModel</span></a>]
	  <a class="ulink" href="http://www.opengroup.org/pubs/catalog/g504.htm" target="_top">
	    <em class="citetitle">
	      Distributed Transaction Processing: Reference Model, Version 3
	    </em>
	  </a>
	</p></li><li style="list-style-type: disc"><p>
	  [<a class="citation" href="#id3421960"><span class="citation">TXspec</span></a>]
	  <a class="ulink" href="http://www.opengroup.org/pubs/catalog/c504.htm" target="_top">
	    <em class="citetitle">
	      Distributed Transaction Processing: The TX (Transaction 
	      Demarcation) Specification
	    </em>
	  </a>
	</p></li><li style="list-style-type: disc"><p>
	  [<a class="citation" href="#id3422020"><span class="citation">XAspec</span></a>]
	  <a class="ulink" href="http://www.opengroup.org/pubs/catalog/c193.htm" target="_top">
	    <em class="citetitle">
	      Distributed Transaction Processing: The XA Specification
	    </em>
	  </a>
	</p></li><li style="list-style-type: disc"><p>
	  [<a class="citation" href="#id3422055"><span class="citation">XA+spec</span></a>]
	  <a class="ulink" href="http://www.opengroup.org/pubs/catalog/s423.htm" target="_top">
	    <em class="citetitle">
	      Distributed Transaction Processing: The XA+ Specification
	      Version 2
	    </em>
	  </a>
	</p></li></ul></div><p>
    LIXA documentation tries to avoid duplication with the content of the
    above books.
  </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Intended audience</h3><p>
      This manual is maintained in the hope it can help:
      </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>developers who want to use LIXA project to develop applications
	  </p></li><li style="list-style-type: disc"><p>system administrators that have to install, configure and
	    manage LIXA project instances
	  </p></li><li style="list-style-type: disc"><p>curious people that want to discover the features offered by
	    the LIXA project
	  </p></li></ul></div><p>
    </p></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Language</h3><p>
      Unfortunately English is not my mother tongue. This manual may contain
      a lot of language mistakes. If you sent me a revisioned versions of the
      Docbook sources (XML), I would accept it promptly .
    </p></div></div><div class="chapter" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="id3402119"></a>ChapterÂ 1.Â Introduction</h2></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3402364"></a>Why should I use LIXA project?</h2></div></div></div><p>
      LIXA project allows you to develop an Application Program that performs
      two phase commit transactions against two ore more Resource Managers.
      Two phase commit is a transactional protocol designed to 
      â<span class="quote">guarantee</span>â <acronym class="acronym">ACID</acronym> (Atomicity, Consistency,
      Isolation, Durability) transactionality.
      XA specification is not the only two phase commit protocol implementation
      but it is probably the best known and widespread. For a detailed
      explanation please refer to [<a class="citation" href="#id3421958"><span class="citation">RefModel</span></a>].
    </p></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
      The reference model ([<a class="citation" href="#id3421958"><span class="citation">RefModel</span></a>]) technical guide
      available on the <span class="trademark">Open Group</span>â¢ web site is more
      recent than the XA specification ([<a class="citation" href="#id3422020"><span class="citation">XAspec</span></a>]); 
      after XA, the X/Open Company developed the XA+ specification and the 
      reference model was improved with the concepts necessary for XA+. 
      LIXA project does <span class="emphasis"><em>not</em></span> implement
      the XA+ specification, but only XA and the following concepts explained 
      in [<a class="citation" href="#id3421958"><span class="citation">RefModel</span></a>] does not apply to the LIXA project:
      </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>3.1: Superior Node</p></li><li style="list-style-type: disc"><p>3.1: Subordinate Node</p></li><li style="list-style-type: disc"><p>3.1: Communication Resource Manager (<acronym class="acronym">CRM</acronym>)</p></li><li style="list-style-type: disc"><p>3.5: Distributed Communication Facilities</p></li><li style="list-style-type: disc"><p>3.6: Activity between Functional Components Involving Two or More APs</p></li><li style="list-style-type: disc"><p>3.7: CRM Communication Paradigms with APs</p></li><li style="list-style-type: disc"><p>3.8: High-level TP Language</p></li></ul></div><p>
      XA specification was designed to implement the two phase commit protocol
      in the case there is only one Application Program running inside a
      Transaction Monitor and using a Transaction Manager to coordinate any
      number of Resource Managers. XA+ specification was designed to
      implement the two phase commit protocol in the case there are two or
      more Application Programs running inside distinct Transaction Monitors
      and using distinct Transaction Managers to coordinate any number of
      Resource Managers.
    </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="Transaction_Manager_and_Transaction_Monitor"></a>Transaction Manager and Transaction Monitor</h2></div></div></div><p>
      As explained in Appendix A of [<a class="citation" href="#id3421958"><span class="citation">RefModel</span></a>] a 
      Transaction Manager can be though as a subset of a Transaction Monitor.
      Most commercial products tend to merge the features
      in a single bundle; this is good if you need a Transaction Monitor,
      this may be bad if you only need a Transaction Manager.
    </p><p>
      IBM TXSeries<sup>[<a id="id3402503" href="#ftn.id3402503" class="footnote">1</a>]</sup> is a Transaction Monitor with an
      integrated Transaction Manager.
      Oracle (BEA) Tuxedo<sup>[<a id="id3402511" href="#ftn.id3402511" class="footnote">2</a>]</sup> is a Transaction Monitor with an
      integrated Transaction Manager.
      JBOSS<sup>[<a id="id3402519" href="#ftn.id3402519" class="footnote">3</a>]</sup> is a <acronym class="acronym">JEE</acronym>
      (Java Enterprise Edition) application server; it is a Transaction
      Monitor with an integrated Transaction Manager for bytecode based
      applications.
    </p><p>
      <a class="ulink" href="http://www.springsource.com/" target="_top">
	<em class="citetitle">Spring JTA Transaction Manager</em>
      </a>,
      <a class="ulink" href="http://jotm.objectweb.org/index.html" target="_top">
	<em class="citetitle">JOTM (Java Open Transaction Manager)</em>
      </a>
      and
      <a class="ulink" href="http://www.bitronix.be/" target="_top">
	<em class="citetitle">BTM (Bitronix JTA Transaction Manager)</em>
      </a> 
      are Transaction Managers, but they are not Transaction Monitors and they
      can be used in conjunction with a
      <acronym class="acronym">JVM</acronym> (Java Virtual Machine) and 
      <span class="emphasis"><em>possibly</em></span> any
      Transaction Monitor. Unfortunately they are Java based technologies and 
      not native ones; in the Java arena there are a few stand-alone 
      Transaction
      Manager, while in the C language arena it is not easy to find out one.
    </p><p>
      The LIXA project implements a stand-alone Transaction Manager that your 
      Application Program can use in many different ways:
      </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>from a C application launched from shell</p></li><li style="list-style-type: disc"><p>from a C application launched via CGI inside a web server</p></li><li style="list-style-type: disc"><p>from a scripting language application<sup>[<a id="id3402604" href="#ftn.id3402604" class="footnote">4</a>]</sup>.</p></li></ul></div><p>
      With the aid of the LIXA Transaction Manager potentially any web server 
      can be converted in an Application Server with two phase commit support.
    </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3402617"></a>LIXA Architecture</h2></div></div></div><p>
      From an architectural point of view, the LIXA project adopts an original
      approach: an Application Program links the LIXA client library and
      embeds the Transaction Manager logic. Every Application Program instance
      runs its own Transaction Manager instance and every Transaction
      Manager instance uses the LIXA server daemon to save and retrieve the
      state of the managed transactions.
      LIXA project was designed to allow massive parallelism and embedding at
      the same time: the parallelism is necessary to support high volume
      workloads while the embeddable property is necessary to avoid conflicts
      with the process and thread management feature of any Transaction 
      Monitors.
    </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3402640"></a>Project, Projuct, Product</h2></div></div></div><p>
      LIXA is a <span class="emphasis"><em>project</em></span>: a software artifact you can pick
      up to try, use, modify and distribute according to the terms of GPL 
      license. 
      The project is hosted on 
      <a class="ulink" href="http://sourceforge.net/projects/lixa/" target="_top">
	<em class="citetitle">SourceForge</em>
      </a>
      collaborative portal and you can use the portal
      to interact with the author and other users.
      LIXA is not supported because it is not a product: you can use it AS IS
      without any guarantee.
    </p><p>
      A projuct is a software artifact that initially was a project financed 
      by a
      customer. Then a second customer was interested in the same software
      artifact and the initial project was selled again. 
      When the third customer knocked the door,
      the team that developed the project started a new business with a new
      <span class="emphasis"><em>product</em></span>, but it should be called 
      <span class="emphasis"><em>projuct</em></span> 
      because it was designed and modeled using the requirements expressed
      by the first customer.
    </p><p>
      In my honest opinion a <span class="emphasis"><em>product</em></span> is a software 
      artifact with some characteristics:
      </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>it is produced by a software factory</p></li><li style="list-style-type: disc"><p>it is sold by a commercial network</p></li><li style="list-style-type: disc"><p>it does have a team of specialists you can 
	    contact to have support</p></li><li style="list-style-type: disc"><p>it does have a team of specialists that can visit and 
	    help you with installation, configuration, problem determination, 
	    etc...</p></li><li style="list-style-type: disc"><p>it is fully documented</p></li><li style="list-style-type: disc"><p>it is certified to run properly on some documented 
	    hardware and software platforms</p></li><li style="list-style-type: disc"><p>it has a certified compatibility matrix the customer
	    can use to find out a valid mix of distinct software components
	    (i.e. different Resource Managers, for an XA Transaction 
	    Manager)</p></li><li style="list-style-type: disc"><p>it can be installed, updated and removed from a system
	    using the standard tool of the platform (i.e. dpkg, rpm, pkg,
	    etc....)</p></li><li style="list-style-type: disc"><p>it can be upgraded to a successive version without
	    side effects for the product and/or the hosting system
	</p></li></ul></div><p>
      </p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>LIXA project is not a product.</p></div><p>
    </p><p>
      If you were running a business that is interested in developing a 
      product based 
      on the technology implemented by the LIXA project you should
      contact the author through       
      <a class="ulink" href="http://sourceforge.net/projects/lixa/" target="_top">
	<em class="citetitle">SourceForge</em>
      </a>
      collaborative portal.
    </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3402789"></a>LIXA and X/OPEN CAE specifications</h2></div></div></div><p>
      The LIXA project tries to be as compliant as possible with the X/Open CAE
      specifications cited in bibliography. Below there are the not implemented
      and/or not implementable features.
    </p><div class="simplesect" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3402799"></a>The commit_return Characteristic</h3></div></div></div><p>
	As explained in [<a class="citation" href="#id3421960"><span class="citation">TXspec</span></a>] (3.4, 3.8.1) two values
	are available:
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="constant">TX_COMMIT_COMPLETED
	    </code></p></li><li style="list-style-type: disc"><p><code class="constant">TX_COMMIT_DECISION_LOGGED
	    </code></p></li></ul></div><p>
	LIXA TX API implementation supports only
	<code class="constant">TX_COMMIT_COMPLETED</code>
	this behavior is allowed by the specification.
      </p></div><div class="simplesect" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3402845"></a>The transaction state element</h3></div></div></div><p>
	As explained in [<a class="citation" href="#id3421960"><span class="citation">TXspec</span></a>] (4.2, page 16)
	<code class="function">tx_info()</code> can return three values:
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="constant">TX_ACTIVE
	    </code></p></li><li style="list-style-type: disc"><p><code class="constant">TX_TIMEOUT_ROLLBACK_ONLY
	    </code></p></li><li style="list-style-type: disc"><p><code class="constant">TX_ROLLBACK_ONLY
	    </code></p></li></ul></div><p>
      </p>
      LIXA <code class="function">tx_info()</code> does not return
      <code class="constant">TX_ROLLBACK_ONLY</code>. This does not hurt the
      X/Open CAE specification.
    </div><div class="simplesect" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3402896"></a>XA -&gt; TX return code mappings</h3></div></div></div><p>
	In [<a class="citation" href="#id3421960"><span class="citation">TXspec</span></a>] (Appendix B.4, page 64) it is suggested
	to return the value <code class="constant">TX_ERROR</code> when the Resource
	Manager returns <code class="constant">XA_RETRY</code>; this is explained in
	â<span class="quote">note 1</span>â. 
      </p><p>
	The LIXA implementation of 
	for <code class="function">tx_commit()</code> and
	<code class="function">tx_rollback()</code> returns 
	<code class="constant">TX_NO_BEGIN</code> instead of 
	<code class="constant">TX_ERROR</code> because it seems a more useful 
	information for the Application Program: the transaction has been
	successfully committed/rolled back, but a new transaction can not be
	started
	<sup>[<a id="id3402944" href="#ftn.id3402944" class="footnote">5</a>]</sup>.
      </p></div><div class="simplesect" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3402964"></a><code class="function">xa_rollback()</code> and 
	<code class="constant">XA_RETRY</code> return code</h3></div></div></div><p>
	In [<a class="citation" href="#id3421960"><span class="citation">TXspec</span></a>] (Appendix B.5, page 69) it is 
	explained <code class="constant">XA_RETRY</code> is a valid return code for
	function <code class="function">xa_rollback()</code>. Unfortunately
	[<a class="citation" href="#id3422020"><span class="citation">XAspec</span></a>] does not agree with this point of view: the
	<code class="constant">XA_RETRY</code> is not a valid return code for 
	function <code class="function">xa_rollback()</code>. It may be an error in
	[<a class="citation" href="#id3421960"><span class="citation">TXspec</span></a>]: the same row could have been copied from 
	the previous table (page 68).
      </p><p>
	[<a class="citation" href="#id3422055"><span class="citation">XA+spec</span></a>] does not list 
	<code class="constant">XA_RETRY</code> as a valid return code for 
	function <code class="function">xa_rollback()</code>; it lists
	<code class="constant">XA_RETRY_COMMFAIL</code> but it does not apply to LIXA
	implementation because it is related to the 
	<span class="emphasis"><em>Communication Resource Manager</em></span> concept that is
	not supported by LIXA implementation.
      </p><p>
	The LIXA implementation sticks to [<a class="citation" href="#id3422020"><span class="citation">XAspec</span></a>]: if a
	resource manager returned <code class="constant">XA_RETRY</code> it would be
	considered a bug inside the resource manager.
      </p></div></div><div class="footnotes"><br /><hr width="100" align="left" /><div class="footnote"><p><sup>[<a id="ftn.id3402503" href="#id3402503" class="para">1</a>] </sup>TXSeries is a registered trademark of 
	  IBM corporation</p></div><div class="footnote"><p><sup>[<a id="ftn.id3402511" href="#id3402511" class="para">2</a>] </sup>Tuxedo is a registered trademark of
	  Oracle corporation</p></div><div class="footnote"><p><sup>[<a id="ftn.id3402519" href="#id3402519" class="para">3</a>] </sup>JBOSS is a registered trademark of Red Hat
	  corporation</p></div><div class="footnote"><p><sup>[<a id="ftn.id3402604" href="#id3402604" class="para">4</a>] </sup>You must wrap the TX C API to be able to use it from Perl, PHP, Python, Ruby...</p></div><div class="footnote"><p><sup>[<a id="ftn.id3402944" href="#id3402944" class="para">5</a>] </sup>The X/Open CAE specification document
	    â<span class="quote">suggests</span>â the mapping and it seems there is some
	    flexibility in the suggestions. From a LIXA perspective all this
	    stuff is academic because <code class="constant">TMNOWAIT</code> is not
	    used by LIXA implementation.</p></div></div></div><div class="chapter" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="Installation"></a>ChapterÂ 2.Â Installation</h2></div></div></div><p>
    This chapter explains how to download, install and verify the software
    released by LIXA project.
  </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3403062"></a>System requirements</h2></div></div></div><p>
      LIXA project is developed on an x86 based 
      <a class="ulink" href="http://www.ubuntu.com/" target="_top">
	<em class="citetitle">Ubuntu 8.04 system</em>
      </a>; it
      compiles and runs on both <span class="emphasis"><em>server</em></span> and
      <span class="emphasis"><em>desktop</em></span> flavors. 
      LIXA project is ported on x86_64 architecture using
      <a class="ulink" href="http://www.ubuntu.com/" target="_top">
	<em class="citetitle">Ubuntu 10.04 system</em>
      </a>.
      Installation on a different GNU/Linux
      distribution should be quite straightforward; installation on a different
      <span class="trademark">UNIX</span>â¢ like system would probably need some work.
    </p><p>
      If you successfully installed LIXA on a different system, you might
      publish your experience on the public forum hosted on SourceForge.net 
      and share your results with other users. 
    </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3403117"></a>Pre-requisites</h3></div></div></div><p>
	To compile LIXA software the GNU tools are needed: gcc, gmake, libtool.
	Autoconf and automake are used, but should not be necessary if you want
	to install the original tarball.
      </p><p>
	Some <span class="emphasis"><em>libraries (run time and development stuff)</em></span> 
	are necessary too:
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="application">libdl</span></p></li><li style="list-style-type: disc"><p><span class="application">libglib</span> (libglib2.0-dev on Ubuntu)</p></li><li style="list-style-type: disc"><p><span class="application">libgmodule</span></p></li><li style="list-style-type: disc"><p><span class="application">libgthread</span></p></li><li style="list-style-type: disc"><p><span class="application">libm</span></p></li><li style="list-style-type: disc"><p><span class="application">libpthread</span></p></li><li style="list-style-type: disc"><p><span class="application">libuuid</span> (uuid-dev on Ubuntu)</p></li><li style="list-style-type: disc"><p><span class="application">libxml2</span> (libxml2-dev on Ubuntu)</p></li></ul></div><p>
	<span class="application">libglib</span> (and others libg*) and 
	<span class="application">libxml2</span> are discovered with 
	<span class="command"><strong>pkg-config</strong></span> command, while the others must be in
	standard include <code class="envar">PATH</code>.
      </p><p>
	<span class="application">xsltproc</span>,
	<span class="application">docbook-xsl</span> and
	<span class="application">docbook-xsl-doc-html</span> are necessary on
	Ubuntu systems to produce this manual.
      </p><p>
	<span class="application">automake</span> and 
	<span class="application">autoconf</span> are 
	necessary to run the test suite (<span class="command"><strong>make check</strong></span>).
      </p><div class="simplesect" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3403242"></a>Low level pre-requisites</h4></div></div></div><p>
	  If you are trying to install LIXA software on a different operating
	  system, these are some fundamental requirements:
	  </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><code class="function">poll</code>: 
		LIXA daemon uses this function for high parallelism network
		operations
	    </p></li><li style="list-style-type: disc"><p><code class="function">mmap</code>:
		LIXA daemon uses this function for high performance disk
		access
	    </p></li><li style="list-style-type: disc"><p><code class="function">dlopen</code>:
		LIXA transaction manager uses this function to dynamically load
		resource managers XA switch structures 
	    </p></li><li style="list-style-type: disc"><p><code class="function">uuid_generate</code>:
		LIXA transaction manager uses this function to generate unique
		transaction identifiers (xid)
	    </p></li></ul></div><p>
	  Without the above functions, a specific porting process is necessary
	  to adapt LIXA to your system.
	</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3403303"></a>Co-requisites</h3></div></div></div><p>
	An XA transaction manager is used to coordinate one or more XA
	resource managers. From a LIXA perspective there are basically 3 type
	of resource managers:
	</p><div class="orderedlist"><ol type="1"><li><p>
	      <span class="emphasis"><em>LIXA:</em></span> resource managers
	      provided by the project for testing and as sample implementations
	  </p></li><li><p>
	      <span class="emphasis"><em>F/OSS:</em></span> resource managers provided by
	      Free/Open Source Software projects
	  </p></li><li><p>
	      <span class="emphasis"><em>Proprietary:</em></span> resource managers
	      provided by business corporations using commercial licensing.
	  </p></li></ol></div><p>
	There is not a list of <span class="emphasis"><em>supported</em></span> third party
	resource managers, because LIXA is a project and not a product; this
	is the list of third party resource managers that have been tested in
	conjuction with LIXA transaction manager:
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="productname">
		IBM DB2 Express-C 9.7 (32 bit)
	  </span></p></li><li style="list-style-type: disc"><p><span class="productname">
		MySQL 5.0 (32 bit) / MySQL 5.1 (64 bit)
	  </span></p></li><li style="list-style-type: disc"><p><span class="productname">
		Oracle XE 10.2 (32 bit) / Oracle XE 11.2 (64 bit)
	  </span></p></li><li style="list-style-type: disc"><p><span class="productname">
		PostgreSQL 8.3 (32 bit) / PostgreSQL 8.4 (64 bit)
	  </span></p></li></ul></div><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3403390"></a>Authorization</h3></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
	The software produced by the LIXA project 
	<span class="emphasis"><em>does</em></span> not require any
	special authorization to run.
      </p></div><p>
	You can run the processes with the desired UNIX user you prefer but
	in this manual specific user and group will be used as a suggestion.
	Use this commands in an Ubuntu based Linux system to create the
	<code class="systemitem">lixa</code> user and the
	<code class="systemitem">lixa</code> group:
	</p><pre class="screen">
tiian@ubuntu:~$ sudo su -
root@ubuntu:~# id
uid=0(root) gid=0(root) groups=0(root)
root@ubuntu:~# addgroup --system lixa
Adding group `lixa' (GID 113) ...
Done.
root@ubuntu:~# adduser --system --ingroup lixa --shell /bin/bash lixa
Adding system user `lixa' (UID 106) ...
Adding new user `lixa' (UID 106) with group `lixa' ...
Creating home directory `/home/lixa' ...
root@ubuntu:~# su -c id lixa
uid=106(lixa) gid=113(lixa) groups=113(lixa)
root@ubuntu:~# exit
logout
	</pre><p>
	Refer to the man page of your Linux distribution if the above
	commands fail; on some distributions you must use
	â<span class="quote"><span class="command"><strong>su -</strong></span></span>â instead of 
	â<span class="quote"><span class="command"><strong>sudo su -</strong></span></span>â.
      </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	  LIXA client communicates to LIXA server (daemon) throught TCP/IP and
	  the client processes do not access the status files located in
	  <code class="filename">/opt/lixa/var/</code>, only the 
	  <span class="command"><strong>lixad</strong></span> has to access the status files.
      </p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3403463"></a>Tested configurations</h2></div></div></div><p>
      A tested configuration is a configuration that passed all the case
      tests.
      This is the list of the tested configurations:
      </p><table xmlns="" frame="all" id="id3403474"><thead><tr><td>Operating system:</td><td>Ubuntu Linux 8.04</td></tr></thead><tbody><tr><td>Architecture:</td><td>x86 (physical)</td></tr><tr><td>Resource Manager:</td><td>IBM DB2 9.7</td></tr><tr><td>Resource Manager:</td><td>MySQL 5.0.51a</td></tr><tr><td>Resource Manager:</td><td>Oracle XE 10.2</td></tr><tr><td>Resource Manager:</td><td>PostgreSQL 8.3</td></tr></tbody></table><p>
      </p><table xmlns="" frame="all" id="id3403534"><thead><tr><td>Operating system:</td><td>Ubuntu Linux 8.04</td></tr></thead><tbody><tr><td>Architecture:</td><td>x86 (virtual)</td></tr><tr><td>Resource Manager:</td><td>IBM DB2 9.7</td></tr><tr><td>Resource Manager:</td><td>MySQL 5.0.51a</td></tr><tr><td>Resource Manager:</td><td>Oracle XE 10.2</td></tr><tr><td>Resource Manager:</td><td>PostgreSQL 8.3</td></tr></tbody></table><p>
      </p><table xmlns="" frame="all" id="id3403592"><thead><tr><td>Operating system:</td><td>Ubuntu Linux 10.04</td></tr></thead><tbody><tr><td>Architecture:</td><td>x86_64 (physical)</td></tr><tr><td>Resource Manager:</td><td>MySQL 5.1.41</td></tr><tr><td>Resource Manager:</td><td>Oracle XE 11.2</td></tr><tr><td>Resource Manager:</td><td>PostgreSQL 8.4</td></tr></tbody></table><p>
    </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3403646"></a>Software download</h2></div></div></div><p>
      The LIXA project is hosted on SourceForge.net portal at this URL:
      <a class="ulink" href="http://sourceforge.net/projects/lixa/" target="_top">
	<em class="citetitle">http://sourceforge.net/projects/lixa/</em>
      </a>
    </p><p>
      The software is available only as a <span class="emphasis"><em>source code</em></span>
      tarball; no
      pre-compiled packages are available: you need the C development tools
      installed to have success in LIXA installation. It is suggested to 
      download the gzipped tarball from the main page: the latest available
      release is generally what you need; you could download a previous release
      if you had a reason to do it.
    </p><p>
      Alternatively you can fetch the source code using a subversion client,
      but you should pay attention that many commits on the subversion 
      repository
      are intermediate works and can give you partial or broken/under
      construction features.
    </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3403692"></a>Configure, build and install</h2></div></div></div><p>
      LIXA project tries to adhere to the GNU <span class="emphasis"><em>de facto</em></span>
      standard. Supposing you downloaded the package 
      <code class="filename">lixa-X.Y.Z.tar.gz</code>, the basic sequence is:
      </p><pre class="screen">
tar xvzf lixa-X.Y.Z.tar.gz
cd lixa-X.Y.Z
./configure
make
      </pre><p>
      To install the software you need 
      <code class="systemitem">root</code> 
      access. With some distributions, 
      like Ubuntu, 
      <code class="systemitem">root</code> 
      access is available with the 
      <span class="command"><strong>sudo</strong></span> command and your own password:
      </p><pre class="screen">
sudo make install
      </pre><p>
      If the previous command does not work,
      <code class="systemitem">root</code> 
      access is available with the
      <span class="command"><strong>su</strong></span> command and the
      <code class="systemitem">root</code> 
      password: 
      </p><pre class="screen">
su; make install; exit
      </pre><p>
      If nothing goes wrong, the above commands install the LIXA software
      artifacts in <code class="filename">/opt/lixa</code> default directory.
      After the installation you should change the authorization
      assigned to some directories. Use <span class="command"><strong>sudo su -c</strong></span> or
      <span class="command"><strong>su -c</strong></span> to gain root privileges and then:
      </p><pre class="screen">
tiian@ubuntu:~$ sudo su -c "chown -R lixa:lixa /opt/lixa/etc/ /opt/lixa/var/"
tiian@ubuntu:~$ ls -la /opt/lixa/etc/ /opt/lixa/var/
/opt/lixa/etc/:
total 16
drwxr-xr-x 2 lixa lixa 4096 2011-03-30 23:13 .
drwxr-xr-x 9 lixa root 4096 2011-03-30 23:14 ..
-rw-r--r-- 1 lixa lixa 3542 2011-03-30 23:13 lixac_conf.xml
-rw-r--r-- 1 lixa lixa  447 2011-03-30 23:13 lixad_conf.xml

/opt/lixa/var/:
total 12
drwxr-xr-x 2 lixa lixa 4096 2011-03-30 23:14 .
drwxr-xr-x 9 lixa root 4096 2011-03-30 23:14 ..
-rw-r--r-- 1 lixa lixa  178 2011-03-30 23:14 README
      </pre><p>
      The succesful execution of the above commands guarantees the
      configuration and the state files can be managed using the
      LIXA administrative account (
      user=<code class="systemitem">lixa</code>,
      group=<code class="systemitem">lixa</code>).
      </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	  The <span class="command"><strong>chown</strong></span> command must be executed after every
	  <span class="command"><strong>make install</strong></span> execution.
      </p></div><p>
    </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3403702"></a>Advanced configuration</h3></div></div></div><p>
	There are many options you can pass to <span class="command"><strong>configure</strong></span>
	command to meet your needs (see below). Skip this section and
	jump directly to
	<a class="xref" href="#Linking_third_party_resource_managers" title="Linking third party resource managers">the section called âLinking third party resource managersâ</a>
	if you are not expert in LIXA configuration to avoid troubles.
      </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3403840"></a>Choosing a different installation <code class="envar">PATH</code></h4></div></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	    The commands explained in the previous section should be
	    adapted to different paths, if you choosed a non standard
	    installation path.
	</p></div><p>
	  Performing the very first install <code class="filename">/tmp</code> 
	  could be a good destination:
	  </p><pre class="screen">
./configure --prefix=/tmp/lixa
	  </pre><p>
	</p><p>
	  After some testing, you might prefer your home directory:
	  </p><pre class="screen">
./configure --prefix=$HOME/lixa
	  </pre><p>
	  and you will get a layout like this:
	  </p><pre class="screen">
$HOME/lixa/bin
$HOME/lixa/etc
$HOME/lixa/include
$HOME/lixa/lib
$HOME/lixa/sbin
$HOME/lixa/var
	  </pre><p>
	</p><p>
	  You can split code and data with something like this:
	  </p><pre class="screen">
./configure --prefix=/ --exec-prefix=/usr/local
	  </pre><p>
	</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3403895"></a>Locating pre-requisites libraries</h4></div></div></div><p>
	  If any of the pre-requisite library include files are not in the
	  standard search <code class="envar">PATH</code>, you can export 
	  <code class="envar">CPPFLAGS</code> before the configure process to add 
	  your custom path:
	  </p><pre class="screen">
export CPPFLAGS=-I/path/to/libuuid
./configure
make
	  </pre><p>
	  to see the list of environment variables that can affect the build 
	  process
	  use the command
	  </p><pre class="screen">
./configure --help
	  </pre><p>
	</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3403928"></a>Optional features</h4></div></div></div><p>
	  The supplied defaults are generally good enought to start 
	  working with LIXA, but if you want to perform some hacking 
	  you might be interested
	  in activating/deactivating some optional features.
	</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="id3403943"></a>Tracing</h5></div></div></div><p>
	    The tracing feature is enabled by default: the binary objects
	    produced by the build procedure contains a lot of messages that can
	    be displayed turning on tracing at run time.
	  </p><p>
	    Removing the tracing feature can save RAM (smaller binary objects)
	    and CPU (every trace message is tested against run time 
	    configuration).
	  </p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
	      Disabling tracing seems a good way to increase the performance of
	      the software, but unfortunately without a trace it is quite 
	      impossible to debug some issues. Only rock stable software can
	      be compiled without tracing, and this is not the case of LIXA.
	    </p></div><p>
	    To disable tracing, use <code class="option">--disable-trace</code> on
	    <span class="command"><strong>./configure</strong></span> command line:
	    </p><pre class="screen">
./configure --disable-trace
	    </pre><p>
	  </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="id3403992"></a>Extra debug code</h5></div></div></div><p>
	    To enable extra debug code, that's basically some redundant check
	    code use <code class="option">--enable-debug</code> on
	    <span class="command"><strong>./configure</strong></span> command line:
	    </p><pre class="screen">
./configure --enable-debug
	    </pre><p>
	    This feature could be interesting when porting the LIXA project
	    software to a different platform; for normal use, the extra
	    debugging code is useless.
	  </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="id3404019"></a>Crash simulation</h5></div></div></div><p>
	    This feature is useful when testing the software: with crash
	    simulation the software can be tested against simulated software
	    crashes and, on some extents, power outages.
	    To enable crash simulation use <code class="option">--enable-crash</code> on
	    <span class="command"><strong>./configure</strong></span> command line:
	    </p><pre class="screen">
./configure --enable-crash
	    </pre><p>
	  </p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="Linking_third_party_resource_managers"></a>Linking third party resource managers</h3></div></div></div><p>
	To link an already tested third party resource manager you can use
	a specific option on <span class="command"><strong>./configure</strong></span> command; to
	link a new resource manager, you have to hack the Makefiles and
	put all you need in place or you can perform a manual link.
      </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3404069"></a>IBM DB2 Express-C 9.7<sup>[<a id="id3404075" href="#ftn.id3404075" class="footnote">6</a>]</sup></h4></div></div></div><p>
	  This step is useful if you want to use IBM DB2 as a Resource
	  Manager coordinated by LIXA; only version Express-C 9.7 has been
	  tested, but there should not be relevant differences with a
	  different version. Use something like this:
	  </p><pre class="screen">
./configure --with-ibmdb2=/opt/ibm/db2/V9.7
	  </pre><p>
	  to create a loadable module containing the switch structure.
	</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3404099"></a>Oracle XE 10.2/11.2<sup>[<a id="id3404104" href="#ftn.id3404104" class="footnote">7</a>]</sup></h4></div></div></div><p>
	  This step is useful if you want to use Oracle Database as a Resource
	  Manager coordinated by LIXA; only version XE 10.2 has been
	  tested, but there should not be relevant differences with a
	  different version. Use something like this for Oracle 10.2
	  (32 bit architecture):
	  </p><pre class="screen">
./configure --with-oracle=/usr/lib/oracle/xe/app/oracle/product/10.2.0/server
	  </pre><p>
	  and something like this for Oracle 11.2 (64 bit architecture):
	  </p><pre class="screen">
./configure --with-oracle=/u01/app/oracle/product/11.2.0/xe
	  </pre><p>
	  to create a loadable module containing the switch structure.
	</p><p>
	  Extra configuration is needed in order to use Oracle DBMS; the
	  necessary steps are documented in the configuration chapter.
	</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3404139"></a>PostgreSQL 8.3/8.4<sup>[<a id="id3404144" href="#ftn.id3404144" class="footnote">8</a>]</sup></h4></div></div></div><p>
	  This step is useful if you want to use PostgreSQL as a Resource
	  Manager coordinated by LIXA; only versions 8.3 and 8.4 have been
	  tested, but there should not be relevant differences with a
	  different version. Use something like this:
	  </p><pre class="screen">
./configure --with-postgresql-include=/usr/include/postgresql --with-postgresql-lib=/usr/lib
	  </pre><p>
	  to create a loadable module containing the switch structure.
	</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	    PostgreSQL does not supply an XA standard switch structure, but
	    only some SQL non standard statements (
	    <code class="code">PREPARE TRANSACTION, COMMIT PREPARED, ROLLBACK PREPARED</code>
	    ) that can be used to implement some XA features.
	    This is good enought to build a loadable module that can be
	    used by the LIXA transaction manager, but some XA standard features
	    - like dynamic registration - can not be implemented.
	</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3404192"></a>MySQL 5.0/5.1<sup>[<a id="id3404196" href="#ftn.id3404196" class="footnote">9</a>]</sup>
	</h4></div></div></div><p>
	  This step is useful if you want to use MySQL as a Resource
	  Manager coordinated by LIXA; only versions 5.0 and 5.1 have been
	  tested, but there should not be relevant differences with a
	  different version. Use something like this:
	  </p><pre class="screen">
./configure --with-mysql
	  </pre><p>
	  to create a loadable module containing the switch structure. It's
	  not necessary to specify the MySQL installation directory because
	  the <span class="command"><strong>mysql_config</strong></span> utility command is used.
	</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	    MySQL does not supply an XA standard switch structure, but
	    only some SQL non standard statements (
	    <code class="code">XA START, XA END, XA PREPARE, XA COMMIT, XA ROLLBACK, 
	      XA RECOVER</code>
	    ) that can be used to implement some XA features.
	    This is good enought to build a loadable module that can be
	    used by the LIXA transaction manager, but some XA standard features
	    - like dynamic registration - can not be implemented.
	</p></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
	    At the time of this writing there is a
	    <a class="ulink" href="http://bugs.mysql.com/bug.php?id=12161" target="_top">
	      seriuos documented bug (# 12161)</a>
	    related to the XA implementation of MySQL. The symptoms perceived
	    while developing LIXA are described below:
	    </p><div class="orderedlist"><ol type="1"><li><p>
		  a MySQL client application invokes XA START
	      </p></li><li><p>
		  it updates some data in the database
	      </p></li><li><p>
		  it invokes XA END and XA PREPARE
	      </p></li><li><p>
		  it crashes and disconnects from the MySQL server 
	      </p></li><li><p>
		  MySQL server rollbacks the transaction and there's no way to
		  see it again using XA RECOVER
	      </p></li></ol></div><p>
	    This behavior violates the XA specification: below there is an 
	    excerpt for <code class="function">xa_prepare</code> from man page (
	    [<a class="citation" href="#id3422020"><span class="citation">XAspec</span></a>], page 44)
	    â<span class="quote">Once this function successfully returns, 
	      the resource manager 
	      must guarantee that the transaction branch may be either 
	      committed or rolled back regardless of failures. A resource 
	      manager cannot erase its knowledge of a branch until the 
	      transaction manager calls either xa_commit() or xa_rollback () 
	      to complete the branch
	    </span>â.
	  </p><p>
	    The impact of this bug is quite severe and seriously compromises
	    the ACID properties of the resulting system (application program
	    + MySQL resource manager + LIXA transaction manager).
	  </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3404323"></a>Two or more resource managers</h4></div></div></div><p>
	  If you want to use two or more resource managers, and this is a
	  typical condition for the XA usage, you must concatenate two or more
	  <em class="parameter"><code>--with-</code></em> parameters.
	  This command, for instance, can be used to build IBM DB2, Oracle
	  and PostgreSQL loadable modules:
	  </p><pre class="screen">
./configure --with-ibmdb2=/opt/ibm/db2/V9.7 \
&gt; --with-oracle=/usr/lib/oracle/xe/app/oracle/product/10.2.0/server \
&gt; --with-postgresql-include=/usr/include/postgresql --with-postgresql-lib=/usr/lib \
&gt; --with-mysql
	  </pre><p>
	</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3404349"></a>Summary</h3></div></div></div><p>
	The options illustrated above can be combined to obtain a specific
	configuration. This is an example of a IBM DB2 + Oracle enabled
	installation using an alternate installation path:
	</p><pre class="screen">
tar xvzf lixa-X.Y.Z.tar.gz
cd lixa-X.Y.Z
./configure --prefix=$HOME/lixa --with-ibmdb2=/opt/ibm/db2/V9.7 --with-oracle=/usr/lib/oracle/xe/app/oracle/product/10.2.0/server
make
sudo make install
	</pre><p>
      </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3404371"></a>Checking</h2></div></div></div><p>
      Before using LIXA to manage your transactions you might be interested
      in checking the compiled software quality.
    </p><p>
      LIXA has its own test suite implemented with 
      <span class="application">Autotest</span>. A specific build configuration is
      <span class="emphasis"><em>necessary</em></span> to enable all the tests:
      </p><pre class="screen">
tar xvzf lixa-X.Y.Z.tar.gz
cd lixa-X.Y.Z
./configure --prefix=/tmp/lixa --enable-crash
make check
      </pre><p>
      If the binary code produced by the compiler is fine, and your system
      is fine too, all the test <span class="emphasis"><em>must</em></span> complete without
      errors.
    </p></div><div class="footnotes"><br /><hr width="100" align="left" /><div class="footnote"><p><sup>[<a id="ftn.id3404075" href="#id3404075" class="para">6</a>] </sup>
	      IBM and DB2 are trademark of <span class="trademark">IBM</span>â¢
	      corporation
	</p></div><div class="footnote"><p><sup>[<a id="ftn.id3404104" href="#id3404104" class="para">7</a>] </sup>
	      Oracle is a trademark of <span class="trademark">Oracle</span>â¢
	      corporation
	</p></div><div class="footnote"><p><sup>[<a id="ftn.id3404144" href="#id3404144" class="para">8</a>] </sup>
	      The Trademark Policy of PostgreSQL is available at this link:
	      <a class="ulink" href="http://wiki.postgresql.org/wiki/Trademark_Policy" target="_top">
		http://wiki.postgresql.org/wiki/Trademark_Policy</a>
	</p></div><div class="footnote"><p><sup>[<a id="ftn.id3404196" href="#id3404196" class="para">9</a>] </sup>
	      MySQL is a trademark of <span class="trademark">Oracle</span>â¢ 
	      corporation; details are available at this link:
	      <a class="ulink" href="http://www.mysql.com/about/legal/" target="_top">
		http://www.mysql.com/about/legal/</a>
	  </p></div></div></div><div class="chapter" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="Configuration"></a>ChapterÂ 3.Â Configuration</h2></div></div></div><p>
    A LIXA system is the assembling of two components: the client and 
    the server. The figure
    below shows a typical configuration with one Application
    Program and two Resource Managers.
  </p><div class="figure"><a id="config1"></a><p class="title"><b>FigureÂ 3.1.Â Typical LIXA topology</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Configuration_1.png" alt="Typical LIXA topology" /></div></div></div><br class="figure-break" /><p>
    The model shows logical and "phisycal" blocks:
    </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	  "Application Program code" is the code of your own application
      </p></li><li style="list-style-type: disc"><p>
	  "librm1" is the code of the library your application must use to
	  communicate with "RM1" (the first resource manager)
      </p></li><li style="list-style-type: disc"><p>
	  "librm2" is the code of the library your application must use to
	  communicate with "RM2" (the second resource manager)
      </p></li><li style="list-style-type: disc"><p>
	  "liblixac" is the code of the library your application must use to
	  invoke the TX verbs and send instruction to the Transaction Manager
      </p></li><li style="list-style-type: disc"><p>
	  "Application Program code" + "librm1" + "librm2" + "liblixac" must
	  be linked togheter to produce the Application Program; the
	  Application Program is an executable object
      </p></li><li style="list-style-type: disc"><p>
	  "RM1" is the first resource manager; it may be a relational database
	  (RDBMS)
      </p></li><li style="list-style-type: disc"><p>
	  "RM2" is the second resource manager; it may be an object oriented
	  database (OODBMS)
      </p></li><li style="list-style-type: disc"><p>
	  "lixad" is the <span class="emphasis"><em>daemon</em></span> used by "liblixac" to
	  store the states of the transactions
      </p></li></ul></div><p>
  </p><p>
    The model shows how the blocks communicate:
    </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	  (A1): is the protocol supplied by the first resource manager; 
	  SQL/CLI is an example and is supplied by IBM DB2, 
	  SQL/OCI is another example and is supplied by Oracle Database Server
      </p></li><li style="list-style-type: disc"><p>
	  (B1): is the protocol supplied by the second resource manager; every
	  resource manager has its own protocol and its own API
      </p></li><li style="list-style-type: disc"><p>
	  (A2): is the internal protocol used by the client of RM1 to 
	  communicate with RM1 server process(es); it can be a cross memory
	  or a network protocol and it depends on RM1 configuration
      </p></li><li style="list-style-type: disc"><p>
	  (B2): is the internal protocol used by the client of RM2 to 
	  communicate with RM2 server process(es); it can be a cross memory
	  or a network protocol and it depends on RM2 configuration
      </p></li><li style="list-style-type: disc"><p>
	  (TX): is the protocol supplied by the LIXA project and is described
	  in [<a class="citation" href="#id3421960"><span class="citation">TXspec</span></a>]; it's a standard protocol and API
      </p></li><li style="list-style-type: disc"><p>
	  (XA): is the standard protocol used by the LIXA project to 
	  communicateand with the resource managers and is described
	  in [<a class="citation" href="#id3422020"><span class="citation">XAspec</span></a>]; it's a standard protocol and API
      </p></li><li style="list-style-type: disc"><p>
	  (LX): is the internal protocol used by the client of LIXA to 
	  communicate with the LIXA server process (lixad); it is a network 
	  protocol
      </p></li></ul></div><p>
  </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3404585"></a>Architectural elements</h2></div></div></div><p>
      The <span class="command"><strong>lixad</strong></span> daemon process can be executed on any
      system: there is no need it is executed on the same system that's hosting
      the Application Programs. The communications between 
      the client and the server (<span class="command"><strong>lixad</strong></span>) uses TCP/IP sockets.
    </p><p>
      The <code class="systemitem">lixac</code> library is 
      embedded in the Application
      Programs; the communication between the Application Program and
      the <code class="systemitem">lixac</code> library uses 
      TX (Transaction Demarcation)
      API, see [<a class="citation" href="#id3421960"><span class="citation">TXspec</span></a>]. 
      The <code class="systemitem">lixac</code> 
      library contains all the logic of the LIXA Transaction Manager.
    </p><p>
      The communication between the Application Program and the Resource
      Managers depends on Resource Managers type and configuration: 
      it may be cross memory, TCP/IP, System V IPC, etc...
      The communication between the 
      <code class="systemitem">lixac</code> library and the
      Resource Manager depends on Resource Manager configuration and must be
      of the same used by the Application Program.
    </p><p>
      The communication between 
      <code class="systemitem">lixac</code> library and 
      <span class="command"><strong>lixad</strong></span> is ever istantiated by the client: the
      server never calls the clients.
    </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3404669"></a>Deployment models</h3></div></div></div><p>
	This section explains some different deployment models you can
	set up leveraging the LIXA project technology.
      </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3404681"></a>The easiest non trivial model</h4></div></div></div><p>
	  The easiest non trivial deployment of a distributed transaction
	  processing system based on the LIXA project is showed below: a single
	  node hosts the Application Program, the Resource Managers and the
	  LIXA server.
	</p><div class="figure"><a id="config2"></a><p class="title"><b>FigureÂ 3.2.Â Easiest non trivial deployment model</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Configuration_2.png" alt="Easiest non trivial deployment model" /></div></div></div><br class="figure-break" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3404721"></a>A trivial model</h4></div></div></div><p>
	  A trivial deployment of a distributed transaction
	  processing system based on the LIXA project is showed below: a single
	  node hosts the Application Program, the Resource Manager and the
	  LIXA server. This configuration is obtained from the previous one
	  removing a Resource Manager.
	</p><p>
	  Using only one Resource Manager is supported by the LIXA project
	  technology, but it's quite useless because you don't need a
	  transaction manager to perform 
	  <span class="emphasis"><em>single phase commit</em></span> against 
	  <span class="emphasis"><em>one</em></span>
	  Resource Manager. This type of configuration will not be described
	  more deeply.
	</p><div class="figure"><a id="config3"></a><p class="title"><b>FigureÂ 3.3.Â Trivial deployment model</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Configuration_3.png" alt="Trivial deployment model" /></div></div></div><br class="figure-break" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3404761"></a>A fully distributed model</h4></div></div></div><p>
	  A fully distributed transaction processing system can be achieved
	  hosting every component in a different node.
	  The picture below shows 4 different nodes:
	  </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
		an application server node hosting the Application Program
	    </p></li><li style="list-style-type: disc"><p>
		a Transaction Manager dedicated node hosting the 
		LIXA server
	    </p></li><li style="list-style-type: disc"><p>
		two Resource Manager dedicated nodes hosting the
		Reosurce Manager
	    </p></li></ul></div><p>
	</p><div class="figure"><a id="config4"></a><p class="title"><b>FigureÂ 3.4.Â Fully distributed deployment model</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Configuration_4.png" alt="Fully distributed deployment model" /></div></div></div><br class="figure-break" /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3404835"></a>A more complex distributed model</h4></div></div></div><p>
	  A more complex distributed transaction processing system 
	  can be achieved introducing a second application server and a third
	  Resource Manager; in the picture below the third Resource Manager 
	  is hosted in the same node of the second Resource Manager.
	</p><p>
	  The two different Application Programs do not need to be hosted in
	  different application servers. They are different 
	  Application Programs because they use a different mix of
	  Resource Managers.
	</p><div class="figure"><a id="config5"></a><p class="title"><b>FigureÂ 3.5.Â Complex distributed deployment model</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Configuration_5.png" alt="Complex distributed deployment model" /></div></div></div><br class="figure-break" /><p>
	  Further complexity can be reached introducing an Application
	  Program that uses three (or more) different Resource Managers,
	  but this document will not go on this path to preserve
	  understandability
	  <sup>[<a id="id3404856" href="#ftn.id3404856" class="footnote">10</a>]</sup>
	  .
	</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3404894"></a>Configuring LIXA components</h2></div></div></div><p>
      The picture below emphasizes the LIXA components must be configured
      in a simple scenario:
    </p><div class="figure"><a id="config6"></a><p class="title"><b>FigureÂ 3.6.Â The LIXA components and the necessary configuration files</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Configuration_6.png" alt="The LIXA components and the necessary configuration files" /></div></div></div><br class="figure-break" /><p>
      The client component (<code class="systemitem">lixac</code>) 
      is configured using the
      <code class="filename">etc/lixac_conf.xml</code> file; the server component
      (<span class="command"><strong>lixad</strong></span>) is configured using the
      <code class="filename">etc/lixad_conf.xml</code> file
      <sup>[<a id="id3404951" href="#ftn.id3404951" class="footnote">11</a>]</sup>.
    </p><p>
      If a node hosts both the client and the server components, both the
      files must be configured. If a node hosts only one component, only
      one configuration file is necessary
      <sup>[<a id="id3404975" href="#ftn.id3404975" class="footnote">12</a>]</sup>.
    </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3404961"></a>Configuring the server</h3></div></div></div><p>
	The default configuration file is 
	<code class="filename">etc/lixad_conf.xml</code>
	and is located at the root installation path (i.e.
	<code class="filename">/opt/lixa/etc/lixad_conf.xml</code>).
      </p><p>
	The file is composed of three sections:
	</p><div class="figure"><a id="config7"></a><p class="title"><b>FigureÂ 3.7.Â The structure of lixad_conf.xml</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Configuration_7.png" alt="The structure of lixad_conf.xml" /></div></div></div><p><br class="figure-break" />
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	      the <span class="emphasis"><em>server</em></span> section contains the global
	      parameters of the server
	  </p></li><li style="list-style-type: disc"><p>
	      the <span class="emphasis"><em>listeners</em></span> section specifies how many
	      TCP/IP addresses and ports must be listened to accept incoming
	      client connections
	  </p></li><li style="list-style-type: disc"><p>
	      the <span class="emphasis"><em>managers</em></span> section specifies how many
	      parallel threads must be activated to serve the LIXA clients
	  </p></li></ul></div><p>
      </p><p>
	Below there is a sample configuration file:
	</p><pre class="screen">
&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
  &lt;server pid_file="/opt/lixa/var/run.pid"&gt;
  &lt;listeners&gt;
    &lt;listener domain="AF_INET" address="127.0.0.1" port="3456"/&gt;
    &lt;listener domain="AF_INET" address="0.0.0.0" port="2345"/&gt;
  &lt;/listeners&gt;
  &lt;managers&gt;
    &lt;manager status_file="/opt/lixa/var/lixad_status1"/&gt;
    &lt;manager status_file="/opt/lixa/var/lixad_status2"/&gt;
    &lt;manager status_file="/opt/lixa/var/lixad_status3"/&gt;
  &lt;/managers&gt;
&lt;/server&gt;
      </pre><p>
	The tags and the
	properties of the XML file are described below:
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	      <code class="varname">pid_file</code>: it is the file used by the server 
	      to store the daemon <acronym class="acronym">PID</acronym>; the server creates
	      the file at start-up and destroys it at shutdown
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="varname">listener</code>: the server can activate one or more
	      listeners; most of the times one listener is sufficient, but if
	      you want to use only a subset of the IP addresses defined at
	      the operating system level, you have to configure a dedicated
	      listener for every desired address
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="varname">domain</code>: the type of socket must be used to
	      listen for clients. The only allowed type is 
	      <code class="constant">AF_INET</code>; this may change in the future
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="varname">address</code>: the address that must be used 
	      to listen for
	      clients; the special value "<code class="constant">0.0.0.0</code>" means
	      <span class="emphasis"><em>any</em></span> address
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="varname">port</code>: the port that must be used to listen for
	      clients; it must be a free port (use command 
	      <span class="command"><strong>netstat</strong></span> to find out one)
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="varname">manager</code>: any configured 
	      <span class="emphasis"><em>manager</em></span> is a server worker and runs as
	      a dedicated thread. The number of managers that should 
	      be activated 
	      depends on the workload; if D is the number of indipendent 
	      hard disk devices and P is the number of processors/cores, the
	      suggested values are in the range:
	      </p><div class="equation"><a id="id3405180"></a><p class="title"><b>EquationÂ 3.1.Â Suggested range for the number of managers</b></p><div class="equation-contents"><span class="mathphrase">
		  [min(D,P) ; D*P]
		</span></div></div><p><br class="equation-break" />
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="varname">status_file</code>: the physical path that 
	      must be used to
	      create the status files (a couple) for a manager; 
	      this generally is
	      a persistent and reliable storage device like a RAID partition.
	      The string specified by the tag <code class="varname">status_file</code>
	      is used as a prefix: every manager (thread) creates two files
	      with the same prefix and different suffix.
	  </p></li></ul></div><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3405213"></a>Configuring the client</h3></div></div></div><p>
	The default configuration file is 
	<code class="filename">etc/lixac_conf.xml</code>
	and is located at the root installation path (i.e.
	<code class="filename">/opt/lixa/etc/lixac_conf.xml</code>). 
      </p><p>
	The file is composed of three sections:
	</p><div class="figure"><a id="config8"></a><p class="title"><b>FigureÂ 3.8.Â The structure of lixac_conf.xml</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Configuration_8.png" alt="The structure of lixac_conf.xml" /></div></div></div><p><br class="figure-break" />
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	      the <span class="emphasis"><em>state servers</em></span> section 
	      contains a list of the available LIXA state servers and how they
	      can be contacted
	  </p></li><li style="list-style-type: disc"><p>
	      the <span class="emphasis"><em>resource managers</em></span> section
	      contains a list of the available Resource Managers and how they
	      can be managed by LIXA using XA standard API and protocol
	  </p></li><li style="list-style-type: disc"><p>
	      the <span class="emphasis"><em>profiles</em></span> section
	      contains a set of possibly different profiles: every
	      Application Program can use only one profile; if you had
	      different Application Programs with different requirements,
	      you should create different profiles. Every profile contains
	      a set of servers and a set of Resource Managers that must be
	      used to support the Application Program.
	  </p></li></ul></div><p>
      </p><p>
	Below there is a sample configuration file:
	</p><pre class="screen">
&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;client&gt;
  &lt;sttsrvs&gt;
    &lt;sttsrv name="server1" domain="AF_INET" address="10.23.45.67" port="2345" /&gt;
    &lt;sttsrv name="server2" domain="AF_INET" address="10.23.46.91" port="3456" /&gt;
  &lt;/sttsrvs&gt;
  &lt;rsrmgrs&gt;
    &lt;rsrmgr name="OracleXE_dynreg" switch_file="/opt/lixa/lib/switch_oracle_dynreg.so" xa_open_info="Oracle_XA+Acc=P/hr/hr+SesTm=30+LogDir=/tmp+threads=true+DbgFl=7+Loose_Coupling=true" xa_close_info="" /&gt;
    &lt;rsrmgr name="OracleXE_stareg" switch_file="/opt/lixa/lib/switch_oracle_stareg.so" xa_open_info="Oracle_XA+Acc=P/hr/hr+SesTm=30+LogDir=/tmp+threads=true+DbgFl=7+Loose_Coupling=true" xa_close_info="" /&gt;
    &lt;rsrmgr name="IBMDB2_dynreg" switch_file="/opt/lixa/lib/switch_ibmdb2_dynreg.so" xa_open_info="axlib=/opt/lixa/lib/liblixac.so,db=sample,tpm=lixa" xa_close_info="" /&gt;
    &lt;rsrmgr name="IBMDB2_stareg" switch_file="/opt/lixa/lib/switch_ibmdb2_stareg.so" xa_open_info="axlib=/opt/lixa/lib/liblixac.so,db=sample,tpm=lixa" xa_close_info="" /&gt;
  &lt;/rsrmgrs&gt;
  &lt;profiles&gt;
    &lt;profile name="GT71"&gt;
      &lt;sttsrvs&gt;
        &lt;sttsrv&gt;local_1&lt;/sttsrv&gt;
      &lt;/sttsrvs&gt;
      &lt;rsrmgrs&gt;
        &lt;rsrmgr&gt;OracleXE_stareg&lt;/rsrmgr&gt;
        &lt;rsrmgr&gt;IBMDB2_stareg&lt;/rsrmgr&gt;
      &lt;/rsrmgrs&gt;
    &lt;/profile&gt;
    &lt;profile name="VZ67"&gt;
      &lt;sttsrvs&gt;
        &lt;sttsrv&gt;local_1&lt;/sttsrv&gt;
      &lt;/sttsrvs&gt;
      &lt;rsrmgrs&gt;
        &lt;rsrmgr&gt;OracleXE_dynreg&lt;/rsrmgr&gt;
        &lt;rsrmgr&gt;IBMDB2_dynreg&lt;/rsrmgr&gt;
      &lt;/rsrmgrs&gt;
    &lt;/profile&gt;
    &lt;profile name="AG71"&gt;
      &lt;sttsrvs&gt;
        &lt;sttsrv&gt;local_2&lt;/sttsrv&gt;
      &lt;/sttsrvs&gt;
      &lt;rsrmgrs&gt;
        &lt;rsrmgr&gt;IBMDB2_dynreg&lt;/rsrmgr&gt;
      &lt;/rsrmgrs&gt;
    &lt;/profile&gt;
  &lt;/profiles&gt;
&lt;/client&gt;
	</pre><p>
	The tags and the
	properties of the XML file are described below:
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	      <code class="varname">sttsrv</code>: this section is used to describe a
	      state server (a LIXA server instance) that must be reached by any
	      client described below
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="varname">sttsrv/name</code>: a name associated to the 
	      state server; it is a logical name that is referenced by 
	      the profiles defined below
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="varname">domain</code>: it must be the same domain specified 
	      by the listener that must be reached; the listener is configured
	      in <code class="filename">lixad_conf.xml</code> (see above) and may be
	      local or remote
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="varname">address</code>: it must be the same same address 
	      specified by the listener that must be reached; the listener is
	      configured in <code class="filename">lixad_conf.xml</code> (see above)
	      and may be local or remote
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="varname">port</code>: it must be the same port specified
	      by the listener that must be reached; the listener is
	      configured in
	      <code class="filename">lixad_conf.xml</code> (see above)
	      and may be local or remote
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="varname">rsrmgr</code>: this section is used to describe 
	      a resource manager that will be used by the
	      Application Programs configured below (see profiles)
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="varname">rsrmgr/name</code>: a name associated to the 
	      Resource Manager; it is a logical name that is referenced by
	      the profile defined below
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="varname">switch_file</code>: name of the file that contains 
	      the XA switch structure; the file is produced by the installation
	      procedure
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="varname">xa_open_info</code>: it is the string of parameters
	      that must be passed to the Resource Manager by the xa_open() 
	      function call; the content
	      of the string depends on the Resource Manager, please refer to
	      the documentation distributed with the resource manager you
	      are using. The string can not exceed 255 characters
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="varname">xa_close_info</code>: it is the string of parameters
	      that must be passed to the Resource Manager by the xa_open() 
	      function call; the content
	      of the string depends on the Resource Manager, please refer to
	      the documentation distributed with the resource manager you
	      are using. The string can not exceed 255 characters
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="varname">profile</code>: it contains the description of the
	      LIXA every transactional profile must be
	      used by the Application Programs needs to be listed here
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="varname">profile/name</code>: the name associated to the
	      transaction profile; this name is used in different places and
	      it is suggested to avoid special characters, blanks and possibly
	      mixed case (these hints may help you in troubleshooting)
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="varname">profile/sttsrv</code>: the state server that
	      will be used to store
	      the transactional information associated to this profile; more
	      than one state servers can be specified but 
	      <span class="emphasis"><em>only</em></span> 
	      the first one is used with the current release software
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="varname">profile/rsrmgr</code>: every Resource Manager that
	      must be
	      used by the Application Programs associated to this transactional
	      profile needs to be listed here. There is no a limit: you can
	      specify 1, 2, 3, ... resource managers. Avoid useless resource
	      manager because xa_open() and xa_close() will be performed 
	      against all the listed resource managers. If you can choose 
	      between a "dynamic" and a "static" version of the same resource
	      manager, the "dynamic" one is more efficient	    
	  </p></li></ul></div><p>
      </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="Client_configuration_explanation"></a>Client configuration explanation</h4></div></div></div><p>
	  The client configuration file contains three sections:
	  </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
		<code class="varname">sttsrvs</code>: is the list of the LIXA daemons 
		you are
		running inside your network and you will use to manage the
		persistent state of the clients that are using the
		configuration
		file; many times a single LIXA state server is sufficient, but
		sometimes you need more (development, test and production
		environment might use different LIXA servers)
	    </p></li><li style="list-style-type: disc"><p>
		<code class="varname">rsrmgrs</code>: the list of the Resource Managers
		necessary execute the Application Programs; there is no limit
		to the number of resource managers you can specify from a LIXA
		point of view, but you should avoid to list useless 
		Resource Managers to obtain the best performance
	    </p></li><li style="list-style-type: disc"><p>
		<code class="varname">profiles</code>: the list of the available
		transactional profiles for your Application Programs. This
		concept allows you a great configuration flexibility: the same
		configuration file can be used for completely different
		Application Programs and completely different environment.
		As an example, imagine you have 3 distinct applications and
		every application uses a different mix of resource managers; 
		then
		you manage 3 different environments (development, test and
		production): with 9 profiles you can model your
		transactional needs completely 
		(APP1DEV, APP2DEV, APP3DEV, APP1TEST,
		APP2TEST, APP3TEST, APP1PROD, APP2PROD, APP3PROD).
	    </p></li></ul></div><p>
	</p><p>
	  The picture below models an environment that's using the sample
	  <code class="filename">etc/lixac_conf.xml</code>
	  showed above:
	  </p><div class="figure"><a id="config9"></a><p class="title"><b>FigureÂ 3.9.Â A "real" environment</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Configuration_9.png" alt="A &quot;real&quot; environment" /></div></div></div><p><br class="figure-break" />
	  The scenario is composed of three distinct applications:
	  </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
		GT71: it's an application that uses both an Oracle and an
		IBM DB2 DBMS; most of the transactions need to perform
		distributed transaction processing and the profile specifies
		the static registration versions of the switch files.
	    </p></li><li style="list-style-type: disc"><p>
		AG71: it's an application that uses only an
		IBM DB2 DBMS; only few transactions need to perform
		distributed transaction processing and the profile specifies
		the dynamic registration versions of the switch files. This
		application does not need an XA Transaction Manager because
		it uses only one Resource Manager, but the development team
		decided to use LIXA because it will use a second Resource
		Manager in the next few months.
	    </p></li><li style="list-style-type: disc"><p>
		VZ67: it's an application that uses both an Oracle and an
		IBM DB2 DBMS; only few transactions need to perform
		distributed transaction processing and the profile specifies
		the dynamic registration versions of the switch files.
	    </p></li></ul></div><p>
	  The scenario uses two distinct LIXA state servers: this is an
	  unusual situation but it works.
	</p><p>
	  The <code class="varname">LIXA_PROFILE</code> environment variable must be used 
	  to specify the transactional profile associated to the Application 
	  Program.
	  If you do not specify a valid transactional profile, 
	  the first profile
	  of the list will be applied (in the above example it's
	  <code class="varname">GT71</code>).
	  </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	      There is not an alternate way to specify the 
	      transactional profile:
	      <code class="function">tx_open</code> does not allow parameters.
	  </p></div><p>
	  With reference to scenario showed above, Application Program GT71
	  must export <code class="varname">LIXA_PROFILE</code> before execution; if
	  you are using <span class="command"><strong>bash</strong></span> shell you must specifiy
	  something like this
	  </p><pre class="screen">
export LIXA_PROFILE=GT71
	  </pre><p>
	  before application execution. The same applies to Application Program
	  AG71 and VZ67:
	  </p><pre class="screen">
export LIXA_PROFILE=AG71
[...]
export LIXA_PROFILE=VZ67
	  </pre><p>
	</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3405712"></a>Environment variables</h2></div></div></div><p>
      You can use some environment variables to tailor the LIXA configuration
      to your needs. Some environment variables applies only to one component,
      others apply to both client and server LIXA components.
    </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3405727"></a>LIXA_CONFIG_FILE</h3></div></div></div><p>
	  This environment variable can be used to specify an alternate
	  configuration file for your application. 
	  Example: if you are trying a new configuration, but you 
	  wont to modify the default
	  <code class="filename">etc/lixac_conf.xml</code>
	  file, you can export the variable before program execution:
	  </p><pre class="screen">
export LIXA_CONFIG_FILE=/tmp/my_lixac
./myapp
	  </pre><p>
	  <span class="command"><strong>myapp</strong></span> will be executed using the configuration
	  stored inside
	  <code class="filename">/tmp/my_lixac</code>
	  instead of the configuration stored inside the default
	  <code class="filename">etc/lixac_conf.xml</code>
	  client configuration file.
	</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3405764"></a>LIXA_CRASH_COUNT</h3></div></div></div><p>
	  This environment variable must be used only in a development
	  environment: after the program crossed the
	  <span class="emphasis"><em>crash point</em></span> as many times as the value of
	  this variable (default = 1), the process crashes. See
	  environemt variable
	  <code class="varname">LIXA_CRASH_POINT</code> too.
	</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3405786"></a>LIXA_CRASH_POINT</h3></div></div></div><p>
	  This environment variable must be used only in a development
	  environment: it specifies the crash point inside the LIXA
	  code. The acceptable values for this variable are listed
	  inside the C header file
	  <code class="filename">src/common/lixa_crash.h</code>
	  LIXA project uses 
	  the <code class="function">abort()</code> function to simulated a soft
	  crash.
	</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3405811"></a>LIXA_JOB</h3></div></div></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
	      This environment variable may be very useful to deal with some
	      specific requirements, but it changes how the automatic
	      recovery process works and the final result could be strange
	      or "unpredictable" if you didn't understand the whole picture.
	  </p></div><p>
	  Use this environment variable to associate a specific transactional
	  job identifier instead of the automatically assigned one. 
	  See <a class="xref" href="#Automatic_recovery_concepts" title="Automatic recovery concepts">the section called âAutomatic recovery conceptsâ</a> and
	  <a class="xref" href="#Workload_balanced_environments" title="Workload balanced environments">the section called âWorkload balanced environmentsâ</a> 
	  for more information.
	</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3405845"></a>LIXA_PROFILE</h3></div></div></div><p>
	  This environment variable must be used 
	  to specify the transactional profile associated to the Application 
	  Program.
	  If you do not specify a valid transactional profile, the first
	  profile listed inside 
	  <code class="filename">etc/lixac_conf.xml</code>
	  will be applied.
	  See <a class="xref" href="#Client_configuration_explanation" title="Client configuration explanation">the section called âClient configuration explanationâ</a> too.
	</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3405878"></a>LIXA_TRACE_MASK</h3></div></div></div><p>
	  This environment variable specifies which internal modules must
	  be traced at run-time. 
	  The C header file
	  <code class="filename">src/common/lixa_trace.h</code>
	  contains the exadecimal value of every internal module; if you 
	  want to trace two or more modules you have make the logical OR
	  among all the desired values.
	</p><p>
	  Supposing you are interested in tracing what happens inside 
	  <span class="emphasis"><em>"server listener"</em></span>,
	  <span class="emphasis"><em>"server manager"</em></span> and
	  <span class="emphasis"><em>"server status"</em></span> modules.
	  Looking at file
	  <code class="filename">src/common/lixa_trace.h</code>:
	  </p><pre class="screen">
#define LIXA_TRACE_MOD_SERVER_LISTENER    0x00000004
#define LIXA_TRACE_MOD_SERVER_MANAGER     0x00000008
#define LIXA_TRACE_MOD_SERVER_STATUS      0x00000010
	  </pre><p>
	  the resulting value is 0x0000001C:
	  </p><pre class="screen">
export LIXA_TRACE_MASK=0x00000010
	  </pre><p>
	  The <span class="emphasis"><em>"trace all"</em></span> value is 0xffffffff:
	  </p><pre class="screen">
export LIXA_TRACE_MASK=0xffffffff
	  </pre><p>
	  </p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
	      Tracing too much is dangerous: it slows down your system and
	      possibly fills-up your filesystems.
	  </p></div><p>
	  Establishing the internal modules that must be traced is a typical
	  troubleshooting task you can acquire working with LIXA project.
	  In <a class="xref" href="#Tracing" title="Tracing">the section called âTracingâ</a> you can discover some useful information
	  related to the usage of this environment variable.
	</p></div></div><div class="footnotes"><br /><hr width="100" align="left" /><div class="footnote"><p><sup>[<a id="ftn.id3404856" href="#id3404856" class="para">10</a>] </sup>
	      The dashed box named "Transaction Manager" was removed to
	      simplify the picture.
	  </p></div><div class="footnote"><p><sup>[<a id="ftn.id3404951" href="#id3404951" class="para">11</a>] </sup>
	  Both the files reside in <code class="filename">/opt/lixa/etc/</code>
	  directory and must be managed by
	  <code class="systemitem">lixa</code> user, the
	  LIXA administrative user
      </p></div><div class="footnote"><p><sup>[<a id="ftn.id3404975" href="#id3404975" class="para">12</a>] </sup>
	  The standard installation procedure installs both the files with
	  default content; it's your responsability to customize the content
	  of the files.
      </p></div></div></div><div class="chapter" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="id3405944"></a>ChapterÂ 4.Â Execution</h2></div></div></div><p>
    Once you have installed (see <a class="xref" href="#Installation" title="ChapterÂ 2.Â Installation">ChapterÂ 2, <i>Installation</i></a>)
    and configured (see <a class="xref" href="#Configuration" title="ChapterÂ 3.Â Configuration">ChapterÂ 3, <i>Configuration</i></a>)
    your environment, you are ready to run LIXA.
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	In this chapter it is assumed you installed the LIXA project
	software at the default path <code class="filename">/opt/lixa</code>; if you
	installed the software at a different path, you'd need to adjust
	the shown commands consequently.
    </p></div><p>
  </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3405980"></a>Starting the state server</h2></div></div></div><p>
      The first step you must perform is starting the
      <span class="emphasis"><em>state server</em></span>; it's name is 
      <span class="command"><strong>lixad</strong></span> (LIXA daemon). The command
    </p><pre class="screen">
tiian@ubuntu:~$ /opt/lixa/sbin/lixad --help
Usage:
  lixad [OPTION...] - LIXA server

Help Options:
  -?, --help             Show help options

Application Options:
  -d, --daemon           Run the process as a daemon
  -m, --maintenance      Start the server in maintenance mode only
  -u, --dump             Dump the content of status files using order [ufs] (u=used, f=free, s=sequential)
  -c, --config-file      Specify an alternate configuration file
  -t, --trace-file       Specify trace file name
  -l, --clean-failed     Clean recovery failed transactions at start-up
  -v, --version          Print package info and exit
    </pre><p>
      displays the available command line options. 
    </p><p>
      If you tried to start the state server without the appropriate 
      privileges it should happen something like this:
      </p><pre class="screen">
tiian@ubuntu:~$ /opt/lixa/sbin/lixad
tiian@ubuntu:~$ sudo su -c "tail /var/log/daemon.log"
[...]
Mar 31 22:53:10 ubuntu lixad[5891]: LXD000N this process is starting a new LIXA server (lixa package version is 0.5.29)
Mar 31 22:53:10 ubuntu lixad[5891]: LXD015W unable to open pid file '/opt/lixa/var/run.pid'
Mar 31 22:53:10 ubuntu lixad[5891]: LXD004E error (ERROR: 'open' function returned an error condition) while starting manager(s), premature exit
      </pre><p>
      because the process is not able to update the content of the
      <code class="filename">/opt/lixa/var/</code> directory; use the administrative
      user and try again:
      </p><pre class="screen">
tiian@ubuntu:~$ sudo su - lixa
[sudo] password for tiian:
lixa@ubuntu:~$ /opt/lixa/sbin/lixad
      </pre><p>
      Running the command
      without options blocks your shell and runs the state server in
      foreground; this is not terribly useful but it may help you when
      you are debugging some issue. Use these commands, from a different
      terminal, to retrieve the PID
      (process id) and to stop the state server:
    </p><pre class="screen">
tiian@ubuntu:~$ sudo su - lixa
lixa@ubuntu:~$ ps -ef|grep lixad|grep -v grep
lixa      5909  5906  0 22:56 pts/1    00:00:00 /opt/lixa/sbin/lixad
lixa@ubuntu:~$ kill 5909
lixa@ubuntu:~$ exit
logout
    </pre><p>
      Alternatively you can strike ^C to break the foreground execution.
      A foreground execution is generally more useful if some 
      tracing is enabled:
    </p><pre class="screen">
lixa@ubuntu:~$ export LIXA_TRACE_MASK=0x00000001
lixa@ubuntu:~$ /opt/lixa/sbin/lixad 
2011-03-31 22:58:32.244333 [5920/3073509104] lixad/main: starting
2011-03-31 22:58:34.864062 [5920/3073509104] lixad/main: exiting
    </pre><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="Background_execution"></a>Background (<span class="emphasis"><em>daemon</em></span>) execution</h3></div></div></div><p>
	The most useful command option is <code class="option">--daemon</code>: it
	allows you to run the state server as a <span class="emphasis"><em>daemon</em></span>
	detached from any terminal:
      </p><pre class="screen">
lixa@ubuntu:~$ /opt/lixa/sbin/lixad --daemon
lixa@ubuntu:~$ ps -ef|grep lixad|grep -v grep
lixa      5926     1  0 22:59 ?        00:00:00 /opt/lixa/sbin/lixad --daemon
      </pre><p>
	when running the state server as a daemon you need to perform some 
	special tasks to understand the process is up &amp; running.
	With <span class="command"><strong>ps -ef|grep lixad|grep -v grep</strong></span> you can
	verify the process is running.
	The state server registers its PID in a special file:
	<code class="filename">/opt/lixa/var/run.pid</code>; if the content of the file
	is different than the result retrieved with the <span class="command"><strong>grep</strong></span>
	command, something is not running well.
      </p><pre class="screen">
lixa@ubuntu:~$ cat /opt/lixa/var/run.pid 
5926
      </pre><p>
	To stop a daemonized state server you must use the
	<span class="command"><strong>kill</strong></span> command as shown below:
      </p><pre class="screen">
lixa@ubuntu:~$ kill $(cat /opt/lixa/var/run.pid)
lixa@ubuntu:~$ ps -ef|grep lixad|grep -v grep
      </pre><p>
	The <span class="command"><strong>grep</strong></span> command returns an empty result because
	the state server is not running. The state server publishes some
	messages using the <code class="function">syslog</code> facility; Ubuntu 8.04
	sends default messages to the file
	<code class="filename">/var/log/daemon.log</code>; below there are some standard
	messages:
      </p><pre class="screen">
tiian@ubuntu:~$ sudo su -c "cat /var/log/daemon.log|grep lixad|grep 5926"
Mar 31 22:59:11 ubuntu lixad[5926]: LXD014N LIXA server entered daemon status
Mar 31 23:00:48 ubuntu lixad[5926]: LXD019N received signal 15, server immediate shutdown in progress...
Mar 31 23:00:48 ubuntu lixad[5926]: LXD006N server terminated activities
      </pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="Maintenance_mode_execution"></a>Maintenance mode execution</h3></div></div></div><p>
	The <code class="option">--maintenance</code> option allows you to start
	the state server to perform some special actions; only special
	clients can connect to the server when the server is operating
	in <span class="emphasis"><em>maintenance</em></span> mode: customer developed
	Application Programs can not perform distributed transactions.
	A special client is <span class="command"><strong>lixar</strong></span>: a command line
	utility designed for recovery purposes
	(see <a class="xref" href="#Recovery" title="ChapterÂ 6.Â Recovery">ChapterÂ 6, <i>Recovery</i></a> for more information).
      </p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3>
	A state server that's operating in maintenance mode is not
	serving the LIXA infrastructure and Distributed Transaction
	Processing can not be performed: use this option 
	<span class="emphasis"><em>only</em></span> if you really need it.
      </div><p>
	There's no way to turn a server operating in maintenance mode in
	a server operating in standard mode: you have to stop and start
	the LIXA state server again.
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3406228"></a>Dump execution</h3></div></div></div><p>
	Use <code class="option">--dump</code> option to get a dump of the content
	of the state currently persisted in the status files. The option
	must specify one or more flags:
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	      "s": dump all the blocks, in sequential order
	  </p></li><li style="list-style-type: disc"><p>
	      "u": dump all the <span class="emphasis"><em>used</em></span> blocks, 
	      travelling the used block chain
	  </p></li><li style="list-style-type: disc"><p>
	      "f": dump all the <span class="emphasis"><em>free</em></span> blocks, 
	      travelling the free block chain
	  </p></li></ul></div><p>
	You may specify two or more flags on the same command line:
	the output will duplicate some blocks.
      </p><p>
	The example below shows the output produced when dumping the
	content of a single status file with no current transactions
	in progress (the free block chain contains all the blocks):
      </p><pre class="screen">
tiian@ubuntu:~$ sudo su - lixa
lixa@ubuntu:~$ /opt/lixa/sbin/lixad --dump f
========================================================================
First file ('/opt/lixa/var/lixad_status1_1') will be dumped
Magic number is: 24848 (24848)
Level is: 1 (1)
Last sync timestamp: 2011-03-31T23:00:48.829787+0200
Size: 10 blocks
Used block chain starts at: 0 (empty chain)
Free block chain starts at: 1
Dumping records following physical order: 0
Dumping records following free block chain: 1
Dumping records following used block chain: 0
------------------------------------------------------------------------
Block: 1, next block in chain: 2
Block type: unknown (0)
------------------------------------------------------------------------
Block: 2, next block in chain: 3
Block type: unknown (0)
------------------------------------------------------------------------
Block: 3, next block in chain: 4
Block type: unknown (0)
------------------------------------------------------------------------
Block: 4, next block in chain: 5
Block type: unknown (0)
------------------------------------------------------------------------
Block: 5, next block in chain: 6
Block type: unknown (0)
------------------------------------------------------------------------
Block: 6, next block in chain: 7
Block type: unknown (0)
------------------------------------------------------------------------
Block: 7, next block in chain: 8
Block type: unknown (0)
------------------------------------------------------------------------
Block: 8, next block in chain: 9
Block type: unknown (0)
------------------------------------------------------------------------
Block: 9, next block in chain: 0
Block type: unknown (0)
      </pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
	The dump can be performed while the state server is running:
	the dump will output the content of the currently sinchronized
	status file and you will not be able to see the last updates.
	Dumps performed at different times may produce different
	results if there is a running state server.
      </div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3406325"></a>Additional options</h3></div></div></div><p>
	Some additional options are available: they don't radically change the 
	state server behavior, but supply some features.
      </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3406338"></a>Specifying a different configuration file</h4></div></div></div><p>
	  With option <code class="option">--config-file</code> you can specify a
	  non default configuration file; this option can be useful if you
	  want to test a different configuration without damaging your
	  production config file. It can be used if you want to
	  run different instances of the state server in the same
	  operating system image, too.
	</p><p>
	  Below there is a sample invocation:
	</p><pre class="screen">
lixa@ubuntu:~$ /opt/lixa/sbin/lixad --config-file /tmp/lixad_conf.xml
	</pre></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3406367"></a>Specifying a trace file</h4></div></div></div><p>
	  With option <code class="option">--trace-file</code> you can specify a
	  different trace file instead of the default 
	  <span class="emphasis"><em>stderr</em></span>
	  process stream; this option is especially useful when you are
	  running the state server as a daemon (see
	  <a class="xref" href="#Background_execution" title="Background (daemon) execution">the section called âBackground (<span class="emphasis"><em>daemon</em></span>) executionâ</a>).
	  Below there is a sample invocation:
	</p><pre class="screen">
lixa@ubuntu:~$ export LIXA_TRACE_MASK=0x01
lixa@ubuntu:~$ /opt/lixa/sbin/lixad --daemon --trace-file /tmp/lixad.trace
lixa@ubuntu:~$ ls -la /tmp/lixad.trace
-rw-r--r-- 1 lixa lixa 349 2011-03-18 16:14 /tmp/lixad.trace
	</pre><p>
	  Take a look to
	  <a class="xref" href="#Tracing" title="Tracing">the section called âTracingâ</a>
	  for additional details.
	</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3406420"></a>Clean-up recovery failed transactions</h4></div></div></div><p>
	  Use option <code class="option">--clean-failed</code> to clean-up the
	  state of the transactions that LIXA was not able to recover
	  automatically: this option is useful to remove useless information
	  from the state file, but you must pay attention to these
	  <span class="emphasis"><em>warnings</em></span>.
	  </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
		If your LIXA installation worked properly, you would not
		need to clean-up the state file.
	    </p></li><li style="list-style-type: disc"><p>
		Removing recovery failed transactions cleans-up the history
		of your issues: you should understand why your state file
		is accumulating recovery failed transaction records
		need to clean-up the state file.
	    </p></li></ul></div><p>
	  Don't use this option without a deep review of the content of
	  <a class="xref" href="#Recovery" title="ChapterÂ 6.Â Recovery">ChapterÂ 6, <i>Recovery</i></a>.	  
	</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3406471"></a>Retrieving software version</h4></div></div></div><p>
	  Use option <code class="option">--version</code> to retrieve the 
	  version of the installed software as shown below:
	</p><pre class="screen">
lixa@ubuntu:~$ /opt/lixa/sbin/lixad --version
LIXA: a Libre XA implementation
Copyright (c) 2009-2011, Christian Ferrari; all rights reserved.
License: GPL (GNU Public License) version 2
Package name: lixa; package version: 0.5.29
Access http://sourceforge.net/projects/lixa/ to report bugs and partecipate to the project
	</pre><p>
	  The <span class="command"><strong>lixad</strong></span> command does not start a real state 
	  server: it prints version information on 
	  <span class="emphasis"><em>stdout</em></span> and exits.
	</p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3405982"></a>Starting the test utility</h2></div></div></div><p>
      The LIXA project supplies a test utility you can use to 
      perform basic tests on your LIXA environment. 
      The command is named <span class="command"><strong>lixat</strong></span> and is
      located in the <code class="filename">bin</code> directory; use 
      <code class="option">--help</code> option to retrieve the list of 
      the available options:
    </p><pre class="screen">
tiian@ubuntu:~$ /opt/lixa/bin/lixat --help
Usage:
  lixat [OPTION...] - LIXA test utility

Help Options:
  -?, --help         Show help options

Application Options:
  -c, --commit       Perform a commit transaction
  -r, --rollback     Perform a rollback transaction
  -v, --version      Print package info and exit
    </pre><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
	The LIXA test utility is a LIXA client program and it 
	does <span class="emphasis"><em>not</em></span> need
	any special authorization to run because it does not need to write
	the content of <code class="filename">/opt/lixa/var/</code> directory.
    </p></div><p>
      The <span class="command"><strong>lixat</strong></span> command does nothing useful except trying 
      to contact the state server and optionally perform a commit and/or 
      rollback dummy distributed transaction.
      Below there's the output of a trivial execution: the program connects
      to the state server, performs tx_open() against all the configured 
      resource managers and performs tx_close() against all the configured
      resource managers.
    </p><pre class="screen">
tiian@ubuntu:~$ /opt/lixa/bin/lixat
tx_open(): 0
tx_close(): 0
    </pre><p>
      With <code class="option">--commit</code> option the test program performs a
      dummy commit against all the configured resource managers too:
    </p><pre class="screen">
tiian@ubuntu:~$ /opt/lixa/bin/lixat --commit
tx_open(): 0
tx_begin(): 0
tx_info(): 1
        xid/formatID.gtrid.bqual = 4c495841.080f2b63a3804bfbbdd3347ca7607ba3.ef954655163edff9fee662b12f881c97
tx_commit(): 0
tx_close(): 0
    </pre><p>
      A <span class="emphasis"><em>dummy commit</em></span> does not damage your data because
      the program does not contains instructions that modify the content
      of the resource managers. A dummy rollback can be performed as well:
    </p><pre class="screen">
tiian@ubuntu:~$ /opt/lixa/bin/lixat --rollback
tx_open(): 0
tx_begin(): 0
tx_info(): 1
        xid/formatID.gtrid.bqual = 4c495841.c651f0f2efb249bd92f3f2b5a76741a5.ef954655163edff9fee6-62b12f881c97
tx_rollback(): 0
tx_close(): 0
    </pre><p>
      The test utility can be used to:
      </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	    check the state server is up and running
	    </p><pre class="screen">
	      tiian@ubuntu:~$ /opt/lixa/bin/lixat
	      tx_open(): -7
	      tiian@ubuntu:~$ echo $?
	      1
	    </pre><p>
	    (the state server is not running)
	</p></li><li style="list-style-type: disc"><p>
	    check the content of <code class="filename">etc/lixac_conf.xml</code>
	    is ok
	    </p><pre class="screen">
	      tiian@ubuntu:~$ export LIXA_PROFILE=XXXX
	      tiian@ubuntu:~$ /opt/lixa/bin/lixat
	      tx_open(): -7
	      tiian@ubuntu:~$ echo $?
	      1
	    </pre><p>
	    (the profile â<span class="quote">XXXX</span>â does not exist)
	</p></li><li style="list-style-type: disc"><p>
	    try different profiles described inside
	    <code class="filename">etc/lixac_conf.xml</code>
	</p></li><li style="list-style-type: disc"><p>
	    ...
	</p></li></ul></div><p>
      You can <span class="emphasis"><em>safely</em></span> experiment by yourself using 
      <span class="command"><strong>lixat</strong></span> command.
    </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3406502"></a>Starting the recovery utility</h2></div></div></div><p>
      The LIXA project supplies a recovery utility you must use to 
      perform some special tasks related to distributed transaction
      recovery. The command is named <span class="command"><strong>lixar</strong></span> and is
      located in the <code class="filename">bin</code> directory; use 
      <code class="option">--help</code> option to retrieve the list of 
      the available options:
    </p><pre class="screen">
tiian@ubuntu:~$ /opt/lixa/bin/lixar --help
Usage:
  lixar [OPTION...] - LIXA recovery utility

Help Options:
  -?, --help                      Show help options

Application Options:
  -p, --print                     Print a report of all the prepared and in-doubt transactions compatible with current configuration and profile
  -x, --xid                       Select specified transaction for rollback/commit
  -X, --xid-file                  Select specified file as a list of transaction to rollback/commit
  -c, --commit                    Commit prepared &amp; in-doubt transactions
  -r, --rollback                  Rollback prepared &amp; in-doubt transactions
  -v, --version                   Print package info and exit
  -b, --bypass-bqual-check        Bypass xid branch qualifier check
  -B, --bypass-formatid-check     Bypass xid format id check
  -e, --use-tmendrscan-flag       Use TMENDRSCAN flag for last xa_recover call
    </pre><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
	The LIXA test utility is a LIXA client program and it does 
	<span class="emphasis"><em>not</em></span> need
	any special authorization to run because it does not need to write
	the content of <code class="filename">/opt/lixa/var/</code> directory.
    </p></div><p>
      The usage of the <span class="command"><strong>lixar</strong></span> command is strictly related
      to <span class="emphasis"><em>recovery</em></span> tasks and is explained in
      <a class="xref" href="#Recovery" title="ChapterÂ 6.Â Recovery">ChapterÂ 6, <i>Recovery</i></a>.
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
      All the option except <code class="option">--commit</code> and 
      <code class="option">--rollback</code> are <span class="emphasis"><em>safe</em></span>; only
      specifying â<span class="quote">commit</span>â and â<span class="quote">rollback</span>â can
      damage the state of the data managed by your resource managers.
    </div><p>
      You must start the state server before you can start 
      <span class="command"><strong>lixar</strong></span>; if you don't start the state server, you
      will get something like shown below:
    </p><pre class="screen">
tiian@ubuntu:~$ /opt/lixa/bin/lixar
Execution options:
        - print report = no
        - transaction(s) will be committed = no
        - transaction(s) will be rolled back = no
        - bypass xid branch qualifier check = no
        - bypass xid format id check = no
        - use TMENDRSCAN flag for last xa_recover call = no

tx_open() returned TX_FAIL: unable to proceed
    </pre></div></div><div class="chapter" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="Development"></a>ChapterÂ 5.Â Development</h2></div></div></div><p>
    This chapter explains how you can develop your own application
    using the libraries and the tools supplied by LIXA project.
  </p><p>
    LIXA project ships some example C programs you can find in directory
    <code class="filename">/opt/lixa/share/doc/lixa-X.Y.Z/examples/</code> after
    software installation (see <a class="xref" href="#Installation" title="ChapterÂ 2.Â Installation">ChapterÂ 2, <i>Installation</i></a>).
  </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3406820"></a>The TX (Transaction Demarcation) Specification</h2></div></div></div><p>
      LIXA project adopts the standard described in 
      [<a class="citation" href="#id3421960"><span class="citation">TXspec</span></a>] as the API you should use when developing
      an Application Program.
    </p><p>
      The API is very easy, it supplies C functions and can be briefly
      explained:
      </p><pre class="programlisting">
/* include this header: it's the header associated to The TX (Transaction
   Demarcation) Specification */
#include &lt;tx.h&gt;

/* your stuff */

int main(int argc, char *argv[])
{
        /* use an int variable to pick-up function return code */
        int rc;
        
        /* use tx_open() to open ALL the Resource Managers associated to
           the current LIXA_PROFILE */
        if (TX_OK != (rc = tx_open()))
                /* this is an error, manage it! */

        /* put your stuff here ... */

        /* this function delimits the transaction begin */
        if (TX_OK != (rc = tx_begin()))
                /* this is an error, manage it! */

        /* put your commands about the Resource Managers here ... */

        /* this function commits the modification operated by the
           Resource Managers */
        if (TX_OK != (rc = tx_commit()))
                /* this is an error, manage it! */
        /* you can use tx_rollback() instead of tx_commit() if you decide
           the work must be rolled back */

        /* put here other transactions if you need them (loops are possible
           too) */

        /* use tx_close() to close ALL the Resource Managers associated to
           the current LIXA_PROFILE */
}
      </pre><p>
      These are the available functions (the descriptions come from
      [<a class="citation" href="#id3421960"><span class="citation">TXspec</span></a>]):
      </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	    <code class="function">tx_begin</code>: begin a global transaction
	</p></li><li style="list-style-type: disc"><p>
	    <code class="function">tx_close</code>: close a set of resource managers
 	</p></li><li style="list-style-type: disc"><p>
	    <code class="function">tx_commit</code>: commit a global transaction
	</p></li><li style="list-style-type: disc"><p>
	    <code class="function">tx_info</code>: return global transaction information
	</p></li><li style="list-style-type: disc"><p>
	    <code class="function">tx_open</code>: open a set of resource managers
	</p></li><li style="list-style-type: disc"><p>
	    <code class="function">tx_rollback</code>: roll back a global transaction
	</p></li><li style="list-style-type: disc"><p>
	    <code class="function">tx_set_commit_return</code>: set 
	    <em class="parameter"><code>commit_return</code></em> 
	    characteristic
	</p></li><li style="list-style-type: disc"><p>
	    <code class="function">tx_set_transaction_control</code>: set
	    <em class="parameter"><code>transaction_control</code></em> 
	    characteristic
	</p></li><li style="list-style-type: disc"><p>
	    <code class="function">tx_set_transaction_timeout</code>: set
	    <em class="parameter"><code>transaction_timeout</code></em> 
	    characteristic
	</p></li></ul></div><p>
      Refer to [<a class="citation" href="#id3421960"><span class="citation">TXspec</span></a>] for the complete description.
    </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3406969"></a>The first example</h2></div></div></div><div class="figure"><a id="develop1"></a><p class="title"><b>FigureÂ 5.1.Â Deploy model of an example with two dummy resource managers</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Development_1.png" alt="Deploy model of an example with two dummy resource managers" /></div></div></div><br class="figure-break" /><p>
      Create a working directory in a place you are comfortable with:
      </p><table xmlns="" frame="box" id="id3407019"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ cd
tiian@ubuntu:~$ mkdir tmp
tiian@ubuntu:~$ cd tmp
tiian@ubuntu:~/tmp$
	</pre></td></tr></tbody></table><p>
    </p><p>
      Copy file <code class="filename">example1.c</code> in your working dir:
      </p><table xmlns="" frame="box" id="id3407047"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ cp /opt/lixa/share/doc/lixa-X.Y.Z/examples/example1.c .
	</pre></td></tr></tbody></table><p>
      Substitute â<span class="quote">lixa-X.Y.Z</span>â with the actual version of
      the software you installed.
    </p><p>
      Compile and link the C example program:
      </p><table xmlns="" frame="box" id="id3407081"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ gcc example1.c -Wall -I /opt/lixa/include/ -L /opt/lixa/lib/ -l lixac -o example1
	</pre></td></tr></tbody></table><p>
      Check the output of the linker:
      </p><table xmlns="" frame="box" id="id3407093"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ldd example1
        linux-gate.so.1 =&gt;  (0xb77a9000)
        liblixac.so.0 =&gt; not found
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb7653000)
        /lib/ld-linux.so.2 (0xb77aa000)
	</pre></td></tr></tbody></table><p>
      <code class="filename">liblixac.so.0</code> library is not resolved because
      the LIXA libraries are not in system standard library path. You can
      bypass the issue exporting <code class="varname">LD_LIBRARY_PATH</code>
      variable and checking it again:
      </p><table xmlns="" frame="box" id="id3407134"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LD_LIBRARY_PATH=/opt/lixa/lib
tiian@ubuntu:~/tmp$ ldd example1
        linux-gate.so.1 =&gt;  (0xb773f000)
        liblixac.so.0 =&gt; /opt/lixa/lib/liblixac.so.0 (0xb7724000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb75d0000)
        libgmodule-2.0.so.0 =&gt; /usr/lib/libgmodule-2.0.so.0 (0xb75cb000)
        libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0xb75c7000)
        libgthread-2.0.so.0 =&gt; /usr/lib/libgthread-2.0.so.0 (0xb75c2000)
        librt.so.1 =&gt; /lib/tls/i686/cmov/librt.so.1 (0xb75b9000)
        libglib-2.0.so.0 =&gt; /usr/lib/libglib-2.0.so.0 (0xb7508000)
        libxml2.so.2 =&gt; /usr/lib/libxml2.so.2 (0xb73e8000)
        liblixab.so.0 =&gt; /opt/lixa/lib/liblixab.so.0 (0xb73d4000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb73bc000)
        /lib/ld-linux.so.2 (0xb7740000)
        libpcre.so.3 =&gt; /usr/lib/libpcre.so.3 (0xb7395000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0xb7380000)
        libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0xb735b000)
        libuuid.so.1 =&gt; /lib/libuuid.so.1 (0xb7356000)
	</pre></td></tr></tbody></table><p>
      Now you are ready to start your first application:
      </p><table xmlns="" frame="box" id="id3407173"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example1
tx_open(): -7
	</pre></td></tr></tbody></table><p>
      The <code class="function">tx_open()</code> function returned the value 
      â<span class="quote">-7</span>â (<code class="constant">TX_FAIL</code>) 
      because the state server is not running.
      Start the state server (see <a class="xref" href="#Background_execution" title="Background (daemon) execution">the section called âBackground (<span class="emphasis"><em>daemon</em></span>) executionâ</a>)
      and try again:
      </p><table xmlns="" frame="box" id="id3407208"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ sudo su - lixa
lixa@ubuntu:~$ /opt/lixa/sbin/lixad --daemon
lixa@ubuntu:~$ exit
logout
tiian@ubuntu:~/tmp$ ps -ef|grep lixad|grep -v grep
lixa     12866     1  0 21:35 ?        00:00:00 /opt/lixa/sbin/lixad --daemon
tiian@ubuntu:~/tmp$ export LD_LIBRARY_PATH=/opt/lixa/lib
tiian@ubuntu:~/tmp$ ./example1
tx_open(): 0
tx_begin(): 0
tx_commit(): 0
tx_begin(): 0
tx_rollback(): 0
tx_close(): 0
	</pre></td></tr></tbody></table><p>
      Your first program has connected to the state server and has performed
      two dummy distributed transactions: <span class="emphasis"><em>commit</em></span> and 
      <span class="emphasis"><em>rollback</em></span>.
    </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3407077"></a>Some details about the example</h3></div></div></div><p>
	You have not specified a specific profile:
	</p><table xmlns="" frame="box" id="id3407255"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
	  </pre></td></tr></tbody></table><p>
	The LIXA client library used the default one, the first listed in
	<code class="filename">etc/lixac_conf.xml</code>. If you inspected the 
	configuration file <code class="filename">/opt/lixa/etc/lixac_conf.xml</code> 
	you would see something like this:
	</p><table xmlns="" frame="box" id="id3407285"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ cat /opt/lixa/etc/lixac_conf.xml
&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;client&gt;
  &lt;sttsrvs&gt;
    &lt;sttsrv name="local_1" domain="AF_INET" address="127.0.0.1" port="2345" /&gt;
[...]
    &lt;rsrmgr name="LIXAdummyRM" switch_file="/opt/lixa/lib/switch_lixa_dummyrm.so" xa_open_info="dummy open string" xa_close_info="dummy close string" /&gt;
[...]
  &lt;profiles&gt;
    &lt;profile name="CF05"&gt;
      &lt;sttsrvs&gt;
        &lt;sttsrv&gt;local_1&lt;/sttsrv&gt;
      &lt;/sttsrvs&gt;
      &lt;rsrmgrs&gt;
        &lt;rsrmgr&gt;LIXAdummyRM&lt;/rsrmgr&gt;
        &lt;rsrmgr&gt;LIXAdummyRM&lt;/rsrmgr&gt;
      &lt;/rsrmgrs&gt;
    &lt;/profile&gt;
    &lt;profile name="GT71"&gt;
[...]
  &lt;/profiles&gt;
&lt;/client&gt;
	  </pre></td></tr></tbody></table><p>
	The default profile is named â<span class="quote">CF05</span>â and lists two
	resource managers of the same type: â<span class="quote">LIXAdummyRM</span>â;
	the related switch file is the file 
	<code class="filename">/opt/lixa/lib/switch_lixa_dummyrm.so</code>.
	The dummy resource managers supplied by the LIXA project is
	a special trivial resource managers: it ever returns
	<code class="constant">XA_OK</code>. If you are interested in LIXA dummy
	Resource Manager implementation, take a look to the source file
	<code class="filename">src/client/switch/lixa/lixa_dummyrm.c</code>.
	To verify that the program is using the dummy resource manager,
	execute it with <code class="varname">LIXA_TRACE_MASK</code> environment
	variable set to <code class="constant">0x00008000</code>:
	</p><table xmlns="" frame="box" id="id3407348"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LIXA_TRACE_MASK=0x00008000
tiian@ubuntu:~/tmp$ ./example1
[...]
2011-04-05 22:07:59.953844 [29359/3073444096] client_config_load_switch
2011-04-05 22:07:59.953875 [29359/3073444096] client_config_load_switch: resource manager # 0, name='LIXAdummyRM', switch_file='/opt/lixa/lib/switch_lixa_dummyrm.so'
2011-04-05 22:07:59.954220 [29359/3073444096] client_config_load_switch: module address 0x804e410, function lixa_get_xa_switch found at address 0xb76dd790
2011-04-05 22:07:59.954254 [29359/3073444096] client_config_load_switch: lixa_getxa_switch()-&gt;name = 'lixa_dummyrm', lixa_get_xa_switch()-&gt;flags = 0
2011-04-05 22:07:59.954279 [29359/3073444096] client_config_load_switch: resource manager dynamically registers: false
2011-04-05 22:07:59.954302 [29359/3073444096] client_config_load_switch: resource manager does not support association migration: false
2011-04-05 22:07:59.954325 [29359/3073444096] client_config_load_switch: resource manager supports asynchronous operations: false
2011-04-05 22:07:59.954348 [29359/3073444096] client_config_load_switch: resource manager # 1, name='LIXAdummyRM', switch_file='/opt/lixa/lib/switch_lixa_dummyrm.so'
2011-04-05 22:07:59.954379 [29359/3073444096] client_config_load_switch: module address 0x804e410, function lixa_get_xa_switch found at address 0xb76dd790
2011-04-05 22:07:59.954405 [29359/3073444096] client_config_load_switch: lixa_getxa_switch()-&gt;name = 'lixa_dummyrm', lixa_get_xa_switch()-&gt;flags = 0
2011-04-05 22:07:59.954429 [29359/3073444096] client_config_load_switch: resource manager dynamically registers: false
2011-04-05 22:07:59.954451 [29359/3073444096] client_config_load_switch: resource manager does not support association migration: false
2011-04-05 22:07:59.954474 [29359/3073444096] client_config_load_switch: resource manager supports asynchronous operations: false
[...]
tx_open(): 0
tx_begin(): 0
tx_commit(): 0
tx_begin(): 0
tx_rollback(): 0
2011-04-05 22:08:00.128531 [29359/3073444096] client_unconfig
2011-04-05 22:08:00.128883 [29359/3073444096] client_unconfig: acquiring exclusive mutex
2011-04-05 22:08:00.129174 [29359/3073444096] client_config_unload_switch
2011-04-05 22:08:00.129399 [29359/3073444096] client_config_unload_switch: resource manager # 0, defined in config as 'LIXAdummyRM', module address 0x804e410, xa_switch-&gt;name='lixa_dummyrm', xa_switch-&gt;flags=0
2011-04-05 22:08:00.129594 [29359/3073444096] client_config_unload_switch: resource manager # 1, defined in config as 'LIXAdummyRM', module address 0x804e410, xa_switch-&gt;name='lixa_dummyrm', xa_switch-&gt;flags=0
2011-04-05 22:08:00.129852 [29359/3073444096] client_config_unload_switch/excp=1/ret_cod=0/errno=0
2011-04-05 22:08:00.130024 [29359/3073444096] client_unconfig/xmlCleanupParser
2011-04-05 22:08:00.130215 [29359/3073444096] client_unconfig: releasing exclusive mutex
2011-04-05 22:08:00.130371 [29359/3073444096] client_unconfig/excp=2/ret_cod=0/errno=0
tx_close(): 0
	  </pre></td></tr></tbody></table><p>
      </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="Development_example2_ora"></a>An example with Oracle Database Server</h2></div></div></div><div class="figure"><a id="develop2"></a><p class="title"><b>FigureÂ 5.2.Â Deploy model of an example with Oracle Database Server</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Development_2.png" alt="Deploy model of an example with Oracle Database Server" /></div></div></div><br class="figure-break" /><p>
      Using a real Resource Manager, like a DBMS, requires some extra effort
      because you have to set-up the environment needed by the Resource
      Manager. The example explained in this section was developed using
      Oracle Database 10g Release 2 (10.2) Express Edition: if you used 
      a different version, you might need to fix some of the details 
      showed by this example.
      </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	  If you did not yet installed the software provided by Oracle,
	  please refer to the official Oracle site to download the
	  software and to pick-up the information necessary to install 
	  and configure
	  the database. This manual does not give you information related
	  to Oracle technology: it is assumed you already installed and
	  configured the database.
      </p></div><p>
      </p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
      The LIXA software must be configured to support the Oracle Database
      Server resource manager as explained in 
      <a class="xref" href="#Linking_third_party_resource_managers" title="Linking third party resource managers">the section called âLinking third party resource managersâ</a>.
      </p></div><p>
    </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="Development_setup_Oracle_environment"></a>Set-up Oracle environment</h3></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3407480"></a>Start-up the Oracle server</h4></div></div></div><p>
	  If the database server was not running, you could start it
	  with these commands:
	  </p><pre class="screen">
tiian@ubuntu:~/tmp$ sudo /etc/init.d/oracle-xe enable
tiian@ubuntu:~/tmp$ sudo /etc/init.d/oracle-xe start
Starting Oracle Net Listener.
Starting Oracle Database 10g Express Edition Instance.
	  </pre><p>
	  on some systems, like Ubuntu 10.04, you would use somethig like
	  this:
	  </p><pre class="screen">
tiian@ubuntu:~/tmp$ sudo service oracle-xe enable
tiian@ubuntu:~/tmp$ sudo service oracle-xe start
Starting Oracle Net Listener.
Starting Oracle Database 11g Express Edition Instance.
	  </pre><p>
	</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3407524"></a>Create the XA related views</h4></div></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	    The steps explained below might be not necessary with some
	    versions of the Oracle software, but they are necessary
	    with Oracle XE 10.2 and Oracle XE 11.2
	</p></div><p>
	  First of all you must be able to connect as â<span class="quote">SYSDBA</span>â
	  from a terminal session; the commands below show what happens when
	  I connect to the Oracle server using the user 
	  <code class="systemitem">sys</code> with password
	  â<span class="quote">oracle</span>â
	  <sup>[<a id="id3407561" href="#ftn.id3407561" class="footnote">13</a>]</sup>
	  <sup>[<a id="id3407590" href="#ftn.id3407590" class="footnote">14</a>]</sup>:
	  </p><pre class="screen">
tiian@ubuntu:~$ sudo su - oracle
oracle@ubuntu:~$ echo $ORACLE_HOME
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server
oracle@ubuntu:~$ sqlplus "sys/oracle as sysdba"

SQL*Plus: Release 10.2.0.1.0 - Production on Thu Apr 7 22:23:56 2011

Copyright (c) 1982, 2005, Oracle.  All rights reserved.


Connected to:
Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

SQL&gt; exit
Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
	  </pre><p>
	  You must check the file <code class="filename">xaview.sql</code>:
	  </p><pre class="screen">
oracle@ubuntu:~$ ls -la $ORACLE_HOME/rdbms/admin/xaview.sql
-rw-r--r-- 1 oracle dba 1754 2006-02-24 06:18 /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/rdbms/admin/xaview.sql
	  </pre><p>
	  It contains the SQL instructions necessary to create two specific
	  system views that could be not defined in your database; the
	  following commands are related to a database that contains
	  the desired views:
	  </p><pre class="screen">
oracle@ubuntu:~$ sqlplus "sys/oracle as sysdba"

SQL*Plus: Release 10.2.0.1.0 - Production on Thu Apr 7 22:32:45 2011

Copyright (c) 1982, 2005, Oracle.  All rights reserved.


Connected to:
Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

SQL&gt; select * from v$pending_xatrans$;

no rows selected

SQL&gt; select * from v$xatrans$;

no rows selected

SQL&gt; exit
Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
	  </pre><p>
	  If the command failed the views would be not defined and you
	  would get something like this:
	  </p><pre class="screen">
oracle@ubuntu:~$ sqlplus "sys/oracle as sysdba"

SQL*Plus: Release 10.2.0.1.0 - Production on Fri Apr 29 22:20:01 2011

Copyright (c) 1982, 2005, Oracle.  All rights reserved.


Connected to:
Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

SQL&gt; select * from v$pending_xatrans$;
select * from v$pending_xatrans$
              *
ERROR at line 1:
ORA-00942: table or view does not exist


SQL&gt; select * from v$xatrans$;
select * from v$xatrans$
              *
ERROR at line 1:
ORA-00942: table or view does not exist


SQL&gt; exit
Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
	  </pre><p>
	  you can create them with a command like this:
	  </p><pre class="screen">
oracle@ubuntu:~$ cat $ORACLE_HOME/rdbms/admin/xaview.sql | sqlplus "sys/oracle as sysdba"

SQL*Plus: Release 10.2.0.1.0 - Production on Fri Apr 29 22:25:48 2011

Copyright (c) 1982, 2005, Oracle.  All rights reserved.


Connected to:
Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; SQL&gt; DROP VIEW v$xatrans$
*
ERROR at line 1:
ORA-00942: table or view does not exist


SQL&gt; DROP VIEW v$pending_xatrans$
*
ERROR at line 1:
ORA-00942: table or view does not exist


SQL&gt; SQL&gt; SQL&gt;   2    3    4    5    6    7    8
View created.

SQL&gt; SQL&gt; SQL&gt; SQL&gt;   2    3    4    5    6    7    8    9   10   11
View created.

SQL&gt; SQL&gt; SQL&gt; Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
	  </pre><p>
	</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3407695"></a>Authorize the XA related views</h4></div></div></div><p>
	  The example programs supplied by the LIXA project are designed
	  to use the 
	  <code class="systemitem">hr</code> user; you 
	  <span class="emphasis"><em>must</em></span> grant
	  the necessary privileges to all the users you want to use for
	  your Application Programs. The below commands show how to grant
	  the necessary privileges to
	  <code class="systemitem">hr</code>:
	  </p><pre class="screen">
oracle@ubuntu:~$ sqlplus "sys/oracle as sysdba"

SQL*Plus: Release 10.2.0.1.0 - Production on Thu Apr 7 22:44:44 2011

Copyright (c) 1982, 2005, Oracle.  All rights reserved.


Connected to:
Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

SQL&gt; grant select on dba_pending_transactions to hr;

Grant succeeded.

SQL&gt; grant select on v$pending_xatrans$ to hr;

Grant succeeded.

SQL&gt; grant select on v$xatrans$ to hr;

Grant succeeded.

SQL&gt; exit
Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
	  </pre><p>
	</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	    If the user
	    <code class="systemitem">hr</code> did not exist and
	    the above commands failed,
	    you should read Oracle documentation and pick-up the necessary
	    information to create it.
	</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3407750"></a>Unlock â<span class="quote"><code class="systemitem">hr</code></span>â Oracle user</h4></div></div></div><p>
	  The example programs supplied by the LIXA project are designed
	  to use the 
	  <code class="systemitem">hr</code> user; it might be 
	  <span class="emphasis"><em>locked</em></span> after Oracle software installation.
	  The below commands show how to unlock it:
	  </p><pre class="screen">
oracle@ubuntu:~$ sqlplus "sys/oracle as sysdba"

SQL*Plus: Release 10.2.0.1.0 - Production on Thu Apr 7 22:44:44 2011

Copyright (c) 1982, 2005, Oracle.  All rights reserved.


Connected to:
Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

SQL&gt; ALTER USER hr ACCOUNT UNLOCK;

User altered.

SQL&gt; ALTER USER hr IDENTIFIED BY hr;

User altered.

SQL&gt; exit
Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
	  </pre><p>
	  You may perform the same operation using the graphical (web based)
	  interface.
	</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="Development_start_LIXA_server"></a>Start the LIXA state server</h3></div></div></div><p>
	Start the state server as shown below:
	</p><pre class="screen">
tiian@ubuntu:~$ sudo su - lixa
lixa@ubuntu:~$ /opt/lixa/sbin/lixad --daemon
lixa@ubuntu:~$ ps -ef|grep lixad|grep -v grep
lixa      6787     1  0 17:36 ?        00:00:00 /opt/lixa/sbin/lixad --daemon
lixa@ubuntu:~$ exit
logout
	</pre><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3407817"></a>Build the client program</h3></div></div></div><p>
	Prepare the client (Application Program) using the below commands
	(<span class="command"><strong>gcc</strong></span> command was splitted on several lines 
	using <span class="command"><strong>\</strong></span> to help readability, but you may use
	a single line):
	</p><pre class="screen">
tiian@ubuntu:~$ mkdir tmp
tiian@ubuntu:~$ cd tmp
tiian@ubuntu:~/tmp$ cp /opt/lixa/share/doc/lixa-X.Y.Z/examples/example2_ora.c .
tiian@ubuntu:~/tmp$ gcc example2_ora.c -Wall \
&gt; -I /opt/lixa/include/ -L /opt/lixa/lib/ -l lixac \
&gt; -I /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/rdbms/public -L /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib -l clntsh -l nnz10 \
&gt; -o example2_ora
	</pre><p>
	If you are using Oracle XE 11.2 the commands might be something like
	these:
	</p><pre class="screen">
tiian@ubuntu:~$ mkdir tmp
tiian@ubuntu:~$ cd tmp
tiian@ubuntu:~/tmp$ cp /opt/lixa/share/doc/lixa-X.Y.Z/examples/example2_ora.c .
tiian@ubuntu:~/tmp$ gcc example2_ora.c -Wall \
&gt; -I /opt/lixa/include/ -L /opt/lixa/lib/ -l lixac \
&gt; -I /u01/app/oracle/product/11.2.0/xe/rdbms/public/ -L /u01/app/oracle/product/11.2.0/xe/lib/ -l clntsh -l nnz11 \
&gt; -o example2_ora
	</pre><p>
	Verify the executable produced by <span class="command"><strong>gcc</strong></span>:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ldd example2_ora
        linux-gate.so.1 =&gt;  (0xb776d000)
        liblixac.so.0 =&gt; not found
        libclntsh.so.10.1 =&gt; not found
        libnnz10.so =&gt; not found
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb7616000)
        /lib/ld-linux.so.2 (0xb776e000)
	</pre><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3407872"></a>Set-up LIXA environment</h3></div></div></div><p>
	There are three unresolved references that can be fixed setting up
	the environment properly:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH

tiian@ubuntu:~/tmp$ export LD_LIBRARY_PATH=/usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib:/opt/lixa/lib

tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib:/opt/lixa/lib
	</pre><p>
	Check again the executable:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ldd example2_ora
        linux-gate.so.1 =&gt;  (0xb7749000)
        liblixac.so.0 =&gt; /opt/lixa/lib/liblixac.so.0 (0xb772f000)
        libclntsh.so.10.1 =&gt; /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib/libclntsh.so.10.1 (0xb697b000)
        libnnz10.so =&gt; /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib/libnnz10.so (0xb6775000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb6621000)
        libgmodule-2.0.so.0 =&gt; /usr/lib/libgmodule-2.0.so.0 (0xb661d000)
        libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0xb6619000)
        libgthread-2.0.so.0 =&gt; /usr/lib/libgthread-2.0.so.0 (0xb6614000)
        librt.so.1 =&gt; /lib/tls/i686/cmov/librt.so.1 (0xb660a000)
        libglib-2.0.so.0 =&gt; /usr/lib/libglib-2.0.so.0 (0xb6559000)
        libxml2.so.2 =&gt; /usr/lib/libxml2.so.2 (0xb6439000)
        liblixab.so.0 =&gt; /opt/lixa/lib/liblixab.so.0 (0xb6426000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb640e000)
        libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0xb63e9000)
        libnsl.so.1 =&gt; /lib/tls/i686/cmov/libnsl.so.1 (0xb63d0000)
        /lib/ld-linux.so.2 (0xb774a000)
        libpcre.so.3 =&gt; /usr/lib/libpcre.so.3 (0xb63a9000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0xb6394000)
        libuuid.so.1 =&gt; /lib/libuuid.so.1 (0xb6390000)
	</pre><p>
	Set-up the necessary environment variables:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE

tiian@ubuntu:~/tmp$ export LIXA_PROFILE=ORA_DYN
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
ORA_DYN

tiian@ubuntu:~/tmp$ echo $ORACLE_HOME

tiian@ubuntu:~/tmp$ export ORACLE_HOME=/usr/lib/oracle/xe/app/oracle/product/10.2.0/server
tiian@ubuntu:~/tmp$ echo $ORACLE_HOME
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server

tiian@ubuntu:~/tmp$ echo $PATH
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games
tiian@ubuntu:~/tmp$ export PATH=$PATH:$ORACLE_HOME/bin
tiian@ubuntu:~/tmp$ echo $PATH
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/lib/oracle/xe/app/oracle/product/10.2.0/server/bin

tiian@ubuntu:~/tmp$ echo $ORACLE_SID

tiian@ubuntu:~/tmp$ export ORACLE_SID=XE
tiian@ubuntu:~/tmp$ echo $ORACLE_SID
XE
	</pre><p>
	It is suggested to set the necessary environment variables in your 
	profile if you are going to execute the programs many times.
	This is the list of the suggested variables:
	<code class="varname">LD_LIBRARY_PATH</code>,
	<code class="varname">LIXA_PROFILE</code>,
	<code class="varname">ORACLE_HOME</code>,
	<code class="varname">ORACLE_SID</code>.
	</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
	    the third and fourth variables can be
	    set sourcing <code class="filename">oracle_env.sh</code> script (it's
	    installed in the Oracle's <code class="filename">bin</code> directory). 
	</p></div><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3407970"></a>Check the data table before execution</h3></div></div></div><p>
	Execute the below commands:
	</p><pre class="screen">
tiian@ubuntu:~$ sqlplus "hr/hr"

SQL*Plus: Release 10.2.0.1.0 - Production on Thu Apr 14 22:04:55 2011

Copyright (c) 1982, 2005, Oracle.  All rights reserved.


Connected to:
Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

no rows selected

SQL&gt; exit
Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
	</pre><p>
	That's OK because the table does not contain the row we 
	are going to insert.
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3407994"></a>Some checks before program execution</h3></div></div></div><p>
	We set <code class="varname">LIXA_PROFILE</code> to value
	â<span class="quote">ORA_DYN</span>â, looking at
	<code class="filename">/opt/lixa/etc/lixac_conf.xml</code>:
	</p><pre class="screen">
    &lt;profile name="ORA_DYN"&gt;
      &lt;sttsrvs&gt;
        &lt;sttsrv&gt;local_1&lt;/sttsrv&gt;
      &lt;/sttsrvs&gt;
      &lt;rsrmgrs&gt;
        &lt;rsrmgr&gt;OracleXE_dynreg&lt;/rsrmgr&gt;
      &lt;/rsrmgrs&gt;
    &lt;/profile&gt;
	</pre><p>
	the profile references the Resource Manager named
	â<span class="quote">OracleXE_dynreg</span>â, looking again at the config file:
	</p><pre class="screen">
    &lt;rsrmgr name="OracleXE_dynreg" switch_file="/opt/lixa/lib/switch_oracle_dynreg.so" xa_open_info="Oracle_XA+Acc=P/hr/hr+SesTm=30+LogDir=/tmp+threads=true+DbgFl=7+Loose_Coupling=true" xa_close_info="" /&gt;
	</pre><p>
	we can discover that our application will access the Oracle
	database using <code class="systemitem">hr</code>
	user and writing the trace file to directory <code class="filename">/tmp</code>
	(see <code class="constant">LogDir</code>)
	<sup>[<a id="id3408054" href="#ftn.id3408054" class="footnote">15</a>]</sup>. Verify no trace file exists:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ls -la /tmp/xa*
ls: cannot access /tmp/xa*: No such file or directory
	</pre><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3408073"></a>Program execution (dynamic registration)</h3></div></div></div><p>
	Execute the client program as shown below:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ./example2_ora
INSERT statement executed!
First arg is not 'DELETE', bypassing DELETE statement...
	</pre><p>
	Check the table after program execution:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ sqlplus "hr/hr"

SQL*Plus: Release 10.2.0.1.0 - Production on Sun Apr 10 10:34:23 2011

Copyright (c) 1982, 2005, Oracle.  All rights reserved.


Connected to:
Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

CO COUNTRY_NAME                              REGION_ID
-- ---------------------------------------- ----------
RS Repubblica San Marino                             1

SQL&gt; exit
Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
	</pre><p>
	The example program <code class="filename">example2_ora</code> inserted a
	row in table <code class="constant">COUNTRIES</code>. Take a look to the
	trace produced by the Oracle client library:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ls -la /tmp/xa*
-rw-r--r-- 1 tiian tiian 1723 2011-04-10 10:33 /tmp/xa_NULL04102011.trc
tiian@ubuntu:~/tmp$ cat /tmp/xa_NULL04102011.trc

ORACLE XA: Version 10.2.0.1.0. RM name = 'Oracle_XA'.

103352.5300.3057182448.0:
xaoopen: xa_info=Oracle_XA+Acc=P/hr/hr+SesTm=30+LogDir=/tmp+threads=true+DbgFl=7+Loose_Coupling=true,rmid=0,flags=0x0

103352.5300.3057182448.0:
xaolgn_help: version#: 169869568 banner: Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

103352.5300.3057182448.0:
xaolgn: sqlxrc/sqlxss completed

103352.5300.3057182448.0:
xaolgn2: return XA_OK

103352.5300.3057182448.0:
xaoopen: xaolgn completed

103352.5300.3057182448.0:
xaoopen: return 0

103352.5300.3057182448.0:
ax_reg: xid=0x494c4158-8c6122ac9fd0477ebfe5f650e21a3539-a154ad9214d0544a3abbd33c8c2ba36f, rmid=0, flags=0x0

103352.5300.3057182448.0:
OCITransStart: Attempting

103352.5300.3057182448.0:
OCITransStart: Succeeded

103352.5300.3057182448.0:
xaodynpo 2: rmid=0, state=3

103352.5300.3057182448.0:
xaoend: xid=0x494c4158-8c6122ac9fd0477ebfe5f650e21a3539-a154ad9214d0544a3abbd33c8c2ba36f, rmid=0, flags=0x4000000

103352.5300.3057182448.0:
OCITransDetach: Attempting

103352.5300.3057182448.0:
OCITransDetach: Succeeded

103352.5300.3057182448.0:
xaoend: return 0

103352.5300.3057182448.0:
xaocommit: xid=0x494c4158-8c6122ac9fd0477ebfe5f650e21a3539-a154ad9214d0544a3abbd33c8c2ba36f, rmid=0, flags=0x40000000

103352.5300.3057182448.0:
OCITransCommit: Attempting

103352.5300.3057182448.0:
xaodynpo 2: rmid=0, state=1

103352.5300.3057182448.0:
OCITransCommit: Succeeded

103352.5300.3057182448.0:
xaocommit: rtn 0

103352.5300.3057182448.0:
xaoclose: xa_info=, rmid=0, flags=0x0

103352.5300.3057182448.0:
OCIServerDetach: Attempting

103352.5300.3057182448.0:
OCIServerDetach: Succeeded

103352.5300.3057182448.0:
xaoclose: rtn 0
	</pre><p>
	The <code class="function">ax_reg</code> function was called because the
	dynamic registration configuration was used 
	(<code class="constant">LIXA_PROFILE=ORA_DYN</code>). 
	Now you can remove
	the inserted record using the same program:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ./example2_ora delete
First arg is 'delete', bypassing INSERT statement...
DELETE statement executed!
	</pre><p>
	Check the content of the table again:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ sqlplus "hr/hr"

SQL*Plus: Release 10.2.0.1.0 - Production on Sun Apr 10 10:40:25 2011

Copyright (c) 1982, 2005, Oracle.  All rights reserved.


Connected to:
Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

no rows selected

SQL&gt; exit
Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
	</pre><p>
	The row was deleted. Please remove the trace file before a new
	execution:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ rm /tmp/xa_NULL04102011.trc
	</pre><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3408179"></a>Program execution (static registration)</h3></div></div></div><p>
	Switch from dynamic registration to static registration:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
ORA_DYN
tiian@ubuntu:~/tmp$ export LIXA_PROFILE=ORA_STA
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
ORA_STA
	</pre><p>
	Execute the program again:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ./example2_ora
INSERT statement executed!
First arg is not 'DELETE', bypassing DELETE statement...
tiian@ubuntu:~/tmp$ sqlplus "hr/hr"

SQL*Plus: Release 10.2.0.1.0 - Production on Sun Apr 10 10:53:05 2011

Copyright (c) 1982, 2005, Oracle.  All rights reserved.


Connected to:
Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

CO COUNTRY_NAME                              REGION_ID
-- ---------------------------------------- ----------
RS Repubblica San Marino                             1

SQL&gt; exit
Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
	</pre><p>
	Inspect the produced trace file:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ls -la /tmp/xa_*
-rw-r--r-- 1 tiian tiian 1661 2011-04-10 10:52 /tmp/xa_NULL04102011.trc
tiian@ubuntu:~/tmp$ cat /tmp/xa_NULL04102011.trc

ORACLE XA: Version 10.2.0.1.0. RM name = 'Oracle_XA'.

105236.5392.3057456880.0:
xaoopen: xa_info=Oracle_XA+Acc=P/hr/hr+SesTm=30+LogDir=/tmp+threads=true+DbgFl=7+Loose_Coupling=true,rmid=0,flags=0x0

105236.5392.3057456880.0:
xaolgn_help: version#: 169869568 banner: Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

105236.5392.3057456880.0:
xaolgn: sqlxrc/sqlxss completed

105236.5392.3057456880.0:
xaolgn: return XA_OK

105236.5392.3057456880.0:
xaoopen: xaolgn completed

105236.5392.3057456880.0:
xaoopen: return 0

105236.5392.3057456880.0:
xaostart: xid=0x494c4158-6119154810784a87b0d0aa83ea497a72-55263ef9237e27f8ae34f46936ce295d, rmid=0, flags=0x0

105236.5392.3057456880.0:
OCITransStart: Attempting

105236.5392.3057456880.0:
OCITransStart: Succeeded

105236.5392.3057456880.0:
xaostart: return XA_OK

105236.5392.3057456880.0:
xaoend: xid=0x494c4158-6119154810784a87b0d0aa83ea497a72-55263ef9237e27f8ae34f46936ce295d, rmid=0, flags=0x4000000

105236.5392.3057456880.0:
OCITransDetach: Attempting

105236.5392.3057456880.0:
OCITransDetach: Succeeded

105236.5392.3057456880.0:
xaoend: return 0

105236.5392.3057456880.0:
xaocommit: xid=0x494c4158-6119154810784a87b0d0aa83ea497a72-55263ef9237e27f8ae34f46936ce295d, rmid=0, flags=0x40000000

105236.5392.3057456880.0:
OCITransCommit: Attempting

105236.5392.3057456880.0:
OCITransCommit: Succeeded

105236.5392.3057456880.0:
xaocommit: rtn 0

105236.5392.3057456880.0:
xaoclose: xa_info=, rmid=0, flags=0x0

105236.5392.3057456880.0:
OCIServerDetach: Attempting

105236.5392.3057456880.0:
OCIServerDetach: Succeeded

105236.5392.3057456880.0:
xaoclose: rtn 0
	</pre><p>
	The <code class="function">xa_start (xaostart)</code> function was called 
	because the static registration configuration was used 
	(<code class="constant">LIXA_PROFILE=ORA_STA</code>). 
	Remove the inserted row again:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ./example2_ora delete
First arg is 'delete', bypassing INSERT statement...
DELETE statement executed!
tiian@ubuntu:~/tmp$ sqlplus "hr/hr"

SQL*Plus: Release 10.2.0.1.0 - Production on Sun Apr 10 11:01:32 2011

Copyright (c) 1982, 2005, Oracle.  All rights reserved.


Connected to:
Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

no rows selected

SQL&gt; exit
Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production
	</pre><p>
	You successfully executed a program that uses Oracle Database Server
	as a Resource Manager.
      </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="Development_example3_db2"></a>An example with IBM DB2 DBMS</h2></div></div></div><div class="figure"><a id="develop3"></a><p class="title"><b>FigureÂ 5.3.Â Deploy model of an example with IBM DB2 DBMS</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Development_3.png" alt="Deploy model of an example with IBM DB2 DBMS" /></div></div></div><br class="figure-break" /><p>
      This example was developed using DB2 Express-C 9.7 for Linux (Ubuntu).
      If you were using a different version you would need to adapt some
      commands to your environment.
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	If you did not yet installed the software provided by IBM,
	please refer to the official IBM site to download the
	software and to pick-up the information necessary to install 
	and configure
	the database. This manual does not give you information related
	to IBM DB2 technology: it is assumed you already installed and
	configured the database.
    </p></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
	The LIXA software must be configured to support the IBM DB2
	server resource manager as explained in 
	<a class="xref" href="#Linking_third_party_resource_managers" title="Linking third party resource managers">the section called âLinking third party resource managersâ</a>.
    </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="Development_setup_DB2_environment"></a>Set-up DB2 environment</h3></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3408346"></a>Start-up the DB2 server</h4></div></div></div><p>
	  If your server didn't start-up automatically at boot time, you
	  could start it with the following commands:
	  </p><pre class="screen">
tiian@ubuntu:~$ ps -ef | grep db2 | grep -v grep
tiian@ubuntu:~$ sudo /etc/init.d/db2exc start
  * Starting DAS:                       done.
  * Instance db2inst1 ( db2c_db2inst1 ):        done.
  * Activating database SAMPLE          done.
tiian@ubuntu:~$ ps -ef | grep db2 | grep -v grep
dasusr1  22959     1  0 10:54 pts/2    00:00:00 /home/dasusr1/das/adm/db2dasrrm
root     23190     1  2 10:54 pts/2    00:00:00 db2wdog                         
db2inst1 23192 23190  4 10:54 pts/2    00:00:01 db2sysc                         
root     23193 23192  0 10:54 pts/2    00:00:00 db2ckpwd                        
root     23194 23192  0 10:54 pts/2    00:00:00 db2ckpwd                        
root     23195 23192  0 10:54 pts/2    00:00:00 db2ckpwd                        
db2inst1 23206 23190  2 10:54 pts/2    00:00:00 db2acd   ,0,0,0,1,0,0,0,1,0,8a6614,14,1e014,2,0,1,11fd0,0x12600000,0x12600000,1600000,740002,2,a0800d
	  </pre><p>
	  Switch to user <code class="systemitem">db2inst1</code>,
	  try to connect to database â<span class="quote">SAMPLE</span>â:
	  </p><pre class="screen">
tiian@ubuntu:~$ sudo su - db2inst1
db2inst1@ubuntu:~$ db2
(c) Copyright IBM Corporation 1993,2007
Command Line Processor for DB2 Client 9.7.1

You can issue database manager commands and SQL statements from the command
prompt. For example:
    db2 =&gt; connect to sample
    db2 =&gt; bind sample.bnd

For general help, type: ?.
For command help, type: ? command, where command can be
the first few keywords of a database manager command. For example:
 ? CATALOG DATABASE for help on the CATALOG DATABASE command
 ? CATALOG          for help on all of the CATALOG commands.

To exit db2 interactive mode, type QUIT at the command prompt. Outside
interactive mode, all commands must be prefixed with 'db2'.
To list the current command option settings, type LIST COMMAND OPTIONS.

For more detailed help, refer to the Online Reference Manual.

db2 =&gt; connect to sample

   Database Connection Information

 Database server        = DB2/LINUX 9.7.1
 SQL authorization ID   = DB2INST1
 Local database alias   = SAMPLE

	  </pre><p>
	  Check the tables â<span class="quote">ORG</span>â and â<span class="quote">DEPT</span>â exist
	  and contain some data:
	  </p><pre class="screen">
db2 =&gt; select * from ORG

DEPTNUMB DEPTNAME       MANAGER DIVISION   LOCATION
-------- -------------- ------- ---------- -------------
      10 Head Office        160 Corporate  New York
      15 New England         50 Eastern    Boston
      20 Mid Atlantic        10 Eastern    Washington
      38 South Atlantic      30 Eastern    Atlanta
      42 Great Lakes        100 Midwest    Chicago
      51 Plains             140 Midwest    Dallas
      66 Pacific            270 Western    San Francisco
      84 Mountain           290 Western    Denver

  8 record(s) selected.

db2 =&gt; select * from DEPT

DEPTNO DEPTNAME                             MGRNO  ADMRDEPT LOCATION
------ ------------------------------------ ------ -------- ----------------
A00    SPIFFY COMPUTER SERVICE DIV.         000010 A00      -
B01    PLANNING                             000020 A00      -
C01    INFORMATION CENTER                   000030 A00      -
D01    DEVELOPMENT CENTER                   -      A00      -
D11    MANUFACTURING SYSTEMS                000060 D01      -
D21    ADMINISTRATION SYSTEMS               000070 D01      -
E01    SUPPORT SERVICES                     000050 A00      -
E11    OPERATIONS                           000090 E01      -
E21    SOFTWARE SUPPORT                     000100 E01      -
F22    BRANCH OFFICE F2                     -      E01      -
G22    BRANCH OFFICE G2                     -      E01      -
H22    BRANCH OFFICE H2                     -      E01      -
I22    BRANCH OFFICE I2                     -      E01      -
J22    BRANCH OFFICE J2                     -      E01      -

  14 record(s) selected.

	  </pre><p>
	  OK, the â<span class="quote">ORG</span>â and â<span class="quote">DEPT</span>â
	  tables are populated. 
	  If something went wrong, you should refer to IBM DB2
	  documentation to fix the issue before the next step because
	  you would not be able to execute the sample program without a
	  basic running installation.
	</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="Development_setup_DB2_user_customization"></a>User customization</h4></div></div></div><p>
	  We want to execute our example program with a generic user,
	  not just using <code class="systemitem">db2inst1</code>
	  because that's the system user dedicated to the database
	  instance execution. The commands below explain as the generic
	  user <code class="systemitem">tiian</code> (my own 
	  user) can be used instead of 
	  <code class="systemitem">db2inst1</code>.
	</p><p>
	  Grant <code class="constant">DBADM</code> privilege to the user
	  <code class="systemitem">tiian</code>:
	  </p><pre class="screen">
db2 =&gt; grant DBADM on database to user tiian
DB20000I  The SQL command completed successfully.
	  </pre><p>
	  <code class="constant">DBADM</code> is not the lowest authorization
	  level necessary to execute our example, but for the sake of 
	  this example it's a â<span class="quote">good enought</span>â choice.
	</p><p>
	  Add something like the 4 lines below to your
	  <code class="filename">$HOME/.profile</code> or equivalent profile
	  configuration:
	  </p><pre class="screen">
# The following three lines have been added by IBM DB2 instance utilities.
if [ -f /home/db2inst1/sqllib/db2profile ]; then
    . /home/db2inst1/sqllib/db2profile
fi
	  </pre><p>
	  Then login again and check your environment:
	  </p><pre class="screen">
tiian@ubuntu:~$ env|grep -i db2
DB2INSTANCE=db2inst1
LD_LIBRARY_PATH=/home/db2inst1/sqllib/lib32
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/home/db2inst1/sqllib/bin:/home/db2inst1/sqllib/adm:/home/db2inst1/sqllib/misc:/home/db2inst1/sqllib/db2tss/bin
CLASSPATH=/home/db2inst1/sqllib/java/db2java.zip:/home/db2inst1/sqllib/java/db2jcc.jar:/home/db2inst1/sqllib/java/sqlj.zip:/home/db2inst1/sqllib/function:/home/db2inst1/sqllib/java/db2jcc_license_cu.jar:.
	  </pre><p>
	  As shown above,
	  <code class="varname">DB2INSTANCE</code>, <code class="varname">LD_LIBRARY_PATH</code>,
	  <code class="varname">PATH</code> variables should refer to DB2 stuff too.
	  Connect to the database using your own user instead of
	  <code class="systemitem">db2inst1</code>:
	  </p><pre class="screen">
tiian@ubuntu:~$ db2
(c) Copyright IBM Corporation 1993,2007
Command Line Processor for DB2 Client 9.7.1

You can issue database manager commands and SQL statements from the command
prompt. For example:
    db2 =&gt; connect to sample
    db2 =&gt; bind sample.bnd

For general help, type: ?.
For command help, type: ? command, where command can be
the first few keywords of a database manager command. For example:
 ? CATALOG DATABASE for help on the CATALOG DATABASE command
 ? CATALOG          for help on all of the CATALOG commands.

To exit db2 interactive mode, type QUIT at the command prompt. Outside
interactive mode, all commands must be prefixed with 'db2'.
To list the current command option settings, type LIST COMMAND OPTIONS.

For more detailed help, refer to the Online Reference Manual.

db2 =&gt; connect to sample

   Database Connection Information

 Database server        = DB2/LINUX 9.7.1
 SQL authorization ID   = TIIAN
 Local database alias   = SAMPLE

db2 =&gt; select * from DB2INST1.ORG

DEPTNUMB DEPTNAME       MANAGER DIVISION   LOCATION
-------- -------------- ------- ---------- -------------
      10 Head Office        160 Corporate  New York
      15 New England         50 Eastern    Boston
      20 Mid Atlantic        10 Eastern    Washington
      38 South Atlantic      30 Eastern    Atlanta
      42 Great Lakes        100 Midwest    Chicago
      51 Plains             140 Midwest    Dallas
      66 Pacific            270 Western    San Francisco
      84 Mountain           290 Western    Denver

  8 record(s) selected.

db2 =&gt; select * from DB2INST1.DEPT

DEPTNO DEPTNAME                             MGRNO  ADMRDEPT LOCATION
------ ------------------------------------ ------ -------- ----------------
A00    SPIFFY COMPUTER SERVICE DIV.         000010 A00      -
B01    PLANNING                             000020 A00      -
C01    INFORMATION CENTER                   000030 A00      -
D01    DEVELOPMENT CENTER                   -      A00      -
D11    MANUFACTURING SYSTEMS                000060 D01      -
D21    ADMINISTRATION SYSTEMS               000070 D01      -
E01    SUPPORT SERVICES                     000050 A00      -
E11    OPERATIONS                           000090 E01      -
E21    SOFTWARE SUPPORT                     000100 E01      -
F22    BRANCH OFFICE F2                     -      E01      -
G22    BRANCH OFFICE G2                     -      E01      -
H22    BRANCH OFFICE H2                     -      E01      -
I22    BRANCH OFFICE I2                     -      E01      -
J22    BRANCH OFFICE J2                     -      E01      -

  14 record(s) selected.

db2 =&gt; quit
DB20000I  The QUIT command completed successfully.
	  </pre><p>
	  You have just verified that a generic user, like
	  <code class="systemitem">tiian</code>	
	  in the example above, can connect to the database and execute
	  some query.
	</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3408630"></a>Start the LIXA state server</h3></div></div></div><p>
	Start the state server as shown below:
	</p><pre class="screen">
tiian@ubuntu:~$ sudo su - lixa
lixa@ubuntu:~$ /opt/lixa/sbin/lixad --daemon
lixa@ubuntu:~$ exit
logout
tiian@ubuntu:~$ ps -ef|grep lixad|grep -v grep
lixa     12866     1  0 21:35 ?        00:00:00 /opt/lixa/sbin/lixad --daemon
	</pre><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3408648"></a>Build the client program</h3></div></div></div><p>
	Prepare the client (Application Program) using the below commands
	(<span class="command"><strong>gcc</strong></span> command was splitted on several lines 
	using <span class="command"><strong>\</strong></span> to help readability, but you may use
	a single line):
	</p><pre class="screen">
tiian@ubuntu:~$ mkdir tmp
tiian@ubuntu:~$ cd tmp
tiian@ubuntu:~/tmp$ cp /opt/lixa/share/doc/lixa-X.Y.Z/examples/example3_db2.c .
tiian@ubuntu:~/tmp$ gcc example3_db2.c -Wall \
&gt; -I /opt/lixa/include/ -L /opt/lixa/lib/ -l lixac -I /opt/ibm/db2/V9.7/include/ -L /opt/ibm/db2/V9.7/lib32/ -l db2 \
&gt; -o example3_db2
	</pre><p>
	Verify the executable produced by <span class="command"><strong>gcc</strong></span>:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ldd example3_db2
        linux-gate.so.1 =&gt;  (0xb7711000)
        liblixac.so.0 =&gt; not found
        libdb2.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2.so.1 (0xb61cf000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb607f000)
        libcrypt.so.1 =&gt; /lib/tls/i686/cmov/libcrypt.so.1 (0xb604d000)
        libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0xb6049000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb6030000)
        libpam.so.0 =&gt; /lib/libpam.so.0 (0xb6026000)
        libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0xb6001000)
        libdb2dascmn.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2dascmn.so.1 (0xb5fd4000)
        libdb2g11n.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2g11n.so.1 (0xb5966000)
        libdb2genreg.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2genreg.so.1 (0xb5925000)
        libdb2install.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2install.so.1 (0xb591a000)
        libdb2locale.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2locale.so.1 (0xb5907000)
        libdb2osse.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2osse.so.1 (0xb5602000)
        libdb2osse_db2.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2osse_db2.so.1 (0xb5592000)
        libdb2trcapi.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2trcapi.so.1 (0xb557e000)
        libstdc++.so.6 =&gt; /usr/lib/libstdc++.so.6 (0xb548b000)
        libgcc_s.so.1 =&gt; /lib/libgcc_s.so.1 (0xb5480000)
        /lib/ld-linux.so.2 (0xb7712000)
        librt.so.1 =&gt; /lib/tls/i686/cmov/librt.so.1 (0xb5476000)
	</pre><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3408710"></a>Set-up LIXA environment</h3></div></div></div><p>
	There is an unresolved reference to liblixac.so.0: it can be fixed 
	setting up the proper environment variable:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH
/home/db2inst1/sqllib/lib32
tiian@ubuntu:~/tmp$ export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/lixa/lib
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH
/home/db2inst1/sqllib/lib32:/opt/lixa/lib
	</pre><p>
	Check again the executable:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ldd example3_db2
        linux-gate.so.1 =&gt;  (0xb775f000)
        liblixac.so.0 =&gt; /opt/lixa/lib/liblixac.so.0 (0xb7744000)
        libdb2.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2.so.1 (0xb6212000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb60b4000)
        libgmodule-2.0.so.0 =&gt; /usr/lib/libgmodule-2.0.so.0 (0xb60b0000)
        libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0xb60ac000)
        libgthread-2.0.so.0 =&gt; /usr/lib/libgthread-2.0.so.0 (0xb60a7000)
        librt.so.1 =&gt; /lib/tls/i686/cmov/librt.so.1 (0xb609e000)
        libglib-2.0.so.0 =&gt; /usr/lib/libglib-2.0.so.0 (0xb5fed000)
        libxml2.so.2 =&gt; /usr/lib/libxml2.so.2 (0xb5ecc000)
        liblixab.so.0 =&gt; /opt/lixa/lib/liblixab.so.0 (0xb5eb9000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb5ea1000)
        libcrypt.so.1 =&gt; /lib/tls/i686/cmov/libcrypt.so.1 (0xb5e6e000)
        libpam.so.0 =&gt; /lib/libpam.so.0 (0xb5e64000)
        libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0xb5e3f000)
        libdb2dascmn.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2dascmn.so.1 (0xb5e12000)
        libdb2g11n.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2g11n.so.1 (0xb57a4000)
        libdb2genreg.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2genreg.so.1 (0xb5763000)
        libdb2install.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2install.so.1 (0xb5758000)
        libdb2locale.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2locale.so.1 (0xb5745000)
        libdb2osse.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2osse.so.1 (0xb5440000)
        libdb2osse_db2.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2osse_db2.so.1 (0xb53d0000)
        libdb2trcapi.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2trcapi.so.1 (0xb53bc000)
        libstdc++.so.6 =&gt; /usr/lib/libstdc++.so.6 (0xb52c9000)
        libgcc_s.so.1 =&gt; /lib/libgcc_s.so.1 (0xb52be000)
        /lib/ld-linux.so.2 (0xb7760000)
        libpcre.so.3 =&gt; /usr/lib/libpcre.so.3 (0xb5297000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0xb5282000)
        libuuid.so.1 =&gt; /lib/libuuid.so.1 (0xb527d000)
	</pre><p>
	Set-up the <code class="varname">LIXA_PROFILE</code> environment variable:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE

tiian@ubuntu:~/tmp$ export LIXA_PROFILE=DB2_DYN
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
DB2_DYN
	</pre><p>
	No additional DB2 variables are needed because they are automatically
	set at login (see <a class="xref" href="#Development_setup_DB2_environment" title="Set-up DB2 environment">the section called âSet-up DB2 environmentâ</a>).
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3408793"></a>Some checks before program execution</h3></div></div></div><p>
	We set <code class="varname">LIXA_PROFILE</code> to value
	â<span class="quote">DB2_DYN</span>â, looking at
	<code class="filename">/opt/lixa/etc/lixac_conf.xml</code>:
	</p><pre class="screen">
    &lt;profile name="DB2_DYN"&gt;
      &lt;sttsrvs&gt;
        &lt;sttsrv&gt;local_1&lt;/sttsrv&gt;
      &lt;/sttsrvs&gt;
      &lt;rsrmgrs&gt;
        &lt;rsrmgr&gt;IBMDB2_dynreg&lt;/rsrmgr&gt;
      &lt;/rsrmgrs&gt;
    &lt;/profile&gt;
	</pre><p>
	the profile references the Resource Manager named
	â<span class="quote">IBMDB2_dynreg</span>â, looking again at the config file:
	</p><pre class="screen">
    &lt;rsrmgr name="IBMDB2_dynreg" switch_file="/opt/lixa/lib/switch_ibmdb2_dynreg.so" xa_open_info="axlib=/opt/lixa/lib/liblixac.so,db=sample,tpm=lixa" xa_close_info="" /&gt;
	</pre><p>
	we can discover how the DB2 database is configured for XA
	<sup>[<a id="id3408827" href="#ftn.id3408827" class="footnote">16</a>]</sup>.
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3408858"></a>Program execution (dynamic registration)</h3></div></div></div><p>
	It is suggested to open two different terminals: the first one
	connected to â<span class="quote">SAMPLE</span>â DB2 database and the second
	one pointing to the directory where the compiled program
	<code class="filename">example3_db2</code> lives.
	First teminal session:
	</p><pre class="screen">
tiian@ubuntu:~$ db2
(c) Copyright IBM Corporation 1993,2007
Command Line Processor for DB2 Client 9.7.1

You can issue database manager commands and SQL statements from the command
prompt. For example:
    db2 =&gt; connect to sample
    db2 =&gt; bind sample.bnd

For general help, type: ?.
For command help, type: ? command, where command can be
the first few keywords of a database manager command. For example:
 ? CATALOG DATABASE for help on the CATALOG DATABASE command
 ? CATALOG          for help on all of the CATALOG commands.

To exit db2 interactive mode, type QUIT at the command prompt. Outside
interactive mode, all commands must be prefixed with 'db2'.
To list the current command option settings, type LIST COMMAND OPTIONS.

For more detailed help, refer to the Online Reference Manual.

db2 =&gt; connect to SAMPLE

   Database Connection Information

 Database server        = DB2/LINUX 9.7.1
 SQL authorization ID   = TIIAN
 Local database alias   = SAMPLE

	</pre><p>
	Second teminal session:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ls -la
total 28
drwxr-xr-x  2 tiian tiian  4096 2011-04-22 16:26 .
drwxr-xr-x 40 tiian tiian  4096 2011-04-18 22:55 ..
-rwxr-xr-x  1 tiian tiian 11030 2011-04-22 16:26 example3_db2
-rw-r--r--  1 tiian tiian  5898 2011-04-22 16:23 example3_db2.c
	</pre><p>
	Check the content of â<span class="quote">DB2INST1.ORG</span>â table before
	program execution:
	</p><pre class="screen">
db2 =&gt; select * from DB2INST1.ORG

DEPTNUMB DEPTNAME       MANAGER DIVISION   LOCATION
-------- -------------- ------- ---------- -------------
      10 Head Office        160 Corporate  New York
      15 New England         50 Eastern    Boston
      20 Mid Atlantic        10 Eastern    Washington
      38 South Atlantic      30 Eastern    Atlanta
      42 Great Lakes        100 Midwest    Chicago
      51 Plains             140 Midwest    Dallas
      66 Pacific            270 Western    San Francisco
      84 Mountain           290 Western    Denver

  8 record(s) selected.

	</pre><p>
	Execute the program:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ./example3_db2 insert org
	</pre><p>
	Check the content of the table again:
	</p><pre class="screen">
db2 =&gt; select * from DB2INST1.ORG

DEPTNUMB DEPTNAME       MANAGER DIVISION   LOCATION
-------- -------------- ------- ---------- -------------
      10 Head Office        160 Corporate  New York
      15 New England         50 Eastern    Boston
      20 Mid Atlantic        10 Eastern    Washington
      38 South Atlantic      30 Eastern    Atlanta
      42 Great Lakes        100 Midwest    Chicago
      51 Plains             140 Midwest    Dallas
      66 Pacific            270 Western    San Francisco
      84 Mountain           290 Western    Denver
     150 Europe             231 R&amp;D        Mojan

  9 record(s) selected.

	</pre><p>
	The example program inserted the last row! You can execute it again
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ./example3_db2 insert org
	</pre><p>
	and it inserts another row:
	</p><pre class="screen">
db2 =&gt; select * from DB2INST1.ORG

DEPTNUMB DEPTNAME       MANAGER DIVISION   LOCATION
-------- -------------- ------- ---------- -------------
      10 Head Office        160 Corporate  New York
      15 New England         50 Eastern    Boston
      20 Mid Atlantic        10 Eastern    Washington
      38 South Atlantic      30 Eastern    Atlanta
      42 Great Lakes        100 Midwest    Chicago
      51 Plains             140 Midwest    Dallas
      66 Pacific            270 Western    San Francisco
      84 Mountain           290 Western    Denver
     150 Europe             231 R&amp;D        Mojan
     150 Europe             231 R&amp;D        Mojan

  10 record(s) selected.

	</pre><p>
	Because there is no an unique constraint on this table; if you
	want to check an error while inserting, use â<span class="quote">DEPT</span>â
	table instead.
	</p><pre class="screen">
db2 =&gt; select * from DB2INST1.DEPT

DEPTNO DEPTNAME                             MGRNO  ADMRDEPT LOCATION
------ ------------------------------------ ------ -------- ----------------
A00    SPIFFY COMPUTER SERVICE DIV.         000010 A00      -
B01    PLANNING                             000020 A00      -
C01    INFORMATION CENTER                   000030 A00      -
D01    DEVELOPMENT CENTER                   -      A00      -
D11    MANUFACTURING SYSTEMS                000060 D01      -
D21    ADMINISTRATION SYSTEMS               000070 D01      -
E01    SUPPORT SERVICES                     000050 A00      -
E11    OPERATIONS                           000090 E01      -
E21    SOFTWARE SUPPORT                     000100 E01      -
F22    BRANCH OFFICE F2                     -      E01      -
G22    BRANCH OFFICE G2                     -      E01      -
H22    BRANCH OFFICE H2                     -      E01      -
I22    BRANCH OFFICE I2                     -      E01      -
J22    BRANCH OFFICE J2                     -      E01      -

  14 record(s) selected.

	</pre><p>
	Try to insert the same row twice:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ./example3_db2 insert dept
tiian@ubuntu:~/tmp$ ./example3_db2 insert dept
Unable to execute the SQL statement ('INSERT INTO DB2INST1.DEPT (DEPTNO, DEPTNAME, ADMRDEPT) VALUES('Z99', 'RESEARCH &amp; DEVELOPMENT', 'E01')'): -1
	</pre><p>
	Check the table content:
	</p><pre class="screen">
db2 =&gt; select * from DB2INST1.DEPT

DEPTNO DEPTNAME                             MGRNO  ADMRDEPT LOCATION
------ ------------------------------------ ------ -------- ----------------
A00    SPIFFY COMPUTER SERVICE DIV.         000010 A00      -
B01    PLANNING                             000020 A00      -
C01    INFORMATION CENTER                   000030 A00      -
D01    DEVELOPMENT CENTER                   -      A00      -
D11    MANUFACTURING SYSTEMS                000060 D01      -
D21    ADMINISTRATION SYSTEMS               000070 D01      -
E01    SUPPORT SERVICES                     000050 A00      -
E11    OPERATIONS                           000090 E01      -
E21    SOFTWARE SUPPORT                     000100 E01      -
F22    BRANCH OFFICE F2                     -      E01      -
G22    BRANCH OFFICE G2                     -      E01      -
H22    BRANCH OFFICE H2                     -      E01      -
I22    BRANCH OFFICE I2                     -      E01      -
J22    BRANCH OFFICE J2                     -      E01      -
Z99    RESEARCH &amp; DEVELOPMENT               -      E01      -

  15 record(s) selected.

	</pre><p>
	Only one record was inserted. As a final step, clean up both the
	tables:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ./example3_db2 delete dept
tiian@ubuntu:~/tmp$ ./example3_db2 delete org
	</pre><p>
	and check the tables were cleaned-up:
	</p><pre class="screen">
db2 =&gt; select * from DB2INST1.DEPT

DEPTNO DEPTNAME                             MGRNO  ADMRDEPT LOCATION
------ ------------------------------------ ------ -------- ----------------
A00    SPIFFY COMPUTER SERVICE DIV.         000010 A00      -
B01    PLANNING                             000020 A00      -
C01    INFORMATION CENTER                   000030 A00      -
D01    DEVELOPMENT CENTER                   -      A00      -
D11    MANUFACTURING SYSTEMS                000060 D01      -
D21    ADMINISTRATION SYSTEMS               000070 D01      -
E01    SUPPORT SERVICES                     000050 A00      -
E11    OPERATIONS                           000090 E01      -
E21    SOFTWARE SUPPORT                     000100 E01      -
F22    BRANCH OFFICE F2                     -      E01      -
G22    BRANCH OFFICE G2                     -      E01      -
H22    BRANCH OFFICE H2                     -      E01      -
I22    BRANCH OFFICE I2                     -      E01      -
J22    BRANCH OFFICE J2                     -      E01      -

  14 record(s) selected.

db2 =&gt; select * from DB2INST1.ORG

DEPTNUMB DEPTNAME       MANAGER DIVISION   LOCATION
-------- -------------- ------- ---------- -------------
      10 Head Office        160 Corporate  New York
      15 New England         50 Eastern    Boston
      20 Mid Atlantic        10 Eastern    Washington
      38 South Atlantic      30 Eastern    Atlanta
      42 Great Lakes        100 Midwest    Chicago
      51 Plains             140 Midwest    Dallas
      66 Pacific            270 Western    San Francisco
      84 Mountain           290 Western    Denver

  8 record(s) selected.

	</pre><p>
	To verify the LIXA Transaction Manager and DB2 Resource Manager
	are using the dynamic transaction registration, you can inspect
	the trace produced by the LIXA client library:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ export LIXA_TRACE_MASK=0x00002000
tiian@ubuntu:~/tmp$ echo $LIXA_TRACE_MASK
0x00002000
tiian@ubuntu:~/tmp$ ./example3_db2 insert dept 2&gt;&amp;1 | grep ax_reg
2011-04-22 22:08:40.650458 [6654/3039381232] ax_reg: rmid=0, xid=0xbfcd65d0, flags=0x0
2011-04-22 22:08:40.650858 [6654/3039381232] ax_reg: the application program has started a transaction (TX states S3); this XID '4c495841.9a73b024b7ab4018915b54761d3dcd79.e41205820a9c722218578c0eeec6a27c' will be returned
2011-04-22 22:08:40.651156 [6654/3039381232] ax_reg: sending 153 bytes to the server for step 8
2011-04-22 22:08:40.651316 [6654/3039381232] ax_reg/excp=7/ret_cod=0/errno=2
	</pre><p>
	I don't know how you can retrieve the same information on the
	DB2 side, but there probably is a way to do it. Clean-up again
	the table...
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ./example3_db2 delete dept
	</pre><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3409083"></a>Program execution (static registration)</h3></div></div></div><p>
	If you desire static transaction registration instead of the
	dynamic one, you can switch the <code class="varname">LIXA_PROFILE</code>:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ export LIXA_PROFILE=DB2_STA
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
DB2_STA
tiian@ubuntu:~/tmp$ export LIXA_TRACE_MASK=0x00002000
tiian@ubuntu:~/tmp$ echo $LIXA_TRACE_MASK
0x00002000
	</pre><p>
	you can verify in file
	<code class="filename">/opt/lixa/etc/lixac_conf.xml</code>
	that â<span class="quote">DB2_STA</span>â is associated to static registration.
	Execute the program:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ./example3_db2 insert dept 2&gt;&amp;1 | grep xa_start
2011-04-22 22:19:45.717003 [6745/3038836464] lixa_xa_start
[...]
2011-04-22 22:19:45.758075 [6745/3038836464] lixa_xa_start: xa_start_entry(xid, 0, 0x0) = 0
2011-04-22 22:19:45.758321 [6745/3038836464] lixa_xa_start: sending 210 bytes to the server for step 24
2011-04-22 22:19:45.758681 [6745/3038836464] lixa_xa_start/excp=10/ret_cod=0/errno=2
	</pre><p>
	Check the content of the table:
	</p><pre class="screen">
db2 =&gt; select * from DB2INST1.DEPT

DEPTNO DEPTNAME                             MGRNO  ADMRDEPT LOCATION
------ ------------------------------------ ------ -------- ----------------
A00    SPIFFY COMPUTER SERVICE DIV.         000010 A00      -
B01    PLANNING                             000020 A00      -
C01    INFORMATION CENTER                   000030 A00      -
D01    DEVELOPMENT CENTER                   -      A00      -
D11    MANUFACTURING SYSTEMS                000060 D01      -
D21    ADMINISTRATION SYSTEMS               000070 D01      -
E01    SUPPORT SERVICES                     000050 A00      -
E11    OPERATIONS                           000090 E01      -
E21    SOFTWARE SUPPORT                     000100 E01      -
F22    BRANCH OFFICE F2                     -      E01      -
G22    BRANCH OFFICE G2                     -      E01      -
H22    BRANCH OFFICE H2                     -      E01      -
I22    BRANCH OFFICE I2                     -      E01      -
J22    BRANCH OFFICE J2                     -      E01      -
Z99    RESEARCH &amp; DEVELOPMENT               -      E01      -

  15 record(s) selected.

	</pre><p>
	And clean the table again:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ unset LIXA_TRACE_MASK
tiian@ubuntu:~/tmp$ ./example3_db2 delete dept
	</pre><p>
      </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3408271"></a>An example with Oracle and IBM DB2</h2></div></div></div><div class="figure"><a id="develop4"></a><p class="title"><b>FigureÂ 5.4.Â Deploy model of an example showing a distributed transaction with Oracle and IBM DB2</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Development_4.png" alt="Deploy model of an example showing a distributed transaction with Oracle and IBM DB2" /></div></div></div><br class="figure-break" /><p>
      This example should be considered a milestone because it shows as
      you can implement DTP (Distributed Transaction Processing) with two
      Resource Managers (Oracle Database Server and IBM DB2 DBMS)
      coordinated by the LIXA Transaction Manager.
      It's strongly suggested you have played with the
      examples previously shown in this chapter (see
      <a class="xref" href="#Development" title="ChapterÂ 5.Â Development">ChapterÂ 5, <i>Development</i></a>) before starting this more complex one.
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	If you did not yet installed the software provided by Oracle,
	please refer to the official Oracle site to download the
	software and to pick-up the information necessary to install 
	and configure
	the database. This manual does not give you information related
	to Oracle technology: it is assumed you already installed and
	configured the database.
      </p><p>
	If you did not yet installed the software provided by IBM,
	please refer to the official IBM site to download the
	software and to pick-up the information necessary to install 
	and configure
	the database. This manual does not give you information related
	to IBM DB2 technology: it is assumed you already installed and
	configured the database.
      </p></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
	The LIXA software must be configured to support the Oracle Database
	Server and the IBM DB2 resource managers as explained in 
	<a class="xref" href="#Linking_third_party_resource_managers" title="Linking third party resource managers">the section called âLinking third party resource managersâ</a>.
	As a little hint, you should configure LIXA as below:
	</p><pre class="screen">
./configure --with-oracle=/usr/lib/oracle/xe/app/oracle/product/10.2.0/server --with-ibmdb2=/opt/ibm/db2/V9.7
	</pre><p>
	Please don't forget you must compile and install every time you
	re-configure.
      </p></div><p>
      Please follow the instructions explained 
      </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	    in <a class="xref" href="#Development_setup_Oracle_environment" title="Set-up Oracle environment">the section called âSet-up Oracle environmentâ</a>
	    to set-up a running environment for Oracle Database Server
	</p></li><li style="list-style-type: disc"><p>
	    in <a class="xref" href="#Development_setup_DB2_environment" title="Set-up DB2 environment">the section called âSet-up DB2 environmentâ</a>
	    to set-up a running environment for IBM DB2 server
	</p></li><li style="list-style-type: disc"><p>
	    in <a class="xref" href="#Development_start_LIXA_server" title="Start the LIXA state server">the section called âStart the LIXA state serverâ</a>
	    to start up the LIXA state server
	</p></li></ul></div><p>
    </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3409272"></a>Build the client program</h3></div></div></div><p>
	Prepare the client (Application Program) using the below commands
	(<span class="command"><strong>gcc</strong></span> command was splitted on several lines 
	using <span class="command"><strong>\</strong></span> to help readability, but you may use
	a single line):
	</p><pre class="screen">
tiian@ubuntu:~$ mkdir tmp
tiian@ubuntu:~$ cd tmp
tiian@ubuntu:~/tmp$ cp /opt/lixa/share/doc/lixa-X.Y.Z/examples/example4_ora_db2.c .
tiian@ubuntu:~/tmp$ gcc example4_ora_db2.c -Wall \
&gt; -I /opt/lixa/include/ -L /opt/lixa/lib/ -l lixac \
&gt; -I /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/rdbms/public -L /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib -l clntsh -l nnz10 \
&gt; -I /opt/ibm/db2/V9.7/include/ -L /opt/ibm/db2/V9.7/lib32/ -l db2 \
&gt; -o example4_ora_db2
	</pre><p>
	Verify the executable produced by <span class="command"><strong>gcc</strong></span>:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ldd example4_ora_db2
        linux-gate.so.1 =&gt;  (0xb779c000)
        liblixac.so.0 =&gt; not found
        libclntsh.so.10.1 =&gt; not found
        libnnz10.so =&gt; not found
        libdb2.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2.so.1 (0xb6259000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb610a000)
        libcrypt.so.1 =&gt; /lib/tls/i686/cmov/libcrypt.so.1 (0xb60d7000)
        libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0xb60d3000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb60bb000)
        libpam.so.0 =&gt; /lib/libpam.so.0 (0xb60b1000)
        libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0xb608c000)
        libdb2dascmn.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2dascmn.so.1 (0xb605e000)
        libdb2g11n.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2g11n.so.1 (0xb59f0000)
        libdb2genreg.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2genreg.so.1 (0xb59b0000)
        libdb2install.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2install.so.1 (0xb59a5000)
        libdb2locale.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2locale.so.1 (0xb5992000)
        libdb2osse.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2osse.so.1 (0xb568d000)
        libdb2osse_db2.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2osse_db2.so.1 (0xb561c000)
        libdb2trcapi.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2trcapi.so.1 (0xb5609000)
        libstdc++.so.6 =&gt; /usr/lib/libstdc++.so.6 (0xb5516000)
        libgcc_s.so.1 =&gt; /lib/libgcc_s.so.1 (0xb550b000)
        /lib/ld-linux.so.2 (0xb779d000)
        librt.so.1 =&gt; /lib/tls/i686/cmov/librt.so.1 (0xb5501000)
	</pre><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3409358"></a>Set-up LIXA environment</h3></div></div></div><p>
	There are three unresolved references that can be fixed setting up
	the environment properly; you can fix the environment manually or
	using these scripts supplied by Oracle and IBM:
	<code class="filename">/home/db2inst1/sqllib/db2profile</code> and
	<code class="filename">/usr/lib/oracle/xe/app/oracle/product/10.2.0/server/bin/oracle_env.sh</code>
	</p><pre class="screen">
tiian@ubuntu:~$ echo $LD_LIBRARY_PATH

tiian@ubuntu:~$ . /home/db2inst1/sqllib/db2profile
tiian@ubuntu:~$ . /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/bin/oracle_env.sh
tiian@ubuntu:~$ echo $LD_LIBRARY_PATH
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib:/home/db2inst1/sqllib/lib32
tiian@ubuntu:~/tmp$ export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/lixa/lib
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib:/home/db2inst1/sqllib/lib32:/opt/lixa/lib
	</pre><p>
	Check again the executable:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ldd example4_ora_db2
        linux-gate.so.1 =&gt;  (0xb775d000)
        liblixac.so.0 =&gt; /opt/lixa/lib/liblixac.so.0 (0xb7743000)
        libclntsh.so.10.1 =&gt; /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib/libclntsh.so.10.1 (0xb698f000)
        libnnz10.so =&gt; /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib/libnnz10.so (0xb6789000)
        libdb2.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2.so.1 (0xb5257000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb50fa000)
        libgmodule-2.0.so.0 =&gt; /usr/lib/libgmodule-2.0.so.0 (0xb50f6000)
        libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0xb50f2000)
        libgthread-2.0.so.0 =&gt; /usr/lib/libgthread-2.0.so.0 (0xb50ec000)
        librt.so.1 =&gt; /lib/tls/i686/cmov/librt.so.1 (0xb50e3000)
        libglib-2.0.so.0 =&gt; /usr/lib/libglib-2.0.so.0 (0xb5032000)
        libxml2.so.2 =&gt; /usr/lib/libxml2.so.2 (0xb4f12000)
        liblixab.so.0 =&gt; /opt/lixa/lib/liblixab.so.0 (0xb4eff000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb4ee7000)
        libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0xb4ec1000)
        libnsl.so.1 =&gt; /lib/tls/i686/cmov/libnsl.so.1 (0xb4ea9000)
        libcrypt.so.1 =&gt; /lib/tls/i686/cmov/libcrypt.so.1 (0xb4e76000)
        libpam.so.0 =&gt; /lib/libpam.so.0 (0xb4e6c000)
        libdb2dascmn.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2dascmn.so.1 (0xb4e3f000)
        libdb2g11n.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2g11n.so.1 (0xb47d1000)
        libdb2genreg.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2genreg.so.1 (0xb4791000)
        libdb2install.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2install.so.1 (0xb4785000)
        libdb2locale.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2locale.so.1 (0xb4772000)
        libdb2osse.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2osse.so.1 (0xb446d000)
        libdb2osse_db2.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2osse_db2.so.1 (0xb43fd000)
        libdb2trcapi.so.1 =&gt; /home/db2inst1/sqllib/lib32/libdb2trcapi.so.1 (0xb43ea000)
        libstdc++.so.6 =&gt; /usr/lib/libstdc++.so.6 (0xb42f6000)
        libgcc_s.so.1 =&gt; /lib/libgcc_s.so.1 (0xb42eb000)
        /lib/ld-linux.so.2 (0xb775e000)
        libpcre.so.3 =&gt; /usr/lib/libpcre.so.3 (0xb42c4000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0xb42af000)
        libuuid.so.1 =&gt; /lib/libuuid.so.1 (0xb42ab000)
	</pre><p>
	Set-up the necessary environment variables:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE

tiian@ubuntu:~/tmp$ export LIXA_PROFILE=ORA_DYN_DB2_DYN
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
ORA_DYN_DB2_SYN
	</pre><p>
	The below environment variables were set by the previous sourced
	script; take a look to them:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ echo $ORACLE_HOME
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server
tiian@ubuntu:~/tmp$ echo $PATH
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/home/db2inst1/sqllib/bin:/home/db2inst1/sqllib/adm:/home/db2inst1/sqllib/misc:/home/db2inst1/sqllib/db2tss/bin
tiian@ubuntu:~/tmp$ echo $ORACLE_SID
XE
	</pre><p>
	It is suggested to set the necessary environment variables in your 
	profile if you are going to execute the programs many times.
	This is the list of the suggested variables:
	<code class="varname">LD_LIBRARY_PATH</code>,
	<code class="varname">LIXA_PROFILE</code>,
	<code class="varname">ORACLE_HOME</code>,
	<code class="varname">ORACLE_SID</code>,
	<code class="varname">PATH</code>.
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3409476"></a>Some checks before program execution</h3></div></div></div><p>
	We set <code class="varname">LIXA_PROFILE</code> to value
	â<span class="quote">ORA_DYN_DB2_DYN</span>â, looking at
	<code class="filename">/opt/lixa/etc/lixac_conf.xml</code>:
	</p><pre class="screen">
    &lt;profile name="ORA_DYN_DB2_DYN"&gt;
      &lt;sttsrvs&gt;
        &lt;sttsrv&gt;local_1&lt;/sttsrv&gt;
      &lt;/sttsrvs&gt;
      &lt;rsrmgrs&gt;
        &lt;rsrmgr&gt;OracleXE_dynreg&lt;/rsrmgr&gt;
        &lt;rsrmgr&gt;IBMDB2_stareg&lt;/rsrmgr&gt;
      &lt;/rsrmgrs&gt;
    &lt;/profile&gt;
	</pre><p>
	the profile references two Resource Managers:
	â<span class="quote">OracleXE_dynreg</span>â and â<span class="quote">IBMDB2_stareg</span>â, 
	looking again at the config file:
	</p><pre class="screen">
    &lt;rsrmgr name="OracleXE_dynreg" switch_file="/opt/lixa/lib/switch_oracle_dynreg.so" xa_open_info="Oracle_XA+Acc=P/hr/hr+SesTm=30+LogDir=/tmp+threads=true+DbgFl=7+Loose_Coupling=true" xa_close_info="" /&gt;
    &lt;rsrmgr name="IBMDB2_dynreg" switch_file="/opt/lixa/lib/switch_ibmdb2_dynreg.so" xa_open_info="axlib=/opt/lixa/lib/liblixac.so,db=sample,tpm=lixa" xa_close_info="" /&gt;
	</pre><p>
	we can discover how our application will access the resource
	managers
	<sup>[<a id="id3409521" href="#ftn.id3409521" class="footnote">17</a>]</sup>. 
	Verify no (Oracle) trace file exists:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ls -la /tmp/xa*
ls: cannot access /tmp/xa*: No such file or directory
	</pre><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3409577"></a>Program execution (dynamic registration)</h3></div></div></div><p>
	It is suggested to open three different terminals: 
	the first one connected to â<span class="quote">SAMPLE</span>â DB2 database,
	the second one connected to Oracle database and the
	third one pointing to the directory where the compiled program 
	example4_ora_db2 lives.
	</p><table xmlns="" frame="box" id="id3409595"><thead><tr><td>[IBM DB2 terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ . /home/db2inst1/sqllib/db2profile
tiian@ubuntu:~$ db2
(c) Copyright IBM Corporation 1993,2007
Command Line Processor for DB2 Client 9.7.1

You can issue database manager commands and SQL statements from the command
prompt. For example:
    db2 =&gt; connect to sample
    db2 =&gt; bind sample.bnd

For general help, type: ?.
For command help, type: ? command, where command can be
the first few keywords of a database manager command. For example:
 ? CATALOG DATABASE for help on the CATALOG DATABASE command
 ? CATALOG          for help on all of the CATALOG commands.

To exit db2 interactive mode, type QUIT at the command prompt. Outside
interactive mode, all commands must be prefixed with 'db2'.
To list the current command option settings, type LIST COMMAND OPTIONS.

For more detailed help, refer to the Online Reference Manual.

db2 =&gt; connect to SAMPLE

   Database Connection Information

 Database server        = DB2/LINUX 9.7.1
 SQL authorization ID   = TIIAN
 Local database alias   = SAMPLE

db2 =&gt;
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3409613"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ . /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/bin/oracle_env.sh
tiian@ubuntu:~$ sqlplus "hr/hr"                                                 
SQL*Plus: Release 10.2.0.1.0 - Production on Tue May 3 21:52:06 2011

Copyright (c) 1982, 2005, Oracle.  All rights reserved.


Connected to:
Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

SQL&gt;
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3409652"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ls -la
total 36
drwxr-xr-x  2 tiian tiian  4096 2011-05-03 21:53 .
drwxr-xr-x 40 tiian tiian  4096 2011-05-03 21:04 ..
-rwxr-xr-x  1 tiian tiian 14422 2011-05-02 21:53 example4_ora_db2
-rw-r--r--  1 tiian tiian 11892 2011-05-02 21:52 example4_ora_db2.c
	  </pre></td></tr></tbody></table><p>
	Check the content of the Oracle table (â<span class="quote">COUNTRIES</span>â):
	</p><table xmlns="" frame="box" id="id3409687"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

no rows selected
	  </pre></td></tr></tbody></table><p>
	Check the content of the DB2 tables (â<span class="quote">DB2INST1.ORG</span>â and
	â<span class="quote">DB2INST1.DEPT</span>â):
	</p><table xmlns="" frame="box" id="id3409715"><thead><tr><td>[IBM DB2 terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
db2 =&gt; select * from DB2INST1.ORG where DEPTNUMB = 150

DEPTNUMB DEPTNAME       MANAGER DIVISION   LOCATION
-------- -------------- ------- ---------- -------------

  0 record(s) selected.

db2 =&gt; select * from DB2INST1.DEPT where DEPTNO='Z99'

DEPTNO DEPTNAME                             MGRNO  ADMRDEPT LOCATION
------ ------------------------------------ ------ -------- ----------------

  0 record(s) selected.
	  </pre></td></tr></tbody></table><p>
	<span class="command"><strong>example4_ora_db2</strong></span> program accepts some arguments
	you can tune to experiment different transactions:
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	      <code class="option">iorg</code>: insert a row into 
	      â<span class="quote">DB2INST1.ORG</span>â table
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="option">dorg</code>: delete rows from 
	      â<span class="quote">DB2INST1.ORG</span>â table
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="option">idept</code>: insert a row into 
	      â<span class="quote">DB2INST1.DEPT</span>â table
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="option">ddept</code>: delete rows from 
	      â<span class="quote">DB2INST1.DEPT</span>â table
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="option">icountries</code>: insert a row into 
	      â<span class="quote">COUNTRIES</span>â table
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="option">dcountries</code>: delete rows from 
	      â<span class="quote">COUNTRIES</span>â table
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="option">rollback</code>: force a transaction rollback (the
	      default behavior is commit)
	  </p></li></ul></div><p>
	Insert a row in all the tables and check the contents of the tables
	after the transaction execution:
	</p><table xmlns="" frame="box" id="id3409840"><thead><tr><td>[Third terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example4_ora_db2 iorg icountries idept
INSERT INTO DB2INST1.ORG executed!
INSERT INTO COUNTRIES executed!
INSERT INTO DB2INST1.DEPT executed!
COMMIT performed!
	  </pre></td></tr></tbody></table><p>
	Now you can verify the content of the tables after the transaction:
	</p><table xmlns="" frame="box" id="id3409865"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

CO COUNTRY_NAME                              REGION_ID
-- ---------------------------------------- ----------
RS Repubblica San Marino                             1
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3409877"><thead><tr><td>[IBM DB2 terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
db2 =&gt; select * from DB2INST1.ORG where DEPTNUMB = 150

DEPTNUMB DEPTNAME       MANAGER DIVISION   LOCATION
-------- -------------- ------- ---------- -------------
     150 Europe             231 R&amp;D        Mojan

  1 record(s) selected.

db2 =&gt;  select * from DB2INST1.DEPT where DEPTNO='Z99'

DEPTNO DEPTNAME                             MGRNO  ADMRDEPT LOCATION
------ ------------------------------------ ------ -------- ----------------
Z99    RESEARCH &amp; DEVELOPMENT               -      E01      -

  1 record(s) selected.
	  </pre></td></tr></tbody></table><p>
	With the opposite command you can remove the rows from the tables:
	</p><table xmlns="" frame="box" id="id3409904"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example4_ora_db2 dorg dcountries ddept
DELETE FROM DB2INST1.ORG executed!
DELETE FROM COUNTRIES executed!
DELETE FROM DB2INST1.DEPT executed!
COMMIT performed!
	  </pre></td></tr></tbody></table><p>
	and check the content of the tables again:
	</p><table xmlns="" frame="box" id="id3409939"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

no rows selected
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3409960"><thead><tr><td>[IBM DB2 terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
db2 =&gt; select * from DB2INST1.ORG where DEPTNUMB = 150

DEPTNUMB DEPTNAME       MANAGER DIVISION   LOCATION
-------- -------------- ------- ---------- -------------

  0 record(s) selected.

db2 =&gt; select * from DB2INST1.DEPT where DEPTNO='Z99'

DEPTNO DEPTNAME                             MGRNO  ADMRDEPT LOCATION
------ ------------------------------------ ------ -------- ----------------

  0 record(s) selected.
	  </pre></td></tr></tbody></table><p>
	This sequence shows what happens trying to insert a duplicated row
	in a table that does not allow duplicates:
	</p><table xmlns="" frame="box" id="id3409966"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example4_ora_db2 iorg icountries idept
INSERT INTO DB2INST1.ORG executed!
INSERT INTO COUNTRIES executed!
INSERT INTO DB2INST1.DEPT executed!
COMMIT performed!
tiian@ubuntu:~/tmp$ ./example4_ora_db2 iorg icountries idept
INSERT INTO DB2INST1.ORG executed!
OCIStmtExecute/Error while executing INSERT statement; ocirc = -1
ROLLBACK performed!
	  </pre></td></tr></tbody></table><p>
	Verify that table â<span class="quote">DB2INST1.ORG</span>â contains only one row
	because the second transaction was rolled back after the error
	occurred while inserting a duplicated row in â<span class="quote">COUNTRIES</span>â
	table:
	</p><table xmlns="" frame="box" id="id3410022"><thead><tr><td>[IBM DB2 terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
db2 =&gt; select * from DB2INST1.ORG where DEPTNUMB = 150

DEPTNUMB DEPTNAME       MANAGER DIVISION   LOCATION
-------- -------------- ------- ---------- -------------
     150 Europe             231 R&amp;D        Mojan

  1 record(s) selected.
	  </pre></td></tr></tbody></table><p>
	Remove the rows from the tables:
	</p><table xmlns="" frame="box" id="id3410045"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example4_ora_db2 dorg dcountries ddept
DELETE FROM DB2INST1.ORG executed!
DELETE FROM COUNTRIES executed!
DELETE FROM DB2INST1.DEPT executed!
COMMIT performed!
	  </pre></td></tr></tbody></table><p>
	We can introduce the usage of the <code class="option">rollback</code> option 
	to check dynamic registration behavior:
	</p><table xmlns="" frame="box" id="id3410072"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LIXA_TRACE_MASK=0x00002000
tiian@ubuntu:~/tmp$ echo $LIXA_TRACE_MASK
0x00002000
tiian@ubuntu:~/tmp$ ./example4_ora_db2 iorg icountries idept rollback 2&gt;&amp;1 | grep ax_reg
2011-05-04 22:35:07.919522 [8962/3023124208] ax_reg: rmid=1, xid=0xbfe8d1f0, flags=0x0
2011-05-04 22:35:07.920026 [8962/3023124208] ax_reg: the application program has started a transaction (TX states S3); this XID '4c495841.47b3b61569764774bfc1e5f79ef725ae.818e85f29a0c09e22f0c75f89ca17658' will be returned
2011-05-04 22:35:07.920276 [8962/3023124208] ax_reg: sending 153 bytes to the server for step 8
2011-05-04 22:35:07.920527 [8962/3023124208] ax_reg/excp=7/ret_cod=0/errno=2
2011-05-04 22:35:07.921592 [8962/3023124208] ax_reg: rmid=0, xid=0xbfe8b09c, flags=0x0
2011-05-04 22:35:07.921812 [8962/3023124208] ax_reg: the application program has started a transaction (TX states S3); this XID '4c495841.47b3b61569764774bfc1e5f79ef725ae.818e85f29a0c09e22f0c75f89ca17658' will be returned
2011-05-04 22:35:07.921979 [8962/3023124208] ax_reg: sending 153 bytes to the server for step 8
2011-05-04 22:35:07.922128 [8962/3023124208] ax_reg/excp=7/ret_cod=0/errno=2
	  </pre></td></tr></tbody></table><p>
	The second resource manager for profile
	â<span class="quote">ORA_DYN_DB2_DYN</span>â is â<span class="quote">IBMDB2_dynreg</span>â
	and it calls <code class="function">ax_reg</code> with 
	<em class="parameter"><code>rmid=1</code></em> before the first resource manager
	that's â<span class="quote">OracleXE_dynreg</span>â and calls
	<code class="function">ax_reg</code> with <em class="parameter"><code>rmid=0</code></em>
	later.
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3409582"></a>Program execution (mixed registration)</h3></div></div></div><p>
	Switching to a different registration type is quite easy; we can start
	with dynamic registration for Oracle and static registration for
	IBM DB2:
	</p><table xmlns="" frame="box" id="id3410147"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LIXA_TRACE_MASK=0x00002000
tiian@ubuntu:~/tmp$ echo $LIXA_TRACE_MASK
0x00002000
tiian@ubuntu:~/tmp$ export LIXA_PROFILE=ORA_DYN_DB2_STA
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
ORA_DYN_DB2_STA
tiian@ubuntu:~/tmp$ ./example4_ora_db2 iorg icountries idept rollback 2&gt;&amp;1 | grep ax_reg
2011-05-04 22:47:11.812256 [9122/3022382832] ax_reg: rmid=0, xid=0xbfc0f59c, flags=0x0
2011-05-04 22:47:11.813114 [9122/3022382832] ax_reg: the application program has started a transaction (TX states S3); this XID '4c495841.a74508954f774509a939ad9580bca2b8.03460325a8fe89a8c8134b6dea4b782e' will be returned
2011-05-04 22:47:11.813631 [9122/3022382832] ax_reg: sending 153 bytes to the server for step 8
2011-05-04 22:47:11.814037 [9122/3022382832] ax_reg/excp=7/ret_cod=0/errno=2
tiian@ubuntu:~/tmp$ ./example4_ora_db2 iorg icountries idept rollback 2&gt;&amp;1 | grep xa_start
2011-05-04 22:47:38.081183 [9126/3022632688] lixa_xa_start
[...]
2011-05-04 22:47:38.124749 [9126/3022632688] lixa_xa_start: resource manager # 0 registers dynamically, skipping...
2011-05-04 22:47:38.125154 [9126/3022632688] lixa_xa_start: xa_start_entry(xid, 1, 0x0) = 0
2011-05-04 22:47:38.125330 [9126/3022632688] lixa_xa_start: sending 210 bytes to the server for step 24
2011-05-04 22:47:38.125654 [9126/3022632688] lixa_xa_start/excp=10/ret_cod=0/errno=2
	  </pre></td></tr></tbody></table><p>
	Oracle is defined as the first resource manager and calls
	<code class="function">ax_reg</code> using <em class="parameter"><code>rmid=0</code></em>.
	IBM DB2 is defined as the second resource manager and its
	<code class="function">xa_start</code> function is called
	from the LIXA transaction manager using <em class="parameter"><code>rmid=1</code></em>.
	</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	    The LIXA Transaction Manager skips the first resource manager
	    because it is configured for dynamic registration.
	</p></div><p>
	Using static registration for Oracle and dynamic registration for
	IBM DB2 is easy as well:
	</p><table xmlns="" frame="box" id="id3410215"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LIXA_PROFILE=ORA_STA_DB2_DYN
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
ORA_STA_DB2_DYN
tiian@ubuntu:~/tmp$ ./example4_ora_db2 iorg icountries idept rollback 2&gt;&amp;1 | grep ax_reg
2011-05-04 22:57:37.235541 [9346/3023226608] ax_reg: rmid=1, xid=0xbfcf8880, flags=0x0
2011-05-04 22:57:37.236410 [9346/3023226608] ax_reg: the application program has started a transaction (TX states S3); this XID '4c495841.1bf330d60c0442e4b61539214a413ecb.79fecb55351db58295ebf99c9bf09a70' will be returned
2011-05-04 22:57:37.236859 [9346/3023226608] ax_reg: sending 153 bytes to the server for step 8
2011-05-04 22:57:37.237581 [9346/3023226608] ax_reg/excp=7/ret_cod=0/errno=2
tiian@ubuntu:~/tmp$ ./example4_ora_db2 iorg icountries idept rollback 2&gt;&amp;1 | grep xa_start
2011-05-04 22:58:10.258562 [9350/3022706416] lixa_xa_start
[...]
2011-05-04 22:58:10.296182 [9350/3022706416] lixa_xa_start: xa_start_entry(xid, 0, 0x0) = 0
2011-05-04 22:58:10.296448 [9350/3022706416] lixa_xa_start: resource manager # 1 registers dynamically, skipping...
2011-05-04 22:58:10.296625 [9350/3022706416] lixa_xa_start: sending 210 bytes to the server for step 24
2011-05-04 22:58:10.296990 [9350/3022706416] lixa_xa_start/excp=10/ret_cod=0/errno=2
	  </pre></td></tr></tbody></table><p>
	Now the roles of Oracle and IBM DB2 swapped. As a final example
	you can try the static registration for Oracle and IBM DB2 too:
	</p><table xmlns="" frame="box" id="id3410260"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LIXA_PROFILE=ORA_STA_DB2_STA
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
ORA_STA_DB2_STA
tiian@ubuntu:~/tmp$ ./example4_ora_db2 iorg icountries idept rollback 2&gt;&amp;1 | grep ax_reg
tiian@ubuntu:~/tmp$ ./example4_ora_db2 iorg icountries idept rollback 2&gt;&amp;1 | grep xa_start
2011-05-04 23:00:27.871131 [9356/3022927600] lixa_xa_start
[...]
2011-05-04 23:00:27.917087 [9356/3022927600] lixa_xa_start: xa_start_entry(xid, 0, 0x0) = 0
2011-05-04 23:00:27.918251 [9356/3022927600] lixa_xa_start: xa_start_entry(xid, 1, 0x0) = 0
2011-05-04 23:00:27.918741 [9356/3022927600] lixa_xa_start: sending 281 bytes to the server for step 24
2011-05-04 23:00:27.919389 [9356/3022927600] lixa_xa_start/excp=10/ret_cod=0/errno=2
	  </pre></td></tr></tbody></table><p>
	No resource manager calls <code class="function">ax_reg</code> with this
	configuration: this is exactly what's expected.
      </p><p>
	As a final check, we can verify all the tables have no rows:
	</p><table xmlns="" frame="box" id="id3410300"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

no rows selected
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3410321"><thead><tr><td>[IBM DB2 terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
db2 =&gt; select * from DB2INST1.ORG where DEPTNUMB = 150

DEPTNUMB DEPTNAME       MANAGER DIVISION   LOCATION
-------- -------------- ------- ---------- -------------

  0 record(s) selected.

db2 =&gt; select * from DB2INST1.DEPT where DEPTNO='Z99'

DEPTNO DEPTNAME                             MGRNO  ADMRDEPT LOCATION
------ ------------------------------------ ------ -------- ----------------

  0 record(s) selected.
	  </pre></td></tr></tbody></table><p>
	Congratulations! You have just completed a full discovery of
	a Distributed Transaction Processing example with a simple
	Application Program, LIXA Transaction Manager and two widespread
	Resource Managers: Oracle Database Server and IBM DB2 DBMS.
      </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="Development_example5_pql"></a>An example with PostgreSQL</h2></div></div></div><div class="figure"><a id="develop5"></a><p class="title"><b>FigureÂ 5.5.Â Deploy model of an example with PostgreSQL DBMS</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Development_5.png" alt="Deploy model of an example with PostgreSQL DBMS" /></div></div></div><br class="figure-break" /><p>
      This example was developed using PostgreSQL 8.3.15 for Linux (Ubuntu).
      If you were using a different version you would need to adapt some
      commands to your environment.
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	If you did not yet installed the software, please refer to the 
	official site for your Linux distribution or to the official site
	of PostgreSQL if your operating system does not distribute the
	software or you want to use a different PostgreSQL version.
	Using Ubuntu Linux this packages are necessary:
	</p><div class="variablelist"><dl><dt><span class="term"><span class="package">libpq-dev</span></span></dt><dd><p>
		header files for libpq5 (PostgreSQL library)
	    </p></dd><dt><span class="term"><span class="package">libpq</span></span></dt><dd><p>
		PostgreSQL C client library
	    </p></dd><dt><span class="term"><span class="package">postgresql-client-8.3</span></span></dt><dd><p>
		front-end programs for PostgreSQL 8.3
	    </p></dd><dt><span class="term"><span class="package">postgresql-client-common</span></span></dt><dd><p>
		manager for multiple PostgreSQL client version
	    </p></dd><dt><span class="term"><span class="package">postgresql-8.3</span></span></dt><dd><p>
		object-relational SQL database, version 8.3
	    </p></dd><dt><span class="term"><span class="package">postgresql-common</span></span></dt><dd><p>
		PostgreSQL database-cluster manager
	    </p></dd></dl></div><p>
	This manual does not give you information related
	to PostgreSQL: it is assumed you already installed and
	configured the database.
    </p></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	This example requires you are running the database and the application
	on the same host: this is not a technical limitation, but a way to
	make it easy. Client/server configuration must work as well, but
	it needs some PostgreSQL extra configuration: please refer to the
	database documentation.
    </p></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
	The LIXA software must be configured to support the PostgreSQL
	server resource manager as explained in 
	<a class="xref" href="#Linking_third_party_resource_managers" title="Linking third party resource managers">the section called âLinking third party resource managersâ</a>.
    </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="Development_setup_PostgreSQL_environment"></a>Set-up PostgreSQL environment</h3></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3410516"></a>Start-up the PostgreSQL server</h4></div></div></div><p>
	  If your server didn't start-up automatically at boot time, you
	  could start it with the following commands:
	  </p><table xmlns="" frame="box" id="id3410536"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ ps -ef|grep postgres|grep -v grep
tiian@ubuntu:~$ sudo /etc/init.d/postgresql-8.3 start
 * Starting PostgreSQL 8.3 database server                               [ OK ]
tiian@ubuntu:~$ ps -ef|grep postgres|grep -v grep
postgres  6086     1 24 11:25 ?        00:00:01 /usr/lib/postgresql/8.3/bin/postgres -D /var/lib/postgresql/8.3/main -c config_file=/etc/postgresql/8.3/main/postgresql.conf
postgres  6088  6086  0 11:25 ?        00:00:00 postgres: writer process                                                                                        
postgres  6089  6086  0 11:25 ?        00:00:00 postgres: wal writer process                                                                                    
postgres  6090  6086  0 11:25 ?        00:00:00 postgres: autovacuum launcher process                                                                           
postgres  6091  6086  0 11:25 ?        00:00:00 postgres: stats collector process
	    </pre></td></tr></tbody></table><p>
	  Switch to user <code class="systemitem">postgres</code>,
	  associate your user to a matching database user
	  <sup>[<a id="id3410578" href="#ftn.id3410578" class="footnote">18</a>]</sup>
	  ; my personal account is 
	  <code class="systemitem">tiian</code>
	  and I created the same user inside PostgreSQL database:
	  </p><table xmlns="" frame="box" id="id3410605"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ sudo su - postgres
[sudo] password for tiian:
postgres@ubuntu:~$ createuser --createdb tiian
Shall the new role be a superuser? (y/n) n
Shall the new role be allowed to create more new roles? (y/n) n
postgres@ubuntu:~$ exit
logout
	    </pre></td></tr></tbody></table><p>
	  Create a new database and a table necessary to store some data:
	  </p><table xmlns="" frame="box" id="id3410619"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ createdb testdb
tiian@ubuntu:~$ psql testdb
Welcome to psql 8.3.15, the PostgreSQL interactive terminal.

Type:  \copyright for distribution terms
       \h for help with SQL commands
       \? for help with psql commands
       \g or terminate with semicolon to execute query
       \q to quit

testdb=&gt; CREATE TABLE "authors" (
testdb(&gt; "id" integer NOT NULL,
testdb(&gt; "last_name" text,
testdb(&gt; "first_name" text,
testdb(&gt; Constraint "authors_pkey" Primary Key ("id"));
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "authors_pkey" for table "authors"
CREATE TABLE

testdb=&gt; select * from authors;
 id | last_name | first_name
----+-----------+------------
(0 rows)
	    </pre></td></tr></tbody></table><p>
	  OK, the â<span class="quote">authors</span>â table was created. 
	  If something went wrong, you should refer to PostgreSQL
	  documentation to fix the issue before the next step because
	  you would not be able to execute the sample program without a
	  basic running installation.
	</p><p>
	  Change the 
	  <code class="systemitem">max_prepared_transactions</code>
	  parameter in file
	  <code class="filename">postgresql.conf</code>
	  to allow the desired number of prepared transactions (i.e. 10):
	  </p><pre class="screen">
shared_buffers = 24MB                   # min 128kB
                                        # (change requires restart)
#temp_buffers = 8MB                     # min 800kB
max_prepared_transactions = 10          # zero disables the feature
#max_prepared_transactions = 0          # zero disables the feature
                                        # (change requires restart)
# Note:  Increasing max_prepared_transactions costs ~600 bytes of shared memory
# per transaction slot, plus lock space (see max_locks_per_transaction).
# It is not advisable to set max_prepared_transactions nonzero unless you
# actively intend to use prepared transactions.
#work_mem = 1MB                         # min 64kB
#maintenance_work_mem = 16MB            # min 1MB
#max_stack_depth = 2MB                  # min 100kB
	  </pre><p>
	  and restart the PostgreSQL server with something like
	  </p><pre class="screen">sudo service postgresql-8.4 restart</pre><p> or
	  </p><pre class="screen">sudo /etc/init.d/postgresql-8.4 restart</pre><p>
	</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3410704"></a>Start the LIXA state server</h3></div></div></div><p>
	Start the state server as shown below:
	</p><table xmlns="" frame="box" id="id3410713"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ sudo su - lixa
lixa@ubuntu:~$ /opt/lixa/sbin/lixad --daemon
lixa@ubuntu:~$ exit
logout
tiian@ubuntu:~$ ps -ef|grep lixad|grep -v grep
lixa     12866     1  0 21:35 ?        00:00:00 /opt/lixa/sbin/lixad --daemon
	  </pre></td></tr></tbody></table><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3410742"></a>Build the client program</h3></div></div></div><p>
	Prepare the client (Application Program) using the below commands
	(<span class="command"><strong>gcc</strong></span> command was splitted on several lines 
	using <span class="command"><strong>\</strong></span> to help readability, but you may use
	a single line):
	</p><table xmlns="" frame="box" id="id3410762"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ mkdir tmp
tiian@ubuntu:~$ cd tmp
tiian@ubuntu:~/tmp$ cp /opt/lixa/share/doc/lixa-X.Y.Z/examples/example5_pql.c .
tiian@ubuntu:~/tmp$ gcc example5_pql.c -Wall \
&gt; -I /opt/lixa/include/ -L /opt/lixa/lib/ -l lixac -l lixapq \
&gt; -I /usr/include/postgresql -l pq \
&gt; -o example5_pql
	  </pre></td></tr></tbody></table><p>
	Verify the executable produced by <span class="command"><strong>gcc</strong></span>:
	</p><table xmlns="" frame="box" id="id3410790"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ldd example5_pql
        linux-gate.so.1 =&gt;  (0xb7701000)
        liblixac.so.0 =&gt; not found
        liblixapq.so.0 =&gt; not found
        libpq.so.5 =&gt; /usr/lib/libpq.so.5 (0xb76d1000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb7582000)
        libssl.so.0.9.8 =&gt; /usr/lib/i686/cmov/libssl.so.0.9.8 (0xb753d000)
        libcrypto.so.0.9.8 =&gt; /usr/lib/i686/cmov/libcrypto.so.0.9.8 (0xb73fb000)
        libkrb5.so.3 =&gt; /usr/lib/libkrb5.so.3 (0xb736e000)
        libcom_err.so.2 =&gt; /lib/libcom_err.so.2 (0xb736b000)
        libgssapi_krb5.so.2 =&gt; /usr/lib/libgssapi_krb5.so.2 (0xb7341000)
        libcrypt.so.1 =&gt; /lib/tls/i686/cmov/libcrypt.so.1 (0xb730f000)
        libldap_r-2.4.so.2 =&gt; /usr/lib/libldap_r-2.4.so.2 (0xb72cf000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb72b7000)
        /lib/ld-linux.so.2 (0xb7702000)
        libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0xb72b3000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0xb729d000)
        libk5crypto.so.3 =&gt; /usr/lib/libk5crypto.so.3 (0xb727a000)
        libkrb5support.so.0 =&gt; /usr/lib/libkrb5support.so.0 (0xb7272000)
        libkeyutils.so.1 =&gt; /lib/libkeyutils.so.1 (0xb726f000)
        libresolv.so.2 =&gt; /lib/tls/i686/cmov/libresolv.so.2 (0xb725c000)
        liblber-2.4.so.2 =&gt; /usr/lib/liblber-2.4.so.2 (0xb724e000)
        libsasl2.so.2 =&gt; /usr/lib/libsasl2.so.2 (0xb7237000)
        libgnutls.so.13 =&gt; /usr/lib/libgnutls.so.13 (0xb71c1000)
        libtasn1.so.3 =&gt; /usr/lib/libtasn1.so.3 (0xb71b1000)
        libgcrypt.so.11 =&gt; /lib/libgcrypt.so.11 (0xb7164000)
        libgpg-error.so.0 =&gt; /lib/libgpg-error.so.0 (0xb715f000)
	  </pre></td></tr></tbody></table><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3410838"></a>Set-up LIXA environment</h3></div></div></div><p>
	There are two unresolved references to liblixac.so.0 and 
	liblixapq.so.0: they can be fixed 
	setting up the proper environment variable:
	</p><table xmlns="" frame="box" id="id3410848"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH

tiian@ubuntu:~/tmp$ export LD_LIBRARY_PATH=/opt/lixa/lib
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH
/opt/lixa/lib
	  </pre></td></tr></tbody></table><p>
	Check again the executable:
	</p><table xmlns="" frame="box" id="id3410872"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ldd example5_pql
        linux-gate.so.1 =&gt;  (0xb7711000)
        liblixac.so.0 =&gt; /opt/lixa/lib/liblixac.so.0 (0xb76f6000)
        liblixapq.so.0 =&gt; /opt/lixa/lib/liblixapq.so.0 (0xb76ef000)
        libpq.so.5 =&gt; /usr/lib/libpq.so.5 (0xb76c1000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb7572000)
        libgmodule-2.0.so.0 =&gt; /usr/lib/libgmodule-2.0.so.0 (0xb756e000)
        libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0xb756a000)
        libgthread-2.0.so.0 =&gt; /usr/lib/libgthread-2.0.so.0 (0xb7565000)
        librt.so.1 =&gt; /lib/tls/i686/cmov/librt.so.1 (0xb755c000)
        libglib-2.0.so.0 =&gt; /usr/lib/libglib-2.0.so.0 (0xb74aa000)
        libxml2.so.2 =&gt; /usr/lib/libxml2.so.2 (0xb738a000)
        liblixab.so.0 =&gt; /opt/lixa/lib/liblixab.so.0 (0xb7376000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb735e000)
        libssl.so.0.9.8 =&gt; /usr/lib/i686/cmov/libssl.so.0.9.8 (0xb7319000)
        libcrypto.so.0.9.8 =&gt; /usr/lib/i686/cmov/libcrypto.so.0.9.8 (0xb71d6000)
        libkrb5.so.3 =&gt; /usr/lib/libkrb5.so.3 (0xb7149000)
        libcom_err.so.2 =&gt; /lib/libcom_err.so.2 (0xb7146000)
        libgssapi_krb5.so.2 =&gt; /usr/lib/libgssapi_krb5.so.2 (0xb711d000)
        libcrypt.so.1 =&gt; /lib/tls/i686/cmov/libcrypt.so.1 (0xb70eb000)
        libldap_r-2.4.so.2 =&gt; /usr/lib/libldap_r-2.4.so.2 (0xb70ab000)
        /lib/ld-linux.so.2 (0xb7712000)
        libpcre.so.3 =&gt; /usr/lib/libpcre.so.3 (0xb7083000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0xb706e000)
        libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0xb7049000)
        libuuid.so.1 =&gt; /lib/libuuid.so.1 (0xb7045000)
        libk5crypto.so.3 =&gt; /usr/lib/libk5crypto.so.3 (0xb7022000)
        libkrb5support.so.0 =&gt; /usr/lib/libkrb5support.so.0 (0xb7019000)
        libkeyutils.so.1 =&gt; /lib/libkeyutils.so.1 (0xb7016000)
        libresolv.so.2 =&gt; /lib/tls/i686/cmov/libresolv.so.2 (0xb7003000)
        liblber-2.4.so.2 =&gt; /usr/lib/liblber-2.4.so.2 (0xb6ff6000)
        libsasl2.so.2 =&gt; /usr/lib/libsasl2.so.2 (0xb6fdf000)
        libgnutls.so.13 =&gt; /usr/lib/libgnutls.so.13 (0xb6f68000)
        libtasn1.so.3 =&gt; /usr/lib/libtasn1.so.3 (0xb6f58000)
        libgcrypt.so.11 =&gt; /lib/libgcrypt.so.11 (0xb6f0b000)
        libgpg-error.so.0 =&gt; /lib/libgpg-error.so.0 (0xb6f07000)
	  </pre></td></tr></tbody></table><p>
	Set-up the <code class="varname">LIXA_PROFILE</code> environment variable:
	</p><table xmlns="" frame="box" id="id3410932"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE

tiian@ubuntu:~/tmp$ export LIXA_PROFILE=PQL_STA
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
PQL_STA
	  </pre></td></tr></tbody></table><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3410957"></a>Some checks before program execution</h3></div></div></div><p>
	We set <code class="varname">LIXA_PROFILE</code> to value
	â<span class="quote">PQL_STA</span>â, looking at
	<code class="filename">/opt/lixa/etc/lixac_conf.xml</code>:
	</p><pre class="screen">
    &lt;profile name="PQL_STA"&gt;
      &lt;sttsrvs&gt;
        &lt;sttsrv&gt;local_1&lt;/sttsrv&gt;
      &lt;/sttsrvs&gt;
      &lt;rsrmgrs&gt;
        &lt;rsrmgr&gt;PostgreSQL_stareg&lt;/rsrmgr&gt;
      &lt;/rsrmgrs&gt;
    &lt;/profile&gt;
	</pre><p>
	the profile references the Resource Manager named
	â<span class="quote">PostgreSQL_stareg</span>â, looking again at the config file:
	</p><pre class="screen">
    &lt;rsrmgr name="PostgreSQL_stareg" switch_file="/opt/lixa/lib/switch_postgresql_stareg.so" xa_open_info="dbname=testdb" xa_close_info="" /&gt;
	</pre><p>
	we can discover how the PostgreSQL database is configured for XA
	<sup>[<a id="id3410997" href="#ftn.id3410997" class="footnote">19</a>]</sup>.
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3411021"></a>Program execution</h3></div></div></div><p>
	It is suggested to open two different terminals: the first one
	connected to â<span class="quote">testdb</span>â PostgreSQL database and the second
	one pointing to the directory where the compiled program
	<code class="filename">example5_pql</code> lives.
	First teminal session:
	</p><table xmlns="" frame="box" id="id3411044"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ psql testdb
Welcome to psql 8.3.15, the PostgreSQL interactive terminal.

Type:  \copyright for distribution terms
       \h for help with SQL commands
       \? for help with psql commands
       \g or terminate with semicolon to execute query
       \q to quit

testdb=&gt; 
	  </pre></td></tr></tbody></table><p>
	Second teminal session:
	</p><table xmlns="" frame="box" id="id3411070"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ls -la
total 21
drwxr-xr-x   2 tiian tiian  112 2011-09-14 21:14 .
drwxrwx--x 101 tiian tiian 5064 2011-09-14 21:13 ..
-rwxr-xr-x   1 tiian tiian 8293 2011-09-13 21:27 example5_pql
-rw-r--r--   1 tiian tiian 3735 2011-09-13 21:26 example5_pql.c
	  </pre></td></tr></tbody></table><p>
	Check the content of â<span class="quote">AUTHORS</span>â table before
	program execution:
	</p><table xmlns="" frame="box" id="id3411098"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from AUTHORS;
 id | last_name | first_name 
----+-----------+------------
(0 rows)
	  </pre></td></tr></tbody></table><p>
	Execute the program:
	</p><table xmlns="" frame="box" id="id3411119"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example5_pql insert
Inserting a row in the table...
	  </pre></td></tr></tbody></table><p>
	Check the content of the table again:
	</p><table xmlns="" frame="box" id="id3411140"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from AUTHORS;
 id | last_name | first_name 
----+-----------+------------
  1 | Foo       | Bar
(1 rows)
	  </pre></td></tr></tbody></table><p>
	The example program inserted the row with id=1. You can not insert
	the same row twice because there is a unique constraint on this table,
	but you can remove the row using
	</p><table xmlns="" frame="box" id="id3411164"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example5_pql delete
Deleting a row from the table...
	  </pre></td></tr></tbody></table><p>
	Check the table content again:
	</p><table xmlns="" frame="box" id="id3411185"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from AUTHORS;
 id | last_name | first_name 
----+-----------+------------
(0 rows)
	  </pre></td></tr></tbody></table><p>
	you can verify in file
	<code class="filename">/opt/lixa/etc/lixac_conf.xml</code>
	that â<span class="quote">PQL_STA</span>â is associated to static registration
	<sup>[<a id="id3411213" href="#ftn.id3411213" class="footnote">20</a>]</sup>
	.
	Execute the program:
	</p><table xmlns="" frame="box" id="id3411220"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LIXA_TRACE_MASK=0x00002000
tiian@ubuntu:~/tmp$ echo $LIXA_TRACE_MASK
0x00002000
tiian@ubuntu:~/tmp$ ./example5_pql insert 2&gt;&amp;1 | grep xa_start
2011-09-14 21:53:13.403943 [9766/3069609728] lixa_xa_start
[...]
2011-09-14 21:53:13.448918 [9766/3069609728] lixa_xa_start: xa_start_entry(xid, 0, 0x0) = 0
2011-09-14 21:53:13.448977 [9766/3069609728] lixa_xa_start: sending 210 bytes to the server for step 24
2011-09-14 21:53:13.449104 [9766/3069609728] lixa_xa_start/excp=10/ret_cod=0/errno=0
	  </pre></td></tr></tbody></table><p>
	Finally, clean up the table again:
	</p><table xmlns="" frame="box" id="id3411248"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ unset LIXA_TRACE_MASK
tiian@ubuntu:~/tmp$ ./example5_pql delete
Deleting a row from the table...
	  </pre></td></tr></tbody></table><p>
      </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="Development_example6_pql_ora"></a>An example with PostgreSQL &amp; Oracle</h2></div></div></div><div class="figure"><a id="develop6"></a><p class="title"><b>FigureÂ 5.6.Â Deploy model of an example showing a distributed transaction with PostgreSQL and Oracle</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Development_6.png" alt="Deploy model of an example showing a distributed transaction with PostgreSQL and Oracle" /></div></div></div><br class="figure-break" /><p>
      This example shows as
      you can implement DTP (Distributed Transaction Processing) with two
      Resource Managers (PostgreSQL and Oracle Database Server)
      coordinated by the LIXA Transaction Manager.
      It's strongly suggested you have played with the
      examples previously shown in this chapter (see
      <a class="xref" href="#Development" title="ChapterÂ 5.Â Development">ChapterÂ 5, <i>Development</i></a>) before starting this more complex one.
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	If you did not yet installed the software provided by PostgreSQL,
	please refer to the official PostgreSQL site to download the
	software and to pick-up the information necessary to install 
	and configure
	the database. This manual does not give you information related
	to PostgreSQL technology: it is assumed you already installed and
	configured the database.
      </p><p>
	If you did not yet installed the software provided by Oracle,
	please refer to the official Oracle site to download the
	software and to pick-up the information necessary to install 
	and configure
	the database. This manual does not give you information related
	to Oracle technology: it is assumed you already installed and
	configured the database.
      </p></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
	The LIXA software must be configured to support the PostgreSQL and
	the Oracle Database Server resource managers as explained in 
	<a class="xref" href="#Linking_third_party_resource_managers" title="Linking third party resource managers">the section called âLinking third party resource managersâ</a>.
	As a little hint, you should configure LIXA as below:
	</p><pre class="screen">
./configure --with-postgresql-include=/usr/include/postgresql --with-postgresql-lib=/usr/lib \
&gt; --with-oracle=/usr/lib/oracle/xe/app/oracle/product/10.2.0/server
	</pre><p>
	Please don't forget you must compile and install every time you
	re-configure.
      </p></div><p>
      Please follow the instructions explained 
      </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	    in <a class="xref" href="#Development_setup_PostgreSQL_environment" title="Set-up PostgreSQL environment">the section called âSet-up PostgreSQL environmentâ</a>
	    to set-up a running environment for PostgreSQL server
	</p></li><li style="list-style-type: disc"><p>
	    in <a class="xref" href="#Development_setup_Oracle_environment" title="Set-up Oracle environment">the section called âSet-up Oracle environmentâ</a>
	    to set-up a running environment for Oracle Database Server
	</p></li><li style="list-style-type: disc"><p>
	    in <a class="xref" href="#Development_start_LIXA_server" title="Start the LIXA state server">the section called âStart the LIXA state serverâ</a>
	    to start up the LIXA state server
	</p></li></ul></div><p>
    </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3411359"></a>Build the client program</h3></div></div></div><p>
	Prepare the client (Application Program) using the below commands
	(<span class="command"><strong>gcc</strong></span> command was splitted on several lines 
	using <span class="command"><strong>\</strong></span> to help readability, but you may use
	a single line):
	</p><table xmlns="" frame="box" id="id3411426"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ mkdir tmp
tiian@ubuntu:~$ cd tmp
tiian@ubuntu:~/tmp$ cp /opt/lixa/share/doc/lixa-X.Y.Z/examples/example6_pql_ora.c .
tiian@ubuntu:~/tmp$ gcc example6_pql_ora.c -Wall \
&gt; -I /opt/lixa/include/ -L /opt/lixa/lib/ -l lixac -l lixapq \
&gt; -I /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/rdbms/public \
&gt; -L /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib -l clntsh -l nnz10 \
&gt; -I /usr/include/postgresql -l pq \
&gt; -o example6_pql_ora
	  </pre></td></tr></tbody></table><p>
	or if you are using Oracle 11.2 you will use something like this:
	</p><table xmlns="" frame="box" id="id3411456"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ gcc example6_pql_ora.c -Wall \
&gt; -I /opt/lixa/include/ -L /opt/lixa/lib/ -l lixac -l lixapq \
&gt; -I /u01/app/oracle/product/11.2.0/xe/rdbms/public \
&gt; -L /u01/app/oracle/product/11.2.0/xe/lib -l clntsh -l nnz11 \
&gt; -I /usr/include/postgresql -l pq \
&gt; -o example6_pql_ora
	  </pre></td></tr></tbody></table><p>
	Verify the executable produced by <span class="command"><strong>gcc</strong></span>:
	</p><table xmlns="" frame="box" id="id3411484"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ldd example6_pql_ora
        linux-gate.so.1 =&gt;  (0xb77ba000)
        liblixac.so.0 =&gt; not found
        liblixapq.so.0 =&gt; not found
        libclntsh.so.10.1 =&gt; not found
        libnnz10.so =&gt; not found
        libpq.so.5 =&gt; /usr/lib/libpq.so.5 (0xb778a000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb763b000)
        libssl.so.0.9.8 =&gt; /usr/lib/i686/cmov/libssl.so.0.9.8 (0xb75f6000)
        libcrypto.so.0.9.8 =&gt; /usr/lib/i686/cmov/libcrypto.so.0.9.8 (0xb74b3000)
        libkrb5.so.3 =&gt; /usr/lib/libkrb5.so.3 (0xb7426000)
        libcom_err.so.2 =&gt; /lib/libcom_err.so.2 (0xb7423000)
        libgssapi_krb5.so.2 =&gt; /usr/lib/libgssapi_krb5.so.2 (0xb73fa000)
        libcrypt.so.1 =&gt; /lib/tls/i686/cmov/libcrypt.so.1 (0xb73c8000)
        libldap_r-2.4.so.2 =&gt; /usr/lib/libldap_r-2.4.so.2 (0xb7388000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb736f000)
        /lib/ld-linux.so.2 (0xb77bb000)
        libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0xb736b000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0xb7356000)
        libk5crypto.so.3 =&gt; /usr/lib/libk5crypto.so.3 (0xb7333000)
        libkrb5support.so.0 =&gt; /usr/lib/libkrb5support.so.0 (0xb732b000)
        libkeyutils.so.1 =&gt; /lib/libkeyutils.so.1 (0xb7327000)
        libresolv.so.2 =&gt; /lib/tls/i686/cmov/libresolv.so.2 (0xb7314000)
        liblber-2.4.so.2 =&gt; /usr/lib/liblber-2.4.so.2 (0xb7307000)
        libsasl2.so.2 =&gt; /usr/lib/libsasl2.so.2 (0xb72f0000)
        libgnutls.so.13 =&gt; /usr/lib/libgnutls.so.13 (0xb727a000)
        libtasn1.so.3 =&gt; /usr/lib/libtasn1.so.3 (0xb7269000)
        libgcrypt.so.11 =&gt; /lib/libgcrypt.so.11 (0xb721c000)
        libgpg-error.so.0 =&gt; /lib/libgpg-error.so.0 (0xb7218000)
	  </pre></td></tr></tbody></table><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3411502"></a>Set-up LIXA environment</h3></div></div></div><p>
	There are four unresolved references that can be fixed setting up
	the environment properly; you can fix the environment manually or
	using this script supplied by Oracle:
	<code class="filename">/usr/lib/oracle/xe/app/oracle/product/10.2.0/server/bin/oracle_env.sh</code>
	</p><table xmlns="" frame="box" id="id3411550"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH

tiian@ubuntu:~/tmp$ . /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/bin/oracle_env.sh
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib:
tiian@ubuntu:~/tmp$ export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/lixa/lib
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib::/opt/lixa/lib
	  </pre></td></tr></tbody></table><p>
	Oracle 11.2 <code class="filename">oracle_env.sh</code> does not set
	environment variable <code class="varname">LD_LIBRARY_PATH</code> and you
	should set-up it manually:
	</p><table xmlns="" frame="box" id="id3411585"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH

tiian@ubuntu:~/tmp$ export LD_LIBRARY_PATH=/u01/app/oracle/product/11.2.0/xe/lib:/opt/lixa/lib
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH/u01/app/oracle/product/11.2.0/xe/lib:/opt/lixa/lib
/u01/app/oracle/product/11.2.0/xe/lib:/opt/lixa/lib
	  </pre></td></tr></tbody></table><p>
	Check again the executable:
	</p><table xmlns="" frame="box" id="id3411611"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ldd example6_pql_ora
        linux-gate.so.1 =&gt;  (0xb7731000)
        liblixac.so.0 =&gt; /opt/lixa/lib/liblixac.so.0 (0xb7716000)
        liblixapq.so.0 =&gt; /opt/lixa/lib/liblixapq.so.0 (0xb770f000)
        libclntsh.so.10.1 =&gt; /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib/libclntsh.so.10.1 (0xb695a000)
        libnnz10.so =&gt; /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib/libnnz10.so (0xb6755000)
        libpq.so.5 =&gt; /usr/lib/libpq.so.5 (0xb6728000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb65d9000)
        libgmodule-2.0.so.0 =&gt; /usr/lib/libgmodule-2.0.so.0 (0xb65d5000)
        libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0xb65d0000)
        libgthread-2.0.so.0 =&gt; /usr/lib/libgthread-2.0.so.0 (0xb65cb000)
        librt.so.1 =&gt; /lib/tls/i686/cmov/librt.so.1 (0xb65c2000)
        libglib-2.0.so.0 =&gt; /usr/lib/libglib-2.0.so.0 (0xb6511000)
        libxml2.so.2 =&gt; /usr/lib/libxml2.so.2 (0xb63f1000)
        liblixab.so.0 =&gt; /opt/lixa/lib/liblixab.so.0 (0xb63dd000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb63c4000)
        libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0xb639f000)
        libnsl.so.1 =&gt; /lib/tls/i686/cmov/libnsl.so.1 (0xb6387000)
        libssl.so.0.9.8 =&gt; /usr/lib/i686/cmov/libssl.so.0.9.8 (0xb6342000)
        libcrypto.so.0.9.8 =&gt; /usr/lib/i686/cmov/libcrypto.so.0.9.8 (0xb6200000)
        libkrb5.so.3 =&gt; /usr/lib/libkrb5.so.3 (0xb6172000)
        libcom_err.so.2 =&gt; /lib/libcom_err.so.2 (0xb616f000)
        libgssapi_krb5.so.2 =&gt; /usr/lib/libgssapi_krb5.so.2 (0xb6146000)
        libcrypt.so.1 =&gt; /lib/tls/i686/cmov/libcrypt.so.1 (0xb6114000)
        libldap_r-2.4.so.2 =&gt; /usr/lib/libldap_r-2.4.so.2 (0xb60d4000)
        /lib/ld-linux.so.2 (0xb7732000)
        libpcre.so.3 =&gt; /usr/lib/libpcre.so.3 (0xb60ac000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0xb6097000)
        libuuid.so.1 =&gt; /lib/libuuid.so.1 (0xb6093000)
        libk5crypto.so.3 =&gt; /usr/lib/libk5crypto.so.3 (0xb6070000)
        libkrb5support.so.0 =&gt; /usr/lib/libkrb5support.so.0 (0xb6068000)
        libkeyutils.so.1 =&gt; /lib/libkeyutils.so.1 (0xb6064000)
        libresolv.so.2 =&gt; /lib/tls/i686/cmov/libresolv.so.2 (0xb6051000)
        liblber-2.4.so.2 =&gt; /usr/lib/liblber-2.4.so.2 (0xb6044000)
        libsasl2.so.2 =&gt; /usr/lib/libsasl2.so.2 (0xb602d000)
        libgnutls.so.13 =&gt; /usr/lib/libgnutls.so.13 (0xb5fb7000)
        libtasn1.so.3 =&gt; /usr/lib/libtasn1.so.3 (0xb5fa6000)
        libgcrypt.so.11 =&gt; /lib/libgcrypt.so.11 (0xb5f59000)
        libgpg-error.so.0 =&gt; /lib/libgpg-error.so.0 (0xb5f55000)
	  </pre></td></tr></tbody></table><p>
	Set-up the necessary environment variables:
	</p><table xmlns="" frame="box" id="id3411675"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE

tiian@ubuntu:~/tmp$ export LIXA_PROFILE=PQL_STA_ORA_DYN
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
PQL_STA_ORA_DYN
	  </pre></td></tr></tbody></table><p>
	The below environment variables were set by the previous sourced
	script; take a look to them:
	</p><table xmlns="" frame="box" id="id3411699"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ echo $ORACLE_HOME
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server
tiian@ubuntu:~/tmp$ echo $PATH
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games
tiian@ubuntu:~/tmp$ echo $ORACLE_SID
XE
	  </pre></td></tr></tbody></table><p>
	It is suggested to set the necessary environment variables in your 
	profile if you are going to execute the programs many times.
	This is the list of the suggested variables:
	<code class="varname">LD_LIBRARY_PATH</code>,
	<code class="varname">LIXA_PROFILE</code>,
	<code class="varname">ORACLE_HOME</code>,
	<code class="varname">ORACLE_SID</code>,
	<code class="varname">PATH</code>.
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3411742"></a>Some checks before program execution</h3></div></div></div><p>
	We set <code class="varname">LIXA_PROFILE</code> to value
	â<span class="quote">PQL_STA_ORA_DYN</span>â, looking at
	<code class="filename">/opt/lixa/etc/lixac_conf.xml</code>:
	</p><pre class="screen">
    &lt;profile name="PQL_STA_ORA_DYN"&gt;
      &lt;sttsrvs&gt;
        &lt;sttsrv&gt;local_1&lt;/sttsrv&gt;
      &lt;/sttsrvs&gt;
      &lt;rsrmgrs&gt;
        &lt;rsrmgr&gt;PostgreSQL_stareg&lt;/rsrmgr&gt;
        &lt;rsrmgr&gt;OracleXE_dynreg&lt;/rsrmgr&gt;
      &lt;/rsrmgrs&gt;
    &lt;/profile&gt;
	</pre><p>
	the profile references two Resource Managers:
	â<span class="quote">PostgreSQL_stareg</span>â and â<span class="quote">OracleXE_dynreg</span>â, 
	looking again at the config file:
	</p><pre class="screen">
    &lt;rsrmgr name="OracleXE_dynreg" switch_file="/opt/lixa/lib/switch_oracle_dynreg.so" xa_open_info="Oracle_XA+Acc=P/hr/hr+SesTm=30+LogDir=/tmp+threads=true+DbgFl=7+Loose_Coupling=true" xa_close_info="" /&gt;
    &lt;rsrmgr name="PostgreSQL_stareg" switch_file="/opt/lixa/lib/switch_postgresql_stareg.so" xa_open_info="dbname=testdb" xa_close_info="" /&gt;
	</pre><p>
	we can discover how our application will access the resource
	managers
	<sup>[<a id="id3411789" href="#ftn.id3411789" class="footnote">21</a>]</sup>
	<sup>[<a id="id3411817" href="#ftn.id3411817" class="footnote">22</a>]</sup>. 
      </p><p>
	Verify no (Oracle) trace file exists:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ls -la /tmp/xa*
ls: cannot access /tmp/xa*: No such file or directory
	</pre><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3411842"></a>Program execution (dynamic registration for Oracle)</h3></div></div></div><p>
	It is suggested to open three different terminals: 
	the first one connected to â<span class="quote">testdb</span>â PostgreSQL database,
	the second one connected to Oracle database and the
	third one pointing to the directory where the compiled program 
	example6_pql_ora lives.
	</p><table xmlns="" frame="box" id="id3411861"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ psql testdb
Welcome to psql 8.3.15, the PostgreSQL interactive terminal.

Type:  \copyright for distribution terms
       \h for help with SQL commands
       \? for help with psql commands
       \g or terminate with semicolon to execute query
       \q to quit

testdb=&gt;
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3411862"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ . /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/bin/oracle_env.sh
tiian@ubuntu:~$ sqlplus "hr/hr"                                                 
SQL*Plus: Release 10.2.0.1.0 - Production on Tue May 3 21:52:06 2011

Copyright (c) 1982, 2005, Oracle.  All rights reserved.


Connected to:
Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

SQL&gt;
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3411915"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ls -la
total 28
drwxr-xr-x  2 tiian tiian  4096 2011-09-20 21:53 .
drwxr-xr-x 40 tiian tiian  4096 2011-09-19 20:54 ..
-rwxr-xr-x  1 tiian tiian 11219 2011-09-18 21:24 example6_pql_ora
-rw-r--r--  1 tiian tiian  7176 2011-09-18 21:24 example6_pql_ora.c
	  </pre></td></tr></tbody></table><p>
	Check the content of the PostgreSQL table (â<span class="quote">AUTHORS</span>â):
	</p><table xmlns="" frame="box" id="id3411943"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from AUTHORS;
 id | last_name | first_name
----+-----------+------------
(0 rows)
	  </pre></td></tr></tbody></table><p>
	Check the content of the Oracle table (â<span class="quote">COUNTRIES</span>â):
	</p><table xmlns="" frame="box" id="id3411968"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

no rows selected
	  </pre></td></tr></tbody></table><p>
	Insert a row in all the tables and check the contents of the tables
	after the transaction execution:
	</p><table xmlns="" frame="box" id="id3411991"><thead><tr><td>[Third terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example6_pql_ora insert
Inserting a row in the tables...
Oracle INSERT statement executed!
	  </pre></td></tr></tbody></table><p>
	Now you can verify the content of the tables after the transaction:
	</p><table xmlns="" frame="box" id="id3412013"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from AUTHORS;
 id | last_name | first_name
----+-----------+------------
  1 | Foo       | Bar
(1 row)
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3412031"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

CO COUNTRY_NAME                              REGION_ID
-- ---------------------------------------- ----------
RS Repubblica San Marino                             1
	  </pre></td></tr></tbody></table><p>
	With the opposite command you can remove the rows from the tables:
	</p><table xmlns="" frame="box" id="id3412051"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example6_pql_ora delete
Deleting a row from the tables...
Oracle DELETE statement executed!
	  </pre></td></tr></tbody></table><p>
	and check the content of the tables again:
	</p><table xmlns="" frame="box" id="id3412080"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from AUTHORS;
 id | last_name | first_name
----+-----------+------------
(0 rows)
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3412101"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

no rows selected
	  </pre></td></tr></tbody></table><p>
	We can verify the dynamic registration behavior of Oracle:
	</p><table xmlns="" frame="box" id="id3412123"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LIXA_TRACE_MASK=0x00002000
tiian@ubuntu:~/tmp$ echo $LIXA_TRACE_MASK
0x00002000
tiian@ubuntu:~/tmp$ ./example6_pql_ora insert 2&gt;&amp;1 | grep ax_reg
2011-09-20 22:11:01.669440 [6844/3052865280] ax_reg: rmid=1, xid=0xbfe4cdcc, flags=0x0
2011-09-20 22:11:01.669537 [6844/3052865280] ax_reg: the application program has started a transaction (TX states S3); this XID '4c495841.ce4993340a46495e94f07dbbdd5d0366.6e8ecf5972a778ab648b5950c0f96dd6' will be returned
2011-09-20 22:11:01.669591 [6844/3052865280] ax_reg: sending 153 bytes to the server for step 8
2011-09-20 22:11:01.669639 [6844/3052865280] ax_reg/excp=7/ret_cod=0/errno=0
	  </pre></td></tr></tbody></table><p>
	We can check the static registration behavior of Oracle with a 
	different profile:
	</p><table xmlns="" frame="box" id="id3412140"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LIXA_PROFILE=PQL_STA_ORA_STA
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
PQL_STA_ORA_STA
tiian@ubuntu:~/tmp$ ./example6_pql_ora delete 2&gt;&amp;1 | grep xa_start
2011-09-20 22:22:22.561677 [22658/3052615424] lixa_xa_start
[...]
2011-09-20 22:22:22.608794 [22658/3052615424] lixa_xa_start: xa_start_entry(xid, 0, 0x0) = 0
2011-09-20 22:22:22.610649 [22658/3052615424] lixa_xa_start: xa_start_entry(xid, 1, 0x0) = 0
2011-09-20 22:22:22.610694 [22658/3052615424] lixa_xa_start: sending 281 bytes to the server for step 24
2011-09-20 22:22:22.610757 [22658/3052615424] lixa_xa_start/excp=10/ret_cod=0/errno=0
	  </pre></td></tr></tbody></table><p>
	and check the content of the tables again:
	</p><table xmlns="" frame="box" id="id3412185"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from AUTHORS;
 id | last_name | first_name
----+-----------+------------
(0 rows)
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3412206"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

no rows selected
	  </pre></td></tr></tbody></table><p>
	The activity of the Oracle database can be analyzed in the trace file:
	</p><table xmlns="" frame="box" id="id3412228"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ls -la /tmp/xa_NULL09202011.trc
-rw-r--r-- 1 tiian tiian 12042 2011-09-20 22:22 /tmp/xa_NULL09202011.trc
	  </pre></td></tr></tbody></table><p>
      </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="Development_example7_pql_ora"></a>An example with PostgreSQL &amp; IBM DB2</h2></div></div></div><div class="figure"><a id="develop7"></a><p class="title"><b>FigureÂ 5.7.Â Deploy model of an example showing a distributed transaction with PostgreSQL and IBM DB2</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Development_7.png" alt="Deploy model of an example showing a distributed transaction with PostgreSQL and IBM DB2" /></div></div></div><br class="figure-break" /><p>
      This example shows as
      you can implement DTP (Distributed Transaction Processing) with two
      Resource Managers (PostgreSQL and IBM DB2)
      coordinated by the LIXA Transaction Manager.
      It's strongly suggested you have played with the
      examples previously shown in this chapter (see
      <a class="xref" href="#Development" title="ChapterÂ 5.Â Development">ChapterÂ 5, <i>Development</i></a>) before starting this more complex one.
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	If you did not yet installed the software provided by PostgreSQL,
	please refer to the official PostgreSQL site to download the
	software and to pick-up the information necessary to install 
	and configure
	the database. This manual does not give you information related
	to PostgreSQL technology: it is assumed you already installed and
	configured the database.
      </p><p>
	If you did not yet installed the software provided by IBM,
	please refer to the official IBM site to download the
	software and to pick-up the information necessary to install 
	and configure
	the database. This manual does not give you information related
	to IBM DB2 technology: it is assumed you already installed and
	configured the database.
      </p></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
	The LIXA software must be configured to support the PostgreSQL and
	the IBM DB2 resource managers as explained in 
	<a class="xref" href="#Linking_third_party_resource_managers" title="Linking third party resource managers">the section called âLinking third party resource managersâ</a>.
	As a little hint, you should configure LIXA as below:
	</p><pre class="screen">
./configure --with-postgresql-include=/usr/include/postgresql --with-postgresql-lib=/usr/lib \
&gt; --with-ibmdb2=/opt/ibm/db2/V9.7
	</pre><p>
	Please don't forget you must compile and install every time you
	re-configure.
      </p></div><p>
      Please follow the instructions explained 
      </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	    in <a class="xref" href="#Development_setup_PostgreSQL_environment" title="Set-up PostgreSQL environment">the section called âSet-up PostgreSQL environmentâ</a>
	    to set-up a running environment for PostgreSQL server
	</p></li><li style="list-style-type: disc"><p>
	    in <a class="xref" href="#Development_setup_DB2_environment" title="Set-up DB2 environment">the section called âSet-up DB2 environmentâ</a>
	    to set-up a running environment for IBM DB2
	</p></li><li style="list-style-type: disc"><p>
	    in <a class="xref" href="#Development_start_LIXA_server" title="Start the LIXA state server">the section called âStart the LIXA state serverâ</a>
	    to start up the LIXA state server
	</p></li></ul></div><p>
    </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3412385"></a>Build the client program</h3></div></div></div><p>
	Prepare the client (Application Program) using the below commands
	(<span class="command"><strong>gcc</strong></span> command was splitted on several lines 
	using <span class="command"><strong>\</strong></span> to help readability, but you may use
	a single line):
	</p><table xmlns="" frame="box" id="id3412403"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ mkdir tmp
tiian@ubuntu:~$ cd tmp
tiian@ubuntu:~/tmp$ cp /opt/lixa/share/doc/lixa-X.Y.Z/examples/example7_pql_db2.c .
tiian@ubuntu:~/tmp$ gcc example7_pql_db2.c -Wall \
&gt; -I /opt/lixa/include/ -L /opt/lixa/lib/ -l lixac -l lixapq \
&gt; -I /usr/include/postgresql -l pq \
&gt; -I /opt/ibm/db2/V9.7/include/ -L /opt/ibm/db2/V9.7/lib32/ -l db2 \
&gt; -o example7_pql_db2
	  </pre></td></tr></tbody></table><p>
	Verify the executable produced by <span class="command"><strong>gcc</strong></span>:
	</p><table xmlns="" frame="box" id="id3412433"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ldd example7_pql_db2
        linux-gate.so.1 =&gt;  (0xb772a000)
        liblixac.so.0 =&gt; not found
        liblixapq.so.0 =&gt; not found
        libpq.so.5 =&gt; /usr/lib/libpq.so.5 (0xb76fa000)
        libdb2.so.1 =&gt; /usr/lib/libdb2.so.1 (0xb61c8000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb6079000)
        libssl.so.0.9.8 =&gt; /usr/lib/i686/cmov/libssl.so.0.9.8 (0xb6034000)
        libcrypto.so.0.9.8 =&gt; /usr/lib/i686/cmov/libcrypto.so.0.9.8 (0xb5ef2000)
        libkrb5.so.3 =&gt; /usr/lib/libkrb5.so.3 (0xb5e65000)
        libcom_err.so.2 =&gt; /lib/libcom_err.so.2 (0xb5e61000)
        libgssapi_krb5.so.2 =&gt; /usr/lib/libgssapi_krb5.so.2 (0xb5e38000)
        libcrypt.so.1 =&gt; /lib/tls/i686/cmov/libcrypt.so.1 (0xb5e06000)
        libldap_r-2.4.so.2 =&gt; /usr/lib/libldap_r-2.4.so.2 (0xb5dc6000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb5dae000)
        libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0xb5da9000)
        libpam.so.0 =&gt; /lib/libpam.so.0 (0xb5d9f000)
        libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0xb5d7a000)
        libdb2dascmn.so.1 =&gt; /opt/ibm/db2/V9.7/lib32/libdb2dascmn.so.1 (0xb5d4c000)
        libdb2g11n.so.1 =&gt; /opt/ibm/db2/V9.7/lib32/libdb2g11n.so.1 (0xb56de000)
        libdb2genreg.so.1 =&gt; /opt/ibm/db2/V9.7/lib32/libdb2genreg.so.1 (0xb569e000)
        libdb2install.so.1 =&gt; /opt/ibm/db2/V9.7/lib32/libdb2install.so.1 (0xb5693000)
        libdb2locale.so.1 =&gt; /opt/ibm/db2/V9.7/lib32/libdb2locale.so.1 (0xb5680000)
        libdb2osse.so.1 =&gt; /opt/ibm/db2/V9.7/lib32/libdb2osse.so.1 (0xb537a000)
        libdb2osse_db2.so.1 =&gt; /opt/ibm/db2/V9.7/lib32/libdb2osse_db2.so.1 (0xb530a000)
        libdb2trcapi.so.1 =&gt; /opt/ibm/db2/V9.7/lib32/libdb2trcapi.so.1 (0xb52f7000)
        libstdc++.so.6 =&gt; /usr/lib/libstdc++.so.6 (0xb5204000)
        libgcc_s.so.1 =&gt; /lib/libgcc_s.so.1 (0xb51f9000)
        /lib/ld-linux.so.2 (0xb772b000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0xb51e3000)
        libk5crypto.so.3 =&gt; /usr/lib/libk5crypto.so.3 (0xb51c0000)
        libkrb5support.so.0 =&gt; /usr/lib/libkrb5support.so.0 (0xb51b8000)
        libkeyutils.so.1 =&gt; /lib/libkeyutils.so.1 (0xb51b5000)
        libresolv.so.2 =&gt; /lib/tls/i686/cmov/libresolv.so.2 (0xb51a2000)
        liblber-2.4.so.2 =&gt; /usr/lib/liblber-2.4.so.2 (0xb5194000)
        libsasl2.so.2 =&gt; /usr/lib/libsasl2.so.2 (0xb517d000)
        libgnutls.so.13 =&gt; /usr/lib/libgnutls.so.13 (0xb5107000)
        librt.so.1 =&gt; /lib/tls/i686/cmov/librt.so.1 (0xb50fd000)
        libtasn1.so.3 =&gt; /usr/lib/libtasn1.so.3 (0xb50ed000)
        libgcrypt.so.11 =&gt; /lib/libgcrypt.so.11 (0xb50a0000)
        libgpg-error.so.0 =&gt; /lib/libgpg-error.so.0 (0xb509c000)
	  </pre></td></tr></tbody></table><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3412498"></a>Set-up LIXA environment</h3></div></div></div><p>
	There are two unresolved references that can be fixed setting up
	the environment properly:
	</p><table xmlns="" frame="box" id="id3412509"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH

tiian@ubuntu:~/tmp$ export LD_LIBRARY_PATH=/opt/lixa/lib
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH
/opt/lixa/lib
	  </pre></td></tr></tbody></table><p>
	Check again the executable:
	</p><table xmlns="" frame="box" id="id3412532"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ldd example7_pql_db2
        linux-gate.so.1 =&gt;  (0xb774c000)
        liblixac.so.0 =&gt; /opt/lixa/lib/liblixac.so.0 (0xb7731000)
        liblixapq.so.0 =&gt; /opt/lixa/lib/liblixapq.so.0 (0xb772a000)
        libpq.so.5 =&gt; /usr/lib/libpq.so.5 (0xb76fc000)
        libdb2.so.1 =&gt; /usr/lib/libdb2.so.1 (0xb61ca000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb607b000)
        libgmodule-2.0.so.0 =&gt; /usr/lib/libgmodule-2.0.so.0 (0xb6077000)
        libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0xb6073000)
        libgthread-2.0.so.0 =&gt; /usr/lib/libgthread-2.0.so.0 (0xb606e000)
        librt.so.1 =&gt; /lib/tls/i686/cmov/librt.so.1 (0xb6064000)
        libglib-2.0.so.0 =&gt; /usr/lib/libglib-2.0.so.0 (0xb5fb3000)
        libxml2.so.2 =&gt; /usr/lib/libxml2.so.2 (0xb5e93000)
        liblixab.so.0 =&gt; /opt/lixa/lib/liblixab.so.0 (0xb5e7f000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb5e67000)
        libssl.so.0.9.8 =&gt; /usr/lib/i686/cmov/libssl.so.0.9.8 (0xb5e21000)
        libcrypto.so.0.9.8 =&gt; /usr/lib/i686/cmov/libcrypto.so.0.9.8 (0xb5cdf000)
        libkrb5.so.3 =&gt; /usr/lib/libkrb5.so.3 (0xb5c52000)
        libcom_err.so.2 =&gt; /lib/libcom_err.so.2 (0xb5c4f000)
        libgssapi_krb5.so.2 =&gt; /usr/lib/libgssapi_krb5.so.2 (0xb5c26000)
        libcrypt.so.1 =&gt; /lib/tls/i686/cmov/libcrypt.so.1 (0xb5bf3000)
        libldap_r-2.4.so.2 =&gt; /usr/lib/libldap_r-2.4.so.2 (0xb5bb3000)
        libpam.so.0 =&gt; /lib/libpam.so.0 (0xb5ba9000)
        libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0xb5b84000)
        libdb2dascmn.so.1 =&gt; /opt/ibm/db2/V9.7/lib32/libdb2dascmn.so.1 (0xb5b56000)
        libdb2g11n.so.1 =&gt; /opt/ibm/db2/V9.7/lib32/libdb2g11n.so.1 (0xb54e8000)
        libdb2genreg.so.1 =&gt; /opt/ibm/db2/V9.7/lib32/libdb2genreg.so.1 (0xb54a8000)
        libdb2install.so.1 =&gt; /opt/ibm/db2/V9.7/lib32/libdb2install.so.1 (0xb549d000)
        libdb2locale.so.1 =&gt; /opt/ibm/db2/V9.7/lib32/libdb2locale.so.1 (0xb548a000)
        libdb2osse.so.1 =&gt; /opt/ibm/db2/V9.7/lib32/libdb2osse.so.1 (0xb5184000)
        libdb2osse_db2.so.1 =&gt; /opt/ibm/db2/V9.7/lib32/libdb2osse_db2.so.1 (0xb5114000)
        libdb2trcapi.so.1 =&gt; /opt/ibm/db2/V9.7/lib32/libdb2trcapi.so.1 (0xb5101000)
        libstdc++.so.6 =&gt; /usr/lib/libstdc++.so.6 (0xb500e000)
        libgcc_s.so.1 =&gt; /lib/libgcc_s.so.1 (0xb5003000)
        /lib/ld-linux.so.2 (0xb774d000)
        libpcre.so.3 =&gt; /usr/lib/libpcre.so.3 (0xb4fdb000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0xb4fc6000)
        libuuid.so.1 =&gt; /lib/libuuid.so.1 (0xb4fc2000)
        libk5crypto.so.3 =&gt; /usr/lib/libk5crypto.so.3 (0xb4f9f000)
        libkrb5support.so.0 =&gt; /usr/lib/libkrb5support.so.0 (0xb4f97000)
        libkeyutils.so.1 =&gt; /lib/libkeyutils.so.1 (0xb4f93000)
        libresolv.so.2 =&gt; /lib/tls/i686/cmov/libresolv.so.2 (0xb4f80000)
        liblber-2.4.so.2 =&gt; /usr/lib/liblber-2.4.so.2 (0xb4f73000)
        libsasl2.so.2 =&gt; /usr/lib/libsasl2.so.2 (0xb4f5c000)
        libgnutls.so.13 =&gt; /usr/lib/libgnutls.so.13 (0xb4ee6000)
        libtasn1.so.3 =&gt; /usr/lib/libtasn1.so.3 (0xb4ed5000)
        libgcrypt.so.11 =&gt; /lib/libgcrypt.so.11 (0xb4e88000)
        libgpg-error.so.0 =&gt; /lib/libgpg-error.so.0 (0xb4e84000)
	  </pre></td></tr></tbody></table><p>
	Set-up the necessary environment variables:
	</p><table xmlns="" frame="box" id="id3412605"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE

tiian@ubuntu:~/tmp$ export LIXA_PROFILE=PQL_STA_DB2_DYN
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
PQL_STA_DB2_DYN
	  </pre></td></tr></tbody></table><p>
	It is suggested to set the necessary environment variables in your 
	profile if you are going to execute the programs many times.
	This is the list of the suggested variables:
	<code class="varname">LD_LIBRARY_PATH</code>,
	<code class="varname">LIXA_PROFILE</code>,
	<code class="varname">PATH</code>.
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3412640"></a>Some checks before program execution</h3></div></div></div><p>
	We set <code class="varname">LIXA_PROFILE</code> to value
	â<span class="quote">PQL_STA_DB2_DYN</span>â, looking at
	<code class="filename">/opt/lixa/etc/lixac_conf.xml</code>:
	</p><pre class="screen">
    &lt;profile name="PQL_STA_DB2_DYN"&gt;
      &lt;sttsrvs&gt;
        &lt;sttsrv&gt;local_1&lt;/sttsrv&gt;
      &lt;/sttsrvs&gt;
      &lt;rsrmgrs&gt;
        &lt;rsrmgr&gt;PostgreSQL_stareg&lt;/rsrmgr&gt;
        &lt;rsrmgr&gt;IBMDB2_dynreg&lt;/rsrmgr&gt;
      &lt;/rsrmgrs&gt;
    &lt;/profile&gt;
	</pre><p>
	the profile references two Resource Managers:
	â<span class="quote">PostgreSQL_stareg</span>â and â<span class="quote">IBMDB2_dynreg</span>â, 
	looking again at the config file:
	</p><pre class="screen">
    &lt;rsrmgr name="PostgreSQL_stareg" switch_file="/opt/lixa/lib/switch_postgresql_stareg.so" xa_open_info="dbname=testdb" xa_close_info="" /&gt;
    &lt;rsrmgr name="IBMDB2_dynreg" switch_file="/opt/lixa/lib/switch_ibmdb2_dynreg.so" xa_open_info="axlib=/opt/lixa/lib/liblixac.so,db=sample,tpm=lixa" xa_close_info="" /&gt;
	</pre><p>
	we can discover how our application will access the resource
	managers
	<sup>[<a id="id3412688" href="#ftn.id3412688" class="footnote">23</a>]</sup>
	<sup>[<a id="id3412714" href="#ftn.id3412714" class="footnote">24</a>]</sup>. 
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3412747"></a>Program execution (dynamic registration)</h3></div></div></div><p>
	It is suggested to open three different terminals: 
	the first one connected to â<span class="quote">TESTDB</span>â PostgreSQL database,
	the second one connected to â<span class="quote">SAMPLE</span>â DB2 database
	and the	third one pointing to the directory where the compiled program 
	example7_pql_db2 lives.
	</p><table xmlns="" frame="box" id="id3412773"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ psql testdb
Welcome to psql 8.3.15, the PostgreSQL interactive terminal.

Type:  \copyright for distribution terms
       \h for help with SQL commands
       \? for help with psql commands
       \g or terminate with semicolon to execute query
       \q to quit

testdb=&gt;
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3412798"><thead><tr><td>[IBM DB2 terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ . /home/db2inst1/sqllib/db2profile
tiian@ubuntu:~$ db2
(c) Copyright IBM Corporation 1993,2007
Command Line Processor for DB2 Client 9.7.1

You can issue database manager commands and SQL statements from the command
prompt. For example:
    db2 =&gt; connect to sample
    db2 =&gt; bind sample.bnd

For general help, type: ?.
For command help, type: ? command, where command can be
the first few keywords of a database manager command. For example:
 ? CATALOG DATABASE for help on the CATALOG DATABASE command
 ? CATALOG          for help on all of the CATALOG commands.

To exit db2 interactive mode, type QUIT at the command prompt. Outside
interactive mode, all commands must be prefixed with 'db2'.
To list the current command option settings, type LIST COMMAND OPTIONS.

For more detailed help, refer to the Online Reference Manual.

db2 =&gt; connect to SAMPLE

   Database Connection Information

 Database server        = DB2/LINUX 9.7.1
 SQL authorization ID   = TIIAN
 Local database alias   = SAMPLE

db2 =&gt;
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3412832"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ls -la
total 32
drwxr-xr-x  2 tiian tiian  4096 2011-09-25 17:11 .
drwxr-xr-x 40 tiian tiian  4096 2011-09-22 22:24 ..
-rwxr-xr-x  1 tiian tiian 12429 2011-09-22 22:47 example7_pql_db2
-rw-r--r--  1 tiian tiian  7541 2011-09-22 22:46 example7_pql_db2.c
	  </pre></td></tr></tbody></table><p>
	Check the content of the PostgreSQL table (â<span class="quote">AUTHORS</span>â):
	</p><table xmlns="" frame="box" id="id3412859"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from AUTHORS;
 id | last_name | first_name
----+-----------+------------
(0 rows)
	  </pre></td></tr></tbody></table><p>
	Check the content of the DB2 tables (â<span class="quote">DB2INST1.ORG</span>â and
	â<span class="quote">DB2INST1.DEPT</span>â):
	</p><table xmlns="" frame="box" id="id3412888"><thead><tr><td>[IBM DB2 terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
db2 =&gt; select * from DB2INST1.ORG where DEPTNUMB = 150

DEPTNUMB DEPTNAME       MANAGER DIVISION   LOCATION
-------- -------------- ------- ---------- -------------

  0 record(s) selected.

db2 =&gt; select * from DB2INST1.DEPT where DEPTNO='Z99'

DEPTNO DEPTNAME                             MGRNO  ADMRDEPT LOCATION
------ ------------------------------------ ------ -------- ----------------

  0 record(s) selected.
	  </pre></td></tr></tbody></table><p>
	Insert a row in PostgreSQL â<span class="quote">AUTHORS</span>â table and in
	DB2 â<span class="quote">ORG</span>â table and check the contents of the tables
	after the transaction execution:
	</p><table xmlns="" frame="box" id="id3412924"><thead><tr><td>[Third terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ . /home/db2inst1/sqllib/db2profile
tiian@ubuntu:~/tmp$ ./example7_pql_db2 insert org
Executing DB2 statement 'INSERT INTO DB2INST1.ORG(DEPTNUMB, DEPTNAME, MANAGER, DIVISION, LOCATION) VALUES(150, 'Europe', 231, 'R&amp;D', 'Mojan')'...
Executing PostgreSQL statement 'INSERT INTO authors VALUES(1, 'Foo', 'Bar');'...	  </pre></td></tr></tbody></table><p>
	Now you can verify the content of the tables after the transaction:
	</p><table xmlns="" frame="box" id="id3412951"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from authors;
 id | last_name | first_name
----+-----------+------------
  1 | Foo       | Bar
(1 row)
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3412971"><thead><tr><td>[IBM DB2 terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
db2 =&gt; select * from DB2INST1.ORG where DEPTNUMB = 150

DEPTNUMB DEPTNAME       MANAGER DIVISION   LOCATION
-------- -------------- ------- ---------- -------------
     150 Europe             231 R&amp;D        Mojan

  1 record(s) selected.
	  </pre></td></tr></tbody></table><p>
	If you try to insert the same row again you can verify an automatic
	rollback due to an error thrown by the second resource manager:
	</p><table xmlns="" frame="box" id="id3412997"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example7_pql_db2 insert org
Executing DB2 statement 'INSERT INTO DB2INST1.ORG(DEPTNUMB, DEPTNAME, MANAGER, DIVISION, LOCATION) VALUES(150, 'Europe', 231, 'R&amp;D', 'Mojan')'...
Executing PostgreSQL statement 'INSERT INTO authors VALUES(1, 'Foo', 'Bar');'...
PostgreSQL error: ERROR:  duplicate key value violates unique constraint "authors_pkey"
	  </pre></td></tr></tbody></table><p>
	DB2 table (â<span class="quote">ORG</span>â) allows multiple rows, PostgreSQL table
	(â<span class="quote">AUTHORS</span>â) does not allow multiple rows: the error stops
	the program execution and the resource managers automatically
	rollback the changes. You can verify there is only one row in the
	tables:
	</p><table xmlns="" frame="box" id="id3413031"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from authors;
 id | last_name | first_name
----+-----------+------------
  1 | Foo       | Bar
(1 row)
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3413054"><thead><tr><td>[IBM DB2 terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
db2 =&gt; select * from DB2INST1.ORG where DEPTNUMB = 150

DEPTNUMB DEPTNAME       MANAGER DIVISION   LOCATION
-------- -------------- ------- ---------- -------------
     150 Europe             231 R&amp;D        Mojan

  1 record(s) selected.
	  </pre></td></tr></tbody></table><p>
	You can easily verify there are no prepared transactions inside
	PostgreSQL database:
	</p><table xmlns="" frame="box" id="id3413078"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from pg_prepared_xacts;
 transaction | gid | prepared | owner | database
-------------+-----+----------+-------+----------
(0 rows)
	  </pre></td></tr></tbody></table><p>
	We can verify that DB2 is using dynamic registration:
	</p><table xmlns="" frame="box" id="id3413101"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LIXA_TRACE_MASK=0x00002000
tiian@ubuntu:~/tmp$ echo $LIXA_TRACE_MASK
0x00002000
tiian@ubuntu:~/tmp$ ./example7_pql_db2 delete org 2&gt;&amp;1 | grep ax_reg
2011-09-25 18:15:38.499702 [13586/3035527472] ax_reg: rmid=1, xid=0xbf9b2630, flags=0x0
2011-09-25 18:15:38.500405 [13586/3035527472] ax_reg: the application program has started a transaction (TX states S3); this XID '4c495841.0565b518222345ba852b4c4a09a660ae.725d0414e912e62f9ef42209ef693f36' will be returned
2011-09-25 18:15:38.500970 [13586/3035527472] ax_reg: sending 153 bytes to the server for step 8
2011-09-25 18:15:38.501415 [13586/3035527472] ax_reg/excp=7/ret_cod=0/errno=0
	  </pre></td></tr></tbody></table><p>
	If you used â<span class="quote">PQL_STA_DB2_STA</span>â profile instead of 
	â<span class="quote">PQL_STA_DB2_DYN</span>â you could switch the DB2 to
	static behavior.
      </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	  Combining the previous two examples you can realize a program that
	  access 3 resource managers: PostgreSQL, Oracle and DB2.
	  It is left as an exercise to the reader.
      </p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="Development_example8_mys"></a>An example with MySQL</h2></div></div></div><div class="figure"><a id="develop8"></a><p class="title"><b>FigureÂ 5.8.Â Deploy model of an example with MySQL DBMS</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Development_8.png" alt="Deploy model of an example with MySQL DBMS" /></div></div></div><br class="figure-break" /><p>
      This example was developed using MySQL 5.0.51a for Linux (Ubuntu).
      If you were using a different version you would need to adapt some
      commands to your environment.
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	If you did not yet installed the software, please refer to the 
	official site for your Linux distribution or to the official site
	of MySQL if your operating system does not distribute the
	software or you want to use a different MySQL version.
	Using Ubuntu Linux this packages are necessary:
	</p><div class="variablelist"><dl><dt><span class="term"><span class="package">mysql-server</span></span></dt><dd><p>
		MySQL server
	    </p></dd><dt><span class="term"><span class="package">libmysqlclient15-dev</span></span></dt><dd><p>
		MySQL C client development library
	    </p></dd></dl></div><p>
	This manual does not give you information related
	to MySQL: it is assumed you already installed and
	configured the database
	<sup>[<a id="id3413223" href="#ftn.id3413223" class="footnote">25</a>]</sup>.
    </p></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	This example uses a client running in the same host used by
	MySQL server: this is not a technical limitation, but a way to
	make it easy. Client/server configuration must work as well: 
	please refer to the database documentation.
    </p></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
	The LIXA software must be configured to support the MySQL 
	server resource manager as explained in 
	<a class="xref" href="#Linking_third_party_resource_managers" title="Linking third party resource managers">the section called âLinking third party resource managersâ</a>.
    </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="Development_setup_MySQL_environment"></a>Set-up MySQL environment</h3></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="id3413258"></a>Start-up the MySQL server</h4></div></div></div><p>
	  If your server didn't start-up automatically at boot time, you
	  could start it with the following commands:
	  </p><table xmlns="" frame="box" id="id3413278"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@mojan:~$ sudo /etc/init.d/mysql start
 * Starting MySQL database server mysqld                                 [ OK ] 
 * Checking for corrupt, not cleanly closed and upgrade needing tables.
tiian@mojan:~$ ps -ef|grep mysql|grep -v grep
root      7666     1  0 21:52 ?        00:00:26 /bin/sh /usr/bin/mysqld_safe
root      9060     1  0 22:46 pts/1    00:00:00 /bin/sh /usr/bin/mysqld_safe
mysql     9099  9060  1 22:46 pts/1    00:00:00 /usr/sbin/mysqld --basedir=/usr --datadir=/var/lib/mysql --user=mysql --pid-file=/var/run/mysqld/mysqld.pid --skip-external-locking --port=3306 --socket=/var/run/mysqld/mysqld.sock
root      9101  9060  0 22:46 pts/1    00:00:00 logger -p daemon.err -t mysqld_safe -i -t mysqld
	    </pre></td></tr></tbody></table><p>
	  Create a new user authorization and a new database
	  <sup>[<a id="id3413313" href="#ftn.id3413313" class="footnote">26</a>]</sup>:
	  </p><table xmlns="" frame="box" id="id3413319"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ mysql -u root -p
Enter password:
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 1
Server version: 5.0.51a-3ubuntu5.8 (Ubuntu)

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql&gt; GRANT ALL ON lixa.* TO 'lixa'@'localhost';
Query OK, 0 rows affected (0.00 sec)

mysql&gt; CREATE DATABASE lixa;
Query OK, 1 row affected (0.00 sec)

mysql&gt; quit
Bye
	    </pre></td></tr></tbody></table><p>
	  The <code class="systemitem">lixa@localhost</code> user
	  has been created with all privileges on the â<span class="quote">lixa</span>â
	  database. Now a sample table must be created using this new user:
	  </p><table xmlns="" frame="box" id="id3413354"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ mysql -h localhost -u lixa lixa
Enter password:
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 3
Server version: 5.0.51a-3ubuntu5.8 (Ubuntu)

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql&gt; SELECT DATABASE();
+------------+
| DATABASE() |
+------------+
| lixa       |
+------------+
1 row in set (0.01 sec)

mysql&gt; CREATE TABLE authors (id INTEGER NOT NULL PRIMARY KEY, last_name TEXT, first_name TEXT) ENGINE=InnoDB;
Query OK, 0 rows affected (0.02 sec)

mysql&gt; DESCRIBE authors;
+------------+---------+------+-----+---------+-------+
| Field      | Type    | Null | Key | Default | Extra |
+------------+---------+------+-----+---------+-------+
| id         | int(11) | NO   | PRI | NULL    |       |
| last_name  | text    | YES  |     | NULL    |       |
| first_name | text    | YES  |     | NULL    |       |
+------------+---------+------+-----+---------+-------+
3 rows in set (0.00 sec)

mysql&gt; select * from authors;
Empty set (0.00 sec)
	    </pre></td></tr></tbody></table><p>
	  OK, the â<span class="quote">authors</span>â table was created using 
	  the â<span class="quote">InnoDB</span>â engine. 
	  If something went wrong, you should refer to MySQL
	  documentation to fix the issue before the next step because
	  you would not be able to execute the sample program without a
	  basic running installation.
	</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3413406"></a>Start the LIXA state server</h3></div></div></div><p>
	Start the state server as shown below:
	</p><table xmlns="" frame="box" id="id3413413"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ sudo su - lixa
lixa@ubuntu:~$ /opt/lixa/sbin/lixad --daemon
lixa@ubuntu:~$ exit
logout
tiian@ubuntu:~$ ps -ef|grep lixad|grep -v grep
lixa     12866     1  0 21:35 ?        00:00:00 /opt/lixa/sbin/lixad --daemon
	  </pre></td></tr></tbody></table><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3413441"></a>Build the client program</h3></div></div></div><p>
	Prepare the client (Application Program) using the below commands
	(<span class="command"><strong>gcc</strong></span> command was splitted on several lines 
	using <span class="command"><strong>\</strong></span> to help readability, but you may use
	a single line):
	</p><table xmlns="" frame="box" id="id3413461"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ mkdir tmp
tiian@ubuntu:~$ cd tmp
tiian@ubuntu:~/tmp$ cp /opt/lixa/share/doc/lixa-X.Y.Z/examples/example8_mys.c .
tiian@ubuntu:~/tmp$ gcc example8_mys.c -Wall -I /opt/lixa/include/ \
&gt; -L /opt/lixa/lib/ -l lixac -l lixamy \
&gt; $(mysql_config --include --libs_r) -o example8_mys
	  </pre></td></tr></tbody></table><p>
	Verify the executable produced by <span class="command"><strong>gcc</strong></span>:
	</p><table xmlns="" frame="box" id="id3413489"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ldd example8_mys
        linux-gate.so.1 =&gt;  (0xb7780000)
        liblixac.so.0 =&gt; not found
        liblixamy.so.0 =&gt; not found
        libmysqlclient.so.15 =&gt; /usr/lib/libmysqlclient.so.15 (0xb758f000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb7440000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb7428000)
        libcrypt.so.1 =&gt; /lib/tls/i686/cmov/libcrypt.so.1 (0xb73f6000)
        libnsl.so.1 =&gt; /lib/tls/i686/cmov/libnsl.so.1 (0xb73de000)
        libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0xb73b8000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0xb73a3000)
        /lib/ld-linux.so.2 (0xb7781000)
	  </pre></td></tr></tbody></table><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3413520"></a>Set-up LIXA environment</h3></div></div></div><p>
	There are two unresolved references to liblixac.so.0 and 
	liblixamy.so.0: they can be fixed 
	setting up the proper environment variable:
	</p><table xmlns="" frame="box" id="id3413530"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH

tiian@ubuntu:~/tmp$ export LD_LIBRARY_PATH=/opt/lixa/lib
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH
/opt/lixa/lib
	  </pre></td></tr></tbody></table><p>
	Check again the executable:
	</p><table xmlns="" frame="box" id="id3413555"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ldd example8_mys
        linux-gate.so.1 =&gt;  (0xb7737000)
        liblixac.so.0 =&gt; /opt/lixa/lib/liblixac.so.0 (0xb771c000)
        liblixamy.so.0 =&gt; /opt/lixa/lib/liblixamy.so.0 (0xb7714000)
        libmysqlclient_r.so.15 =&gt; /usr/lib/libmysqlclient_r.so.15 (0xb7523000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb73d4000)
        libgmodule-2.0.so.0 =&gt; /usr/lib/libgmodule-2.0.so.0 (0xb73d0000)
        libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0xb73cc000)
        libgthread-2.0.so.0 =&gt; /usr/lib/libgthread-2.0.so.0 (0xb73c7000)
        librt.so.1 =&gt; /lib/tls/i686/cmov/librt.so.1 (0xb73bd000)
        libglib-2.0.so.0 =&gt; /usr/lib/libglib-2.0.so.0 (0xb730c000)
        libxml2.so.2 =&gt; /usr/lib/libxml2.so.2 (0xb71ec000)
        liblixab.so.0 =&gt; /opt/lixa/lib/liblixab.so.0 (0xb71d7000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb71bf000)
        libcrypt.so.1 =&gt; /lib/tls/i686/cmov/libcrypt.so.1 (0xb718d000)
        libnsl.so.1 =&gt; /lib/tls/i686/cmov/libnsl.so.1 (0xb7174000)
        libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0xb714f000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0xb713a000)
        /lib/ld-linux.so.2 (0xb7738000)
        libpcre.so.3 =&gt; /usr/lib/libpcre.so.3 (0xb7113000)
        libuuid.so.1 =&gt; /lib/libuuid.so.1 (0xb710f000)
	  </pre></td></tr></tbody></table><p>
	Set-up the <code class="varname">LIXA_PROFILE</code> environment variable:
	</p><table xmlns="" frame="box" id="id3413599"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE

tiian@ubuntu:~/tmp$ export LIXA_PROFILE=MYS_STA
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
MYS_STA
	  </pre></td></tr></tbody></table><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="Development_setup_MySQL_xa_open_info"></a>Some checks before program execution</h3></div></div></div><p>
	We set <code class="varname">LIXA_PROFILE</code> to value
	â<span class="quote">MYS_STA</span>â, looking at
	<code class="filename">/opt/lixa/etc/lixac_conf.xml</code>:
	</p><pre class="screen">
    &lt;profile name="MYS_STA"&gt;
      &lt;sttsrvs&gt;
        &lt;sttsrv&gt;local_1&lt;/sttsrv&gt;
      &lt;/sttsrvs&gt;
      &lt;rsrmgrs&gt;
        &lt;rsrmgr&gt;MySQL_stareg&lt;/rsrmgr&gt;
      &lt;/rsrmgrs&gt;
    &lt;/profile&gt;
	</pre><p>
	the profile references the Resource Manager named
	â<span class="quote">MySQL_stareg</span>â, looking again at the config file:
	</p><pre class="screen">
    &lt;rsrmgr name="MySQL_stareg" switch_file="/opt/lixa/lib/switch_mysql_stareg.so" xa_open_info="host=localhost,user=lixa,passwd=,db=lixa,client_flag=0" xa_close_info="" /&gt;
	</pre><p>
	we can discover how LIXA is configured to access the MySQL database.
	The content of <code class="constant">xa_open_info</code> is passed to
	<a class="ulink" href="http://dev.mysql.com/doc/refman/5.0/en/mysql-real-connect.html" target="_top"><code class="function">mysql_real_connect</code></a>
	function after some parsing has occurred.
	This is the prototype of the <code class="function">mysql_real_connect</code>
	function as described in the official manual
	</p><div class="funcsynopsis"><p><code class="funcdef">MYSQL *<b class="fsfunc">mysql_real_connect</b>(</code>const char *<var class="pdparam">host</var>, const char *<var class="pdparam">passwd</var>, const char *<var class="pdparam">db</var>, unsigned int <var class="pdparam">port</var>, const char *<var class="pdparam">unix_socket</var>, unsigned long <var class="pdparam">client_flag</var><code>)</code>;</p></div><p>
	and these are the tokens accepted by LIXA inside 
	<code class="constant">xa_open_info</code>:
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	      <em class="parameter"><code>host</code></em>: a string of characters
	  </p></li><li style="list-style-type: disc"><p>
	      <em class="parameter"><code>user</code></em>: a string of characters
	  </p></li><li style="list-style-type: disc"><p>
	      <em class="parameter"><code>passwd</code></em>: a string of characters
	  </p></li><li style="list-style-type: disc"><p>
	      <em class="parameter"><code>db</code></em>: a string of characters
	  </p></li><li style="list-style-type: disc"><p>
	      <em class="parameter"><code>port</code></em>: a number
	  </p></li><li style="list-style-type: disc"><p>
	      <em class="parameter"><code>unix_socket</code></em>: a string of characters
	  </p></li><li style="list-style-type: disc"><p>
	      <em class="parameter"><code>client_flag</code></em>: a number
	  </p></li></ul></div><p>
	As shown in the above example, this is the syntax that applies to
	<code class="constant">xa_open_info</code>:
	</p><div class="orderedlist"><ol type="1"><li><p>
	      an element is composed by
	      <span class="token">&lt;token&gt;</span>=<span class="token">&lt;value&gt;</span> where 
	      <span class="token">&lt;token&gt;</span> is one of the keywords listed above
	  </p></li><li><p>
	      a comma â<span class="quote">,</span>â separates two elements 
	  </p></li><li><p>
	      <span class="token">&lt;value&gt;</span> may be empty 
	      (like <code class="constant">passwd</code> 
	      in the above example): it will passed as an empty string ("")
	      to <code class="function">mysql_real_connect</code>
	  </p></li><li><p>
	      if a <span class="token">&lt;token&gt;</span> is not specified in 
	      <code class="constant">xa_open_info</code>, LIXA will pass to 
	      <code class="function">mysql_real_connect</code> a NULL pointer if the
	      missing token refers to a character string and 0 value if the
	      missing token refers to a number
	  </p></li><li><p>
	      if you must put an equal symbol ("=") inside 
	      <span class="token">&lt;value&gt;</span>
	      you must put two instead of one: "=="
	  </p></li><li><p>
	      if you must put a comma symbol (",") inside 
	      <span class="token">&lt;value&gt;</span>
	      you must put two instead of one: ",,"
	  </p></li><li><p>
	      all control characters like space, tab, newline and so on, are
	      passed as is without any modification
	  </p></li></ol></div><p>
	Using this configuration:
	<code class="constant">xa_open_info="host=localhost,user=lixa,passwd=,db=lixa,client_flag=0"</code>
	LIXA will call <code class="function">mysql_real_connect</code> as
      </p><p>
	<code class="function">mysql_real_connect</code>(<em class="parameter"><code>conn</code></em>,
	<em class="parameter"><code>"localhost"</code></em>, <em class="parameter"><code>"lixa"</code></em>,
	<em class="parameter"><code>""</code></em>, <em class="parameter"><code>"lixa"</code></em>,
	<em class="parameter"><code>0</code></em>, <em class="parameter"><code>NULL</code></em>,
	<em class="parameter"><code>0</code></em>)
      </p><p>
	You should refer to MySQL official documentation to discover how you
	can configure <code class="constant">xa_open_info</code>.
	</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
	    <code class="constant">xa_open_info</code> can contain a maximum of 255
	    characters (plus \0 string terminator); if you need more space,
	    consider to move some parameters to <code class="filename">mycnf</code> file
	    (see MySQL official documentation to pick-up the details).
	</p></div><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3413999"></a>Program execution</h3></div></div></div><p>
	It is suggested to open two different terminals: the first one
	connected to â<span class="quote">lixa</span>â MySQL database and the second
	one pointing to the directory where the compiled program
	<code class="filename">example8_mys</code> lives.
	First teminal session:
	</p><table xmlns="" frame="box" id="id3414019"><thead><tr><td>[MySQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ mysql -h localhost -u lixa lixa
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 7
Server version: 5.0.51a-3ubuntu5.8 (Ubuntu)

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql&gt;
	  </pre></td></tr></tbody></table><p>
	Second teminal session:
	</p><table xmlns="" frame="box" id="id3414036"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ls -la
total 21
drwxr-xr-x   2 tiian tiian  112 2011-09-14 21:14 .
drwxrwx--x 101 tiian tiian 5064 2011-09-14 21:13 ..
-rwxr-xr-x  1 tiian tiian  8828 2011-11-02 15:01 example8_mys
-rw-r--r--  1 tiian tiian  3174 2011-11-02 15:00 example8_mys.c
	  </pre></td></tr></tbody></table><p>
	Check the content of â<span class="quote">authors</span>â table before
	program execution:
	</p><table xmlns="" frame="box" id="id3414074"><thead><tr><td>[MySQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; SELECT * FROM authors;
Empty set (0.04 sec)
	  </pre></td></tr></tbody></table><p>
	Execute the program:
	</p><table xmlns="" frame="box" id="id3414096"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example8_mys insert
Inserting a row in the table...
	  </pre></td></tr></tbody></table><p>
	Check the content of the table again:
	</p><table xmlns="" frame="box" id="id3414109"><thead><tr><td>[MySQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; SELECT * FROM authors;
+----+-----------+------------+
| id | last_name | first_name |
+----+-----------+------------+
|  1 | Foo       | Bar        |
+----+-----------+------------+
1 row in set (0.00 sec)
	  </pre></td></tr></tbody></table><p>
	The example program inserted the row with id=1. You can not insert
	the same row twice because there is a unique constraint on this table,
	but you can remove the row using
	</p><table xmlns="" frame="box" id="id3414143"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example8_mys delete
Deleting a row from the table...
	  </pre></td></tr></tbody></table><p>
	Check the table content again:
	</p><table xmlns="" frame="box" id="id3414152"><thead><tr><td>[MySQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; SELECT * FROM authors;
Empty set (0.00 sec)
	  </pre></td></tr></tbody></table><p>
	you can verify in file
	<code class="filename">/opt/lixa/etc/lixac_conf.xml</code>
	that â<span class="quote">MYS_STA</span>â is associated to static registration
	<sup>[<a id="id3414190" href="#ftn.id3414190" class="footnote">27</a>]</sup>
	.
	Execute the program:
	</p><table xmlns="" frame="box" id="id3414196"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LIXA_TRACE_MASK=0x00002000
tiian@ubuntu:~/tmp$ echo $LIXA_TRACE_MASK
0x00002000
tiian@ubuntu:~/tmp$ ./example8_mys insert 2&gt;&amp;1 | grep xa_start
2011-11-02 22:10:45.425495 [25927/3069150960] lixa_xa_start
[...]
2011-11-02 22:10:45.473079 [25927/3069150960] lixa_xa_start: xa_start_entry(xid, 0, 0x0) = 0
2011-11-02 22:10:45.473633 [25927/3069150960] lixa_xa_start: sending 210 bytes to the server for step 24
2011-11-02 22:10:45.474534 [25927/3069150960] lixa_xa_start/excp=10/ret_cod=0/errno=0
	  </pre></td></tr></tbody></table><p>
	Finally, clean up the table again:
	</p><table xmlns="" frame="box" id="id3414226"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ unset LIXA_TRACE_MASK
tiian@ubuntu:~/tmp$ ./example8_mys delete
Deleting a row from the table...
	  </pre></td></tr></tbody></table><p>
      </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="Development_example9_mys_pql"></a>An example with MySQL &amp; PostgreSQL</h2></div></div></div><div class="figure"><a id="develop9"></a><p class="title"><b>FigureÂ 5.9.Â Deploy model of an example showing a distributed transaction with
	MySQL and PostgreSQL</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Development_9.png" alt="Deploy model of an example showing a distributed transaction with MySQL and PostgreSQL" /></div></div></div><br class="figure-break" /><p>
      This example shows as
      you can implement DTP (Distributed Transaction Processing) with two
      Resource Managers (MySQL and PostgreSQL)
      coordinated by the LIXA Transaction Manager.
      It's strongly suggested you have played with the
      examples previously shown in this chapter (see
      <a class="xref" href="#Development" title="ChapterÂ 5.Â Development">ChapterÂ 5, <i>Development</i></a>) before starting this more complex one.
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	If you did not yet installed the software provided by PostgreSQL,
	please refer to the official PostgreSQL site to download the
	software and to pick-up the information necessary to install 
	and configure
	the database. This manual does not give you information related
	to PostgreSQL technology: it is assumed you already installed and
	configured the database.
      </p><p>
	If you did not yet installed the software provided by MySQL,
	please refer to the official MySQL site to download the
	software and to pick-up the information necessary to install 
	and configure
	the database. This manual does not give you information related
	to MySQL technology: it is assumed you already installed and
	configured the database.
      </p></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
	The LIXA software must be configured to support the MySQL and 
	PostgreSQL and resource managers as explained in 
	<a class="xref" href="#Linking_third_party_resource_managers" title="Linking third party resource managers">the section called âLinking third party resource managersâ</a>.
	As a little hint, you should configure LIXA as below:
	</p><pre class="screen">
./configure --with-mysql \
&gt; --with-postgresql-include=/usr/include/postgresql --with-postgresql-lib=/usr/lib
	</pre><p>
	Please don't forget you must compile and install every time you
	re-configure.
      </p></div><p>
      Please follow the instructions explained 
      </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	    in <a class="xref" href="#Development_setup_MySQL_environment" title="Set-up MySQL environment">the section called âSet-up MySQL environmentâ</a>
	    to set-up a running environment for MySQL server
	</p></li><li style="list-style-type: disc"><p>
	    in <a class="xref" href="#Development_setup_PostgreSQL_environment" title="Set-up PostgreSQL environment">the section called âSet-up PostgreSQL environmentâ</a>
	    to set-up a running environment for PostgreSQL server
	</p></li><li style="list-style-type: disc"><p>
	    in <a class="xref" href="#Development_start_LIXA_server" title="Start the LIXA state server">the section called âStart the LIXA state serverâ</a>
	    to start up the LIXA state server
	</p></li></ul></div><p>
    </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3414383"></a>Build the client program</h3></div></div></div><p>
	Prepare the client (Application Program) using the below commands
	(<span class="command"><strong>gcc</strong></span> command was splitted on several lines 
	using <span class="command"><strong>\</strong></span> to help readability, but you may use
	a single line):
	</p><table xmlns="" frame="box" id="id3414403"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ mkdir tmp
tiian@ubuntu:~$ cd tmp
tiian@ubuntu:~/tmp$ cp /opt/lixa/share/doc/lixa-X.Y.Z/examples/example9_mys_pql.c .
tiian@ubuntu:~/tmp$ gcc example9_mys_pql.c -Wall \
&gt; -I /opt/lixa/include/ -L /opt/lixa/lib/ -l lixac -l lixamy -l lixapq \
&gt; $(mysql_config --include --libs_r) \
&gt; -I /usr/include/postgresql -l pq \
&gt; -o example9_mys_pql
	  </pre></td></tr></tbody></table><p>
	Verify the executable produced by <span class="command"><strong>gcc</strong></span>:
	</p><table xmlns="" frame="box" id="id3414434"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ldd example9_mys_pql
        linux-gate.so.1 =&gt;  (0xb77aa000)
        liblixac.so.0 =&gt; not found
        liblixamy.so.0 =&gt; not found
        liblixapq.so.0 =&gt; not found
        libmysqlclient_r.so.15 =&gt; /usr/lib/libmysqlclient_r.so.15 (0xb75b7000)
        libpq.so.5 =&gt; /usr/lib/libpq.so.5 (0xb7598000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb7449000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb7431000)
        libcrypt.so.1 =&gt; /lib/tls/i686/cmov/libcrypt.so.1 (0xb73fe000)
        libnsl.so.1 =&gt; /lib/tls/i686/cmov/libnsl.so.1 (0xb73e6000)
        libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0xb73c1000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0xb73ac000)
        libssl.so.0.9.8 =&gt; /usr/lib/i686/cmov/libssl.so.0.9.8 (0xb7367000)
        libcrypto.so.0.9.8 =&gt; /usr/lib/i686/cmov/libcrypto.so.0.9.8 (0xb7224000)
        libkrb5.so.3 =&gt; /usr/lib/libkrb5.so.3 (0xb7197000)
        libcom_err.so.2 =&gt; /lib/libcom_err.so.2 (0xb7194000)
        libgssapi_krb5.so.2 =&gt; /usr/lib/libgssapi_krb5.so.2 (0xb716b000)
        libldap_r-2.4.so.2 =&gt; /usr/lib/libldap_r-2.4.so.2 (0xb712b000)
        /lib/ld-linux.so.2 (0xb77ab000)
        libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0xb7126000)
        libk5crypto.so.3 =&gt; /usr/lib/libk5crypto.so.3 (0xb7103000)
        libkrb5support.so.0 =&gt; /usr/lib/libkrb5support.so.0 (0xb70fb000)
        libkeyutils.so.1 =&gt; /lib/libkeyutils.so.1 (0xb70f8000)
        libresolv.so.2 =&gt; /lib/tls/i686/cmov/libresolv.so.2 (0xb70e5000)
        liblber-2.4.so.2 =&gt; /usr/lib/liblber-2.4.so.2 (0xb70d7000)
        libsasl2.so.2 =&gt; /usr/lib/libsasl2.so.2 (0xb70c0000)
        libgnutls.so.13 =&gt; /usr/lib/libgnutls.so.13 (0xb704a000)
        libtasn1.so.3 =&gt; /usr/lib/libtasn1.so.3 (0xb703a000)
        libgcrypt.so.11 =&gt; /lib/libgcrypt.so.11 (0xb6fed000)
        libgpg-error.so.0 =&gt; /lib/libgpg-error.so.0 (0xb6fe8000)
	  </pre></td></tr></tbody></table><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3414448"></a>Set-up LIXA environment</h3></div></div></div><p>
	There are three unresolved references that can be fixed setting up
	the environment properly:
	</p><table xmlns="" frame="box" id="id3414496"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH

tiian@ubuntu:~/tmp$ export LD_LIBRARY_PATH=/opt/lixa/lib
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH
/opt/lixa/lib
	  </pre></td></tr></tbody></table><p>
	Check again the executable:
	</p><table xmlns="" frame="box" id="id3414520"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ldd example9_mys_pql
        linux-gate.so.1 =&gt;  (0xb76f6000)
        liblixac.so.0 =&gt; /opt/lixa/lib/liblixac.so.0 (0xb76db000)
        liblixamy.so.0 =&gt; /opt/lixa/lib/liblixamy.so.0 (0xb76d3000)
        liblixapq.so.0 =&gt; /opt/lixa/lib/liblixapq.so.0 (0xb76cb000)
        libmysqlclient_r.so.15 =&gt; /usr/lib/libmysqlclient_r.so.15 (0xb74db000)
        libpq.so.5 =&gt; /usr/lib/libpq.so.5 (0xb74bc000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb736d000)
        libgmodule-2.0.so.0 =&gt; /usr/lib/libgmodule-2.0.so.0 (0xb7369000)
        libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0xb7365000)
        libgthread-2.0.so.0 =&gt; /usr/lib/libgthread-2.0.so.0 (0xb735f000)
        librt.so.1 =&gt; /lib/tls/i686/cmov/librt.so.1 (0xb7356000)
        libglib-2.0.so.0 =&gt; /usr/lib/libglib-2.0.so.0 (0xb72a5000)
        libxml2.so.2 =&gt; /usr/lib/libxml2.so.2 (0xb7185000)
        liblixab.so.0 =&gt; /opt/lixa/lib/liblixab.so.0 (0xb7170000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb7157000)
        libcrypt.so.1 =&gt; /lib/tls/i686/cmov/libcrypt.so.1 (0xb7125000)
        libnsl.so.1 =&gt; /lib/tls/i686/cmov/libnsl.so.1 (0xb710d000)
        libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0xb70e8000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0xb70d3000)
        libssl.so.0.9.8 =&gt; /usr/lib/i686/cmov/libssl.so.0.9.8 (0xb708e000)
        libcrypto.so.0.9.8 =&gt; /usr/lib/i686/cmov/libcrypto.so.0.9.8 (0xb6f4b000)
        libkrb5.so.3 =&gt; /usr/lib/libkrb5.so.3 (0xb6ebe000)
        libcom_err.so.2 =&gt; /lib/libcom_err.so.2 (0xb6ebb000)
        libgssapi_krb5.so.2 =&gt; /usr/lib/libgssapi_krb5.so.2 (0xb6e92000)
        libldap_r-2.4.so.2 =&gt; /usr/lib/libldap_r-2.4.so.2 (0xb6e52000)
        /lib/ld-linux.so.2 (0xb76f7000)
        libpcre.so.3 =&gt; /usr/lib/libpcre.so.3 (0xb6e2a000)
        libuuid.so.1 =&gt; /lib/libuuid.so.1 (0xb6e26000)
        libk5crypto.so.3 =&gt; /usr/lib/libk5crypto.so.3 (0xb6e03000)
        libkrb5support.so.0 =&gt; /usr/lib/libkrb5support.so.0 (0xb6dfb000)
        libkeyutils.so.1 =&gt; /lib/libkeyutils.so.1 (0xb6df8000)
        libresolv.so.2 =&gt; /lib/tls/i686/cmov/libresolv.so.2 (0xb6de4000)
        liblber-2.4.so.2 =&gt; /usr/lib/liblber-2.4.so.2 (0xb6dd7000)
        libsasl2.so.2 =&gt; /usr/lib/libsasl2.so.2 (0xb6dc0000)
        libgnutls.so.13 =&gt; /usr/lib/libgnutls.so.13 (0xb6d4a000)
        libtasn1.so.3 =&gt; /usr/lib/libtasn1.so.3 (0xb6d3a000)
        libgcrypt.so.11 =&gt; /lib/libgcrypt.so.11 (0xb6cec000)
        libgpg-error.so.0 =&gt; /lib/libgpg-error.so.0 (0xb6ce8000)
	  </pre></td></tr></tbody></table><p>
	Set-up the necessary environment variables:
	</p><table xmlns="" frame="box" id="id3414582"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE

tiian@ubuntu:~/tmp$ export LIXA_PROFILE=MYS_STA_PQL_STA
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
MYS_STA_PQL_STA
	  </pre></td></tr></tbody></table><p>
	It is suggested to set the necessary environment variables in your 
	profile if you are going to execute the programs many times.
	This is the list of the suggested variables:
	<code class="varname">LD_LIBRARY_PATH</code>,
	<code class="varname">LIXA_PROFILE</code>.
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3414615"></a>Some checks before program execution</h3></div></div></div><p>
	We set <code class="varname">LIXA_PROFILE</code> to value
	â<span class="quote">MYS_STA_PQL_STA</span>â, looking at
	<code class="filename">/opt/lixa/etc/lixac_conf.xml</code>:
	</p><pre class="screen">
    &lt;profile name="MYS_STA_PQL_STA"&gt;
      &lt;sttsrvs&gt;
        &lt;sttsrv&gt;local_1&lt;/sttsrv&gt;
      &lt;/sttsrvs&gt;
      &lt;rsrmgrs&gt;
        &lt;rsrmgr&gt;MySQL_stareg&lt;/rsrmgr&gt;
        &lt;rsrmgr&gt;PostgreSQL_stareg&lt;/rsrmgr&gt;
      &lt;/rsrmgrs&gt;
    &lt;/profile&gt;
	</pre><p>
	the profile references two Resource Managers:
	â<span class="quote">MySQL_stareg</span>â and â<span class="quote">PostgreSQL_stareg</span>â, 
	looking again at the config file:
	</p><pre class="screen">
    &lt;rsrmgr name="MySQL_stareg" switch_file="/opt/lixa/lib/switch_mysql_stareg.so" xa_open_info="host=localhost,user=lixa,passwd=,db=lixa,client_flag=0" xa_close_info="" /&gt;
    &lt;rsrmgr name="PostgreSQL_stareg" switch_file="/opt/lixa/lib/switch_postgresql_stareg.so" xa_open_info="dbname=testdb" xa_close_info="" /&gt;
	</pre><p>
	we can discover how our application will access the resource
	managers
	<sup>[<a id="id3414662" href="#ftn.id3414662" class="footnote">28</a>]</sup>
	<sup>[<a id="id3414688" href="#ftn.id3414688" class="footnote">29</a>]</sup>.
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3414708"></a>Program execution</h3></div></div></div><p>
	It is suggested to open three different terminals: 
	the first one connected to â<span class="quote">lixa</span>â MySQL database,
	the second one connected to â<span class="quote">testdb</span>â PostgreSQL database
	and the
	third one pointing to the directory where the compiled program 
	example9_mys_pql lives.
	</p><table xmlns="" frame="box" id="id3414731"><thead><tr><td>[MySQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ mysql -h localhost -u lixa lixa
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 37
Server version: 5.0.51a-3ubuntu5.8 (Ubuntu)

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql&gt;
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3414758"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ psql testdb
Welcome to psql 8.3.15, the PostgreSQL interactive terminal.

Type:  \copyright for distribution terms
       \h for help with SQL commands
       \? for help with psql commands
       \g or terminate with semicolon to execute query
       \q to quit

testdb=&gt;
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3414776"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ls -la
total 28
drwxr-xr-x  2 tiian tiian  4096 2011-09-20 21:53 .
drwxr-xr-x 40 tiian tiian  4096 2011-09-19 20:54 ..
-rwxr-xr-x  1 tiian tiian 10096 2011-11-03 20:45 example9_mys_pql
-rw-r--r--  1 tiian tiian  4602 2011-11-03 20:45 example9_mys_pql.c
	  </pre></td></tr></tbody></table><p>
	Check the content of the MySQL table (â<span class="quote">authors</span>â):
	</p><table xmlns="" frame="box" id="id3414808"><thead><tr><td>[MySQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; SELECT * FROM authors;
Empty set (0.02 sec)
	  </pre></td></tr></tbody></table><p>
	Check the content of the PostgreSQL table (â<span class="quote">AUTHORS</span>â):
	</p><table xmlns="" frame="box" id="id3414833"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from AUTHORS;
 id | last_name | first_name
----+-----------+------------
(0 rows)
	  </pre></td></tr></tbody></table><p>
	Insert a row in all the tables and check the contents of the tables
	after the transaction execution:
	</p><table xmlns="" frame="box" id="id3414857"><thead><tr><td>[Third terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example9_mys_pql insert
Inserting a row in MySQL table...
Inserting a row in PostgreSQL table...
	  </pre></td></tr></tbody></table><p>
	Now you can verify the content of the tables after the transaction:
	</p><table xmlns="" frame="box" id="id3414879"><thead><tr><td>[MySQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; SELECT * FROM authors;
+----+-----------+------------+
| id | last_name | first_name |
+----+-----------+------------+
|  1 | Foo       | Bar        |
+----+-----------+------------+
1 row in set (0.00 sec)
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3414896"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from AUTHORS;
 id | last_name | first_name
----+-----------+------------
  1 | Foo       | Bar
(1 row)
	  </pre></td></tr></tbody></table><p>
	With the opposite command you can remove the rows from the tables:
	</p><table xmlns="" frame="box" id="id3414924"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example9_mys_pql delete
Deleting a row from MySQL  table...
Deleting a row from PostgreSQL table...
	  </pre></td></tr></tbody></table><p>
	and check the content of the tables again:
	</p><table xmlns="" frame="box" id="id3414946"><thead><tr><td>[MySQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; SELECT * FROM authors;
Empty set (0.00 sec)
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3414966"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from AUTHORS;
 id | last_name | first_name
----+-----------+------------
(0 rows)
	  </pre></td></tr></tbody></table><p>
      </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="Development_example10_mys_pql_ora"></a>An example with MySQL, PostgreSQL &amp; Oracle</h2></div></div></div><div class="figure"><a id="develop10"></a><p class="title"><b>FigureÂ 5.10.Â Deploy model of an example showing a distributed transaction with
	MySQL, PostgreSQL and Oracle</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Development_10.png" alt="Deploy model of an example showing a distributed transaction with MySQL, PostgreSQL and Oracle" /></div></div></div><br class="figure-break" /><p>
      This example shows as
      you can implement DTP (Distributed Transaction Processing) with three
      Resource Managers (MySQL, PostgreSQL and Oracle)
      coordinated by the LIXA Transaction Manager.
      It's strongly suggested you have played with the
      examples previously shown in this chapter (see
      <a class="xref" href="#Development" title="ChapterÂ 5.Â Development">ChapterÂ 5, <i>Development</i></a>) before starting this more complex one.
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	If you did not yet installed the software provided by MySQL,
	please refer to the official MySQL site to download the
	software and to pick-up the information necessary to install 
	and configure
	the database. This manual does not give you information related
	to MySQL technology: it is assumed you already installed and
	configured the database.
      </p><p>
	If you did not yet installed the software provided by PostgreSQL,
	please refer to the official PostgreSQL site to download the
	software and to pick-up the information necessary to install 
	and configure
	the database. This manual does not give you information related
	to PostgreSQL technology: it is assumed you already installed and
	configured the database.
      </p><p>
	If you did not yet installed the software provided by Oracle,
	please refer to the official Oracle site to download the
	software and to pick-up the information necessary to install 
	and configure
	the database. This manual does not give you information related
	to Oracle technology: it is assumed you already installed and
	configured the database.
      </p></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
	The LIXA software must be configured to support the MySQL, 
	PostgreSQL and Oracle resource managers as explained in 
	<a class="xref" href="#Linking_third_party_resource_managers" title="Linking third party resource managers">the section called âLinking third party resource managersâ</a>.
	As a little hint, you should configure LIXA as below:
	</p><pre class="screen">
./configure --with-mysql \
&gt; --with-postgresql-include=/usr/include/postgresql --with-postgresql-lib=/usr/lib \
&gt; --with-oracle=/usr/lib/oracle/xe/app/oracle/product/10.2.0/server
	</pre><p>
	Please don't forget you must compile and install every time you
	re-configure.
      </p></div><p>
      Please follow the instructions explained 
      </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	    in <a class="xref" href="#Development_setup_MySQL_environment" title="Set-up MySQL environment">the section called âSet-up MySQL environmentâ</a>
	    to set-up a running environment for MySQL server
	</p></li><li style="list-style-type: disc"><p>
	    in <a class="xref" href="#Development_setup_PostgreSQL_environment" title="Set-up PostgreSQL environment">the section called âSet-up PostgreSQL environmentâ</a>
	    to set-up a running environment for PostgreSQL server
	</p></li><li style="list-style-type: disc"><p>
	    in <a class="xref" href="#Development_setup_Oracle_environment" title="Set-up Oracle environment">the section called âSet-up Oracle environmentâ</a>
	    to set-up a running environment for Oracle Database Server
	</p></li><li style="list-style-type: disc"><p>
	    in <a class="xref" href="#Development_start_LIXA_server" title="Start the LIXA state server">the section called âStart the LIXA state serverâ</a>
	    to start up the LIXA state server
	</p></li></ul></div><p>
    </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3415144"></a>Build the client program</h3></div></div></div><p>
	Prepare the client (Application Program) using the below commands
	(<span class="command"><strong>gcc</strong></span> command was splitted on several lines 
	using <span class="command"><strong>\</strong></span> to help readability, but you may use
	a single line):
	</p><table xmlns="" frame="box" id="id3415164"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ mkdir tmp
tiian@ubuntu:~$ cd tmp
tiian@ubuntu:~/tmp$ cp /opt/lixa/share/doc/lixa-X.Y.Z/examples/example10_mys_pql_ora.c .
tiian@ubuntu:~/tmp$ gcc example10_mys_pql_ora.c -Wall \
&gt; -I /opt/lixa/include/ -L /opt/lixa/lib/ -l lixac -l lixamy -l lixapq \
&gt; $(mysql_config --include --libs_r) \
&gt; -I /usr/include/postgresql -l pq \
&gt; -I /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/rdbms/public \
&gt; -L /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib -l clntsh -l nnz10 \
&gt; -o example10_mys_pql_ora
	  </pre></td></tr></tbody></table><p>
	Verify the executable produced by <span class="command"><strong>gcc</strong></span>:
	</p><table xmlns="" frame="box" id="id3415197"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ldd example10_mys_pql_ora
        linux-gate.so.1 =&gt;  (0xb7717000)
        liblixac.so.0 =&gt; not found
        liblixamy.so.0 =&gt; not found
        liblixapq.so.0 =&gt; not found
        libmysqlclient_r.so.15 =&gt; /usr/lib/libmysqlclient_r.so.15 (0xb7524000)
        libpq.so.5 =&gt; /usr/lib/libpq.so.5 (0xb7505000)
        libclntsh.so.10.1 =&gt; not found
        libnnz10.so =&gt; not found
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb73b5000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb739d000)
        libcrypt.so.1 =&gt; /lib/tls/i686/cmov/libcrypt.so.1 (0xb736b000)
        libnsl.so.1 =&gt; /lib/tls/i686/cmov/libnsl.so.1 (0xb7353000)
        libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0xb732e000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0xb7319000)
        libssl.so.0.9.8 =&gt; /usr/lib/i686/cmov/libssl.so.0.9.8 (0xb72d3000)
        libcrypto.so.0.9.8 =&gt; /usr/lib/i686/cmov/libcrypto.so.0.9.8 (0xb7191000)
        libkrb5.so.3 =&gt; /usr/lib/libkrb5.so.3 (0xb7104000)
        libcom_err.so.2 =&gt; /lib/libcom_err.so.2 (0xb7101000)
        libgssapi_krb5.so.2 =&gt; /usr/lib/libgssapi_krb5.so.2 (0xb70d8000)
        libldap_r-2.4.so.2 =&gt; /usr/lib/libldap_r-2.4.so.2 (0xb7097000)
        /lib/ld-linux.so.2 (0xb7718000)
        libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0xb7093000)
        libk5crypto.so.3 =&gt; /usr/lib/libk5crypto.so.3 (0xb7070000)
        libkrb5support.so.0 =&gt; /usr/lib/libkrb5support.so.0 (0xb7068000)
        libkeyutils.so.1 =&gt; /lib/libkeyutils.so.1 (0xb7065000)
        libresolv.so.2 =&gt; /lib/tls/i686/cmov/libresolv.so.2 (0xb7051000)
        liblber-2.4.so.2 =&gt; /usr/lib/liblber-2.4.so.2 (0xb7044000)
        libsasl2.so.2 =&gt; /usr/lib/libsasl2.so.2 (0xb702d000)
        libgnutls.so.13 =&gt; /usr/lib/libgnutls.so.13 (0xb6fb7000)
        libtasn1.so.3 =&gt; /usr/lib/libtasn1.so.3 (0xb6fa7000)
        libgcrypt.so.11 =&gt; /lib/libgcrypt.so.11 (0xb6f59000)
        libgpg-error.so.0 =&gt; /lib/libgpg-error.so.0 (0xb6f55000)
	  </pre></td></tr></tbody></table><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3415251"></a>Set-up LIXA environment</h3></div></div></div><p>
	There are five unresolved references that can be fixed setting up
	the environment properly:
	</p><table xmlns="" frame="box" id="id3415261"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH

tiian@ubuntu:~/tmp$ . /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/bin/oracle_env.sh
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib:
tiian@ubuntu:~/tmp$ export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/lixa/lib
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib::/opt/lixa/lib
	  </pre></td></tr></tbody></table><p>
	Check again the executable:
	</p><table xmlns="" frame="box" id="id3415289"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ldd example10_mys_pql_ora
        linux-gate.so.1 =&gt;  (0xb7736000)
        liblixac.so.0 =&gt; /opt/lixa/lib/liblixac.so.0 (0xb771b000)
        liblixamy.so.0 =&gt; /opt/lixa/lib/liblixamy.so.0 (0xb7713000)
        liblixapq.so.0 =&gt; /opt/lixa/lib/liblixapq.so.0 (0xb770b000)
        libmysqlclient_r.so.15 =&gt; /usr/lib/libmysqlclient_r.so.15 (0xb751b000)
        libpq.so.5 =&gt; /usr/lib/libpq.so.5 (0xb74fc000)
        libclntsh.so.10.1 =&gt; /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib/libclntsh.so.10.1 (0xb6748000)
        libnnz10.so =&gt; /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib/libnnz10.so (0xb6543000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb63f3000)
        libgmodule-2.0.so.0 =&gt; /usr/lib/libgmodule-2.0.so.0 (0xb63ef000)
        libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0xb63eb000)
        libgthread-2.0.so.0 =&gt; /usr/lib/libgthread-2.0.so.0 (0xb63e6000)
        librt.so.1 =&gt; /lib/tls/i686/cmov/librt.so.1 (0xb63dd000)
        libglib-2.0.so.0 =&gt; /usr/lib/libglib-2.0.so.0 (0xb632c000)
        libxml2.so.2 =&gt; /usr/lib/libxml2.so.2 (0xb620b000)
        liblixab.so.0 =&gt; /opt/lixa/lib/liblixab.so.0 (0xb61f6000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb61de000)
        libcrypt.so.1 =&gt; /lib/tls/i686/cmov/libcrypt.so.1 (0xb61ac000)
        libnsl.so.1 =&gt; /lib/tls/i686/cmov/libnsl.so.1 (0xb6194000)
        libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0xb616e000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0xb6159000)
        libssl.so.0.9.8 =&gt; /usr/lib/i686/cmov/libssl.so.0.9.8 (0xb6114000)
        libcrypto.so.0.9.8 =&gt; /usr/lib/i686/cmov/libcrypto.so.0.9.8 (0xb5fd2000)
        libkrb5.so.3 =&gt; /usr/lib/libkrb5.so.3 (0xb5f45000)
        libcom_err.so.2 =&gt; /lib/libcom_err.so.2 (0xb5f41000)
        libgssapi_krb5.so.2 =&gt; /usr/lib/libgssapi_krb5.so.2 (0xb5f18000)
        libldap_r-2.4.so.2 =&gt; /usr/lib/libldap_r-2.4.so.2 (0xb5ed8000)
        /lib/ld-linux.so.2 (0xb7737000)
        libpcre.so.3 =&gt; /usr/lib/libpcre.so.3 (0xb5eb1000)
        libuuid.so.1 =&gt; /lib/libuuid.so.1 (0xb5ead000)
        libk5crypto.so.3 =&gt; /usr/lib/libk5crypto.so.3 (0xb5e89000)
        libkrb5support.so.0 =&gt; /usr/lib/libkrb5support.so.0 (0xb5e81000)
        libkeyutils.so.1 =&gt; /lib/libkeyutils.so.1 (0xb5e7e000)
        libresolv.so.2 =&gt; /lib/tls/i686/cmov/libresolv.so.2 (0xb5e6b000)
        liblber-2.4.so.2 =&gt; /usr/lib/liblber-2.4.so.2 (0xb5e5e000)
        libsasl2.so.2 =&gt; /usr/lib/libsasl2.so.2 (0xb5e46000)
        libgnutls.so.13 =&gt; /usr/lib/libgnutls.so.13 (0xb5dd0000)
        libtasn1.so.3 =&gt; /usr/lib/libtasn1.so.3 (0xb5dc0000)
        libgcrypt.so.11 =&gt; /lib/libgcrypt.so.11 (0xb5d73000)
        libgpg-error.so.0 =&gt; /lib/libgpg-error.so.0 (0xb5d6f000)
	  </pre></td></tr></tbody></table><p>
	Set-up the necessary environment variables:
	</p><table xmlns="" frame="box" id="id3415354"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE

tiian@ubuntu:~/tmp$ export LIXA_PROFILE=MYS_STA_PQL_STA_ORA_DYN
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
MYS_STA_PQL_STA_ORA_DYN
	  </pre></td></tr></tbody></table><p>
	It is suggested to set the necessary environment variables in your 
	profile if you are going to execute the programs many times.
	This is the list of the suggested variables:
	<code class="varname">LD_LIBRARY_PATH</code>,
	<code class="varname">LIXA_PROFILE</code>,
	<code class="varname">ORACLE_HOME</code>,
	<code class="varname">ORACLE_SID</code>,
	<code class="varname">PATH</code>.
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3415397"></a>Some checks before program execution</h3></div></div></div><p>
	We set <code class="varname">LIXA_PROFILE</code> to value
	â<span class="quote">MYS_STA_PQL_STA_ORA_DYN</span>â, looking at
	<code class="filename">/opt/lixa/etc/lixac_conf.xml</code>:
	</p><pre class="screen">
    &lt;profile name="MYS_STA_PQL_STA_ORA_DYN"&gt;
      &lt;sttsrvs&gt;
        &lt;sttsrv&gt;local_1&lt;/sttsrv&gt;
      &lt;/sttsrvs&gt;
      &lt;rsrmgrs&gt;
        &lt;rsrmgr&gt;MySQL_stareg&lt;/rsrmgr&gt;
        &lt;rsrmgr&gt;PostgreSQL_stareg&lt;/rsrmgr&gt;
        &lt;rsrmgr&gt;OracleXE_dynreg&lt;/rsrmgr&gt;
      &lt;/rsrmgrs&gt;
    &lt;/profile&gt;
	</pre><p>
	the profile references three Resource Managers:
	â<span class="quote">MySQL_stareg</span>â, â<span class="quote">PostgreSQL_stareg</span>â 
	and â<span class="quote">OracleXE_dynreg</span>â,
	looking again at the config file:
	</p><pre class="screen">
    &lt;rsrmgr name="MySQL_stareg" switch_file="/opt/lixa/lib/switch_mysql_stareg.so" xa_open_info="host=localhost,user=lixa,passwd=,db=lixa,client_flag=0" xa_close_info="" /&gt;
    &lt;rsrmgr name="PostgreSQL_stareg" switch_file="/opt/lixa/lib/switch_postgresql_stareg.so" xa_open_info="dbname=testdb" xa_close_info="" /&gt;
    &lt;rsrmgr name="OracleXE_dynreg" switch_file="/opt/lixa/lib/switch_oracle_dynreg.so" xa_open_info="Oracle_XA+Acc=P/hr/hr+SesTm=30+LogDir=/tmp+threads=true+DbgFl=7+Loose_Coupling=true" xa_close_info="" /&gt;
	</pre><p>
	we can discover how our application will access the resource
	managers
	<sup>[<a id="id3415453" href="#ftn.id3415453" class="footnote">30</a>]</sup>
	<sup>[<a id="id3415480" href="#ftn.id3415480" class="footnote">31</a>]</sup>
	<sup>[<a id="id3415499" href="#ftn.id3415499" class="footnote">32</a>]</sup>. 
      </p><p>
	Verify no (Oracle) trace file exists:
	</p><pre class="screen">
tiian@ubuntu:~/tmp$ ls -la /tmp/xa*
ls: cannot access /tmp/xa*: No such file or directory
	</pre><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3415523"></a>Program execution (dynamic registration for Oracle)</h3></div></div></div><p>
	It is suggested to open four different terminals: 
	the first one connected to â<span class="quote">lixa</span>â MySQL database,
	the second one connected to â<span class="quote">testdb</span>â PostgreSQL database,
	the third one connected to Oracle database and the
	fourth one pointing to the directory where the compiled program 
	example10_mys_pql_ora lives.
	</p><table xmlns="" frame="box" id="id3415551"><thead><tr><td>[MySQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ mysql -h localhost -u lixa lixa
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 37
Server version: 5.0.51a-3ubuntu5.8 (Ubuntu)

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql&gt;
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3415578"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ psql testdb
Welcome to psql 8.3.15, the PostgreSQL interactive terminal.

Type:  \copyright for distribution terms
       \h for help with SQL commands
       \? for help with psql commands
       \g or terminate with semicolon to execute query
       \q to quit

testdb=&gt;
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3415603"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ . /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/bin/oracle_env.sh
tiian@ubuntu:~$ sqlplus "hr/hr"                                                 
SQL*Plus: Release 10.2.0.1.0 - Production on Tue May 3 21:52:06 2011

Copyright (c) 1982, 2005, Oracle.  All rights reserved.


Connected to:
Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

SQL&gt;
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3415620"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ls -la
total 152
drwxr-xr-x  2 tiian tiian  4096 2011-11-11 21:06 .
drwxr-xr-x 40 tiian tiian  4096 2011-11-11 15:47 ..
-rwxr-xr-x  1 tiian tiian 12317 2011-11-11 21:06 example10_mys_pql_ora
-rw-r--r--  1 tiian tiian  8422 2011-11-11 21:05 example10_mys_pql_ora.c
	  </pre></td></tr></tbody></table><p>
	Check the content of the MySQL table (â<span class="quote">authors</span>â):
	</p><table xmlns="" frame="box" id="id3415466"><thead><tr><td>[MySQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; SELECT * FROM authors;
Empty set (0.02 sec)
	  </pre></td></tr></tbody></table><p>
	Check the content of the PostgreSQL table (â<span class="quote">AUTHORS</span>â):
	</p><table xmlns="" frame="box" id="id3415679"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from AUTHORS;
 id | last_name | first_name
----+-----------+------------
(0 rows)
	  </pre></td></tr></tbody></table><p>
	Check the content of the Oracle table (â<span class="quote">COUNTRIES</span>â):
	</p><table xmlns="" frame="box" id="id3415703"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

no rows selected
	  </pre></td></tr></tbody></table><p>
	Insert a row in all the tables and check the contents of the tables
	after the transaction execution:
	</p><table xmlns="" frame="box" id="id3415727"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example10_mys_pql_ora insert
Inserting a row in MySQL table...
Inserting a row in PostgreSQL table...
Inserting a row in Oracle table...
	  </pre></td></tr></tbody></table><p>
	Now you can verify the content of the tables after the transaction:
	</p><table xmlns="" frame="box" id="id3415750"><thead><tr><td>[MySQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; SELECT * FROM authors;
+----+-----------+------------+
| id | last_name | first_name |
+----+-----------+------------+
|  1 | Foo       | Bar        |
+----+-----------+------------+
1 row in set (0.00 sec)
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3415771"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from AUTHORS;
 id | last_name | first_name
----+-----------+------------
  1 | Foo       | Bar
(1 row)
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3415793"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

CO COUNTRY_NAME                              REGION_ID
-- ---------------------------------------- ----------
RS Repubblica San Marino                             1
	  </pre></td></tr></tbody></table><p>
	With the opposite command you can remove the rows from the tables:
	</p><table xmlns="" frame="box" id="id3415810"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example10_mys_pql_ora delete
Deleting a row from MySQL  table...
Deleting a row from PostgreSQL table...
Deleting a row from Oracle table...
	  </pre></td></tr></tbody></table><p>
	and check the content of the tables again:
	</p><table xmlns="" frame="box" id="id3415839"><thead><tr><td>[MySQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; SELECT * FROM authors;
Empty set (0.00 sec)
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3415859"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from AUTHORS;
 id | last_name | first_name
----+-----------+------------
(0 rows)
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3415877"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

no rows selected
	  </pre></td></tr></tbody></table><p>
	We can verify the dynamic registration behavior of Oracle:
	</p><table xmlns="" frame="box" id="id3415902"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LIXA_TRACE_MASK=0x00002000
tiian@ubuntu:~/tmp$ echo $LIXA_TRACE_MASK
0x00002000
tiian@ubuntu:~/tmp$ ./example10_mys_pql_ora insert 2&gt;&amp;1 | grep ax_reg
2011-11-11 21:39:40.850356 [23176/3051161344] ax_reg: rmid=2, xid=0xbfecc68c, flags=0x0
2011-11-11 21:39:40.850451 [23176/3051161344] ax_reg: the application program has started a transaction (TX states S3); this XID '4c495841.0600c467d21b42b38f1c89d912fc125d.8be5bdb35ba638bb997258e6bd8b9d88' will be returned
2011-11-11 21:39:40.850565 [23176/3051161344] ax_reg: sending 153 bytes to the server for step 8
2011-11-11 21:39:40.850602 [23176/3051161344] ax_reg/excp=7/ret_cod=0/errno=0
	  </pre></td></tr></tbody></table><p>
	We can check the static registration behavior of Oracle with a 
	different profile:
	</p><table xmlns="" frame="box" id="id3415933"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LIXA_PROFILE=MYS_STA_PQL_STA_ORA_STA
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
MYS_STA_PQL_STA_ORA_STA
tiian@ubuntu:~/tmp$ ./example10_mys_pql_ora delete 2&gt;&amp;1 | grep xa_start
2011-11-11 21:41:52.953050 [23204/3050981120] lixa_xa_start
[...]
2011-11-11 21:41:53.005001 [23204/3050981120] lixa_xa_start: xa_start_entry(xid, 0, 0x0) = 0
2011-11-11 21:41:53.007040 [23204/3050981120] lixa_xa_start: xa_start_entry(xid, 1, 0x0) = 0
2011-11-11 21:41:53.009927 [23204/3050981120] lixa_xa_start: xa_start_entry(xid, 2, 0x0) = 0
2011-11-11 21:41:53.010004 [23204/3050981120] lixa_xa_start: sending 352 bytes to the server for step 24
2011-11-11 21:41:53.010095 [23204/3050981120] lixa_xa_start/excp=10/ret_cod=0/errno=0
	  </pre></td></tr></tbody></table><p>
	and check the content of the tables again:
	</p><table xmlns="" frame="box" id="id3415966"><thead><tr><td>[MySQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; SELECT * FROM authors;
Empty set (0.00 sec)
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3415985"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from AUTHORS;
 id | last_name | first_name
----+-----------+------------
(0 rows)
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3416006"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

no rows selected
	  </pre></td></tr></tbody></table><p>
	The activity of the Oracle database can be analyzed in the trace file:
	</p><table xmlns="" frame="box" id="id3416029"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ls -la /tmp/xa_NULL11112011.trc
-rw-r--r-- 1 tiian tiian 22112 2011-11-11 21:47 /tmp/xa_NULL11112011.trc
	  </pre></td></tr></tbody></table><p>
      </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="Development_example11_mys_mys"></a>An example with two MySQL servers</h2></div></div></div><div class="figure"><a id="develop11"></a><p class="title"><b>FigureÂ 5.11.Â Deploy model of an example showing a distributed transaction with
	two MySQL servers</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Development_11.png" alt="Deploy model of an example showing a distributed transaction with two MySQL servers" /></div></div></div><br class="figure-break" /><p>
      This example shows as
      you can implement DTP (Distributed Transaction Processing) with two
      Resource Managers of the same type (MySQL) 
      coordinated by the LIXA Transaction Manager.
      It's strongly suggested you have played with the
      examples previously shown in this chapter (see
      <a class="xref" href="#Development" title="ChapterÂ 5.Â Development">ChapterÂ 5, <i>Development</i></a>) before starting this more complex one.
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	If you did not yet installed the software provided by MySQL,
	please refer to the official MySQL site to download the
	software and to pick-up the information necessary to install 
	and configure
	the database. This manual does not give you information related
	to MySQL technology: it is assumed you already installed and
	configured the database.
      </p></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
	The LIXA software must be configured to support the MySQL 
	resource managers as explained in 
	<a class="xref" href="#Linking_third_party_resource_managers" title="Linking third party resource managers">the section called âLinking third party resource managersâ</a>.
	As a little hint, you should configure LIXA as below:
	</p><pre class="screen">
./configure --with-mysql
	</pre><p>
	Please don't forget you must compile and install every time you
	re-configure.
      </p></div><p>
      Please follow the instructions explained 
      </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	    in <a class="xref" href="#Development_setup_MySQL_environment" title="Set-up MySQL environment">the section called âSet-up MySQL environmentâ</a>
	    to set-up a running environment for MySQL server
	</p></li><li style="list-style-type: disc"><p>
	    in <a class="xref" href="#Development_start_LIXA_server" title="Start the LIXA state server">the section called âStart the LIXA state serverâ</a>
	    to start up the LIXA state server
	</p></li></ul></div><p>
      To address a remote MySQL server some additional steps must be completed.
      The example explained here uses this configuration:
      </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	    IP address of the server running <span class="command"><strong>lixad</strong></span>
	    (LIXA state server), application program and local MySQL
	    server (reached using localhost 
	    <code class="systemitem">127.0.0.1</code> 
	    address): 
	    <code class="systemitem">192.168.1.2</code> 
	</p></li><li style="list-style-type: disc"><p>
	    IP address of the server running the remote MySQL server:
	    <code class="systemitem">192.168.1.3</code> 
	</p></li></ul></div><p>
      Connect to server 
      <code class="systemitem">192.168.1.3</code> 
      and change the parameter
      <em class="parameter"><code>bind-address</code></em> in the file
      <code class="filename">/etc/mysql/my.cnf</code> to allow network reachability:
      </p><table xmlns="" frame="box" id="id3416217"><thead><tr><td>[Host:192.168.1.3 /etc/mysql/my.cnf]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
# Instead of skip-networking the default is now to listen only on
# localhost which is more compatible and is not less secure.
#bind-address            = 127.0.0.1
bind-address            = 192.168.1.3
	</pre></td></tr></tbody></table><p>
      restart MySQL server:
      </p><table xmlns="" frame="box" id="id3416241"><thead><tr><td>[Host:192.168.1.3 terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ sudo /etc/init.d/mysql restart
[sudo] password for tiian:
 * Stopping MySQL database server mysqld                                 [ OK ]
 * Starting MySQL database server mysqld                                 [ OK ]
 * Checking for corrupt, not cleanly closed and upgrade needing tables.
	</pre></td></tr></tbody></table><p>
      connect to that MySQL server from the remote host and grant access to
      user <code class="systemitem">lixa</code> from the server 
      <code class="systemitem">192.168.1.2</code>:
      </p><table xmlns="" frame="box" id="id3416271"><thead><tr><td>[Host:192.168.1.3 terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@mojan:~$ mysql -u root -p
Enter password:
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 11
Server version: 5.0.51a-3ubuntu5.8 (Ubuntu)

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql&gt; GRANT ALL ON lixa.* TO 'lixa'@'192.168.1.2';
Query OK, 0 rows affected (0.00 sec)
	</pre></td></tr></tbody></table><p>
      now you should be able to connect to the server running at
      <code class="systemitem">192.168.1.3</code> 
      from the server 
      <code class="systemitem">192.168.1.2</code>:
      </p><table xmlns="" frame="box" id="id3416309"><thead><tr><td>[Host:192.168.1.2 terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ mysql -h 192.168.1.3 -u lixa lixa
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 13
Server version: 5.0.51a-3ubuntu5.8 (Ubuntu)

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.
	</pre></td></tr></tbody></table><p>
      and you must create the table necessary for the example program:
      </p><table xmlns="" frame="box" id="id3416338"><thead><tr><td>[MySQL (remote) terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; CREATE TABLE authors (id INTEGER NOT NULL PRIMARY KEY, last_name TEXT, first_name TEXT) ENGINE=InnoDB;
Query OK, 0 rows affected (0.01 sec)

mysql&gt; DESCRIBE authors;
+------------+---------+------+-----+---------+-------+
| Field      | Type    | Null | Key | Default | Extra |
+------------+---------+------+-----+---------+-------+
| id         | int(11) | NO   | PRI | NULL    |       |
| last_name  | text    | YES  |     | NULL    |       |
| first_name | text    | YES  |     | NULL    |       |
+------------+---------+------+-----+---------+-------+
3 rows in set (0.01 sec)
	</pre></td></tr></tbody></table><p>
    </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3416358"></a>Build the client program</h3></div></div></div><p>
	Prepare the client (Application Program) using the below commands
	(<span class="command"><strong>gcc</strong></span> command was splitted on several lines 
	using <span class="command"><strong>\</strong></span> to help readability, but you may use
	a single line):
	</p><table xmlns="" frame="box" id="id3416390"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ mkdir tmp
tiian@ubuntu:~$ cd tmp
tiian@ubuntu:~/tmp$ cp /opt/lixa/share/doc/lixa-X.Y.Z/examples/example11_mys_mys.c .
tiian@ubuntu:~/tmp$ gcc example11_mys_mys.c -Wall \
&gt; -I /opt/lixa/include/ -L /opt/lixa/lib/ -l lixac -l lixamy \
&gt; $(mysql_config --include --libs_r) \
&gt; -o example11_mys_mys
	  </pre></td></tr></tbody></table><p>
	Verify the executable produced by <span class="command"><strong>gcc</strong></span>:
	</p><table xmlns="" frame="box" id="id3416422"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ldd example11_mys_mys
        linux-gate.so.1 =&gt;  (0xb76f2000)
        liblixac.so.0 =&gt; not found
        liblixamy.so.0 =&gt; not found
        libmysqlclient_r.so.15 =&gt; /usr/lib/libmysqlclient_r.so.15 (0xb74ff000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb73b0000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb7398000)
        libcrypt.so.1 =&gt; /lib/tls/i686/cmov/libcrypt.so.1 (0xb7366000)
        libnsl.so.1 =&gt; /lib/tls/i686/cmov/libnsl.so.1 (0xb734e000)
        libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0xb7328000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0xb7313000)
        /lib/ld-linux.so.2 (0xb76f3000)
	  </pre></td></tr></tbody></table><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3416452"></a>Set-up LIXA environment</h3></div></div></div><p>
	There are two unresolved references that can be fixed setting up
	the environment properly:
	</p><table xmlns="" frame="box" id="id3416463"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LD_LIBRARY_PATH=/opt/lixa/lib
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH
/opt/lixa/lib
	  </pre></td></tr></tbody></table><p>
	Check again the executable:
	</p><table xmlns="" frame="box" id="id3416487"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ldd example11_mys_mys
        linux-gate.so.1 =&gt;  (0xb777d000)
        liblixac.so.0 =&gt; /opt/lixa/lib/liblixac.so.0 (0xb7762000)
        liblixamy.so.0 =&gt; /opt/lixa/lib/liblixamy.so.0 (0xb775a000)
        libmysqlclient_r.so.15 =&gt; /usr/lib/libmysqlclient_r.so.15 (0xb7569000)
        libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0xb741a000)
        libgmodule-2.0.so.0 =&gt; /usr/lib/libgmodule-2.0.so.0 (0xb7416000)
        libdl.so.2 =&gt; /lib/tls/i686/cmov/libdl.so.2 (0xb7412000)
        libgthread-2.0.so.0 =&gt; /usr/lib/libgthread-2.0.so.0 (0xb740d000)
        librt.so.1 =&gt; /lib/tls/i686/cmov/librt.so.1 (0xb7403000)
        libglib-2.0.so.0 =&gt; /usr/lib/libglib-2.0.so.0 (0xb7352000)
        libxml2.so.2 =&gt; /usr/lib/libxml2.so.2 (0xb7232000)
        liblixab.so.0 =&gt; /opt/lixa/lib/liblixab.so.0 (0xb721d000)
        libpthread.so.0 =&gt; /lib/tls/i686/cmov/libpthread.so.0 (0xb7205000)
        libcrypt.so.1 =&gt; /lib/tls/i686/cmov/libcrypt.so.1 (0xb71d3000)
        libnsl.so.1 =&gt; /lib/tls/i686/cmov/libnsl.so.1 (0xb71ba000)
        libm.so.6 =&gt; /lib/tls/i686/cmov/libm.so.6 (0xb7195000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0xb7180000)
        /lib/ld-linux.so.2 (0xb777e000)
        libpcre.so.3 =&gt; /usr/lib/libpcre.so.3 (0xb7159000)
        libuuid.so.1 =&gt; /lib/libuuid.so.1 (0xb7155000)
	  </pre></td></tr></tbody></table><p>
	Set-up the necessary environment variables:
	</p><table xmlns="" frame="box" id="id3416500"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE

tiian@ubuntu:~/tmp$ export LIXA_PROFILE=MYS_STA_MYS_STA
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
MYS_STA_MYS_STA
	  </pre></td></tr></tbody></table><p>
	It is suggested to set the necessary environment variables in your 
	profile if you are going to execute the programs many times.
	This is the list of the suggested variables:
	<code class="varname">LD_LIBRARY_PATH</code>,
	<code class="varname">LIXA_PROFILE</code>.
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3416560"></a>Some checks before program execution</h3></div></div></div><p>
	We set <code class="varname">LIXA_PROFILE</code> to value
	â<span class="quote">MYS_STA_MYS_STA</span>â, looking at
	<code class="filename">/opt/lixa/etc/lixac_conf.xml</code>:
	</p><pre class="screen">
    &lt;profile name="MYS_STA_MYS_STA"&gt;
      &lt;sttsrvs&gt;
        &lt;sttsrv&gt;local_1&lt;/sttsrv&gt;
      &lt;/sttsrvs&gt;
      &lt;rsrmgrs&gt;
        &lt;rsrmgr&gt;MySQL_stareg&lt;/rsrmgr&gt;
        &lt;rsrmgr&gt;MySQL2_stareg&lt;/rsrmgr&gt;
      &lt;/rsrmgrs&gt;
    &lt;/profile&gt;
	</pre><p>
	the profile references two Resource Managers:
	â<span class="quote">MySQL_stareg</span>â and â<span class="quote">MySQL2_stareg</span>â 
	looking again at the config file:
	</p><pre class="screen">
    &lt;rsrmgr name="MySQL_stareg" switch_file="/opt/lixa/lib/switch_mysql_stareg.so" xa_open_info="host=localhost,user=lixa,passwd=,db=lixa,client_flag=0" xa_close_info="" /&gt;
    &lt;rsrmgr name="MySQL2_stareg" switch_file="/opt/lixa/lib/switch_mysql_stareg.so" xa_open_info="host=192.168.1.3,user=lixa,passwd=,db=lixa,client_flag=0" xa_close_info="" /&gt;
	</pre><p>
	we can discover how our application will access the resource
	managers
	<sup>[<a id="id3416601" href="#ftn.id3416601" class="footnote">33</a>]</sup>. 
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3416634"></a>Program execution</h3></div></div></div><p>
	It is suggested to open three different terminals: 
	the first one connected to â<span class="quote">lixa</span>â local MySQL database,
	the second one connected to â<span class="quote">lixa</span>â remote MySQL database
	and the	third one pointing to the directory where the compiled program 
	example11_mys_mys lives.
	</p><table xmlns="" frame="box" id="id3416652"><thead><tr><td>[MySQL (local) terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ mysql -h localhost -u lixa lixa
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 37
Server version: 5.0.51a-3ubuntu5.8 (Ubuntu)

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql&gt;
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3416680"><thead><tr><td>[MySQL (remote) terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ mysql -h 192.168.1.3 -u lixa lixa
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 7
Server version: 5.0.51a-3ubuntu5.8 (Ubuntu)

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3416694"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ls -la
total 168
drwxr-xr-x  2 tiian tiian  4096 2011-11-13 21:04 .
drwxr-xr-x 40 tiian tiian  4096 2011-11-13 19:09 ..
-rwxr-xr-x  1 tiian tiian  9201 2011-11-13 21:04 example11_mys_mys
-rw-r--r--  1 tiian tiian  3977 2011-11-13 21:04 example11_mys_mys.c
	  </pre></td></tr></tbody></table><p>
	Check the content of the (local) MySQL table (â<span class="quote">authors</span>â):
	</p><table xmlns="" frame="box" id="id3416733"><thead><tr><td>[MySQL (local) terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; SELECT * FROM authors;
Empty set (0.02 sec)
	  </pre></td></tr></tbody></table><p>
	Check the content of the (remote) MySQL table (â<span class="quote">authors</span>â):
	</p><table xmlns="" frame="box" id="id3416758"><thead><tr><td>[MySQL (remote) terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; SELECT * FROM authors;
Empty set (0.01 sec)
	  </pre></td></tr></tbody></table><p>
	Insert a row in all the tables and check the contents of the tables
	after the transaction execution:
	</p><table xmlns="" frame="box" id="id3416780"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example11_mys_mys insert
Inserting a row in MySQL(1) table...
Inserting a row in MySQL(2) table...
	  </pre></td></tr></tbody></table><p>
	Now you can verify the content of the tables after the transaction:
	</p><table xmlns="" frame="box" id="id3416804"><thead><tr><td>[MySQL (local) terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; SELECT * FROM authors;
+----+-----------+------------+
| id | last_name | first_name |
+----+-----------+------------+
|  1 | Foo       | Bar        |
+----+-----------+------------+
1 row in set (0.00 sec)
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3416820"><thead><tr><td>[MySQL (remote) terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; SELECT * FROM authors;
+----+-----------+------------+
| id | last_name | first_name |
+----+-----------+------------+
|  1 | Foo       | Bar        |
+----+-----------+------------+
1 row in set (0.01 sec)
	  </pre></td></tr></tbody></table><p>
	With the opposite command you can remove the rows from the tables:
	</p><table xmlns="" frame="box" id="id3416850"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example11_mys_mys delete
Deleting a row from MySQL(1) table...
Deleting a row from MySQL(2) table...
	  </pre></td></tr></tbody></table><p>
	and check the content of the tables again:
	</p><table xmlns="" frame="box" id="id3416872"><thead><tr><td>[MySQL (local) terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; SELECT * FROM authors;
Empty set (0.00 sec)
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3416893"><thead><tr><td>[MySQL (remote) terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; SELECT * FROM authors;
Empty set (0.00 sec)
	  </pre></td></tr></tbody></table><p>
	Finally, you can verify the two phase commit protocol is running as
	expected. Insert a row in all the tables:
	</p><table xmlns="" frame="box" id="id3416916"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example11_mys_mys insert
Inserting a row in MySQL(1) table...
Inserting a row in MySQL(2) table...
	  </pre></td></tr></tbody></table><p>
	manually remove the row from the local MySQL server only:
	</p><table xmlns="" frame="box" id="id3416939"><thead><tr><td>[MySQL (local) terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; SELECT * FROM authors;
+----+-----------+------------+
| id | last_name | first_name |
+----+-----------+------------+
|  1 | Foo       | Bar        |
+----+-----------+------------+
1 row in set (0.00 sec)

mysql&gt; DELETE FROM authors;
Query OK, 1 row affected (0.01 sec)

mysql&gt; SELECT * FROM authors;
Empty set (0.00 sec)
	  </pre></td></tr></tbody></table><p>
	try to insert the row again in all the tables:
	</p><table xmlns="" frame="box" id="id3416965"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ ./example11_mys_mys insert
Inserting a row in MySQL(1) table...
Inserting a row in MySQL(2) table...
INSERT INTO authors: 1062/Duplicate entry '1' for key 1
	  </pre></td></tr></tbody></table><p>
	the first (local) INSERT is ok, while the second one can not be
	performed due to a duplicated key. 
	Check the content of the tables again:
	</p><table xmlns="" frame="box" id="id3416989"><thead><tr><td>[MySQL (local) terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; SELECT * FROM authors;
Empty set (0.00 sec)
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3417010"><thead><tr><td>[MySQL (remote) terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; SELECT * FROM authors;
+----+-----------+------------+
| id | last_name | first_name |
+----+-----------+------------+
|  1 | Foo       | Bar        |
+----+-----------+------------+
1 row in set (0.01 sec)
	  </pre></td></tr></tbody></table><p>
	If you inspect the program
	source code you will discover what the program will do:
	</p><table xmlns="" frame="box" id="id3417035"><thead><tr><td><code xmlns="http://www.w3.org/1999/xhtml" class="filename">example11_mys_mys.c</code></td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
        [...]

        printf("Inserting a row in MySQL(2) table...\n");
        if (mysql_query(conn2,
                        "INSERT INTO authors VALUES(1, 'Foo', 'Bar')")) {
            fprintf(stderr, "INSERT INTO authors: %u/%s\n",
                    mysql_errno(conn2), mysql_error(conn2));
            exit_nicely(conn1, conn2);
        }

        [...]
	  </pre></td></tr></tbody></table><p>
	in case of error the program exits closing the connections...
	XA protocol is a â<span class="quote">two phase commit with presumed 
	rollback</span>â: if the transaction does not complete 
	<code class="function">xa_prepare</code>, the transaction will be rolled back.
	An alternative way is the usage of <code class="function">tx_rollback()</code>:
	you can rollback the current transaction and start a new one without
	program (and connection) termination.
	Clean up the (remote) table:
	</p><table xmlns="" frame="box" id="id3417076"><thead><tr><td>[MySQL (remote) terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
mysql&gt; DELETE FROM authors;
Query OK, 1 row affected (0.04 sec)

mysql&gt; SELECT * FROM authors;
Empty set (0.00 sec)
	  </pre></td></tr></tbody></table><p>
      </p></div></div><div class="footnotes"><br /><hr width="100" align="left" /><div class="footnote"><p><sup>[<a id="ftn.id3407561" href="#id3407561" class="para">13</a>] </sup>
	      I put this line (Oracle 10.2 32 bit)
	      <code class="computeroutput">. /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/bin/oracle_env.sh</code>
	      or this line (Oracle 11.2 64 bit)
	      <code class="computeroutput">. /u01/app/oracle/product/11.2.0/xe/bin/oracle_env.sh</code>
	      in the file <code class="filename">$HOME/.profile</code> of the
	      <code class="systemitem">oracle</code> user to set-up
	      the default administration environment; it complains about
	      two shell errors, but for the sake of our example it's
	      safe.
	  </p></div><div class="footnote"><p><sup>[<a id="ftn.id3407590" href="#id3407590" class="para">14</a>] </sup>
	      If you got some errors like these:
	      <pre class="screen">
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server/bin/nls_lang.sh: 114: [[: not found
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server/bin/nls_lang.sh: 114: [[: not found
	      </pre>
	      you could edit the file <code class="filename">/usr/lib/oracle/xe/app/oracle/product/10.2.0/server/bin/nls_lang.sh</code> and substitute 
	      <code class="computeroutput">#!/bin/sh</code> with
	      <code class="computeroutput">#!/bin/bash</code> in the first row as explained 
	      here:
	      <a class="ulink" href="http://forums.oracle.com/forums/thread.jspa?messageID=1542334" target="_top">http://forums.oracle.com/forums/thread.jspa?messageID=1542334</a>
	  </p></div><div class="footnote"><p><sup>[<a id="ftn.id3408054" href="#id3408054" class="para">15</a>] </sup>
	    The content of <code class="constant">xa_open_info</code> string is
	    described in chapter 15 "Developing Applications with Oracle XA"
	    of the "Oracle Database Application Developer's Guide"
	    manual; please refer to the documentation published by
	    Oracle Corporation for further details.
	</p></div><div class="footnote"><p><sup>[<a id="ftn.id3408827" href="#id3408827" class="para">16</a>] </sup>
	    The content of <code class="constant">xa_open_info</code> string is
	    documented at IBM Infocenter: search the string
	    â<span class="quote">xa_open string formats</span>â in the documentation
	    relevant to your installed version; this is a link
	    <a class="ulink" href="http://publib.boulder.ibm.com/infocenter/db2luw/v9r7/topic/com.ibm.db2.luw.admin.2pc.doc/doc/r0005080.html" target="_top">
	      http://publib.boulder.ibm.com/infocenter/db2luw/v9r7/topic/com.ibm.db2.luw.admin.2pc.doc/doc/r0005080.html
	    </a>
	    but it may change in the future.
	</p></div><div class="footnote"><p><sup>[<a id="ftn.id3409521" href="#id3409521" class="para">17</a>] </sup>
	    The content of <code class="constant">xa_open_info</code> string is
	    described in chapter 15 "Developing Applications with Oracle XA"
	    of the "Oracle Database Application Developer's Guide"
	    manual; please refer to the documentation published by
	    Oracle Corporation for further details.
	  </p><p>
	    The content of <code class="constant">xa_open_info</code> string is
	    documented at IBM Infocenter: search the string
	    â<span class="quote">xa_open string formats</span>â in the documentation
	    relevant to your installed version; this is a link
	    <a class="ulink" href="http://publib.boulder.ibm.com/infocenter/db2luw/v9r7/topic/com.ibm.db2.luw.admin.2pc.doc/doc/r0005080.html" target="_top">
	      http://publib.boulder.ibm.com/infocenter/db2luw/v9r7/topic/com.ibm.db2.luw.admin.2pc.doc/doc/r0005080.html
	    </a>
	    but it may change in the future.
	  </p></div><div class="footnote"><p><sup>[<a id="ftn.id3410578" href="#id3410578" class="para">18</a>] </sup>
	      If you wanted to use a database user different than your own
	      UNIX user, as it ever happens when the database is hosted on
	      a different system, you should configure
	      <code class="filename">pg_hba.conf</code> as well. Look at the PostgreSQL
	      documentation to pick up all the necessary details.
	  </p></div><div class="footnote"><p><sup>[<a id="ftn.id3410997" href="#id3410997" class="para">19</a>] </sup>
	    The content of <code class="constant">xa_open_info</code> is passed to
	    <code class="function">PQconnectdb</code> function: you can refer to 
	    PostgreSQL official
	    documentation to discover what you can pass to this function.
	    Please pay attention the <code class="varname">xa_open_info</code> can
	    contain a maximum of 255 characters: this limitation is
	    documented in [<a class="citation" href="#id3422020"><span class="citation">XAspec</span></a>].
	</p></div><div class="footnote"><p><sup>[<a id="ftn.id3411213" href="#id3411213" class="para">20</a>] </sup>
	    The current implementation does not support dynamic registration
	    for PostgreSQL.
	</p></div><div class="footnote"><p><sup>[<a id="ftn.id3411789" href="#id3411789" class="para">21</a>] </sup>
	    The content of <code class="constant">xa_open_info</code> is passed to
	    <code class="function">PQconnectdb</code> function: you can refer to 
	    PostgreSQL official
	    documentation to discover what you can pass to this function.
	    Please pay attention the <code class="varname">xa_open_info</code> can
	    contain a maximum of 255 characters: this limitation is
	    documented in [<a class="citation" href="#id3422020"><span class="citation">XAspec</span></a>].
	  </p></div><div class="footnote"><p><sup>[<a id="ftn.id3411817" href="#id3411817" class="para">22</a>] </sup>
	    The content of <code class="constant">xa_open_info</code> string is
	    described in chapter 15 "Developing Applications with Oracle XA"
	    of the "Oracle Database Application Developer's Guide"
	    manual; please refer to the documentation published by
	    Oracle Corporation for further details.
	  </p></div><div class="footnote"><p><sup>[<a id="ftn.id3412688" href="#id3412688" class="para">23</a>] </sup>
	    The content of <code class="constant">xa_open_info</code> is passed to
	    <code class="function">PQconnectdb</code> function: you can refer to 
	    PostgreSQL official
	    documentation to discover what you can pass to this function.
	    Please pay attention the <code class="varname">xa_open_info</code> can
	    contain a maximum of 255 characters: this limitation is
	    documented in [<a class="citation" href="#id3422020"><span class="citation">XAspec</span></a>].
	  </p></div><div class="footnote"><p><sup>[<a id="ftn.id3412714" href="#id3412714" class="para">24</a>] </sup>
	    The content of <code class="constant">xa_open_info</code> string is
	    documented at IBM Infocenter: search the string
	    â<span class="quote">xa_open string formats</span>â in the documentation
	    relevant to your installed version; this is a link
	    <a class="ulink" href="http://publib.boulder.ibm.com/infocenter/db2luw/v9r7/topic/com.ibm.db2.luw.admin.2pc.doc/doc/r0005080.html" target="_top">
	      http://publib.boulder.ibm.com/infocenter/db2luw/v9r7/topic/com.ibm.db2.luw.admin.2pc.doc/doc/r0005080.html
	    </a>
	    but it may change in the future.
	  </p></div><div class="footnote"><p><sup>[<a id="ftn.id3413223" href="#id3413223" class="para">25</a>] </sup>
	    This is the sample command for Ubuntu 8.04 operating system:
	    <code class="computeroutput">sudo apt-get install mysql-server libmysqlclient15-dev</code>
	</p></div><div class="footnote"><p><sup>[<a id="ftn.id3413313" href="#id3413313" class="para">26</a>] </sup>
	      You need the password of MySQL root user to execute
	      these commands
	  </p></div><div class="footnote"><p><sup>[<a id="ftn.id3414190" href="#id3414190" class="para">27</a>] </sup>
	    The current implementation does not support dynamic registration
	    for MySQL.
	</p></div><div class="footnote"><p><sup>[<a id="ftn.id3414662" href="#id3414662" class="para">28</a>] </sup>
	    The content of <code class="constant">xa_open_info</code> for MySQL is
	    described in 
	    <a class="xref" href="#Development_setup_MySQL_xa_open_info" title="Some checks before program execution">the section called âSome checks before program executionâ</a>.
	  </p></div><div class="footnote"><p><sup>[<a id="ftn.id3414688" href="#id3414688" class="para">29</a>] </sup>
	    The content of <code class="constant">xa_open_info</code> is passed to
	    <code class="function">PQconnectdb</code> function: you can refer to 
	    PostgreSQL official
	    documentation to discover what you can pass to this function.
	    Please pay attention the <code class="varname">xa_open_info</code> can
	    contain a maximum of 255 characters: this limitation is
	    documented in [<a class="citation" href="#id3422020"><span class="citation">XAspec</span></a>].
	  </p></div><div class="footnote"><p><sup>[<a id="ftn.id3415453" href="#id3415453" class="para">30</a>] </sup>
	    The content of <code class="constant">xa_open_info</code> for MySQL is
	    described in 
	    <a class="xref" href="#Development_setup_MySQL_xa_open_info" title="Some checks before program execution">the section called âSome checks before program executionâ</a>.
	  </p></div><div class="footnote"><p><sup>[<a id="ftn.id3415480" href="#id3415480" class="para">31</a>] </sup>
	    The content of <code class="constant">xa_open_info</code> is passed to
	    <code class="function">PQconnectdb</code> function: you can refer to 
	    PostgreSQL official
	    documentation to discover what you can pass to this function.
	    Please pay attention the <code class="varname">xa_open_info</code> can
	    contain a maximum of 255 characters: this limitation is
	    documented in [<a class="citation" href="#id3422020"><span class="citation">XAspec</span></a>].
	  </p></div><div class="footnote"><p><sup>[<a id="ftn.id3415499" href="#id3415499" class="para">32</a>] </sup>
	    The content of <code class="constant">xa_open_info</code> string is
	    described in chapter 15 "Developing Applications with Oracle XA"
	    of the "Oracle Database Application Developer's Guide"
	    manual; please refer to the documentation published by
	    Oracle Corporation for further details.
	  </p></div><div class="footnote"><p><sup>[<a id="ftn.id3416601" href="#id3416601" class="para">33</a>] </sup>
	    The content of <code class="constant">xa_open_info</code> for MySQL is
	    described in 
	    <a class="xref" href="#Development_setup_MySQL_xa_open_info" title="Some checks before program execution">the section called âSome checks before program executionâ</a>.
	  </p></div></div></div><div class="chapter" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="Recovery"></a>ChapterÂ 6.Â Recovery</h2></div></div></div><p>
    This chapter explains some advanced concepts that the LIXA system
    administrator should know to solve some complex issues the XA 
    technology could generate.
    LIXA technology provide two type of recovery:
    </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	  <span class="emphasis"><em>Automatic Recovery</em></span>: 
	  it happens silently and rolls back or commits
	  the transactions that crashed before a consistent point had been
	  reached
      </p></li><li style="list-style-type: disc"><p>
	  <span class="emphasis"><em>Manual Recovery</em></span>:
	  it is invoked by <span class="command"><strong>lixar</strong></span> utility
	  to solve the transactions that cannot be automatically recovered
      </p></li></ul></div><p>	
  </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3417136"></a>Automatic (warm) recovery</h2></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3417141"></a>Scenario 1: autonoumos rollback</h3></div></div></div><p>
	If your environment is configured and runs as designed, when an
	Application Program fails an automatic recovery operation fix the
	problem as soon as possible. Below there is a first trivial
	scenarios:
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>the Application Program crashes before it reaches the
	      <code class="function">xa_prepare()</code> function
	      (called by <code class="function">tx_commit()</code>)
	    </p></li><li style="list-style-type: disc"><p>the Resource Managers 
	      <span class="emphasis"><em>autonoumosly</em></span> roll back the
	      work in progress and the environment is cleaned up</p></li></ul></div><p>	
	the distributed transaction started but it did not initiated the
	two phase commit protocol: there is no relevant difference between
	this scenario and a single Resource Manager (one phase commit)
	scenario. The LIXA Transaction Manager does <span class="emphasis"><em>not</em></span>
	manage a recovery phase.
	</p><div class="figure"><a id="recover1"></a><p class="title"><b>FigureÂ 6.1.Â The Application Program crashes before <code class="function">xa_prepare()</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Recovery_01.png" alt="The Application Program crashes before xa_prepare()" /></div></div></div><p><br class="figure-break" />
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3417226"></a>Scenario 2: a second Application Program triggers the recovery action</h3></div></div></div><p>
	The following scenario is slightly different:
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>the Application Program crashes after it has passed the
	      <code class="function">xa_prepare()</code> function but before it
	      reaches the <code class="function">xa_commit()</code> function
	    </p></li><li style="list-style-type: disc"><p>the Resource Managers keep the <span class="emphasis"><em>prepared</em></span>
	    transaction â<span class="quote">in flight</span>â until the Transaction
	    Manager decides the proper recovery action</p></li><li style="list-style-type: disc"><p>an â<span class="quote">equivalent</span>â Application Program starts 
	      and activates
	      the LIXA Transaction Manager with <code class="function">tx_open()</code>
	    </p></li><li style="list-style-type: disc"><p>the LIXA Transaction Manager discovers there is a
	      <span class="emphasis"><em>prepared</em></span> transaction and establishes that
	      it must commit the transaction
	    </p></li><li style="list-style-type: disc"><p>the second Application Program implicitly and inconsciously
	    started the recovery process of a previously crashed
	    Application Program</p></li></ul></div><p>	
	</p><div class="figure"><a id="recover2"></a><p class="title"><b>FigureÂ 6.2.Â The Application Program crashes after <code class="function">xa_prepare()</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Recovery_02.png" alt="The Application Program crashes after xa_prepare()" /></div></div></div><p><br class="figure-break" />
	The above pattern is the result of the LIXA design: the Transaction
	Manager is not an active component, but it's a passive one and
	is embedded in the Application Program when it links the
	<code class="systemitem">lixac</code> library 
	and activates it with the
	<code class="function">tx_open()</code> function.
      </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	  Depending on the crash time: slightly before the 
	  <span class="emphasis"><em>prepare phase</em></span>,
	  in the middle of the <span class="emphasis"><em>prepare phase</em></span>,
	  after the completion of the <span class="emphasis"><em>prepare phase</em></span>, 
	  the LIXA Transaction Manager chooses a different recovery 
	  operation between
	  <code class="function">xa_commit()</code> and 
	  <code class="function">xa_rollback()</code>.
      </p></div></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="Automatic_recovery_concepts"></a>Automatic recovery concepts</h2></div></div></div><p>
      Automatic (warm) recovery uses the information stored inside the
      LIXA state server to decide which transaction must be recovered and
      how it should be completed (committed or rolled back).
    </p><p>
      The above paragraphs explain what's happen when automatic recovery
      starts and completes (rolls back or commits) the transaction marked
      as â<span class="quote">recovery pending</span>â.
    </p><p>
      <span class="foreignphrase"><em class="foreignphrase">
	An â<span class="quote">equivalent</span>â Application Program starts and activates
	the LIXA Transaction Manager with <code class="function">tx_open()</code>.
	The LIXA Transaction Manager autonoumosly coordinates the transaction
	completion and the Application Program is not aware of this
	â<span class="quote">under the covers</span>â operation.
      </em></span>
    </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="Application_Program_equivalence"></a>Application Program equivalence</h3></div></div></div><p>
	From the LIXA Transaction Manager point of view,
	two Application Programs are
	equivalent when they are associated to the same 
	<span class="emphasis"><em>job</em></span>.
      </p><p>
	The job associated to an Application Program can be:
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	      the content of the environment variable 
	      <code class="varname">LIXA_JOB</code> if it is set
	    </p></li><li style="list-style-type: disc"><p>
	      a string computed in this way if the environment variable 
	      <code class="varname">LIXA_JOB</code> is <span class="emphasis"><em>not</em></span> set:
	      </p><p>
		<code class="varname">branch qualifier</code> + 
		â<span class="quote">/</span>â + 
		<code class="systemitem">IP address</code>
	      </p><p>
	      where <code class="varname">branch qualifier</code> is computed as:
	      </p><p>
		<code class="function">MD5</code>(<code class="filename">lixac_conf.xml</code> + 
		$(<code class="varname">LIXA_PROFILE</code>) +
		<code class="function">gethostid()</code>)
	      </p><p>
	    </p></li></ul></div><p>
	An example of <code class="varname">branch qualifier</code> is
	â<span class="quote">0fc29445b1d4c3f4ed6be2fea20f918b</span>â, while an example of
	job automatically associated to an Application Program is
	â<span class="quote">0fc29445b1d4c3f4ed6be2fea20f918b/127.0.0.1</span>â
      </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	  If you don't set the environment variable 
	  <code class="varname">LIXA_JOB</code> all the Application Programs that
	  meet this requirements:
	  </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
		they use a config file (<code class="filename">lixac_conf.xml</code>)
		with the same content
	    </p></li><li style="list-style-type: disc"><p>
		they use a <code class="varname">LIXA_PROFILE</code> environment variable
		with the same content
	    </p></li><li style="list-style-type: disc"><p>
		they run in a host that returns the same value to
		<code class="function">gethostid()</code> function		
	    </p></li><li style="list-style-type: disc"><p>
		they are calling the LIXA state server from the same 
		IP address	
	    </p></li></ul></div><p>
	  <span class="emphasis"><em>are associated to the same job</em></span>.
      </p></div><p>
	To pick-up the job associated to an Application Program you can
	activate the trace using the bit associated to the label
	â<span class="quote">LIXA_TRACE_MOD_CLIENT_CONFIG</span>â. Take a look to
	<a class="xref" href="#Tracing_modules" title="Tracing modules">the section called âTracing modulesâ</a> for more information.
	This is an excerpt from the trace:
	</p><pre class="screen">
[...]	  
2011-12-03 17:00:59.746036 [6021/1078050640] client_config_job
2011-12-03 17:00:59.746073 [6021/1078050640] client_config_job: acquiring exclusive mutex
2011-12-03 17:00:59.746120 [6021/1078050640] client_config_job: 'LIXA_JOB' environment variable not found, computing job string...
2011-12-03 17:00:59.746175 [6021/1078050640] lixa_job_set_source_ip
2011-12-03 17:00:59.746275 [6021/1078050640] lixa_job_set_source_ip/excp=1/ret_cod=0/errno=0
2011-12-03 17:00:59.746339 [6021/1078050640] client_config_job: job value for this process is '0fc29445b1d4c3f4ed6be2fea20f918b/127.0.0.1      '
2011-12-03 17:00:59.746379 [6021/1078050640] client_config_job: releasing exclusive mutex
2011-12-03 17:00:59.746514 [6021/1078050640] client_config_job/excp=3/ret_cod=0/errno=0
[...]
	</pre><p>
	</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
	    Setting the environment variable <code class="varname">LIXA_JOB</code>
	    allows you to associate any Application Program to a custom
	    user defined job: this may be interesting if you are using a
	    workload balanced environment, this may be dangerous if you
	    associate Application Programs using a different set of
	    Resource Managers to the same job.
	</p></div><p>
      </p><p>
	If you don't set <code class="varname">LIXA_JOB</code> environment variable,
	the default behavior should be strong enought to avoid issues when
	LIXA is used under â<span class="quote">standard</span>â conditions.
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3417660"></a>Automatic Recovery in a distributed environment</h3></div></div></div><p>
	The previous section (see 
	<a class="xref" href="#Application_Program_equivalence" title="Application Program equivalence">the section called âApplication Program equivalenceâ</a>) explains the
	conditions that must be met to enable automatic recovery.
	A tipical scenario that needs tuning is a workload balanced
	Application Server environment as is in the below picture:
	</p><div class="figure"><a id="recover3"></a><p class="title"><b>FigureÂ 6.3.Â Workload balanced Application Server</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_Recovery_03.png" alt="Workload balanced Application Server" /></div></div></div><p><br class="figure-break" />
	The same program (â<span class="quote">Application Program 1</span>â) is
	executed by two different Application Servers: this is a typical
	configuration used to improve service availability and scalability.
	If the Application Server 1 is running in a different host than
	Application Server 2 (this is a de facto standard), by default 
	LIXA will
	associate <span class="emphasis"><em>two different jobs.</em></span>
      </p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
	  The LIXA default behavior is not the optimal one when you are
	  using a workload balanced environment.
	</p><p>
	  If the host of Application Server 1 crashed, the Application Program
	  running inside Application Server 2
	  could not automatically recover the transactions in 
	  â<span class="quote">prepared/in-doubt/recovery pending</span>â of the
	  Application Server 1 because they are associated to a different
	  <span class="emphasis"><em>job</em></span>.
	</p><p>
	  This is a scenario when setting <code class="varname">LIXA_JOB</code> is
	  <span class="emphasis"><em>strongly</em></span> suggested.
      </p></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
	  When you set the <code class="varname">LIXA_JOB</code> environment variable
	  to control LIXA automatic recovery feature you 
	  <span class="emphasis"><em>must not</em></span> associate the same job to 
	  Application Programs that use different sets of Resource Managers
	  or use the same set of Resource Managers but with different
	  options for any Resource Manager.
	  If you broke this rule, you would probably face difficult to 
	  troubleshoot issues: automatic recovery could fail and you
	  would have to understand why.
      </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="Forcing_automatic_recovery"></a>Forcing automatic recovery</h3></div></div></div><p>
	Sometimes you need to force the automatic recovery to happen because
	the crashed Applicaton Program is a â<span class="quote">one shot</span>â program
	and you can not execute it a second time due to some functional
	constrain.
      </p><p>
	Any application program meeting the requirements described above can
	be used, <span class="command"><strong>lixat</strong></span> utility command too. The following
	example will show you how it works using PostgreSQL and Oracle
	Resource Managers.
      </p><p>
	First of all, you must configure, build and install the LIXA project
	software enabling PostgreSQL, Oracle and crash simulation features:
	</p><pre class="screen">
tiian@ubuntu:~/lixa$ ./configure --with-oracle=/usr/lib/oracle/xe/app/oracle/product/10.2.0/server \
&gt; --with-postgresql-include=/usr/include/postgresql --with-postgresql-lib=/usr/lib \
&gt; --enable-crash
	</pre><p>
	then you must follow the steps described in 
	<a class="xref" href="#Development_example6_pql_ora" title="An example with PostgreSQL &amp; Oracle">the section called âAn example with PostgreSQL &amp; Oracleâ</a>
	to prepare the scenario environment.
	Open three different terminal sessions as explained in the above
	example, and try to insert/delete a row:
	</p><table xmlns="" frame="box" id="id3417824"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
PQL_STA_ORA_DYN
tiian@ubuntu:~/tmp$ echo $ORACLE_HOME
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server
tiian@ubuntu:~/tmp$ echo $ORACLE_SID
XE
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib::/opt/lixa/lib
tiian@ubuntu:~/tmp$ ./example6_pql_ora insert
Inserting a row in the tables...
Oracle INSERT statement executed!
tiian@ubuntu:~/tmp$ ./example6_pql_ora delete
Deleting a row from the tables...
Oracle DELETE statement executed!
	  </pre></td></tr></tbody></table><p>
	To simulate a crash after the <code class="function">xa_prepare()</code>
	completed successfully, you can set the environment variable
	<code class="varname">LIXA_CRASH_POINT</code> to the value
	<code class="constant">LIXA_CRASH_POINT_PREPARE_2</code>
	(see <code class="filename">src/common/lixa_crash.h</code>:
	</p><table xmlns="" frame="box" id="id3417868"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LIXA_CRASH_POINT=15
tiian@ubuntu:~/tmp$ echo $LIXA_CRASH_POINT
15
tiian@ubuntu:~/tmp$ ./example6_pql_ora insert
Inserting a row in the tables...
Oracle INSERT statement executed!
Aborted
	  </pre></td></tr></tbody></table><p>
	You can check there is a prepared (in-doubt) transaction inside Oracle:
	</p><table xmlns="" frame="box" id="id3417895"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from dba_pending_transactions;

  FORMATID
----------
GLOBALID
--------------------------------------------------------------------------------
BRANCHID
--------------------------------------------------------------------------------
1279875137
97DD30A150604AFDBFA5FDC94B611FD5
9BAC7BE1C129EA6EE31F2D71B318120C
	  </pre></td></tr></tbody></table><p>
	And the same transaction inside PostgreSQL:
	</p><table xmlns="" frame="box" id="id3417920"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from pg_prepared_xacts;
 transaction |                                    gid                                     |           prepared            | owner | database 
-------------+----------------------------------------------------------------------------+-------------------------------+-------+----------
         874 | 4c495841.97dd30a150604afdbfa5fdc94b611fd5.9bac7be1c129ea6ee31f2d71b318120c | 2011-12-14 22:02:50.462682+01 | tiian | testdb
	  </pre></td></tr></tbody></table><p>
	Noting that the decimal value 1279875137 is expressed as 4c495841 
	in hexadecimal, the information retrieved from the Resource Managers 
	is consistent.
	It is suggested to activate the trace related to the 
	â<span class="quote">client recovery</span>â
	module (see <a class="xref" href="#Tracing_modules" title="Tracing modules">the section called âTracing modulesâ</a>)
	before running <span class="command"><strong>lixat</strong></span> program:
	</p><table xmlns="" frame="box" id="id3417969"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LIXA_TRACE_MASK=0x00040000
tiian@ubuntu:~/tmp$ /opt/lixa/bin/lixat 
2011-12-14 22:22:01.740634 [27735/3073944240] client_recovery
2011-12-14 22:22:01.740771 [27735/3073944240] client_recovery: sending 197 bytes ('000191&lt;?xml version="1.0" encoding="UTF-8" ?&gt;&lt;msg level="0" verb="8" step="8"&gt;&lt;client job="9bac7be1c129ea6ee31f2d71b318120c/127.0.0.1      " config_digest="9bac7be1c129ea6ee31f2d71b318120c"/&gt;&lt;/msg&gt;') to the server for step 8
2011-12-14 22:22:01.759352 [27735/3073944240] client_recovery: receiving 561 bytes from the server |&lt;?xml version="1.0" encoding="UTF-8" ?&gt;&lt;msg level="0" verb="8" step="16"&gt;&lt;answer rc="0"/&gt;&lt;client job="9bac7be1c129ea6ee31f2d71b318120c/127.0.0.1      " config_digest="9bac7be1c129ea6ee31f2d71b318120c"&gt;&lt;last_verb_step verb="5" step="16"/&gt;&lt;state finished="0" txstate="3" will_commit="1" will_rollback="0" xid="4c495841.97dd30a150604afdbfa5fdc94b611fd5.9bac7be1c129ea6ee31f2d71b318120c"/&gt;&lt;/client&gt;&lt;rsrmgrs&gt;&lt;rsrmgr rmid="0" next_verb="0" r_state="1" s_state="33" td_state="10"/&gt;&lt;rsrmgr rmid="1" next_verb="0" r_state="1" s_state="33" td_state="20"/&gt;&lt;/rsrmgrs&gt;&lt;/msg&gt;|
2011-12-14 22:22:01.759776 [27735/3073944240] client_recovery_analyze
2011-12-14 22:22:01.759857 [27735/3073944240] client_recovery_analyze: the TX was committing
2011-12-14 22:22:01.759873 [27735/3073944240] client_recovery_analyze: rmid=0, r_state=1, s_state=33, td_state=10
2011-12-14 22:22:01.759884 [27735/3073944240] client_recovery_analyze: rmid=1, r_state=1, s_state=33, td_state=20
2011-12-14 22:22:01.759902 [27735/3073944240] client_recovery_analyze/excp=1/ret_cod=0/errno=0
2011-12-14 22:22:01.759921 [27735/3073944240] client_recovery: transaction '4c495841.97dd30a150604afdbfa5fdc94b611fd5.9bac7be1c129ea6ee31f2d71b318120c' must be committed
2011-12-14 22:22:01.759937 [27735/3073944240] client_recovery_commit
2011-12-14 22:22:01.759971 [27735/3073944240] client_recovery_commit: committing transaction '4c495841.97dd30a150604afdbfa5fdc94b611fd5.9bac7be1c129ea6ee31f2d71b318120c'
2011-12-14 22:22:01.759998 [27735/3073944240] client_recovery_commit: xa_commit for rmid=0, name='PostgreSQL_stareg', xa_name='PostgreSQL[LIXA]'...
2011-12-14 22:22:02.143764 [27735/3073944240] client_recovery_commit: rc=0
2011-12-14 22:22:02.143866 [27735/3073944240] client_recovery_commit: xa_commit for rmid=1, name='OracleXE_dynreg', xa_name='Oracle_XA'...
2011-12-14 22:22:03.188211 [27735/3073944240] client_recovery_commit: rc=0
2011-12-14 22:22:03.188272 [27735/3073944240] client_recovery_commit/excp=1/ret_cod=0/errno=0
2011-12-14 22:22:03.188318 [27735/3073944240] client_recovery: sending 187 bytes ('000181&lt;?xml version="1.0" encoding="UTF-8" ?&gt;&lt;msg level="0" verb="8" step="24"&gt;&lt;recovery failed="0" commit="1"/&gt;&lt;rsrmgrs&gt;&lt;rsrmgr rmid="0" rc="0"/&gt;&lt;rsrmgr rmid="1" rc="0"/&gt;&lt;/rsrmgrs&gt;&lt;/msg&gt;') to the server for step 24
2011-12-14 22:22:03.188496 [27735/3073944240] client_recovery: sending 197 bytes ('000191&lt;?xml version="1.0" encoding="UTF-8" ?&gt;&lt;msg level="0" verb="8" step="8"&gt;&lt;client job="9bac7be1c129ea6ee31f2d71b318120c/127.0.0.1      " config_digest="9bac7be1c129ea6ee31f2d71b318120c"/&gt;&lt;/msg&gt;') to the server for step 8
2011-12-14 22:22:03.228361 [27735/3073944240] client_recovery: receiving 95 bytes from the server |&lt;?xml version="1.0" encoding="UTF-8" ?&gt;&lt;msg level="0" verb="8" step="16"&gt;&lt;answer rc="1"/&gt;&lt;/msg&gt;|
2011-12-14 22:22:03.228544 [27735/3073944240] client_recovery: the server answered LIXA_RC_OBJ_NOT_FOUND; there are no more transactions to recover
2011-12-14 22:22:03.228589 [27735/3073944240] client_recovery/excp=12/ret_cod=0/errno=0
tx_open(): 0
tx_close(): 0
	  </pre></td></tr></tbody></table><p>
	You can now verify there are no more 
	<span class="emphasis"><em>prepared/in-doubt</em></span> transactions inside the
	Resource Managers:
	</p><table xmlns="" frame="box" id="id3418045"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from dba_pending_transactions;

no rows selected
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3418067"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from pg_prepared_xacts;
 transaction | gid | prepared | owner | database 
-------------+-----+----------+-------+----------
(0 rows)
	  </pre></td></tr></tbody></table><p>
	</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
	    The automatic (warm) recovery process completed successfully
	    because <span class="command"><strong>./example6_pql_ora</strong></span> and
	    <span class="command"><strong>/opt/lixa/bin/lixat</strong></span> were associated to 
	    <span class="emphasis"><em>the same job</em></span> and the LIXA state server
	    (<span class="command"><strong>lixad</strong></span>) kept the state of the transaction in
	    the meanwhile.
	</p></div><p>
	In the next paragraphs you can explore what happens if the previous
	conditions are not satisfied.
      </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3418112"></a>Manual (cold) recovery</h2></div></div></div><p>
      Manual (cold) recovery uses the information provided by the
      Resource Managers querying them using 
      <code class="function">xa_recover()</code>.
      This type of recovery should be used to resolve some unusual
      situations.
    </p><p>
      If, for any reason, the LIXA state server (<span class="command"><strong>lixad</strong></span>)
      forgot the state of a transaction
      <sup>[<a id="id3418137" href="#ftn.id3418137" class="footnote">34</a>]</sup>
      or the transaction is in state â<span class="quote">recovery failed</span>â because
      a previous automatic (warm) recovery failed, you have to manually
      recover the transaction.
      The procedure to recover a â<span class="quote">forgotten</span>â transaction is 
      the same you use to recover a â<span class="quote">recovery failed</span>â one, 
      but additional server side clean-up is suggested for 
      â<span class="quote">recovery failed</span>â transactions.
    </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="Recoverying_forgotten_transactions"></a>Recoverying forgotten transactions</h3></div></div></div><p>
	This example necessitates of the same environment set-up in
	<a class="xref" href="#Forcing_automatic_recovery" title="Forcing automatic recovery">the section called âForcing automatic recoveryâ</a>; you must start running
	the example program after you enabled the 
	<code class="varname">LIXA_CRASH_POINT</code> environment variable:
	</p><table xmlns="" frame="box" id="id3418208"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LIXA_CRASH_POINT=15
tiian@ubuntu:~/tmp$ echo $LIXA_CRASH_POINT
15
tiian@ubuntu:~/tmp$ ./example6_pql_ora insert
Deleting a row from the tables...
Oracle DELETE statement executed!
Aborted
	  </pre></td></tr></tbody></table><p>
	and check there is a recovery pending transaction inside PostgreSQL
	and Oracle Resource Managers:
	</p><table xmlns="" frame="box" id="id3418227"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from dba_pending_transactions;

  FORMATID
----------
GLOBALID
--------------------------------------------------------------------------------
BRANCHID
--------------------------------------------------------------------------------
1279875137
957747F7F37B439EBCEA4146076AD322
9BAC7BE1C129EA6EE31F2D71B318120C
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3418240"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from pg_prepared_xacts;
 transaction |                                    gid                                     |           prepared            | owner | database 
-------------+----------------------------------------------------------------------------+-------------------------------+-------+----------
         877 | 4c495841.957747f7f37b439ebcea4146076ad322.9bac7be1c129ea6ee31f2d71b318120c | 2011-12-14 22:55:14.973443+01 | tiian | testdb
	  </pre></td></tr></tbody></table><p>
	Then you should stop and cold start the <span class="command"><strong>lixad</strong></span> 
	state server:
	</p><table xmlns="" frame="box" id="id3418281"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ sudo su - lixa
lixa@ubuntu:~$ ps -ef|grep lixad|grep -v grep
lixa     24437     1  0 21:19 ?        00:00:00 /opt/lixa/sbin/lixad --daemon
lixa@ubuntu:~$ pkill lixad
lixa@ubuntu:~$ ps -ef|grep lixad|grep -v grep
lixa@ubuntu:~$ ls /opt/lixa/var/
lixad_status1_1  lixad_status2_1  lixad_status3_1  README
lixad_status1_2  lixad_status2_2  lixad_status3_2
lixa@ubuntu:~$ rm /opt/lixa/var/lixad_status*
lixa@ubuntu:~$ ls /opt/lixa/var/
README
lixa@ubuntu:~$ /opt/lixa/sbin/lixad --daemon
lixa@ubuntu:~$ ps -ef|grep lixad|grep -v grep
lixa     28594     1  0 23:00 ?        00:00:00 /opt/lixa/sbin/lixad --daemon
lixa@ubuntu:~$ ls /opt/lixa/var/
lixad_status1_1  lixad_status2_1  lixad_status3_1  README
lixad_status1_2  lixad_status2_2  lixad_status3_2  run.pid
lixa@ubuntu:~$ exit
logout
	  </pre></td></tr></tbody></table><p>
	These are the operations you just performed:
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	      changed the user from your own to 
	      <code class="systemitem">lixa</code> user
	  </p></li><li style="list-style-type: disc"><p>
	      checked the <span class="command"><strong>lixad</strong></span> daemon was running
	  </p></li><li style="list-style-type: disc"><p>
	      stopped the <span class="command"><strong>lixad</strong></span> daemon
	  </p></li><li style="list-style-type: disc"><p>
	      checked the <span class="command"><strong>lixad</strong></span> daemon was not running
	  </p></li><li style="list-style-type: disc"><p>
	      checked the <span class="command"><strong>lixad</strong></span>'s state files
	  </p></li><li style="list-style-type: disc"><p>
	      removed the <span class="command"><strong>lixad</strong></span>'s state files
	  </p></li><li style="list-style-type: disc"><p>
	      started the <span class="command"><strong>lixad</strong></span> daemon
	  </p></li><li style="list-style-type: disc"><p>
	      checked the new <span class="command"><strong>lixad</strong></span>'s state files
	  </p></li></ul></div><p>
	Running <span class="command"><strong>lixat</strong></span> does <span class="emphasis"><em>not</em></span>
	automatically recover the transaction:
	</p><table xmlns="" frame="box" id="id3418400"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LIXA_TRACE_MASK=0x00040000
tiian@ubuntu:~/tmp$ /opt/lixa/bin/lixat 
tx_open(): 0
tx_close(): 0
	  </pre></td></tr></tbody></table><p>
	</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	    The program does not produce trace because
	    â<span class="quote">client recovery</span>â module is not called (the 
	    state server does not pass information about recovery 
	    pending transactions to the LIXA client library).
	</p></div><p>
	</p><table xmlns="" frame="box" id="id3418436"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from dba_pending_transactions;

  FORMATID
----------
GLOBALID
--------------------------------------------------------------------------------
BRANCHID
--------------------------------------------------------------------------------
1279875137
957747F7F37B439EBCEA4146076AD322
9BAC7BE1C129EA6EE31F2D71B318120C
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3418461"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from pg_prepared_xacts;
 transaction |                                    gid                                     |           prepared            | owner | database 
-------------+----------------------------------------------------------------------------+-------------------------------+-------+----------
         877 | 4c495841.957747f7f37b439ebcea4146076ad322.9bac7be1c129ea6ee31f2d71b318120c | 2011-12-14 22:55:14.973443+01 | tiian | testdb
	  </pre></td></tr></tbody></table><p>
	The <span class="command"><strong>lixar</strong></span> utility program with <code class="option">-p</code>
	option can be used to list the prepared transactions that can not be
	automatically recovered:
	</p><table xmlns="" frame="box" id="id3418496"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ /opt/lixa/bin/lixar -p
Execution options:
	- print report = yes
	- transaction(s) will be committed = no
	- transaction(s) will be rolled back = no
	- bypass xid branch qualifier check = no
	- bypass xid format id check = no
	- use TMENDRSCAN flag for last xa_recover call = no

Recovery environment:
LIXA_CONFIG_FILE_ENV_VAR = '(null)'
LIXA_PROFILE_ENV_VAR = 'PQL_STA_ORA_DYN'
LIXA_JOB_ENV_VAR = '(null)'

Resource manager list:
rmid=0, lixa_name='PostgreSQL_stareg', xa_name='PostgreSQL[LIXA]'
rmid=1, lixa_name='OracleXE_dynreg', xa_name='Oracle_XA'

Prepared and in-doubt transaction list:
xid='4c495841.957747f7f37b439ebcea4146076ad322.9bac7be1c129ea6ee31f2d71b318120c': rmid=0 rmid=1 
	  </pre></td></tr></tbody></table><p>
	it reports some useful information and at the bottom there is the
	list of in-doubt transactions. 
	The transaction is prepared/in-doubt for both Resource Managers;
	sometimes it may be only for a subset of the Resource Managers
	defined by <code class="varname">LIXA_PROFILE</code>.
	You can manually recover the transaction using
	the <code class="option">-x</code> and <code class="option">-r</code> (rollback) or
	<code class="option">-c</code> (commit):
	</p><table xmlns="" frame="box" id="id3418546"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ /opt/lixa/bin/lixar -p -x 4c495841.957747f7f37b439ebcea4146076ad322.9bac7be1c129ea6ee31f2d71b318120c -r
Execution options:
	- print report = yes
	- transaction to commit/rollback = 4c495841.957747f7f37b439ebcea4146076ad322.9bac7be1c129ea6ee31f2d71b318120c
	- transaction(s) will be committed = no
	- transaction(s) will be rolled back = yes
	- bypass xid branch qualifier check = no
	- bypass xid format id check = no
	- use TMENDRSCAN flag for last xa_recover call = no

Recovery environment:
LIXA_CONFIG_FILE_ENV_VAR = '(null)'
LIXA_PROFILE_ENV_VAR = 'PQL_STA_ORA_DYN'
LIXA_JOB_ENV_VAR = '(null)'

Resource manager list:
rmid=0, lixa_name='PostgreSQL_stareg', xa_name='PostgreSQL[LIXA]'
rmid=1, lixa_name='OracleXE_dynreg', xa_name='Oracle_XA'

Prepared and in-doubt transaction list:
xid='4c495841.957747f7f37b439ebcea4146076ad322.9bac7be1c129ea6ee31f2d71b318120c': rmid=0 rmid=1 

Analizing transaction '4c495841.957747f7f37b439ebcea4146076ad322.9bac7be1c129ea6ee31f2d71b318120c':
xa_rollback --&gt; rmid=0, lixa_name='PostgreSQL_stareg', xa_name='PostgreSQL[LIXA]', rc=0
xa_rollback --&gt; rmid=1, lixa_name='OracleXE_dynreg', xa_name='Oracle_XA', rc=0
	  </pre></td></tr></tbody></table><p>
	You can now verify there are no prepared/in-doubt transactions 
	inside the Resource Managers:
	</p><table xmlns="" frame="box" id="id3418588"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from dba_pending_transactions;

no rows selected
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3418608"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from pg_prepared_xacts;
 transaction | gid | prepared | owner | database 
-------------+-----+----------+-------+----------
(0 rows)
	  </pre></td></tr></tbody></table><p>
	We rolled back the deletion so the rows must be in place:
	</p><table xmlns="" frame="box" id="id3418632"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

COUNTR
------
COUNTRY_NAME
--------------------------------------------------------------------------------
 REGION_ID
----------
RS
Repubblica San Marino
	 1
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3418649"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from AUTHORS;
 id | last_name | first_name 
----+-----------+------------
  1 | Foo       | Bar
	  </pre></td></tr></tbody></table><p>
	You can retrieve some help from <span class="command"><strong>lixar</strong></span> with
	<code class="option">-?</code> option:
	</p><table xmlns="" frame="box" id="id3418681"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ /opt/lixa/bin/lixar -?
Usage:
  lixar [OPTION...] - LIXA recovery utility

Help Options:
  -?, --help                      Show help options

Application Options:
  -p, --print                     Print a report of all the prepared and in-doubt transactions compatible with current configuration and profile
  -x, --xid                       Select specified transaction for rollback/commit
  -X, --xid-file                  Select specified file as a list of transaction to rollback/commit
  -c, --commit                    Commit prepared &amp; in-doubt transactions
  -r, --rollback                  Rollback prepared &amp; in-doubt transactions
  -v, --version                   Print package info and exit
  -b, --bypass-bqual-check        Bypass xid branch qualifier check
  -B, --bypass-formatid-check     Bypass xid format id check
  -e, --use-tmendrscan-flag       Use TMENDRSCAN flag for last xa_recover call
	  </pre></td></tr></tbody></table><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3418188"></a>Recoverying a â<span class="quote">recovery failed</span>â transaction</h3></div></div></div><p>
	This example is quite complex because a 
	â<span class="quote">recovery failed</span>â transaction is unlikely.
	To create a â<span class="quote">recovery failed</span>â transaction we 
	will use a special
	Resource Manager, the â<span class="quote">LIXA monkey</span>â one: it's a
	R.M. we can â<span class="quote">program</span>â to answer the Transaction Manager
	as we desire. We will emulate an heuristically completed transaction
	to force the LIXA Transaction Manager marking it as
	â<span class="quote">recovery failed</span>â.
      </p><p>
	Before we can start, you must set-up the same environment already 
	explained in <a class="xref" href="#Recoverying_forgotten_transactions" title="Recoverying forgotten transactions">the section called âRecoverying forgotten transactionsâ</a>.
	Open three terminals session and prepare the sessions as shown
	below:
	</p><table xmlns="" frame="box" id="id3418771"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ . /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/bin/oracle_env.sh
tiian@ubuntu:~/tmp$ echo $ORACLE_HOME
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server
tiian@ubuntu:~/tmp$ echo $ORACLE_SID
XE
tiian@ubuntu:~/tmp$ export LIXA_PROFILE=MON_STA_PQL_STA_ORA_DYN
tiian@ubuntu:~/tmp$ echo $LIXA_PROFILE
MON_STA_PQL_STA_ORA_DYN
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib:
tiian@ubuntu:~/tmp$ export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/lixa/lib
tiian@ubuntu:~/tmp$ echo $LD_LIBRARY_PATH
/usr/lib/oracle/xe/app/oracle/product/10.2.0/server/lib::/opt/lixa/lib
	  </pre></td></tr></tbody></table><p>
	The specified <code class="varname">LIXA_PROFILE</code> points to a
	configuration with three Resource Managers: LIXA Monkey (a fake
	R.M.), PostgreSQL (static registration) and Oracle DBMS (dynamic
	registration).
	</p><table xmlns="" frame="box" id="id3418800"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ . /usr/lib/oracle/xe/app/oracle/product/10.2.0/server/bin/oracle_env.sh
tiian@ubuntu:~$ sqlplus "hr/hr"

SQL*Plus: Release 10.2.0.1.0 - Production on Ven Dic 16 16:15:23 2011

Copyright (c) 1982, 2005, Oracle.  All rights reserved.


Connesso a:
Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

no rows selected
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3418807"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~$ psql testdb
Welcome to psql 8.3.16, the PostgreSQL interactive terminal.

Type:  \copyright for distribution terms
       \h for help with SQL commands
       \? for help with psql commands
       \g or terminate with semicolon to execute query
       \q to quit

testdb=&gt; SELECT * FROM authors;
 id | last_name | first_name 
----+-----------+------------
(0 rows)
	  </pre></td></tr></tbody></table><p>
	Start the LIXA state server if it's not active:
	</p><table xmlns="" frame="box" id="id3418854"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ sudo su - lixa
lixa@ubuntu:~$ /opt/lixa/sbin/lixad --daemon
lixa@ubuntu:~$ ps -ef|grep lixad|grep -v grep
lixa      7127     1  0 22:13 ?        00:00:00 /opt/lixa/sbin/lixad --daemon
lixa@ubuntu:~$ exit
logout
	  </pre></td></tr></tbody></table><p>
	Before we can start the program execution, we must create a file
	named <code class="filename">monkeyrm.conf</code> in the current directory
	and put the following content inside it:
	</p><table xmlns="" frame="box" id="id3418883"><thead><tr><td>[Content of file monkeyrm.conf]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
xa_open/0
xa_start/0
xa_end/0
xa_prepare/0
xa_commit/0
xa_close/0
	  </pre></td></tr></tbody></table><p>
	Now you can execute the program to verify it's running as expected;
	we are tracing the module â<span class="quote">client XA switch</span>â
	(see <a class="xref" href="#Tracing_modules" title="Tracing modules">the section called âTracing modulesâ</a>) to verify the 
	LIXA Monkey Resource Manager is properly configured:
	</p><table xmlns="" frame="box" id="id3418913"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LIXA_TRACE_MASK=0x00010000
tiian@ubuntu:~/tmp$ ./example6_pql_ora insert 2&gt;&amp;1 | grep monkey
2011-12-15 22:42:20.709697 [22490/3052672768] lixa_monkeyrm_open: xa_info='monkeyrm.conf', rmid=1, flags=0x0
2011-12-15 22:42:20.710101 [22490/3052672768] lixa_monkeyrm_open: creating new first level hash table...
2011-12-15 22:42:20.713087 [22490/3052672768] lixa_monkeyrm_open/g_hash_table_new_full/monkey_status: 0x804caa0
2011-12-15 22:42:20.713361 [22490/3052672768] lixa_monkeyrm_open: creating new second level hash table for tid=3052672768
2011-12-15 22:42:20.713719 [22490/3052672768] lixa_monkeyrm_open/g_hash_table_new_full/slht: 0x804cac8
2011-12-15 22:42:20.713994 [22490/3052672768] lixa_monkeyrm_open: creating new status block for tid=3052672768, rmid=1
2011-12-15 22:42:20.714248 [22490/3052672768] lixa_monkeyrm_open/g_malloc/mss: 0x804e998
2011-12-15 22:42:20.714521 [22490/3052672768] lixa_monkeyrm_open_init
2011-12-15 22:42:20.714783 [22490/3052672768] lixa_monkeyrm_open_init/g_array_new/mss-&gt;records: 0x804c550 
2011-12-15 22:42:20.715139 [22490/3052672768] lixa_monkeyrm_open_init: verb='xa_open'
2011-12-15 22:42:20.715430 [22490/3052672768] lixa_monkeyrm_open_init: appending record verb=1, rc=0
2011-12-15 22:42:20.715691 [22490/3052672768] lixa_monkeyrm_open_init: verb='xa_start'
2011-12-15 22:42:20.715946 [22490/3052672768] lixa_monkeyrm_open_init: appending record verb=3, rc=0
2011-12-15 22:42:20.716340 [22490/3052672768] lixa_monkeyrm_open_init: verb='xa_end'
2011-12-15 22:42:20.716602 [22490/3052672768] lixa_monkeyrm_open_init: appending record verb=4, rc=0
2011-12-15 22:42:20.716864 [22490/3052672768] lixa_monkeyrm_open_init: verb='xa_prepare'
2011-12-15 22:42:20.717123 [22490/3052672768] lixa_monkeyrm_open_init: appending record verb=5, rc=0
2011-12-15 22:42:20.717377 [22490/3052672768] lixa_monkeyrm_open_init: verb='xa_commit'
2011-12-15 22:42:20.717671 [22490/3052672768] lixa_monkeyrm_open_init: appending record verb=6, rc=0
2011-12-15 22:42:20.717937 [22490/3052672768] lixa_monkeyrm_open_init: verb='xa_close'
2011-12-15 22:42:20.718196 [22490/3052672768] lixa_monkeyrm_open_init: appending record verb=2, rc=0
2011-12-15 22:42:20.718519 [22490/3052672768] lixa_monkeyrm_open_init/excp=3/ret_cod=0/errno=0
2011-12-15 22:42:20.718816 [22490/3052672768] lixa_monkeyrm_get_rc
2011-12-15 22:42:20.726862 [22490/3052672768] lixa_monkeyrm_get_rc: verb is 1, XA return code is 0
2011-12-15 22:42:20.727177 [22490/3052672768] lixa_monkeyrm_get_rc/excp=2/ret_cod=0/errno=0
2011-12-15 22:42:20.727429 [22490/3052672768] lixa_monkeyrm_open/excp=4/ret_cod=0/xa_rc=0/errno=0
2011-12-15 22:42:21.022655 [22490/3052672768] lixa_monkeyrm_start: xid='4c495841.7bdcf6c060e14bdba416302661187411.a100c8728292168b21ba7239bffc137d', rmid=1, flags=0x0
2011-12-15 22:42:21.022695 [22490/3052672768] lixa_monkeyrm_get_rc
2011-12-15 22:42:21.022705 [22490/3052672768] lixa_monkeyrm_get_rc: verb is 3, XA return code is 0
2011-12-15 22:42:21.022712 [22490/3052672768] lixa_monkeyrm_get_rc/excp=2/ret_cod=0/errno=0
2011-12-15 22:42:21.022719 [22490/3052672768] lixa_monkeyrm_start/excp=4/ret_cod=0/xa_rc=0/errno=0
2011-12-15 22:42:21.059688 [22490/3052672768] lixa_monkeyrm_end: xid='4c495841.7bdcf6c060e14bdba416302661187411.a100c8728292168b21ba7239bffc137d', rmid=1, flags=0x4000000
2011-12-15 22:42:21.059701 [22490/3052672768] lixa_monkeyrm_get_rc
2011-12-15 22:42:21.059709 [22490/3052672768] lixa_monkeyrm_get_rc: verb is 4, XA return code is 0
2011-12-15 22:42:21.059716 [22490/3052672768] lixa_monkeyrm_get_rc/excp=2/ret_cod=0/errno=0
2011-12-15 22:42:21.059723 [22490/3052672768] lixa_monkeyrm_end/excp=4/ret_cod=0/xa_rc=0/errno=0
2011-12-15 22:42:21.076478 [22490/3052672768] lixa_monkeyrm_prepare: xid='4c495841.7bdcf6c060e14bdba416302661187411.a100c8728292168b21ba7239bffc137d', rmid=1, flags=0x0
2011-12-15 22:42:21.076498 [22490/3052672768] lixa_monkeyrm_get_rc
2011-12-15 22:42:21.076512 [22490/3052672768] lixa_monkeyrm_get_rc: verb is 5, XA return code is 0
2011-12-15 22:42:21.076520 [22490/3052672768] lixa_monkeyrm_get_rc/excp=2/ret_cod=0/errno=0
2011-12-15 22:42:21.076527 [22490/3052672768] lixa_monkeyrm_prepare/excp=4/ret_cod=0/xa_rc=0/errno=0
2011-12-15 22:42:21.098722 [22490/3052672768] lixa_monkeyrm_commit: xid='4c495841.7bdcf6c060e14bdba416302661187411.a100c8728292168b21ba7239bffc137d', rmid=1, flags=0x0
2011-12-15 22:42:21.098747 [22490/3052672768] lixa_monkeyrm_get_rc
2011-12-15 22:42:21.098756 [22490/3052672768] lixa_monkeyrm_get_rc: verb is 6, XA return code is 0
2011-12-15 22:42:21.098764 [22490/3052672768] lixa_monkeyrm_get_rc/excp=2/ret_cod=0/errno=0
2011-12-15 22:42:21.098770 [22490/3052672768] lixa_monkeyrm_commit/excp=4/ret_cod=0/xa_rc=0/errno=0
2011-12-15 22:42:21.102841 [22490/3052672768] lixa_monkeyrm_close: xa_info='', rmid=1, flags=0x0
2011-12-15 22:42:21.102853 [22490/3052672768] lixa_monkeyrm_get_rc
2011-12-15 22:42:21.102862 [22490/3052672768] lixa_monkeyrm_get_rc: verb is 2, XA return code is 0
2011-12-15 22:42:21.102869 [22490/3052672768] lixa_monkeyrm_get_rc/excp=2/ret_cod=0/errno=0
2011-12-15 22:42:21.102877 [22490/3052672768] lixa_monkeyrm_close/excp=4/ret_cod=0/xa_rc=0/errno=0
tiian@ubuntu:~/tmp$ unset LIXA_TRACE_MASK
tiian@ubuntu:~/tmp$ ./example6_pql_ora delete
Deleting a row from the tables...
Oracle DELETE statement executed!
	  </pre></td></tr></tbody></table><p>
	Don't forget the clean-up step (last command) before performing
	the next steps.
      </p><p>
	To create a â<span class="quote">recovery pending</span>â transaction, we are
	going to forcea crash after <code class="function">xa_prepare()</code>
	functions completed successfully:
	</p><table xmlns="" frame="box" id="id3419038"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LIXA_CRASH_POINT=15
tiian@ubuntu:~/tmp$ echo $LIXA_CRASH_POINT
15
tiian@ubuntu:~/tmp$ ./example6_pql_ora insert
Inserting a row in the tables...
Oracle INSERT statement executed!
Aborted
tiian@ubuntu:~/tmp$ unset LIXA_CRASH_POINT
tiian@ubuntu:~/tmp$ echo $LIXA_CRASH_POINT

	  </pre></td></tr></tbody></table><p>
	Verify there is a prepared/in-doubt transaction inside Oracle:
	</p><table xmlns="" frame="box" id="id3419066"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from dba_pending_transactions;

  FORMATID
----------
GLOBALID
--------------------------------------------------------------------------------
BRANCHID
--------------------------------------------------------------------------------
1279875137
D2F5F0A5C37E485CB44D9FC16E72A33D
68D0E0CCBC6FC4B7FA616DF9AB122395
	  </pre></td></tr></tbody></table><p>
	Verify there is a prepared/in-doubt transaction inside PostgreSQL:
	</p><table xmlns="" frame="box" id="id3419094"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from pg_prepared_xacts;
 transaction |                                    gid                                     |           prepared            | owner | database 
-------------+----------------------------------------------------------------------------+-------------------------------+-------+----------
         964 | 4c495841.d2f5f0a5c37e485cb44d9fc16e72a33d.68d0e0ccbc6fc4b7fa616df9ab122395 | 2011-12-16 16:38:47.921947+01 | tiian | testdb
	  </pre></td></tr></tbody></table><p>
	To move the transaction in â<span class="quote">recovery failed</span>â status
	we emulate
	an â<span class="quote">heuristically rolled back</span>â in the automatic recovery
	step.
	Edit the file <code class="filename">monkeyrm.conf</code> to code the
	new behavior of the LIXA Monkey R.M.:
	</p><table xmlns="" frame="box" id="id3419133"><thead><tr><td>[Content of file monkeyrm.conf]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
xa_open/0
xa_commit/6
xa_close/0
	  </pre></td></tr></tbody></table><p>
	Start the <span class="command"><strong>lixat</strong></span> utility command to start an
	â<span class="quote">automatic (warm) recovery</span>â; trace the
	â<span class="quote">client recovery</span>â 
	(see <a class="xref" href="#Tracing_modules" title="Tracing modules">the section called âTracing modulesâ</a>) module to understand what
	happens:
	</p><table xmlns="" frame="box" id="id3419174"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ export LIXA_TRACE_MASK=0x00040000
tiian@ubuntu:~/tmp$ /opt/lixa/bin/lixat
2011-12-16 16:44:09.970398 [8385/3073862320] client_recovery
2011-12-16 16:44:09.970575 [8385/3073862320] client_recovery: sending 197 bytes ('000191&lt;?xml version="1.0" encoding="UTF-8" ?&gt;&lt;msg level="0" verb="8" step="8"&gt;&lt;client job="68d0e0ccbc6fc4b7fa616df9ab122395/127.0.0.1      " config_digest="68d0e0ccbc6fc4b7fa616df9ab122395"/&gt;&lt;/msg&gt;') to the server for step 8
2011-12-16 16:44:10.007703 [8385/3073862320] client_recovery: receiving 632 bytes from the server |&lt;?xml version="1.0" encoding="UTF-8" ?&gt;&lt;msg level="0" verb="8" step="16"&gt;&lt;answer rc="0"/&gt;&lt;client job="68d0e0ccbc6fc4b7fa616df9ab122395/127.0.0.1      " config_digest="68d0e0ccbc6fc4b7fa616df9ab122395"&gt;&lt;last_verb_step verb="5" step="16"/&gt;&lt;state finished="0" txstate="3" will_commit="1" will_rollback="0" xid="4c495841.d2f5f0a5c37e485cb44d9fc16e72a33d.68d0e0ccbc6fc4b7fa616df9ab122395"/&gt;&lt;/client&gt;&lt;rsrmgrs&gt;&lt;rsrmgr rmid="0" next_verb="0" r_state="1" s_state="33" td_state="10"/&gt;&lt;rsrmgr rmid="1" next_verb="0" r_state="1" s_state="33" td_state="10"/&gt;&lt;rsrmgr rmid="2" next_verb="0" r_state="1" s_state="33" td_state="20"/&gt;&lt;/rsrmgrs&gt;&lt;/msg&gt;|
2011-12-16 16:44:10.008178 [8385/3073862320] client_recovery_analyze
2011-12-16 16:44:10.008229 [8385/3073862320] client_recovery_analyze: the TX was committing
2011-12-16 16:44:10.008242 [8385/3073862320] client_recovery_analyze: rmid=0, r_state=1, s_state=33, td_state=10
2011-12-16 16:44:10.008261 [8385/3073862320] client_recovery_analyze: rmid=1, r_state=1, s_state=33, td_state=10
2011-12-16 16:44:10.008278 [8385/3073862320] client_recovery_analyze: rmid=2, r_state=1, s_state=33, td_state=20
2011-12-16 16:44:10.008303 [8385/3073862320] client_recovery_analyze/excp=1/ret_cod=0/errno=0
2011-12-16 16:44:10.008327 [8385/3073862320] client_recovery: transaction '4c495841.d2f5f0a5c37e485cb44d9fc16e72a33d.68d0e0ccbc6fc4b7fa616df9ab122395' must be committed
2011-12-16 16:44:10.008353 [8385/3073862320] client_recovery_commit
2011-12-16 16:44:10.008388 [8385/3073862320] client_recovery_commit: committing transaction '4c495841.d2f5f0a5c37e485cb44d9fc16e72a33d.68d0e0ccbc6fc4b7fa616df9ab122395'
2011-12-16 16:44:10.008412 [8385/3073862320] client_recovery_commit: xa_commit for rmid=0, name='LIXAmonkey1staRM', xa_name='LIXA Monkey RM (static)'...
2011-12-16 16:44:10.008464 [8385/3073862320] client_recovery_commit: rc=6
2011-12-16 16:44:10.008613 [8385/3073862320] client_recovery_commit: xa_commit for rmid=1, name='PostgreSQL_stareg', xa_name='PostgreSQL[LIXA]'...
2011-12-16 16:44:10.062892 [8385/3073862320] client_recovery_commit: rc=0
2011-12-16 16:44:10.062962 [8385/3073862320] client_recovery_commit: xa_commit for rmid=2, name='OracleXE_dynreg', xa_name='Oracle_XA'...
2011-12-16 16:44:10.275061 [8385/3073862320] client_recovery_commit: rc=0
2011-12-16 16:44:10.275128 [8385/3073862320] client_recovery_commit/excp=1/ret_cod=0/errno=0
2011-12-16 16:44:10.275286 [8385/3073862320] client_recovery: sending 212 bytes ('000206&lt;?xml version="1.0" encoding="UTF-8" ?&gt;&lt;msg level="0" verb="8" step="24"&gt;&lt;recovery failed="1" commit="1"/&gt;&lt;rsrmgrs&gt;&lt;rsrmgr rmid="0" rc="6"/&gt;&lt;rsrmgr rmid="1" rc="0"/&gt;&lt;rsrmgr rmid="2" rc="0"/&gt;&lt;/rsrmgrs&gt;&lt;/msg&gt;') to the server for step 24
2011-12-16 16:44:10.275483 [8385/3073862320] client_recovery: sending 197 bytes ('000191&lt;?xml version="1.0" encoding="UTF-8" ?&gt;&lt;msg level="0" verb="8" step="8"&gt;&lt;client job="68d0e0ccbc6fc4b7fa616df9ab122395/127.0.0.1      " config_digest="68d0e0ccbc6fc4b7fa616df9ab122395"/&gt;&lt;/msg&gt;') to the server for step 8
2011-12-16 16:44:10.315057 [8385/3073862320] client_recovery: receiving 95 bytes from the server |&lt;?xml version="1.0" encoding="UTF-8" ?&gt;&lt;msg level="0" verb="8" step="16"&gt;&lt;answer rc="1"/&gt;&lt;/msg&gt;|
2011-12-16 16:44:10.315261 [8385/3073862320] client_recovery: the server answered LIXA_RC_OBJ_NOT_FOUND; there are no more transactions to recover
2011-12-16 16:44:10.315315 [8385/3073862320] client_recovery/excp=12/ret_cod=0/errno=0
tx_open(): 0
tx_close(): 0
	  </pre></td></tr></tbody></table><p>
	The trace gives us a lot of information:
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	      <span class="command"><strong>lixat</strong></span> fires an automatic (warm) recovery
	      for transaction XID='4c495841.d2f5f0a5c37e485cb44d9fc16e72a33d.68d0e0ccbc6fc4b7fa616df9ab122395'
	  </p></li><li style="list-style-type: disc"><p>
	      the transaction must be committed because the crash followed
	      a successful â<span class="quote">prepare</span>â phase
	  </p></li><li style="list-style-type: disc"><p>
	      first Resource Manager returns 6:
	      <code class="constant">XA_HEURRB</code> (â<span class="quote">the transaction branch 
		has been heuristically rolled back</span>â)
	  </p></li><li style="list-style-type: disc"><p>
	      second and third Resource Managers return 0: XA_OK
	  </p></li><li style="list-style-type: disc"><p>
	      the client send a â<span class="quote">recovery failed</span>â
	      message to the state server
	  </p></li></ul></div><p>
	</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	    You could think the LIXA Transaction Manager should have not
	    performed the second and third 
	    <code class="function">xa_commit</code> after a failure with the
	    first Resource Manager. It seems a good idea, but unfortunately
	    it does not add much value because, if applied, it would
	    introduce a behaviour that depends on the order of the
	    operations. The LIXA Transaction Manager tryes to apply a
	    consistent rule: after a successful <code class="function">xa_prepare</code>
	    all the Resource Managers must receive the same command
	    (<code class="function">xa_commit</code>/<code class="function">xa_rollback</code>).
	</p></div><p>
	You can check the (real) Resource Managers status:
	</p><table xmlns="" frame="box" id="id3419338"><thead><tr><td>[Oracle terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
SQL&gt; select * from dba_pending_transactions;

no rows selected

SQL&gt; select * from COUNTRIES where COUNTRY_ID = 'RS';

COUNTR
------
COUNTRY_NAME
--------------------------------------------------------------------------------
 REGION_ID
----------
RS
Repubblica San Marino
	 1
	  </pre></td></tr></tbody></table><p>
	</p><table xmlns="" frame="box" id="id3419364"><thead><tr><td>[PostgreSQL terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
testdb=&gt; select * from pg_prepared_xacts;
 transaction | gid | prepared | owner | database 
-------------+-----+----------+-------+----------
(0 rows)

testdb=&gt; SELECT * FROM authors;
 id | last_name | first_name 
----+-----------+------------
  1 | Foo       | Bar
	  </pre></td></tr></tbody></table><p>
	Inspecting the system log you can notify there was a problem:
	</p><table xmlns="" frame="box" id="id3419383"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ sudo tail /var/log/daemon.log
Dec 16 16:44:09 ubuntu lixat[8385]: LXC000I this process is starting a new LIXA transaction manager (lixa package version is 0.5.36)
Dec 16 16:44:10 ubuntu lixat[8385]: LXC003C resource manager 'LIXAmonkey1staRM' returned an error (6) while committing (xa_commit) during recovery phase for transaction '4c495841.d2f5f0a5c37e485cb44d9fc16e72a33d.68d0e0ccbc6fc4b7fa616df9ab122395'
Dec 16 16:44:10 ubuntu lixat[8385]: LXC005W unable to recover transaction id '4c495841.d2f5f0a5c37e485cb44d9fc16e72a33d.68d0e0ccbc6fc4b7fa616df9ab122395'; this transaction must be manually recovered and the correlated record(s) must be manually fixed in lixad server status file
Dec 16 16:44:10 ubuntu lixad[8157]: LXD012W a client notified recovery failed condition for the transaction registered in status file 3 and block 1
	  </pre></td></tr></tbody></table><p>
	there is a critical message (LXC003C) and two warning messages
	(LXC005W, LXD012W). Pay attention the server notifies the problem 
	(LXD012W) as well as the client (LXC005W).
	To inspect the content of the â<span class="quote">recovery failed</span>â
	transaction you may dump the state server:
	</p><table xmlns="" frame="box" id="id3419429"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ sudo su - lixa
lixa@ubuntu:~$ pkill lixad
lixa@ubuntu:~$ /opt/lixa/sbin/lixad --dump=u &gt;/tmp/bar
lixa@ubuntu:~$ exit
logout
	  </pre></td></tr></tbody></table><p>
	and inspect the content of file <code class="filename">/tmp/bar</code>
	<sup>[<a id="id3419455" href="#ftn.id3419455" class="footnote">35</a>]</sup>:
	</p><table xmlns="" frame="box" id="id3419472"><thead><tr><td>[Content of file /tmp/bar]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
========================================================================
Second file ('/opt/lixa/var/lixad_status1_2') will be dumped
Magic number is: 24848 (24848)
Level is: 1 (1)
Last sync timestamp: 2011-12-16T16:38:23.482854+0100
Size: 17 blocks
Used block chain starts at: 16 
Free block chain starts at: 0 (empty chain)
Dumping records following physical order: 0
Dumping records following free block chain: 0
Dumping records following used block chain: 1
------------------------------------------------------------------------

[...] 

------------------------------------------------------------------------
Block: 9, next block in chain: 8
Block type: transaction manager record (transaction header)
	Trnhdr/number of resource managers: 3
	Trnhdr/resource manager blocks are: 10 11 12 
	Trnhdr/arrival time: 2011-12-16T16:26:04.790526+0100
	Trnhdr/local socket address:port is 127.0.0.1:2345
	Trnhdr/peer socket address:port is 127.0.0.1:52251
	Trnhdr/config digest is '68d0e0ccbc6fc4b7fa616df9ab122395'
	Trnhdr/job is '68d0e0ccbc6fc4b7fa616df9ab122395/127.0.0.1      '
	Trnhdr/last (verb, step) are: [ (9,8) (4,8) (4,16) (5,8) (5,16) ]
	Trnhdr/state/finished: 0
	Trnhdr/state/txstate: 3
	Trnhdr/state/will commit: 1
	Trnhdr/state/will rollback: 0
	Trnhdr/state/xid: '4c495841.592cec793be1433d8ffd18574211e0e2.68d0e0ccbc6fc4b7fa616df9ab122395'
	Trnhdr/recoverying block id: 0
	Trnhdr/recovery failed: 1
	Trnhdr/recovery failed time: 2011-12-16T16:29:15.947057+0100
	Trnhdr/recovery commit: 1
------------------------------------------------------------------------
Block: 8, next block in chain: 7
Block type: resource manager record
	Rsrmgr/rmid: 2
	Rsrmgr/state/next_verb: 0
	Rsrmgr/state/xa_r_state: 1
	Rsrmgr/state/dynamic: 0
	Rsrmgr/state/xa_td_state: 10
	Rsrmgr/state/xa_s_state: 33
	Rsrmgr/lixac_conf.xml name: 'LIXAmonkey1staRM'
	Rsrmgr/xa_name: 'LIXA Monkey RM (static)'
	Rsrmgr/xa_open_info: 'monkeyrm.conf'
	Rsrmgr/xa_open_flags: 0x0
	Rsrmgr/xa_open_rc: 0
	Rsrmgr/xa_start_flags: 0x0
	Rsrmgr/xa_start_rc: 0
	Rsrmgr/xa_end_flags: 0x4000000
	Rsrmgr/xa_end_rc: 0
	Rsrmgr/xa_prepare_flags: 0x0
	Rsrmgr/xa_prepare_rc: 0
	Rsrmgr/xa_commit_flags: 0x0
	Rsrmgr/xa_commit_rc: 0
	Rsrmgr/xa_rollback_flags: 0x0
	Rsrmgr/xa_rollback_rc: 0
	Rsrmgr/xa_forget_flags: 0x0
	Rsrmgr/xa_forget_rc: 0
	Rsrmgr/ax_reg_flags: 0x0
	Rsrmgr/ax_reg_rc: 0
	Rsrmgr/ax_unreg_flags: 0x0
	Rsrmgr/ax_unreg_rc: 0
	Rsrmgr/recovery_rc: 6
------------------------------------------------------------------------
Block: 7, next block in chain: 6
Block type: resource manager record
	Rsrmgr/rmid: 1
	Rsrmgr/state/next_verb: 0
	Rsrmgr/state/xa_r_state: 1
	Rsrmgr/state/dynamic: 1
	Rsrmgr/state/xa_td_state: 20
	Rsrmgr/state/xa_s_state: 33
	Rsrmgr/lixac_conf.xml name: 'OracleXE_dynreg'
	Rsrmgr/xa_name: 'Oracle_XA'
	Rsrmgr/xa_open_info: 'Oracle_XA+Acc=P/hr/hr+SesTm=30+LogDir=/tmp+threads=true+DbgFl=7+Loose_Coupling=true'
	Rsrmgr/xa_open_flags: 0x0
	Rsrmgr/xa_open_rc: 0
	Rsrmgr/xa_start_flags: 0x0
	Rsrmgr/xa_start_rc: 0
	Rsrmgr/xa_end_flags: 0x4000000
	Rsrmgr/xa_end_rc: 0
	Rsrmgr/xa_prepare_flags: 0x0
	Rsrmgr/xa_prepare_rc: 0
	Rsrmgr/xa_commit_flags: 0x0
	Rsrmgr/xa_commit_rc: 0
	Rsrmgr/xa_rollback_flags: 0x0
	Rsrmgr/xa_rollback_rc: 0
	Rsrmgr/xa_forget_flags: 0x0
	Rsrmgr/xa_forget_rc: 0
	Rsrmgr/ax_reg_flags: 0x0
	Rsrmgr/ax_reg_rc: 0
	Rsrmgr/ax_unreg_flags: 0x0
	Rsrmgr/ax_unreg_rc: 0
	Rsrmgr/recovery_rc: 0
------------------------------------------------------------------------
Block: 6, next block in chain: 5
Block type: resource manager record
	Rsrmgr/rmid: 0
	Rsrmgr/state/next_verb: 0
	Rsrmgr/state/xa_r_state: 1
	Rsrmgr/state/dynamic: 0
	Rsrmgr/state/xa_td_state: 10
	Rsrmgr/state/xa_s_state: 33
	Rsrmgr/lixac_conf.xml name: 'PostgreSQL_stareg'
	Rsrmgr/xa_name: 'PostgreSQL[LIXA]'
	Rsrmgr/xa_open_info: 'dbname=testdb'
	Rsrmgr/xa_open_flags: 0x0
	Rsrmgr/xa_open_rc: 0
	Rsrmgr/xa_start_flags: 0x0
	Rsrmgr/xa_start_rc: 0
	Rsrmgr/xa_end_flags: 0x4000000
	Rsrmgr/xa_end_rc: 0
	Rsrmgr/xa_prepare_flags: 0x0
	Rsrmgr/xa_prepare_rc: 0
	Rsrmgr/xa_commit_flags: 0x0
	Rsrmgr/xa_commit_rc: 0
	Rsrmgr/xa_rollback_flags: 0x0
	Rsrmgr/xa_rollback_rc: 0
	Rsrmgr/xa_forget_flags: 0x0
	Rsrmgr/xa_forget_rc: 0
	Rsrmgr/ax_reg_flags: 0x0
	Rsrmgr/ax_reg_rc: 0
	Rsrmgr/ax_unreg_flags: 0x0
	Rsrmgr/ax_unreg_rc: 0
	Rsrmgr/recovery_rc: 0
------------------------------------------------------------------------

[...]

========================================================================
First file ('/opt/lixa/var/lixad_status2_1') will be dumped
Magic number is: 24848 (24848)
Level is: 1 (1)
Last sync timestamp: 2011-12-16T16:23:40.512332+0100
Size: 10 blocks
Used block chain starts at: 0 (empty chain)
Free block chain starts at: 1 
Dumping records following physical order: 0
Dumping records following free block chain: 0
Dumping records following used block chain: 1
========================================================================
First file ('/opt/lixa/var/lixad_status3_1') will be dumped
Magic number is: 24848 (24848)
Level is: 1 (1)
Last sync timestamp: 2011-12-16T16:38:47.933099+0100
Size: 10 blocks
Used block chain starts at: 4 
Free block chain starts at: 5 
Dumping records following physical order: 0
Dumping records following free block chain: 0
Dumping records following used block chain: 1
------------------------------------------------------------------------

[...]
	  </pre></td></tr></tbody></table><p>
	The chain composed of blocks 9 (transaction manager record) and
	8, 7, 6 (resource manager records) keeps the state of the 
	â<span class="quote">recovery failed</span>â transaction: 
	<code class="computeroutput">Trnhdr/recovery failed: 1</code>
      </p><p>
	If â<span class="quote">LIXA Monkey RM</span>â Resource Manager was a real
	Resource Manager, you could manually recovery the transaction
	used the procedure shown in 
	<a class="xref" href="#Recoverying_forgotten_transactions" title="Recoverying forgotten transactions">the section called âRecoverying forgotten transactionsâ</a>.
	Unfortunately the LIXA Monkey RM is a fake Resource Manager and it
	does not save the state anywhere: it is not able to correctly
	answer to <code class="function">xa_recover()</code> and there is no way to
	show this last step.
      </p><p>
	As a final step, to clean-up the â<span class="quote">recovery failed</span>â
	state from LIXA state server, you have to recycle it using a special
	option:
	</p><table xmlns="" frame="box" id="id3419616"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ sudo su - lixa
lixa@ubuntu:~$ pkill lixad
lixa@ubuntu:~$ /opt/lixa/sbin/lixad --daemon --clean-failed
lixa@ubuntu:~$ pkill lixad<sup>[<a id="id3419639" href="#ftn.id3419639" class="footnote">36</a>]</sup>
lixa@ubuntu:~$ exit
logout
	  </pre></td></tr></tbody></table><p>
	Dump again the content of the state server:
	</p><table xmlns="" frame="box" id="id3419650"><thead><tr><td>[Shell terminal session]</td></tr></thead><tbody><tr><td><pre xmlns="http://www.w3.org/1999/xhtml" class="screen">
tiian@ubuntu:~/tmp$ sudo su - lixa
lixa@ubuntu:~$ /opt/lixa/sbin/lixad --dump=u &gt;/tmp/bar
lixa@ubuntu:~$ exit
logout
	  </pre></td></tr></tbody></table><p>
	and check the content of the dump file again: the blocks 
	10, 9, 8, 7 should not be used or, if re-used, they should be
	related to a different transaction.
      </p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
	  <span class="emphasis"><em>Don't use 
	    <code class="option">--clean-failed</code> as a default</em></span>
	  when starting LIXA state server (<span class="command"><strong>lixad</strong></span>):
	  this option should be used only after you inspected the content
	  of the state server and solved any in-doubt transaction.
      </p></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	  Operating this type of recovery can be easier if the LIXA state
	  server is running in â<span class="quote">maintenance mode</span>â
	  (see <a class="xref" href="#Maintenance_mode_execution" title="Maintenance mode execution">the section called âMaintenance mode executionâ</a>): only
	  <span class="command"><strong>lixar</strong></span> can access the online content of the
	  LIXA state server and ordinary clients (Application Program)
	  can not perform transactions. It may be useful using the 
	  state server in â<span class="quote">maintenance mode</span>â, but only you
	  can decide if your business rules allows it.
      </p></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>
	  The LIXA technology <span class="emphasis"><em>does not</em></span> ask you to:
	  </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
		recycle the <span class="command"><strong>lixad</strong></span> state server to see
		the current status when dumping the content of the state
		server files (<code class="option">--dump</code> option)
	    </p></li><li style="list-style-type: disc"><p>
		start the <span class="command"><strong>lixad</strong></span> state server in
		â<span class="quote">maintenance mode</span>â when performing
		â<span class="quote">manual (cold) recovery</span>â
	    </p></li></ul></div><p>
	  The LIXA technology provides you these functions to simplify the
	  administrative tasks, but deciding which option should be used
	  it's your own responsability. 
      </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="Recoverying_transaction_associated_different_job"></a>Recoverying a transaction associated to a different job</h3></div></div></div><p>
	As explained in <a class="xref" href="#Automatic_recovery_concepts" title="Automatic recovery concepts">the section called âAutomatic recovery conceptsâ</a>,
	the â<span class="quote">automatic (warm) recovery</span>â is automatically
	performed by the LIXA Transaction Manager under the condition of
	â<span class="quote">Application Program equivalence</span>â
	(see <a class="xref" href="#Application_Program_equivalence" title="Application Program equivalence">the section called âApplication Program equivalenceâ</a>).
      </p><p>
	Sometimes you have to perform a â<span class="quote">manual (cold) recovery</span>â
	because â<span class="quote">Application Program equivalence</span>â is no more
	available. This is a typical scenario:
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	      an Application Program crashed and its transaction is in
	      â<span class="quote">in-doubt/prepared (recovery pending) status</span>â
	  </p></li><li style="list-style-type: disc"><p>
	      the Application Program didn't specify a custom value for
	      the environment variable <code class="varname">LIXA_JOB</code>
	  </p></li><li style="list-style-type: disc"><p>
	      you changed the content of file
	      <code class="filename">lixac_conf.xml</code>, for example you added a 
	      new profile
	  </p></li><li style="list-style-type: disc"><p>
	      the MD5 signature of file <code class="filename">lixac_conf.xml</code>
	      changed, the associated <code class="varname">branch qualifier</code>
	      changed, new transactions would be associated to a 
	      different <span class="emphasis"><em>job</em></span>
	  </p></li><li style="list-style-type: disc"><p>
	      automatic (warm) recovery wouldn't be automatically performed
	      and the transaction becomes a 
	      â<span class="quote">forgotten</span>â transaction.
	  </p></li></ul></div><p>
	Inspecting the list of recovery pending transaction using
	<span class="command"><strong>lixar -p</strong></span> does not return the desired transaction...
	What's going on?
      </p><p>
	By default, the <span class="command"><strong>lixar</strong></span> utility filters the 
	transactions
	retrieved by the Resource Managers: it keeps only the transactions
	with the same <code class="varname">branch qualifier</code> of the current
	<span class="command"><strong>lixar</strong></span> running instance.
	If you look at <a class="xref" href="#Application_Program_equivalence" title="Application Program equivalence">the section called âApplication Program equivalenceâ</a>,
	you will realize that <span class="command"><strong>lixar</strong></span> 
	retrieves only the transactions started with 
	the same <code class="filename">lixac_conf.xml</code>,
	the same $(<code class="varname">LIXA_PROFILE</code>) and
	the same <code class="function">gethostid()</code>.
	This behaviour helps the system engineer to see only the 
	â<span class="quote">relevant</span>â subset of the whole
	â<span class="quote">recovery pending</span>â set.
      </p><p>
	If you are looking for <span class="emphasis"><em>all</em></span> the transactions in
	â<span class="quote">recovery pending</span>â status currently kept by the
	Resource Managers associated to the current 
	<code class="varname">LIXA_PROFILE</code>, you must specify the
	<code class="option">--bypass-bqual-check</code> (<code class="option">-b</code>) option.
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3419956"></a>Recoverying a transaction managed by a different Transaction Manager</h3></div></div></div><p>
	The LIXA project technology can help you dealing with a different
	Transaction Manager 
	(see <a class="xref" href="#Transaction_Manager_and_Transaction_Monitor" title="Transaction Manager and Transaction Monitor">the section called âTransaction Manager and Transaction Monitorâ</a>) 
	too: the <span class="command"><strong>lixar</strong></span> utility program can be used to
	inspect (and manually recover) a transaction managed by a different
	Transaction Manager using two command options together:
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	      <code class="option">--bypass-bqual-check</code> (<code class="option">-b</code>):
	      to bypass branch qualifier based filtering
	  </p></li><li style="list-style-type: disc"><p>
	      <code class="option">--bypass-formatid-check</code> (<code class="option">-B</code>):
	      to bypass format ID based filtering
	  </p></li></ul></div><p>
	If you use the above command options together, 
	<span class="command"><strong>lixar</strong></span> utility program will inspect (and eventually
	commit/rollback) any XA transaction known by the Resource Managers
	associated to the current <code class="varname">LIXA_PROFILE</code>.
      </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	  It's <span class="emphasis"><em>your own</em></span> responsability to define a
	  LIXA profile that's compatible with the configuration of the
	  third party Transaction Manager used when managing the transaction:
	  it <span class="emphasis"><em>must</em></span> contain the <span class="emphasis"><em>same</em></span>
	  Resource Managers in the <span class="emphasis"><em>same</em></span> order
	  with the <span class="emphasis"><em>same</em></span> options.
      </p></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
	  LIXA software is libre/free/open source software and you use it
	  <span class="emphasis"><em>exclusively and consciously without any
	  warranty at your own risk</em></span>.
	  Using LIXA software technology will probably put you in an
	  <span class="emphasis"><em>unsupported</em></span> state regarding to the
	  third party Transaction Manager supplier.
      </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3420069"></a>Picking up the LIXA format id and branch qualifier</h3></div></div></div><p>
	In the previous sections we have dealt with 
	â<span class="quote">format id</span>â and â<span class="quote">branch qualifier</span>â;
	you could ask 
	â<span class="quote">How can I discover the
	  â<span class="quote">format id</span>â and the â<span class="quote">branch qualifier</span>â
	  branch qualifier associated to my own Application Program?</span>â
      </p><p>
	The easiest way to pick-up them is to use <span class="command"><strong>lixat</strong></span>
	utility program using the <span class="emphasis"><em>same</em></span>
	<code class="varname">LIXA_PROFILE</code> you use when running your
	Application Program:
	</p><pre class="screen">
tiian@ubuntu:~/src/lixa$ sudo su - lixa
lixa@ubuntu:~$ /opt/lixa/sbin/lixad --daemon
lixa@ubuntu:~$ ps -ef|grep lixad|grep -v grep
lixa      8122     1  0 23:02 ?        00:00:00 /opt/lixa/sbin/lixad --daemon
lixa@ubuntu:~$ exit
logout
tiian@ubuntu:~/src/lixa$ /opt/lixa/bin/lixat -c
tx_open(): 0
tx_begin(): 0
tx_info(): 1
	xid/formatID.gtrid.bqual = 4c495841.56af7a66398f4eca82b8826fe10165ad.9e4c11057107c73366c9fc421eaa85ca
tx_commit(): 0
tx_close(): 0
tiian@ubuntu:~/src/lixa$ /opt/lixa/bin/lixat -c
tx_open(): 0
tx_begin(): 0
tx_info(): 1
	xid/formatID.gtrid.bqual = 4c495841.218f05b733fb4bc1aa3d21eeaf01fbab.9e4c11057107c73366c9fc421eaa85ca
tx_commit(): 0
tx_close(): 0	  
	</pre><p>
	From the above terminal output:
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	      â<span class="quote">formatID</span>â is constant and the LIXA Transaction
	      Manager uses the exadecimal value 4c495841 (that's the 
	      ASCII sequence of string â<span class="quote">LIXA</span>â)
	  </p></li><li style="list-style-type: disc"><p>
	      â<span class="quote">branch qualifier</span>â is computed as explained in
	      <a class="xref" href="#Application_Program_equivalence" title="Application Program equivalence">the section called âApplication Program equivalenceâ</a> and the
	      value in the above example is
	      â<span class="quote">9e4c11057107c73366c9fc421eaa85ca</span>â
	  </p></li><li style="list-style-type: disc"><p>
	      â<span class="quote">global transaction id</span>â must be different for
	      any transaction and you can see two different values in the
	      above examples (it's computed using
	      <code class="function">uuid_generate()</code> function).
	  </p></li></ul></div><p>
      </p><p>
	If you were interested in retrieving them programmatically
	(from your own C language program) you could use the standard
	<code class="function">tx_info()</code> function that returns a 
	<span class="type">TXINFO</span> struct ([<a class="citation" href="#id3421960"><span class="citation">TXspec</span></a>]).
	Please pay attention the
	<span class="type">XID</span> struct contains <span class="emphasis"><em>binary data</em></span>
	(it does not contain ASCII data).
      </p></div></div><div class="footnotes"><br /><hr width="100" align="left" /><div class="footnote"><p><sup>[<a id="ftn.id3418137" href="#id3418137" class="para">34</a>] </sup>
	  This should never happen: it could be a bug in LIXA project
	  software or it might be the consequence of a 
	  â<span class="quote">cold start</span>â (you removed the state files) of
	  <span class="command"><strong>lixad</strong></span>
      </p></div><div class="footnote"><p><sup>[<a id="ftn.id3419455" href="#id3419455" class="para">35</a>] </sup>
	    The state server can be analyzed without stopping it
	    (<span class="command"><strong>pkill lixad</strong></span>), but it may happen you will
	    not see the current content because the state server 
	    has not yet synchronized
	    the state file(s). If the LIXA state server is processing many
	    transactions per second you will probably see an up-to-date
	    state, but if it was â<span class="quote">sleeping</span>â you wouldn't.
	</p></div><div class="footnote"><p><sup>[<a id="ftn.id3419639" href="#id3419639" class="para">36</a>] </sup>
The LIXA state server is stopped after start-up to guarantee the content
of the state file(s) on the disk are up-to-date before dumping them.
</p></div></div></div><div class="chapter" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="id3420212"></a>ChapterÂ 7.Â In Depth</h2></div></div></div><p>
    This chapter explains some internal details you can be interested in
    when you are dealing with complex environments.
  </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3420226"></a>Logging</h2></div></div></div><p>
      The LIXA project software uses standard UNIX logging 
      <code class="function">syslog()</code> function but it does not
      set a specific <em class="parameter"><code>facility</code></em>
      using the <code class="function">openlog()</code> function.
      The final destination of the log messages depends on the configuration
      of the standard UNIX logging; Ubuntu 8.04, for examples, sends the
      messages to file <code class="filename">/var/log/daemon.log</code>. This should
      be in accordance with the content of the <code class="function">syslog</code>
      man page â<span class="quote">LOG_DAEMON
        system daemons without separate facility value</span>â.
    </p><p>
      The messages produced by the LIXA project software are documented in
      the file <code class="filename">src/common/lixa_syslog.h</code>
    </p><p>
      The messages produced by the LIXA project software use two different
      prefixes: â<span class="quote">LXC</span>â for
      <code class="systemitem">lixac</code> (client library) and
      â<span class="quote">LXD</span>â for
      <span class="command"><strong>lixad</strong></span> (state server).
      Try the following example:
      </p><pre class="screen">
tiian@ubuntu:~$ ps -ef|grep lixad|grep -v grep
tiian@ubuntu:~$ /opt/lixa/bin/lixat
tx_open(): -7	
      </pre><p>
      inspecting the log file <code class="filename">/var/log/daemon.log</code>
      you should find out something like this:
      </p><pre class="screen">
Dec  4 18:16:10 ubuntu lixat[6538]: LXC000I this process is starting a new LIXA transaction manager (lixa package version is 0.5.36)
Dec  4 18:16:10 ubuntu lixat[6538]: LXC002E unable to connect to LIXA server at address 127.0.0.1, port 2345
      </pre><p>
      the <span class="command"><strong>lixat</strong></span> command is running as expected because
      the state server is not active.
      To see the messages produced by the state server you can try the
      following commands:
      </p><pre class="screen">
tiian@ubuntu:~$ sudo su - lixa
lixa@ubuntu:~$ /opt/lixa/sbin/lixad -d
lixa@ubuntu:~$ pkill lixad
lixa@ubuntu:~$ exit
logout
      </pre><p>
      inspecting the log file <code class="filename">/var/log/daemon.log</code>
      you should find out something like this:
      </p><pre class="screen">
Dec  4 18:22:46 ubuntu lixad[6694]: LXD000N this process is starting a new LIXA server (lixa package version is 0.5.36)
Dec  4 18:22:46 ubuntu lixad[6697]: LXD014N LIXA server entered daemon status
Dec  4 18:22:49 ubuntu lixad[6697]: LXD019N received signal 15, server immediate shutdown in progress...
Dec  4 18:22:49 ubuntu lixad[6697]: LXD006N server terminated activities
      </pre><p>
      The log messages are differentiated by 
      <em class="parameter"><code>priority</code></em>; there is a direct
      link between the letter in the seventh position and the severity of
      the message:
      </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p><span class="emphasis"><em>D</em></span> : <code class="constant">LOG_DEBUG</code></p></li><li style="list-style-type: disc"><p><span class="emphasis"><em>I</em></span> : <code class="constant">LOG_INFO</code></p></li><li style="list-style-type: disc"><p><span class="emphasis"><em>N</em></span> : <code class="constant">LOG_NOTICE</code></p></li><li style="list-style-type: disc"><p><span class="emphasis"><em>W</em></span> : <code class="constant">LOG_WARNING</code></p></li><li style="list-style-type: disc"><p><span class="emphasis"><em>E</em></span> : <code class="constant">LOG_ERR</code></p></li><li style="list-style-type: disc"><p><span class="emphasis"><em>C</em></span> : <code class="constant">LOG_CRIT</code></p></li></ul></div><p>
      If LIXA software was logging too much in your production environment
      you can configure the system log facility
      (<code class="filename">/etc/syslog.conf</code>) to filter some messages, but
      this tuning operation should not be necessary because the LIXA software
      does not use the system log facility as a debugging tool: look at
      <a class="xref" href="#Tracing" title="Tracing">the section called âTracingâ</a> to discover how debug messages are managed.
    </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="Tracing"></a>Tracing</h2></div></div></div><p>
      The LIXA project can produce a lot of traces when the software is 
      running; the tracing functions are included in the code by default but
      you can disable them when you configure the software before the build 
      phase:
      </p><pre class="screen">
	./configure --disable-trace
	make
	...
      </pre><p>
      </p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
	  Excluding tracing functions can reduce CPU and memory usage when
	  the software is running, but you should disable tracing 
	  <span class="emphasis"><em>only if you are really sure about it:
	  </em></span>without tracing you have no instruments
	  to understand what's happening inside LIXA code when it's running.
      </p></div><p>
      In the case you didn't disable the tracing feature at build time (see
      above), you could activate the message production when you need it.
    </p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="Tracing_modules"></a>Tracing modules</h3></div></div></div><p>
	The trace messages produced by LIXA code are divided by 
	<span class="emphasis"><em>modules</em></span>: you can activate the trace messages for
	one or more modules. There is not a concept of â<span class="quote">severity</span>â
	for the trace messages: if you activate the trace for a module, it
	will print all the trace messages of that module.
      </p><p>
	The table below shows how the LIXA software is partitioned in modules:
	</p><div class="table"><a id="id3420516"></a><p class="title"><b>TableÂ 7.1.Â Tracing module flags</b></p><div class="table-contents"><table summary="Tracing module flags" border="1"><colgroup><col /><col /><col /><col /></colgroup><thead><tr><th align="center">Module Trace Label</th><th align="center">Hex Flag</th><th align="center">Component</th><th align="center">Function</th></tr></thead><tbody><tr><td align="left">LIXA_TRACE_MOD_SERVER</td><td align="left">0x00000001</td><td align="left"><span class="command"><strong>lixad</strong></span> (state server)</td><td align="left">main program</td></tr><tr><td align="left">LIXA_TRACE_MOD_SERVER_CONFIG</td><td align="left">0x00000002</td><td align="left"><span class="command"><strong>lixad</strong></span> (state server)</td><td align="left">configuration: config file parsing and environment 
		  variable detection</td></tr><tr><td align="left">LIXA_TRACE_MOD_SERVER_LISTENER</td><td align="left">0x00000004</td><td align="left"><span class="command"><strong>lixad</strong></span> (state server)</td><td align="left">network listener and signal handler</td></tr><tr><td align="left">LIXA_TRACE_MOD_SERVER_MANAGER</td><td align="left">0x00000008</td><td align="left"><span class="command"><strong>lixad</strong></span> (state server)</td><td align="left">session client manager, thread manager, 
		  network I/O manager</td></tr><tr><td align="left">LIXA_TRACE_MOD_SERVER_STATUS</td><td align="left">0x00000010</td><td align="left"><span class="command"><strong>lixad</strong></span> (state server)</td><td align="left">persistent state</td></tr><tr><td align="left">LIXA_TRACE_MOD_SERVER_XA</td><td align="left">0x00000040</td><td align="left"><span class="command"><strong>lixad</strong></span> (state server)</td><td align="left">XA logic called by client</td></tr><tr><td align="left">LIXA_TRACE_MOD_SERVER_REPLY</td><td align="left">0x00000080</td><td align="left"><span class="command"><strong>lixad</strong></span> (state server)</td><td align="left">replies to client messages</td></tr><tr><td align="left">LIXA_TRACE_MOD_SERVER_RECOVERY</td><td align="left">0x00000100</td><td align="left"><span class="command"><strong>lixad</strong></span> (state server)</td><td align="left">logic necessary to answer the client recovery 
		  calls</td></tr><tr><td align="left">LIXA_TRACE_MOD_CLIENT_TX</td><td align="left">0x00001000</td><td align="left"><code class="systemitem">lixac</code>
		  (client library)</td><td align="left">transaction demarcation (TX) functions:
		  <code class="function">tx_open()</code>,
		  <code class="function">tx_begin()</code>, ...</td></tr><tr><td align="left">LIXA_TRACE_MOD_CLIENT_XA</td><td align="left">0x00002000</td><td align="left"><code class="systemitem">lixac</code>
		  (client library)</td><td align="left">XA function wrapper:
		  <code class="function">xa_open()</code>,
		  <code class="function">xa_start()</code>, 
		  <code class="function">ax_reg()</code>, ...</td></tr><tr><td align="left">LIXA_TRACE_MOD_CLIENT_CONN</td><td align="left">0x00004000</td><td align="left"><code class="systemitem">lixac</code>
		  (client library)</td><td align="left">function necessary to connect to the state server 
		  (<span class="command"><strong>lixad</strong></span>)</td></tr><tr><td align="left">LIXA_TRACE_MOD_CLIENT_CONFIG</td><td align="left">0x00008000</td><td align="left"><code class="systemitem">lixac</code>
		  (client library)</td><td align="left">configuration: config file parsing and environment 
		  variable detection</td></tr><tr><td align="left">LIXA_TRACE_MOD_CLIENT_XA_SWITCH</td><td align="left">0x00010000</td><td align="left"><code class="systemitem">lixac</code>
		  (client library)</td><td align="left">XA switch file implementation of the dummy resource
		managers provided by LIXA and of the XA wrappers for the
		resource managers without a standard switch file</td></tr><tr><td align="left">LIXA_TRACE_MOD_CLIENT_STATUS</td><td align="left">0x00020000</td><td align="left"><code class="systemitem">lixac</code>
		  (client library)</td><td align="left">client status management</td></tr><tr><td align="left">LIXA_TRACE_MOD_CLIENT_RECOVERY</td><td align="left">0x00040000</td><td align="left"><code class="systemitem">lixac</code>
		  (client library)</td><td align="left">warm and cold recovery of the transaction(s)</td></tr><tr><td align="left">LIXA_TRACE_MOD_COMMON_CONFIG</td><td align="left">0x01000000</td><td align="left"><code class="systemitem">lixab</code>
		  (common base library)</td><td align="left">configuration stuff common to all components</td></tr><tr><td align="left">LIXA_TRACE_MOD_COMMON_XML_MSG</td><td align="left">0x02000000</td><td align="left"><code class="systemitem">lixab</code>
		  (common base library)</td><td align="left">functions related to XML messages serialization and
		deserialization</td></tr><tr><td align="left">LIXA_TRACE_MOD_COMMON_STATUS</td><td align="left">0x04000000</td><td align="left"><code class="systemitem">lixab</code>
		  (common base library)</td><td align="left">convenience functions used to manage the status on
		client and server side</td></tr><tr><td align="left">LIXA_TRACE_MOD_COMMON_UTILS</td><td align="left">0x08000000</td><td align="left"><code class="systemitem">lixab</code>
		  (common base library)</td><td align="left">utility functions used by all the components</td></tr><tr><td align="left">LIXA_TRACE_MOD_COMMON_XID</td><td align="left">0x10000000</td><td align="left"><code class="systemitem">lixab</code>
		  (common base library)</td><td align="left">functions specialized for XID (transaction ID)
		management</td></tr></tbody></table></div></div><p><br class="table-break" />
	You can trace any module combination creating any
	<span class="emphasis"><em>trace mask</em></span> ORing the bits; for example:
	</p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>0x00000003 will produce all the messages of
	    <code class="constant">LIXA_TRACE_MOD_SERVER</code> and
	    <code class="constant">LIXA_TRACE_MOD_SERVER_CONFIG</code></p></li><li style="list-style-type: disc"><p>0xffffffff will produce all the messages</p></li><li style="list-style-type: disc"><p>0x00000000 will disable all the messages</p></li></ul></div><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3421118"></a>Improve troubleshooting with trace</h3></div></div></div><p>
	The trace can be activated setting the environment variable
	<code class="varname">LIXA_TRACE_MASK</code> before starting the execution of
	the traced program. Try the following example...
      </p><p>
	Check the state server is not active:
	</p><pre class="screen">
tiian@ubuntu:~$ ps -ef|grep lixad|grep -v grep
	</pre><p>
	try to execute <span class="command"><strong>lixat</strong></span>, the LIXA test program:
	</p><pre class="screen">
tiian@ubuntu:~$ /opt/lixa/bin/lixat
tx_open(): -7
	</pre><p>
	it gives us few information (<code class="constant">TX_FAIL = -7</code>): from
	<code class="filename">/opt/lixa/include/tx.h</code> we can retrieve the
	meaning: â<span class="quote">fatal error</span>â... Not so much...
	We could try to trace the â<span class="quote">CLIENT TX</span>â module:
	</p><pre class="screen">
tiian@ubuntu:~$ export LIXA_TRACE_MASK=0x00001000
tiian@ubuntu:~$ /opt/lixa/bin/lixat
2011-12-04 12:19:49.235007 [8899/3073612464] lixa_tx_open
2011-12-04 12:19:49.241544 [8899/3073612464] lixa_tx_open/TX_*=-7/excp=5/ret_cod=-138/errno=111
tx_open(): -7
	</pre><p>
	â<span class="quote">ret_cod=-138</span>â can be inspected inside
	<code class="filename">src/common/lixa_errors.h</code>:
	</p><pre class="screen">
[...]
/**
 * "connect" function error
 */
#define LIXA_RC_CONNECT_ERROR                  -138
[...]
	</pre><p>
	now we know the errors happens using <code class="function">connect()</code>
	function; â<span class="quote">errno=111</span>â can be inspected inside
	<code class="filename">/usr/include/asm-generic/errno.h</code>:
	</p><pre class="screen">
[...]
#define ECONNREFUSED    111     /* Connection refused */
[...]
	</pre><p>
	The error happens because the LIXA state server 
	(<span class="command"><strong>lixad</strong></span>) is not running, but we can improve our
	diagnosis with a more detailed tracing adding
	â<span class="quote">CLIENT CONN</span>â module:
	</p><pre class="screen">
tiian@ubuntu:~$ export LIXA_TRACE_MASK=0x00005000
tiian@ubuntu:~$ /opt/lixa/bin/lixat
2011-12-04 17:00:49.447866 [4514/3074067120] lixa_tx_open
2011-12-04 17:00:49.452624 [4514/3074067120] client_connect
2011-12-04 17:00:49.452678 [4514/3074067120] client_connect: connecting socket 4 to server '127.0.0.1' port 2345
2011-12-04 17:00:49.454033 [4514/3074067120] client_connect/excp=2/ret_cod=-138/errno=111
2011-12-04 17:00:49.454872 [4514/3074067120] lixa_tx_open/TX_*=-7/excp=5/ret_cod=-138/errno=111
tx_open(): -7
	</pre><p>
	the client is not able to contact the state server that is configured
	to listen port <code class="systemitem">2345</code> 
	at address 
	<code class="systemitem">127.0.0.1</code>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3421138"></a>Activating trace for <span class="command"><strong>lixad</strong></span> in 
	<span class="emphasis"><em>daemon</em></span> mode</h3></div></div></div><p>
	When running the state server (<span class="command"><strong>lixad</strong></span>) in
	<span class="emphasis"><em>daemon</em></span>
	mode, you must explicitly ask <span class="command"><strong>lixad</strong></span> to use a
	trace file. Try the following steps...
	</p><pre class="screen">
tiian@ubuntu:~$ sudo su - lixa
lixa@ubuntu:~$ export LIXA_TRACE_MASK=0x00000005
lixa@ubuntu:~$ /opt/lixa/sbin/lixad -d
2011-12-04 17:14:46.976067 [4888/3074164464] lixad/daemonize: fork()
2011-12-04 17:14:46.978399 [4889/3074164464] lixad/daemonize: setsid()
2011-12-04 17:14:46.979740 [4889/3074164464] lixad/daemonize: signal()
2011-12-04 17:14:46.980513 [4889/3074164464] lixad/daemonize: fork()
2011-12-04 17:14:46.982516 [4890/3074164464] lixad/daemonize: chdir()
2011-12-04 17:14:46.984002 [4890/3074164464] lixad/daemonize: umask()
	</pre><p>
	the process is tracing the initial operations and after the
	<span class="emphasis"><em>daemonization</em></span> it does not produce any more
	messages. By default <code class="filename">stderr</code> is used as the
	standard tracing file, but the
	<span class="emphasis"><em>daemon</em></span> disconnects from the terminal
	and closes the <code class="filename">stderr</code> file.
	To avoid this issue you can specify a specific trace file name using
	the <code class="option">-t</code> (<code class="option">--trace-file</code>) dedicated
	option:
	</p><pre class="screen">
lixa@ubuntu:~$ /opt/lixa/sbin/lixad -d -t /tmp/lixad.trace
lixa@ubuntu:~$ ls -la /tmp/lixad.trace
-rw-r--r-- 1 lixa lixa 349 2011-12-04 17:29 /tmp/lixad.trace
lixa@ubuntu:~$ pkill lixad
	</pre><p>
	inspecting the content of <code class="filename">/tmp/lixad.trace</code>
	you can now find messages related to the listener module too:
	</p><pre class="screen">
2011-12-04 17:29:12.435474 [5187/3074373360] lixad/daemonize: fork()
2011-12-04 17:29:12.436593 [5188/3074373360] lixad/daemonize: setsid()
2011-12-04 17:29:12.437187 [5188/3074373360] lixad/daemonize: signal()
2011-12-04 17:29:12.437245 [5188/3074373360] lixad/daemonize: fork()
2011-12-04 17:29:12.435474 [5187/3074373360] lixad/daemonize: fork()
2011-12-04 17:29:12.439878 [5189/3074373360] lixad/daemonize: now daemonized!
2011-12-04 17:29:12.441874 [5189/3074373360] lixad/main: starting
2011-12-04 17:29:12.447862 [5189/3074373360] server_listener
2011-12-04 17:29:12.447940 [5189/3074373360] server_listener: resolving address '127.0.0.1' for listener # 0
2011-12-04 17:29:12.448001 [5189/3074373360] server_listener: creating socket for listener # 0
2011-12-04 17:29:12.448033 [5189/3074373360] server_listener: socket for listener 0 is 10
2011-12-04 17:29:12.448044 [5189/3074373360] server_listener: setting SO_REUSE option for listener # 0
2011-12-04 17:29:12.448142 [5189/3074373360] server_listener: resolving address '0.0.0.0' for listener # 1
2011-12-04 17:29:12.448156 [5189/3074373360] server_listener: creating socket for listener # 1
2011-12-04 17:29:12.448174 [5189/3074373360] server_listener: socket for listener 1 is 11
2011-12-04 17:29:12.448183 [5189/3074373360] server_listener: setting SO_REUSE option for listener # 1
2011-12-04 17:29:12.448213 [5189/3074373360] server_listener_signal
2011-12-04 17:29:12.448262 [5189/3074373360] server_listener_signal/excp=3/ret_cod=0/errno=0
2011-12-04 17:29:12.448275 [5189/3074373360] server_listener_loop
2011-12-04 17:29:12.448284 [5189/3074373360] server_listener_loop: entering poll...
2011-12-04 17:29:23.499666 [5189/3074373360] server_listener_signal_action: signo=15
2011-12-04 17:29:23.499850 [5189/3074373360] server_listener_signal_action: sending message to thread id 0
2011-12-04 17:29:23.499877 [5189/3074373360] server_listener_signal_action: sending message to thread id 1
2011-12-04 17:29:23.499904 [5189/3074373360] server_listener_signal_action: sending message to thread id 2
2011-12-04 17:29:23.499942 [5189/3074373360] server_listener_signal_action: sending message to thread id 3
2011-12-04 17:29:23.499991 [5189/3074373360] server_listener_loop: ready file descriptors = 1
2011-12-04 17:29:23.500003 [5189/3074373360] server_listener_loop: slot=0, fd=2, POLLIN=1, POLLERR=0, POLLHUP=0, POLLNVAL=0
2011-12-04 17:29:23.500025 [5189/3074373360] server_listener_loop: waiting thread (1) id 3074329488 termination...
2011-12-04 17:29:23.521138 [5189/3074373360] server_listener_loop: waiting thread (2) id 3065920400 termination...
2011-12-04 17:29:23.521169 [5189/3074373360] server_listener_loop: waiting thread (3) id 3057511312 termination...
2011-12-04 17:29:23.521180 [5189/3074373360] server_listener_loop/excp=8/ret_cod=0/errno=4
2011-12-04 17:29:23.521190 [5189/3074373360] server_listener/excp=8/ret_cod=0/errno=4
2011-12-04 17:29:23.521558 [5189/3074373360] lixad/main: exiting
	</pre><p>
	</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	    The trace file is written using the 
	    <code class="systemitem">stdio</code>
	    and the output is not flushed after every message: if you look
	    at the trace file of a running <span class="command"><strong>lixad</strong></span> state
	    server, you will not be able to read the last messages due to
	    the buffering of <code class="systemitem">stdio</code>
	    library. After the
	    server termination you are sure every trace message is inside the
	    trace file.
	</p></div><p>
      </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="id3421410"></a>Redirecting the trace messages</h3></div></div></div><p>
	In the previous section you discovered how you can send the trace
	messages of <span class="command"><strong>lixad</strong></span>. The
	<code class="systemitem">lixac</code> library sends the
	trace messages to the <code class="filename">stderr</code> file associated to
	the terminal of the user that's running the process; many times you
	would send the messages to a specific disk hosted file. You can
	obtain this behavior using redirection:
	</p><pre class="screen">
tiian@ubuntu:~$ export LIXA_TRACE_MASK=0x00005000
tiian@ubuntu:~$ /opt/lixa/bin/lixat 2&gt;/tmp/lixat.trace
tx_open(): -7
tiian@ubuntu:~$ ls -la /tmp/lixat.trace
-rw-r--r-- 1 tiian tiian 417 2011-12-04 17:43 /tmp/lixat.trace
	</pre><p>
	You can inspect the content of the file
	<code class="filename">/tmp/lixat.trace</code>:
	</p><pre class="screen">
2011-12-04 17:43:36.078314 [5544/3074013872] lixa_tx_open
2011-12-04 17:43:36.083822 [5544/3074013872] client_connect
2011-12-04 17:43:36.083890 [5544/3074013872] client_connect: connecting socket 4 to server '127.0.0.1' port 2345
2011-12-04 17:43:36.084862 [5544/3074013872] client_connect/excp=2/ret_cod=-138/errno=111
2011-12-04 17:43:36.084906 [5544/3074013872] lixa_tx_open/TX_*=-7/excp=5/ret_cod=-138/errno=111
	</pre><p>
      </p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="Non_root_installation"></a>Non root installation</h2></div></div></div><p>
      The standard installation procedure explained in
      <a class="xref" href="#Installation" title="ChapterÂ 2.Â Installation">ChapterÂ 2, <i>Installation</i></a> uses 
      <code class="systemitem">root</code> account.
      You can install the software in a home directory using a normal user
      account, for instance <code class="systemitem">lixa</code>.
      To specify an alternative installation path you have to use
      <code class="option">--prefix</code> option at configure time.
    </p><p>
      The following steps show how you can install the software in 
      <code class="systemitem">lixa</code> home directory.
      </p><pre class="screen">
lixa@ubuntu:~$ ls -l
total 1520
-rw-r--r-- 1 lixa lixa 1550959 2011-12-18 21:25 lixa-0.5.36.tar.gz
lixa@ubuntu:~$ tar xzf lixa-0.5.36.tar.gz
lixa@ubuntu:~$ cd lixa-0.5.36

lixa@ubuntu:~/lixa-0.5.36$ ./configure --prefix=/home/lixa/prod
[...]
config.status: creating config.h
config.status: executing depfiles commands
config.status: executing tests/atconfig commands

lixa@ubuntu:~/lixa-0.5.36$ make install
[...]
make[2]: Leaving directory `/home/lixa/lixa-0.5.36'
make[1]: Leaving directory `/home/lixa/lixa-0.5.36'

lixa@ubuntu:~/lixa-0.5.36$ ls -la /home/lixa/prod/
total 36
drwxr-xr-x 9 lixa lixa 4096 2011-12-18 21:30 .
drwxr-xr-x 5 lixa lixa 4096 2011-12-18 21:28 ..
drwxr-xr-x 2 lixa lixa 4096 2011-12-18 21:29 bin
drwxr-xr-x 2 lixa lixa 4096 2011-12-18 21:28 etc
drwxr-xr-x 2 lixa lixa 4096 2011-12-18 21:29 include
drwxr-xr-x 2 lixa lixa 4096 2011-12-18 21:29 lib
drwxr-xr-x 2 lixa lixa 4096 2011-12-18 21:29 sbin
drwxr-xr-x 3 lixa lixa 4096 2011-12-18 21:30 share
drwxr-xr-x 2 lixa lixa 4096 2011-12-18 21:29 var

lixa@ubuntu:~/lixa-0.5.36$ export LD_LIBRARY_PATH=/home/lixa/prod/lib
lixa@ubuntu:~/lixa-0.5.36$ /home/lixa/prod/sbin/lixad --daemon
lixa@ubuntu:~/lixa-0.5.36$ ps -ef|grep lixad|grep -v grep
lixa     23493     1  0 21:32 ?        00:00:00 /home/lixa/prod/sbin/lixad --daemon

lixa@ubuntu:~/lixa-0.5.36$ export PATH=$PATH:/home/lixa/prod/bin
lixa@ubuntu:~/lixa-0.5.36$ lixat
tx_open(): 0
tx_close(): 0
      </pre><p>
    </p><p>
      Installing LIXA using a non 
      <code class="systemitem">root</code> 
      account has some advantages:
      </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	    there aren't post install steps to change the ownership of
	    <code class="filename">etc</code> and <code class="filename">var</code>
	    directories
	</p></li><li style="list-style-type: disc"><p>
	    you can install the software without
	    <code class="systemitem">root</code> privileges
	</p></li></ul></div><p>
      and some disadvantages:
      </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	    the software is installed inside a home directory instead of
	    a system path
	</p></li><li style="list-style-type: disc"><p>
	    there is no distinction between the administrative account
	    that must manage the state (<code class="filename">var</code>) and
	    the configuration (<code class="filename">etc</code>) and the
	    system account that must manage the software installation.
	</p></li></ul></div><p>
    </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="Workload_balanced_environments"></a>Workload balanced environments</h2></div></div></div><p>
      The LIXA client (<code class="systemitem">lixac</code>)
      uses only one state server at a time, but different profiles can
      use different state servers and you can statically balance the
      workload.
    </p><p>
      We can not name it â<span class="quote">workload balancing</span>â, but this is
      an effective way to manage large environments.
      To configure many LIXA state servers you must put many
      â<span class="quote">sttsrv</span>â tags in <code class="filename">etc/lixac_conf.xml</code>
      as in the example below:
      </p><pre class="screen">
  &lt;sttsrvs&gt;
    &lt;sttsrv name="local_1" domain="AF_INET" address="127.0.0.1" port="2345" /&gt;
    &lt;sttsrv name="local_2" domain="AF_INET" address="127.0.0.1" port="3456" /&gt;
  &lt;/sttsrvs&gt;
      </pre><p>
      then you must specify different â<span class="quote">sttsrv</span>â tags in the
      profiles as in the example below:
      </p><pre class="screen">
    &lt;profile name="ORA_DYN_DB2_DYN"&gt;
      &lt;sttsrvs&gt;
        &lt;sttsrv&gt;local_1&lt;/sttsrv&gt;
      &lt;/sttsrvs&gt;
      &lt;rsrmgrs&gt;
        &lt;rsrmgr&gt;OracleXE_dynreg&lt;/rsrmgr&gt;
        &lt;rsrmgr&gt;IBMDB2_dynreg&lt;/rsrmgr&gt;
      &lt;/rsrmgrs&gt;
    &lt;/profile&gt;
    &lt;profile name="ORA_DYN_DB2_STA"&gt;
      &lt;sttsrvs&gt;
        &lt;sttsrv&gt;local_2&lt;/sttsrv&gt;
      &lt;/sttsrvs&gt;
      &lt;rsrmgrs&gt;
        &lt;rsrmgr&gt;OracleXE_dynreg&lt;/rsrmgr&gt;
        &lt;rsrmgr&gt;IBMDB2_stareg&lt;/rsrmgr&gt;
      &lt;/rsrmgrs&gt;
    &lt;/profile&gt;
      </pre><p>
    </p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id3421671"></a>High Availability configuration</h2></div></div></div><p>
      If you were using LIXA software project in a mission critical
      environment, you should set-up an high availability configuration.
      If you take a look to <a class="xref" href="#config1" title="FigureÂ 3.1.Â Typical LIXA topology">FigureÂ 3.1, âTypical LIXA topologyâ</a> you will notice the
      <span class="command"><strong>lixad</strong></span> daemon is a <span class="emphasis"><em>single point of
	failure</em></span>: if the system hosting <span class="command"><strong>lixad</strong></span>
      crashed, the Application Program could not perform distributed
      transaction processing due to the unavailability of
      <span class="command"><strong>lixad</strong></span> daemon.
    </p><p>
      To avoid the issues related to â<span class="quote">single point of failure
      pathology</span>â the suggested configuration is
      â<span class="quote">Active/passive</span>â as described in 
      <a class="ulink" href="http://en.wikipedia.org/wiki/High-availability_cluster#Node_configurations" target="_top">
	Wikipedia â<span class="quote">High-availability cluster</span>â page</a>.
      You can use:
      </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	    any cluster manager, for example
	    <a class="ulink" href="http://www.linux-ha.org/wiki/Main_Page" target="_top">Linux-HA
	      Heartbeat</a>
	</p></li><li style="list-style-type: disc"><p>
	    any shared disk technology like 
	    <a class="ulink" href="http://en.wikipedia.org/wiki/Storage_area_network" target="_top">SAN (Storage Area Network)</a>, 
	    <a class="ulink" href="http://en.wikipedia.org/wiki/Network-attached_storage" target="_top">NAS (Network Attached Storage)</a> or disk replication technology like
	    <a class="ulink" href="http://www.drbd.org/" target="_top">DR:BD</a>
	</p></li></ul></div><p>
      <span class="command"><strong>lixad</strong></span> requires that the filesystem and the
      block device support <code class="function">mmap()</code>, 
      <code class="function">munmap()</code> and <code class="function">msync()</code> functions.
      The faster the filesystem/block device you are using, the better the
      <span class="command"><strong>lixad</strong></span> performance.
    </p><p>
      The easiest high-availability configuration uses:
      </p><div class="itemizedlist"><ul type="bullet"><li style="list-style-type: disc"><p>
	    a shared/mirrored disk containing the LIXA file tree
	    (<code class="filename">/opt/lixa</code> if you are using a default
	    installation)
	</p></li><li style="list-style-type: disc"><p>
	    a service dedicated IP address that must be activated on the
	    host servicing LIXA
	</p></li></ul></div><p>
      The following pictures show an high availability configuration in action:
      </p><div class="figure"><a id="high_availability_1"></a><p class="title"><b>FigureÂ 7.1.Â HA, step 1: the active node is on the left, 
	  the passive one is on the right</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_In_Depth_01.png" alt="HA, step 1: the active node is on the left, the passive one is on the right" /></div></div></div><p><br class="figure-break" />
      </p><div class="figure"><a id="high_availability_2"></a><p class="title"><b>FigureÂ 7.2.Â HA, step 2: the active node fails</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_In_Depth_02.png" alt="HA, step 2: the active node fails" /></div></div></div><p><br class="figure-break" />
      </p><div class="figure"><a id="high_availability_3"></a><p class="title"><b>FigureÂ 7.3.Â HA, step 3: the passive node takes over the service</b></p><div class="figure-contents"><div class="mediaobject"><img src="LIXA_In_Depth_03.png" alt="HA, step 3: the passive node takes over the service" /></div></div></div><p><br class="figure-break" />
    </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>
	If you put all the LIXA installation files 
	(<code class="filename">/opt/lixa</code>) in the shared disk you will not
	be able to run LIXA utility program from the node that's not owning
	the shared disk: this should not be an issue if your active/passive
	cluster hosts only <span class="command"><strong>lixad</strong></span>.
      </p><p>
	If you were using a most complicated configuration, it might be
	preferable to put only <code class="filename">/opt/lixa/var</code> and
	<code class="filename">/opt/lixa/etc</code> in the shared disk. You could
	implement such a configuration using symbolic links or customizing
	the configure procedure with 
	<code class="option">--sysconfdir=DIR</code> and 
	<code class="option">--localstatedir=DIR</code>
	options. Use <span class="command"><strong>./configure</strong></span> <code class="option">--help</code>
	for more details.
      </p></div></div></div><div class="bibliography"><div class="titlepage"><div><div><h2 class="title"><a id="id3421948"></a>Bibliography</h2></div></div></div><div class="bibliodiv"><h3 class="title">Books</h3><div class="biblioentry"><a id="id3421958"></a><p>[<abbr class="abbrev">RefModel</abbr>] <span class="copyright">Copyright Â© 1996 X/Open Company Limited. </span><span class="biblioid">1-85912-170-5. </span><span class="publisher"><span class="publishername">X/Open Company Ltd., U.K.. </span></span><span class="title"><i>Distributed Transaction Processing: Reference Model, Version 3</i>. </span></p></div><div class="biblioentry"><a id="id3421960"></a><p>[<abbr class="abbrev">TXspec</abbr>] <span class="copyright">Copyright Â© 1995 X/Open Company Limited. </span><span class="biblioid">1-85912-094-6. </span><span class="publisher"><span class="publishername">X/Open Company Ltd., U.K.. </span></span><span class="title"><i>Distributed Transaction Processing: The TX (Transaction Demarcation) Specification</i>. </span></p></div><div class="biblioentry"><a id="id3422020"></a><p>[<abbr class="abbrev">XAspec</abbr>] <span class="copyright">Copyright Â© 1991 X/Open Company Limited. </span><span class="biblioid">1-872630-24-3. </span><span class="publisher"><span class="publishername">X/Open Company Ltd., U.K.. </span></span><span class="title"><i>Distributed Transaction Processing: The XA Specification</i>. </span></p></div><div class="biblioentry"><a id="id3422055"></a><p>[<abbr class="abbrev">XA+spec</abbr>] <span class="copyright">Copyright Â© 1994 X/Open Company Limited. </span><span class="biblioid">1-85912-046-6. </span><span class="publisher"><span class="publishername">X/Open Company Ltd., U.K.. </span></span><span class="title"><i>Distributed Transaction Processing: The XA+ Specification
      Version 2</i>. </span></p></div></div></div></div></body></html>
